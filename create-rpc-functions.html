<!DOCTYPE html>
<html>
<head>
    <title>Create RPC Functions for Tornado War</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 5px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #facc15; }
        button { padding: 10px 20px; margin: 5px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2563eb; }
        button:disabled { background: #6b7280; cursor: not-allowed; }
        .log { background: #111; padding: 10px; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .function { margin: 10px 0; padding: 10px; border: 1px solid #444; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Create RPC Functions for Tornado War</h1>
        
        <div class="section">
            <h3>Instructions</h3>
            <p>This page will help you create the necessary RPC functions for Tornado War.</p>
            <p><strong>Note:</strong> You'll need to run these SQL commands manually in your Supabase SQL Editor.</p>
        </div>

        <div class="section">
            <h3>Step 1: Create Tables</h3>
            <div class="function">
                <h4>Core Tables SQL</h4>
                <textarea readonly style="width: 100%; height: 300px; background: #2a2a2a; color: #fff; border: 1px solid #444; padding: 10px; font-family: monospace;">-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Users table (extends Supabase auth.users)
CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Classes table
CREATE TABLE IF NOT EXISTS classes (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Students table
CREATE TABLE IF NOT EXISTS students (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    class_id UUID NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
    display_name TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Games table
CREATE TABLE IF NOT EXISTS games (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    class_id UUID NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    board_w INTEGER NOT NULL DEFAULT 8,
    board_h INTEGER NOT NULL DEFAULT 8,
    victory_target_pct NUMERIC(3,2) NOT NULL DEFAULT 0.50,
    turn_based BOOLEAN NOT NULL DEFAULT FALSE,
    status TEXT NOT NULL DEFAULT 'active',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Game students table (junction table)
CREATE TABLE IF NOT EXISTS game_students (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    game_id UUID NOT NULL REFERENCES games(id) ON DELETE CASCADE,
    student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
    start_points INTEGER NOT NULL DEFAULT 5,
    tiles_owned INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(game_id, student_id)
);

-- Tiles table
CREATE TABLE IF NOT EXISTS tiles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    game_id UUID NOT NULL REFERENCES games(id) ON DELETE CASCADE,
    x INTEGER NOT NULL,
    y INTEGER NOT NULL,
    owner_game_student_id UUID REFERENCES game_students(id) ON DELETE SET NULL,
    castle_level INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(game_id, x, y)
);

-- Transactions table
CREATE TABLE IF NOT EXISTS transactions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    game_student_id UUID NOT NULL REFERENCES game_students(id) ON DELETE CASCADE,
    type TEXT NOT NULL CHECK (type IN ('earn', 'spend')),
    amount INTEGER NOT NULL,
    meta JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Truces table
CREATE TABLE IF NOT EXISTS truces (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    game_id UUID NOT NULL REFERENCES games(id) ON DELETE CASCADE,
    a_game_student_id UUID NOT NULL REFERENCES game_students(id) ON DELETE CASCADE,
    b_game_student_id UUID NOT NULL REFERENCES game_students(id) ON DELETE CASCADE,
    proposer_game_student_id UUID NOT NULL REFERENCES game_students(id) ON DELETE CASCADE,
    status TEXT NOT NULL DEFAULT 'proposed' CHECK (status IN ('proposed', 'active', 'declined', 'revoked')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(game_id, a_game_student_id, b_game_student_id)
);

-- Audit log table
CREATE TABLE IF NOT EXISTS audit_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    game_id UUID NOT NULL REFERENCES games(id) ON DELETE CASCADE,
    actor TEXT NOT NULL,
    action TEXT NOT NULL,
    meta JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);</textarea>
            </div>
        </div>

        <div class="section">
            <h3>Step 2: Create RLS Policies</h3>
            <div class="function">
                <h4>RLS Policies SQL</h4>
                <textarea readonly style="width: 100%; height: 400px; background: #2a2a2a; color: #fff; border: 1px solid #444; padding: 10px; font-family: monospace;">-- Enable RLS on all tables
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE classes ENABLE ROW LEVEL SECURITY;
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE games ENABLE ROW LEVEL SECURITY;
ALTER TABLE game_students ENABLE ROW LEVEL SECURITY;
ALTER TABLE tiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE truces ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_log ENABLE ROW LEVEL SECURITY;

-- Users policies
CREATE POLICY "Users can view own profile" ON users FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can insert own profile" ON users FOR INSERT WITH CHECK (auth.uid() = id);

-- Classes policies
CREATE POLICY "Users can view own classes" ON classes FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own classes" ON classes FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own classes" ON classes FOR UPDATE USING (auth.uid() = user_id);

-- Students policies
CREATE POLICY "Users can view students in own classes" ON students FOR SELECT 
    USING (class_id IN (SELECT id FROM classes WHERE user_id = auth.uid()));
CREATE POLICY "Users can insert students in own classes" ON students FOR INSERT 
    WITH CHECK (class_id IN (SELECT id FROM classes WHERE user_id = auth.uid()));
CREATE POLICY "Users can update students in own classes" ON students FOR UPDATE 
    USING (class_id IN (SELECT id FROM classes WHERE user_id = auth.uid()));

-- Games policies
CREATE POLICY "Users can view games in own classes" ON games FOR SELECT 
    USING (class_id IN (SELECT id FROM classes WHERE user_id = auth.uid()));
CREATE POLICY "Users can insert games in own classes" ON games FOR INSERT 
    WITH CHECK (class_id IN (SELECT id FROM classes WHERE user_id = auth.uid()));
CREATE POLICY "Users can update games in own classes" ON games FOR UPDATE 
    USING (class_id IN (SELECT id FROM classes WHERE user_id = auth.uid()));

-- Game students policies
CREATE POLICY "Users can view game students in own games" ON game_students FOR SELECT 
    USING (game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid())));
CREATE POLICY "Users can insert game students in own games" ON game_students FOR INSERT 
    WITH CHECK (game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid())));
CREATE POLICY "Users can update game students in own games" ON game_students FOR UPDATE 
    USING (game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid())));

-- Tiles policies
CREATE POLICY "Users can view tiles in own games" ON tiles FOR SELECT 
    USING (game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid())));
CREATE POLICY "Users can insert tiles in own games" ON tiles FOR INSERT 
    WITH CHECK (game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid())));
CREATE POLICY "Users can update tiles in own games" ON tiles FOR UPDATE 
    USING (game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid())));

-- Transactions policies
CREATE POLICY "Users can view transactions in own games" ON transactions FOR SELECT 
    USING (game_student_id IN (SELECT id FROM game_students WHERE game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid()))));
CREATE POLICY "Users can insert transactions in own games" ON transactions FOR INSERT 
    WITH CHECK (game_student_id IN (SELECT id FROM game_students WHERE game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid()))));

-- Truces policies
CREATE POLICY "Users can view truces in own games" ON truces FOR SELECT 
    USING (game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid())));
CREATE POLICY "Users can insert truces in own games" ON truces FOR INSERT 
    WITH CHECK (game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid())));
CREATE POLICY "Users can update truces in own games" ON truces FOR UPDATE 
    USING (game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid())));

-- Audit log policies
CREATE POLICY "Users can view audit logs in own games" ON audit_log FOR SELECT 
    USING (game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid())));
CREATE POLICY "Users can insert audit logs in own games" ON audit_log FOR INSERT 
    WITH CHECK (game_id IN (SELECT id FROM games WHERE class_id IN (SELECT id FROM classes WHERE user_id = auth.uid())));</textarea>
            </div>
        </div>

        <div class="section">
            <h3>Step 3: Create RPC Functions</h3>
            <div class="function">
                <h4>ensure_user Function</h4>
                <textarea readonly style="width: 100%; height: 150px; background: #2a2a2a; color: #fff; border: 1px solid #444; padding: 10px; font-family: monospace;">CREATE OR REPLACE FUNCTION ensure_user()
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    INSERT INTO users (id, email)
    VALUES (auth.uid(), auth.jwt() ->> 'email')
    ON CONFLICT (id) DO NOTHING;
END;
$$;

GRANT EXECUTE ON FUNCTION ensure_user() TO anon, authenticated;</textarea>
            </div>

            <div class="function">
                <h4>create_game_from_roster Function</h4>
                <textarea readonly style="width: 100%; height: 300px; background: #2a2a2a; color: #fff; border: 1px solid #444; padding: 10px; font-family: monospace;">CREATE OR REPLACE FUNCTION create_game_from_roster(
    p_class_name TEXT,
    p_game_name TEXT,
    p_student_names TEXT,
    p_board_w INTEGER DEFAULT NULL,
    p_board_h INTEGER DEFAULT NULL,
    p_start_points INTEGER DEFAULT 5
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_user_id UUID;
    v_class_id UUID;
    v_game_id UUID;
    v_student_names TEXT[];
    v_student_name TEXT;
    v_student_id UUID;
    v_game_student_id UUID;
    v_board_w INTEGER;
    v_board_h INTEGER;
    v_x INTEGER;
    v_y INTEGER;
    v_tile_id UUID;
BEGIN
    -- Get current user
    v_user_id := auth.uid();
    IF v_user_id IS NULL THEN
        RAISE EXCEPTION 'User not authenticated';
    END IF;

    -- Ensure user exists
    INSERT INTO users (id, email)
    VALUES (v_user_id, auth.jwt() ->> 'email')
    ON CONFLICT (id) DO NOTHING;

    -- Create or get class
    INSERT INTO classes (user_id, name)
    VALUES (v_user_id, p_class_name)
    ON CONFLICT (user_id, name) DO NOTHING
    RETURNING id INTO v_class_id;
    
    IF v_class_id IS NULL THEN
        SELECT id INTO v_class_id FROM classes WHERE user_id = v_user_id AND name = p_class_name;
    END IF;

    -- Parse student names (split by newlines, trim, filter empty)
    v_student_names := ARRAY(
        SELECT TRIM(name) 
        FROM unnest(string_to_array(p_student_names, E'\n')) AS name 
        WHERE TRIM(name) != ''
    );

    -- Calculate board size if not provided
    v_board_w := COALESCE(p_board_w, GREATEST(8, CEIL(SQRT(array_length(v_student_names, 1) * 2))));
    v_board_h := COALESCE(p_board_h, GREATEST(8, CEIL(SQRT(array_length(v_student_names, 1) * 2))));

    -- Create game
    INSERT INTO games (class_id, name, board_w, board_h)
    VALUES (v_class_id, p_game_name, v_board_w, v_board_h)
    RETURNING id INTO v_game_id;

    -- Create students and game_students
    FOREACH v_student_name IN ARRAY v_student_names
    LOOP
        -- Create student
        INSERT INTO students (class_id, display_name)
        VALUES (v_class_id, v_student_name)
        RETURNING id INTO v_student_id;

        -- Create game_student
        INSERT INTO game_students (game_id, student_id, start_points, tiles_owned)
        VALUES (v_game_id, v_student_id, p_start_points, 0)
        RETURNING id INTO v_game_student_id;
    END LOOP;

    -- Create tiles grid
    FOR v_y IN 0..(v_board_h - 1)
    LOOP
        FOR v_x IN 0..(v_board_w - 1)
        LOOP
            INSERT INTO tiles (game_id, x, y, owner_game_student_id, castle_level)
            VALUES (v_game_id, v_x, v_y, NULL, 0)
            RETURNING id INTO v_tile_id;
        END LOOP;
    END LOOP;

    -- Log the creation
    INSERT INTO audit_log (game_id, actor, action, meta)
    VALUES (v_game_id, 'system', 'game_created', jsonb_build_object(
        'class_name', p_class_name,
        'game_name', p_game_name,
        'student_count', array_length(v_student_names, 1),
        'board_size', jsonb_build_object('w', v_board_w, 'h', v_board_h),
        'start_points', p_start_points
    ));

    -- Return game info
    RETURN jsonb_build_object(
        'game_id', v_game_id,
        'class_id', v_class_id,
        'board_w', v_board_w,
        'board_h', v_board_h,
        'student_count', array_length(v_student_names, 1)
    );
END;
$$;

GRANT EXECUTE ON FUNCTION create_game_from_roster(TEXT, TEXT, TEXT, INTEGER, INTEGER, INTEGER) TO anon, authenticated;</textarea>
            </div>

            <div class="function">
                <h4>Other Essential Functions</h4>
                <textarea readonly style="width: 100%; height: 200px; background: #2a2a2a; color: #fff; border: 1px solid #444; padding: 10px; font-family: monospace;">-- resolve_battle function (simplified)
CREATE OR REPLACE FUNCTION resolve_battle(
    p_game_id UUID,
    p_tile_id UUID,
    p_attacker UUID,
    p_defender UUID,
    p_att_mercs INTEGER,
    p_weapon_level INTEGER,
    p_def_mercs INTEGER
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_odds NUMERIC;
    v_roll NUMERIC;
    v_result TEXT;
BEGIN
    -- Simple battle logic
    v_odds := 0.5 + (p_att_mercs * 0.05) + (p_weapon_level * 0.1) - (p_def_mercs * 0.05);
    v_odds := GREATEST(0.1, LEAST(0.9, v_odds));
    v_roll := random();
    v_result := CASE WHEN v_roll < v_odds THEN 'attacker_wins' ELSE 'defender_wins' END;

    -- Update tile if attacker wins
    IF v_result = 'attacker_wins' THEN
        UPDATE tiles 
        SET owner_game_student_id = p_attacker, castle_level = 0
        WHERE id = p_tile_id;
    END IF;

    RETURN jsonb_build_object('odds', v_odds, 'roll', v_roll, 'result', v_result);
END;
$$;

GRANT EXECUTE ON FUNCTION resolve_battle(UUID, UUID, UUID, UUID, INTEGER, INTEGER, INTEGER) TO anon, authenticated;</textarea>
            </div>
        </div>

        <div class="section">
            <h3>Instructions</h3>
            <ol>
                <li>Go to your Supabase dashboard: <a href="https://supabase.com/dashboard" target="_blank">https://supabase.com/dashboard</a></li>
                <li>Navigate to your project: <strong>dmbbsrcwqpmdxqtzvtqj</strong></li>
                <li>Go to the SQL Editor</li>
                <li>Copy and paste each SQL block above in order (Tables → RLS → Functions)</li>
                <li>Execute each block</li>
                <li>Test the functions using the war-admin.html page</li>
            </ol>
        </div>
    </div>
</body>
</html>
