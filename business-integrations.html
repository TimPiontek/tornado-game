<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tornado Business ‚Äì Integrations</title>
  <style>
    :root { --bg:#0f172a; --panel:#0b1220; --border:#1f2a44; --text:#e5e7eb; --muted:#9aa3b2; --accent:#22d3ee; }
    * { box-sizing: border-box }
    body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position:sticky; top:0; z-index:2; background:#0d1628cc; border-bottom:1px solid var(--border); }
    .bar { display:flex; gap:8px; align-items:center; padding:12px 16px }
    .wrap { max-width:1100px; margin:0 auto; padding:16px }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px }
    .tile { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px; }
    .tile h3 { margin:6px 0 6px; font-size:16px }
    .tile p { margin:0 0 10px; color:var(--muted); font-size:12px; line-height:1.4 }
    .btn { padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#0b1932; color:#fff; cursor:pointer; font-size:12px }
    .status { font-size:11px; color:var(--muted) }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="lib/dataSync.js"></script>
  <script>
    const SUPABASE_URL  = "https://dmbbsrcwqpmdxqtzvtqj.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYmJzcmN3cXBtZHhxdHp2dHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NDg1OTYsImV4cCI6MjA2MjMyNDU5Nn0.E7EYSLCFXMYw5f4Wv7EXXj7-5yAT__BoYXklDB4uE2w";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const INTEGRATIONS = [
      { key: 'salesforce', name: 'Salesforce', desc: 'Connect Opportunities, Accounts, Leads', kind: 'oauth' },
      { key: 'hubspot', name: 'HubSpot', desc: 'Import Deals and Tasks', kind: 'oauth' },
      { key: 'dynamics', name: 'Microsoft Dynamics 365', desc: 'Token placeholder', kind: 'token' },
      { key: 'sheets', name: 'Google Sheets / CSV', desc: 'Upload CSV (already supported)', kind: 'csv' },
      { key: 'powerbi', name: 'Power BI / Tableau', desc: 'Export dataset + embed', kind: 'export' },
      { key: 'slack', name: 'Slack Webhook', desc: 'Announcements to Slack', kind: 'webhook' },
      { key: 'teams', name: 'Microsoft Teams Webhook', desc: 'Announcements to Teams', kind: 'webhook' }
    ];

    async function loadStatus() {
      const container = document.getElementById('tiles');
      const { data } = await supabase.from('integrations').select('*');
      const byType = Object.fromEntries((data||[]).map(r => [r.type, r]));
      container.innerHTML = INTEGRATIONS.map(intg => {
        const row = byType[intg.key];
        const status = row?.status || 'Not Connected';
        return `<div class="tile">
          <div class="status">${status}</div>
          <h3>${intg.name}</h3>
          <p>${intg.desc}</p>
          ${intg.kind==='webhook' ? `<input id="inp_${intg.key}" placeholder="Webhook URL" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:#081125;color:#e5e7eb;margin-bottom:8px;" />` : ''}
          <button class="btn" onclick="connect('${intg.key}','${intg.kind}')">${status==='Connected'?'Reconnect':'Connect'}</button>
          ${status==='Connected' ? `<button class="btn" onclick="disconnect('${intg.key}')" style="margin-left:8px;background:#dc2626;">Disconnect</button>` : ''}
          ${status==='Connected' && intg.kind==='webhook' ? `<button class="btn" onclick="testWebhook('${intg.key}')" style="margin-left:8px;background:#059669;">Test</button>` : ''}
          ${status==='Connected' && ['salesforce','hubspot'].includes(intg.key) ? `<button class="btn" onclick="syncIntegration('${intg.key}')" style="margin-left:8px;background:#3b82f6;">Sync</button>` : ''}
        </div>`;
      }).join('');
    }

    async function connect(key, kind) {
      let token = null; let settings = {};
      
      if (kind === 'webhook') {
        token = document.getElementById('inp_'+key)?.value || '';
        if (!token) { alert('Enter webhook URL'); return; }
        settings = { webhook_url: token };
      } else if (kind === 'oauth') {
        // For OAuth integrations, we'll simulate the connection process
        if (key === 'salesforce') {
          const clientId = prompt('Enter Salesforce Client ID:');
          const clientSecret = prompt('Enter Salesforce Client Secret:');
          if (!clientId || !clientSecret) return;
          token = btoa(`${clientId}:${clientSecret}`); // Basic auth encoding
          settings = { client_id: clientId, instance_url: 'https://yourcompany.salesforce.com' };
        } else if (key === 'hubspot') {
          const apiKey = prompt('Enter HubSpot API Key:');
          if (!apiKey) return;
          token = apiKey;
          settings = { api_key: apiKey };
        }
      } else if (kind === 'token') {
        const accessToken = prompt(`Enter ${key} Access Token:`);
        if (!accessToken) return;
        token = accessToken;
        settings = { access_token: accessToken };
      } else if (kind === 'csv') {
        // CSV upload is already supported in business.html
        token = 'csv_upload_enabled';
        settings = { upload_enabled: true };
      } else if (kind === 'export') {
        // Export functionality placeholder
        token = 'export_enabled';
        settings = { export_enabled: true };
      }
      
      try {
        await supabase.from('integrations').upsert({ 
          type: key, 
          status: 'Connected', 
          token, 
          settings,
          created_at: new Date().toISOString()
        });
        await loadStatus();
        alert(`${key} connected successfully!`);
      } catch (error) {
        console.error('Connection error:', error);
        alert(`Failed to connect ${key}: ${error.message}`);
      }
    }

    async function disconnect(key) {
      if (!confirm(`Are you sure you want to disconnect ${key}?`)) return;
      
      try {
        await supabase.from('integrations').delete().eq('type', key);
        await loadStatus();
        alert(`${key} disconnected successfully!`);
      } catch (error) {
        console.error('Disconnection error:', error);
        alert(`Failed to disconnect ${key}: ${error.message}`);
      }
    }

    async function testWebhook(key) {
      const { data } = await supabase.from('integrations').select('settings').eq('type', key).single();
      if (!data?.settings?.webhook_url) {
        alert('No webhook URL configured');
        return;
      }
      
      try {
        const response = await fetch(data.settings.webhook_url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            text: `üéâ Tornado Business Integration Test - ${key} is working!`,
            username: 'Tornado Business'
          })
        });
        
        if (response.ok) {
          alert(`${key} webhook test successful!`);
        } else {
          alert(`${key} webhook test failed: ${response.status}`);
        }
      } catch (error) {
        alert(`${key} webhook test failed: ${error.message}`);
      }
    }

    // Initialize data sync service
    let dataSyncService;
    
    async function syncIntegration(key) {
      if (!dataSyncService) {
        dataSyncService = new DataSyncService(supabase);
      }
      
      try {
        let result;
        if (key === 'salesforce') {
          const { data: integration } = await supabase.from('integrations').select('*').eq('type', 'salesforce').single();
          result = await dataSyncService.syncSalesforceData(integration);
        } else if (key === 'hubspot') {
          const { data: integration } = await supabase.from('integrations').select('*').eq('type', 'hubspot').single();
          result = await dataSyncService.syncHubSpotData(integration);
        }
        
        displaySyncResults([{ integration: key, ...result }]);
        alert(`${key} sync ${result.success ? 'completed' : 'failed'}!`);
      } catch (error) {
        console.error('Sync error:', error);
        alert(`${key} sync failed: ${error.message}`);
      }
    }

    async function syncAllData() {
      if (!dataSyncService) {
        dataSyncService = new DataSyncService(supabase);
      }
      
      const button = document.querySelector('button[onclick="syncAllData()"]');
      button.disabled = true;
      button.textContent = 'üîÑ Syncing...';
      
      try {
        const results = await dataSyncService.syncAllIntegrations();
        displaySyncResults(results);
        alert(`Sync completed! Processed ${results.length} integrations.`);
      } catch (error) {
        console.error('Sync error:', error);
        alert(`Sync failed: ${error.message}`);
      } finally {
        button.disabled = false;
        button.textContent = 'üîÑ Sync All Data';
      }
    }
    
    function displaySyncResults(results) {
      const container = document.getElementById('syncResults');
      const timestamp = new Date().toLocaleString();
      
      if (results.length === 0) {
        container.innerHTML = '<div style="color:var(--muted);">No connected integrations to sync</div>';
        return;
      }
      
      const html = results.map(result => {
        const status = result.success ? '‚úÖ' : '‚ùå';
        const records = result.records || 0;
        return `<div style="margin-bottom:8px;">
          ${status} <strong>${result.integration}</strong>: ${result.success ? `${records} records synced` : result.error}
        </div>`;
      }).join('');
      
      container.innerHTML = `
        <div style="color:var(--muted); margin-bottom:8px;">Last sync: ${timestamp}</div>
        ${html}
      `;
    }

    document.addEventListener('DOMContentLoaded', loadStatus);
  </script>
</head>
<body>
  <header>
    <div class="bar">
      <h1 style="margin:0; font-size:18px;">üîå Integrations</h1>
      <div style="flex:1"></div>
      <button class="btn" onclick="window.location.href='business-home.html'">‚Üê Manager Hub</button>
    </div>
  </header>
  <div class="wrap">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h2 style="margin:0; font-size:16px;">Connected Integrations</h2>
      <button class="btn" onclick="syncAllData()" style="background:#059669;">üîÑ Sync All Data</button>
    </div>
    <div id="tiles" class="grid"></div>
    
    <div style="margin-top:24px;">
      <h3 style="margin-bottom:12px;">Recent Sync Results</h3>
      <div id="syncResults" style="background:var(--panel); border:1px solid var(--border); border-radius:8px; padding:12px; font-size:12px;">
        <div style="color:var(--muted);">No recent syncs</div>
      </div>
    </div>
  </div>
</body>
</html>

