<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; img-src * data: blob:; connect-src *;">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Tornado War ‚Äì Employee</title>
  <script src="scenarios.js?v=20251017-4"></script>
  <style>
    :root { --bg:#0f172a; --panel:#0b1220; --border:#1f2a44; --text:#e5e7eb; --muted:#9aa3b2; --accent:#22d3ee; }
    * { box-sizing: border-box }
    html, body { height:100% }
    body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position:sticky; top:0; z-index:3; background:#0d1628cc; backdrop-filter: blur(6px); border-bottom:1px solid var(--border); }
    .bar { display:flex; gap:8px; align-items:center; padding:10px 14px; flex-wrap:wrap }
    .bar h1 { font-size:18px; margin:0 8px 0 0; }
    .pill { padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:var(--panel); color:var(--text); cursor:pointer; }
    .pill[disabled] { opacity:.6; cursor:not-allowed }
    .muted { color:var(--muted) }
    .wrap { display:grid; grid-template-columns: 400px 1fr; gap:12px; padding:12px; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px; }
    .title { font-size:14px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); margin:0 0 8px; }
    #gamesList { width: 100%; }
    #roster { display:flex; flex-direction:column; gap:6px; max-height: calc(100vh - 220px); overflow:auto; }
    .row { display:grid; grid-template-columns: 1fr auto auto auto auto auto auto auto; gap:6px; align-items:center; padding:6px 8px; border:1px solid var(--border); border-radius:10px; cursor:pointer; }
    .row.sel { outline:2px solid var(--accent) }
    .bal { font-variant-numeric: tabular-nums; }
    .chip { padding:4px 8px; border:1px solid var(--border); border-radius:8px; font-size:12px; color:var(--muted) }
    .plus { padding:4px 8px; border:1px solid var(--border); border-radius:8px; background:#12223a; cursor:pointer }
    #board { width:100%; aspect-ratio: 0.8 / 1; background:#0a1220; border:1px solid var(--border); border-radius:12px; overflow:hidden; max-height: 60vh; }
    #grid { width:100%; height:100%; display:grid; }
    .cell { border:1px solid #0d1930; display:flex; align-items:center; justify-content:center; font-size:12px; user-select:none; position:relative; }
    .castle { font-weight:bold; filter: drop-shadow(0 1px 0 #0008) }
    .section { margin: 10px 0 0 }
    input, textarea, select { width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#081125; color:var(--text) }
    textarea { min-height: 160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:6px 4px; border-bottom: 1px solid var(--border); text-align:left; font-size:14px }
    .minor { font-size:12px; color:var(--muted) }
    .ok { color:#86efac } .warn { color:#facc15 } .err { color:#f87171 }
    
    /* Employee-specific styles */
    .employee-card {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .metrics-table {
      width: 100%;
      font-size: 11px;
    }
    
    .metrics-table th,
    .metrics-table td {
      padding: 4px 6px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    
    .credits-display {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 6px;
      padding: 8px;
      text-align: center;
      font-weight: bold;
      color: #fbbf24;
    }
    
    .notification-feed {
      max-height: 200px;
      overflow-y: auto;
      font-size: 11px;
    }
    
    .notification-item {
      padding: 6px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
    }
    
    .notification-item:last-child {
      border-bottom: none;
    }
</style>
</head>
<body>

<header>
  <div class="bar">
    <h1 style="cursor: pointer;" onclick="window.location.href = '/employee-login.html'">TORNADO WAR - EMPLOYEE</h1>
    <button class="pill" id="btnTruces">Truces</button>
    <button class="pill" id="btnHelp">How to Play</button>
    <div style="flex:1"></div>
    <span id="who" class="muted">Employee Mode</span>
    <button class="pill" id="btnInbox" onclick="openInbox()">üîî <span id="inboxCount" style="background:#ef4444; color:#fff; padding:2px 6px; border-radius:10px; font-size:11px;">0</span></button>
    <button class="pill" onclick="window.location.href='employee-login.html'" style="background: #10b981; color: white;">‚Üê Back to Dashboard</button>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: Employee Dashboard -->
  <div class="panel">
    <div class="section">
      <div class="title">Employee Dashboard</div>
      <div class="employee-card">
        <h4 style="margin: 0 0 8px; color: #60a5fa;">üë§ My Performance</h4>
        <div id="employeeStats">
          <div class="credits-display">
            <div style="font-size: 14px;">Credits Earned</div>
            <div id="myCredits" style="font-size: 18px;">0</div>
          </div>
          <div style="margin-top: 8px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px;">
              <span>My Points:</span>
              <span id="myPoints" class="bal">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 12px;">
              <span>My Team:</span>
              <span id="myTeam">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="title">My Metrics</div>
      <div class="employee-card">
        <table class="metrics-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Score</th>
              <th>Weight</th>
            </tr>
          </thead>
          <tbody id="myMetricsTable">
            <tr>
              <td colspan="3" style="text-align: center; color: var(--muted); font-size: 11px;">No metrics assigned yet</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <div class="title">Quick Actions</div>
      <div class="employee-card">
        <button class="pill" onclick="playTornadoQuiz()" style="background: #8b5cf6; color: white; font-size: 12px; width: 100%; margin-bottom: 8px;">üéØ Play Tornado Quiz</button>
        <button class="pill" onclick="viewAssignments()" style="background: #10b981; color: white; font-size: 12px; width: 100%; margin-bottom: 8px;">üìã View Assignments</button>
        <button class="pill" onclick="viewLeaderboard()" style="background: #f59e0b; color: white; font-size: 12px; width: 100%;">üèÜ Team Leaderboard</button>
      </div>
    </div>

    <div class="section">
      <div class="title">Notifications</div>
      <div class="employee-card">
        <div id="notificationFeed" class="notification-feed">
          <div class="notification-item" style="color: var(--muted); text-align: center;">
            No notifications yet
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CENTER: Game Board -->
  <div class="panel">
    <div id="gameThemeTitle" style="
      background: linear-gradient(135deg, #8b5cf6, #3b82f6);
      color: white;
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      margin: 0.5rem;
      transition: all 0.2s ease;
    ">
      üéÆ Business Game
    </div>
    <div id="teamScoreboards" style="margin-bottom: 1rem;"></div>
    <div id="board">
      <div id="grid"></div>
    </div>
    <div class="minor" id="tip">Tip: click a team name, then click a tile.</div>
  </div>
</div>

<!-- Assignment Modal -->
<div id="assignmentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h3 style="margin: 0; color: var(--text);">üìã My Assignments</h3>
      <button onclick="closeAssignmentModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);">&times;</button>
    </div>
    <div id="assignmentsList">
      <div style="text-align: center; color: var(--muted); padding: 2rem;">
        No assignments yet
      </div>
    </div>
  </div>
</div>

<!-- Quiz Modal -->
<div id="quizModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h3 style="margin: 0; color: var(--text);">üéØ Tornado Quiz</h3>
      <button onclick="closeQuizModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);">&times;</button>
    </div>
    <div id="quizContent">
      <div style="text-align: center; color: var(--muted); padding: 2rem;">
        Loading quiz...
      </div>
    </div>
  </div>
</div>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<script>
  // Employee-specific state
  let employeeState = {
    currentEmployee: null,
    gameData: null,
    assignments: [],
    notifications: [],
    credits: 0,
    points: 0,
    team: null,
    metrics: [],
    board: { w: 0, h: 0, tiles: [] },
    employees: []
  };

  // === Supabase ===
  const SUPABASE_URL  = "https://dmbbsrcwqpmdxqtzvtqj.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYmJzcmN3cXBtZHhxdHp2dHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NDg1OTYsImV4cCI6MjA2MjMyNDU5Nn0.E7EYSLCFXMYw5f4Wv7EXXj7-5yAT__BoYXklDB4uE2w";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  async function saveActivity(action, detail) {
    try {
      if (!employeeState.gameData) return;
      await supabase.from('activity_feed').insert({
        game_id: employeeState.gameData.id || employeeState.gameData.code,
        actor_id: employeeState.currentEmployee?.id,
        action,
        detail
      });
    } catch (e) { console.warn('[emp] activity save failed', e); }
  }

  // Initialize employee page
  function initializeEmployeePage() {
    // Load employee data from localStorage or URL params
    const urlParams = new URLSearchParams(window.location.search);
    const employeeId = urlParams.get('employeeId') || localStorage.getItem('currentEmployeeId');
    const managerCode = urlParams.get('code') || localStorage.getItem('managerCode');
    
    if (employeeId) {
      loadEmployeeData(employeeId);
    } else {
      // Show join code input
      showJoinCodeInput();
    }
    
    // Load game from cloud by manager code
    if (managerCode) {
      fetchCloudGame(managerCode).then(() => {
        renderBoardFromState();
      });
    } else {
      // Initialize fallback board
      initializeGameBoard();
    }
    
    // Load notifications
    loadNotifications();
    // Start inbox polling
    setInterval(pollNotifications, 5000);
  }

  function showJoinCodeInput() {
    const joinCode = prompt('Enter your Manager Code to join the game:');
    if (joinCode) {
      // In production, this would validate with the server
      localStorage.setItem('currentEmployeeId', 'emp_' + Date.now());
      localStorage.setItem('managerCode', joinCode);
      location.reload();
    }
  }

  function loadEmployeeData(employeeId) {
    // Mock employee data - in production, this would come from the server
    employeeState.currentEmployee = {
      id: employeeId,
      name: 'Employee ' + employeeId.slice(-4),
      team: 'Alpha',
      credits: 15,
      points: 42
    };
    
    employeeState.credits = employeeState.currentEmployee.credits;
    employeeState.points = employeeState.currentEmployee.points;
    employeeState.team = employeeState.currentEmployee.team;
    
    updateEmployeeDashboard();
  }
  async function fetchCloudGame(code) {
    try {
      // Load game by manager code
      const { data: games } = await supabase.from('games').select('*').eq('code', code).limit(1);
      if (games && games.length) {
        employeeState.gameData = games[0];
        // Load employees
        const { data: emps } = await supabase.from('employees').select('*').eq('game_id', employeeState.gameData.id);
        employeeState.employees = emps || [];
        const me = employeeState.employees.find(e => e.id === employeeState.currentEmployee.id);
        if (me) {
          employeeState.points = me.points||0; employeeState.credits = me.credits||0; employeeState.team = me.team||null;
        }
        // Load tiles
        const { data: tiles } = await supabase.from('tiles').select('*').eq('game_id', employeeState.gameData.id);
        const w = employeeState.gameData.board_w || 10; const h = employeeState.gameData.board_h || 10;
        employeeState.board = { w, h, tiles: (tiles||[]).map(t => ({ id: t.tile_id, x: t.x, y: t.y, owner_game_student_id: t.owner_employee_id, isHeadquarters: !!t.is_headquarters, cost: t.cost||20 })) };
        // Realtime subscriptions
        subscribeTiles();
        subscribeNotifications();
      }
    } catch (e) { console.warn('[emp] load game failed', e); }
  }

  function renderBoardFromState() {
    const grid = document.getElementById('grid');
    if (!grid || !employeeState.board?.tiles) return;
    grid.style.gridTemplateColumns = `repeat(${employeeState.board.w}, 1fr)`;
    grid.style.gridTemplateRows = `repeat(${employeeState.board.h}, 1fr)`;
    grid.innerHTML = employeeState.board.tiles.map(tile => {
      const owner = employeeState.employees.find(e => e.id === tile.owner_game_student_id);
      const isHQ = tile.isHeadquarters;
      const bg = tile.owner_game_student_id ? (isHQ ? '#1e40af' : '#1e3a8a') : '#1e293b';
      const icon = tile.owner_game_student_id ? 'üè¢' : '';
      const name = owner ? (owner.name.split(' ')[0]) : '';
      return `<div class="cell" onclick="handleTileClick('${tile.id}')" style="background:${bg};position:relative;cursor:pointer;${isHQ?'border:2px solid #fbbf24;':''}">
        <div style="font-size:10px;text-align:center;">${icon}<div style="font-size:8px;color:var(--muted);">${!tile.owner_game_student_id?`üí∞${tile.cost||20}`:''}</div>${name?`<div style=\"font-size:7px;color:var(--accent)\">${name}</div>`:''}</div>
      </div>`;
    }).join('');
  }

  function subscribeTiles() {
    try {
      if (!employeeState.gameData) return;
      const channel = supabase.channel('emp_tiles_'+employeeState.gameData.id);
      channel.on('postgres_changes', { event: '*', schema: 'public', table: 'tiles', filter: `game_id=eq.${employeeState.gameData.id}` }, payload => {
        const r = payload.new || payload.old;
        if (!r) return;
        const idx = employeeState.board.tiles.findIndex(t => t.id === r.tile_id);
        if (idx >= 0) {
          employeeState.board.tiles[idx].owner_game_student_id = r.owner_employee_id;
          employeeState.board.tiles[idx].isHeadquarters = !!r.is_headquarters;
        } else {
          employeeState.board.tiles.push({ id: r.tile_id, x: r.x, y: r.y, owner_game_student_id: r.owner_employee_id, isHeadquarters: !!r.is_headquarters, cost: r.cost||20 });
        }
        renderBoardFromState();
      }).subscribe();
    } catch (e) { console.warn('[emp] subscribe tiles failed', e); }
  }

  function subscribeNotifications() {
    try {
      if (!employeeState.gameData) return;
      const channel = supabase.channel('emp_notifs_'+employeeState.currentEmployee.id);
      channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `game_id=eq.${employeeState.gameData.id}` }, payload => {
        const n = payload.new;
        if (!n || n.to_employee_id !== employeeState.currentEmployee.id) return;
        employeeState.notifications.unshift({ id: n.id, type: n.kind, message: formatNotification(n), timestamp: n.created_at, read: false });
        updateNotificationFeed();
      }).subscribe();
      // also show recognitions
      const ch2 = supabase.channel('emp_recog_'+employeeState.gameData.id);
      ch2.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'recognitions', filter: `game_id=eq.${employeeState.gameData.id}` }, payload => {
        employeeState.recognitions = employeeState.recognitions || [];
        employeeState.recognitions.unshift(payload.new);
        updateNotificationFeed();
      }).subscribe();
    } catch (e) { console.warn('[emp] subscribe notifications failed', e); }
  }

  window.handleTileClick = async function(tileId) {
    const tile = employeeState.board.tiles.find(t => t.id === tileId);
    if (!tile) return;
    const me = employeeState.currentEmployee;
    const myRow = employeeState.employees.find(e => e.id === me.id) || { id: me.id, name: me.name };

    // Claim empty tile (deduct points)
    if (!tile.owner_game_student_id) {
      const cost = tile.cost || 20;
      if ((employeeState.points||0) < cost) { alert(`Insufficient points (${cost} needed)`); return; }
      tile.owner_game_student_id = me.id;
      employeeState.points -= cost;
      // Persist
      await supabase.from('tiles').upsert({ game_id: employeeState.gameData.id, tile_id: tile.id, x: tile.x, y: tile.y, owner_employee_id: me.id, is_headquarters: tile.isHeadquarters||false, cost });
      await supabase.from('employees').upsert({ id: myRow.id, game_id: employeeState.gameData.id, name: myRow.name, team: myRow.team||employeeState.team, points: employeeState.points, credits: employeeState.credits, balance: employeeState.points });
      await saveActivity('purchase_tile', { tileId });
      updateEmployeeDashboard();
      renderBoardFromState();
      return;
    }

    // Attack enemy tile
    if (tile.owner_game_student_id && tile.owner_game_student_id !== me.id) {
      const defender = employeeState.employees.find(e => e.id === tile.owner_game_student_id);
      const attackCost = (tile.cost||20) * 2;
      if ((employeeState.points||0) < attackCost) { alert(`Need ${attackCost} points to attack`); return; }
      if (!confirm(`Attack ${defender?.name || 'opponent'}'s tile for ${attackCost} points?`)) return;
      // Resolve locally (optimistic) and notify
      const success = Math.random() < 0.7;
      employeeState.points -= attackCost;
      if (success) tile.owner_game_student_id = me.id;
      await supabase.from('notifications').insert({
        game_id: employeeState.gameData.id,
        to_employee_id: defender?.id,
        from_employee_id: me.id,
        kind: 'attack',
        payload: { tile_id: tile.id, attack_cost: attackCost, success }
      });
      await supabase.from('tiles').upsert({ game_id: employeeState.gameData.id, tile_id: tile.id, x: tile.x, y: tile.y, owner_employee_id: tile.owner_game_student_id, is_headquarters: tile.isHeadquarters||false, cost: tile.cost||20 });
      await supabase.from('employees').upsert({ id: myRow.id, game_id: employeeState.gameData.id, name: myRow.name, team: myRow.team||employeeState.team, points: employeeState.points, credits: employeeState.credits, balance: employeeState.points });
      await saveActivity(success?'attack_success':'attack_failed', { tileId: tile.id, defender: defender?.id, attackCost });
      updateEmployeeDashboard();
      renderBoardFromState();
      alert(success? 'üéâ Attack successful!' : 'üí• Attack failed.');
    }
  }

  function updateEmployeeDashboard() {
    // Update credits display
    const creditsEl = document.getElementById('myCredits');
    if (creditsEl) {
      creditsEl.textContent = employeeState.credits;
    }
    
    // Update points display
    const pointsEl = document.getElementById('myPoints');
    if (pointsEl) {
      pointsEl.textContent = employeeState.points;
    }
    
    // Update team display
    const teamEl = document.getElementById('myTeam');
    if (teamEl) {
      teamEl.textContent = employeeState.team || '-';
    }
    
    // Update metrics table
    updateMetricsTable();
  }

  function updateMetricsTable() {
    const tableBody = document.getElementById('myMetricsTable');
    if (!tableBody) return;
    
    if (employeeState.metrics.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="3" style="text-align: center; color: var(--muted); font-size: 11px;">No metrics assigned yet</td>
        </tr>
      `;
      return;
    }
    
    tableBody.innerHTML = employeeState.metrics.map(metric => `
      <tr>
        <td>${metric.name}</td>
        <td class="bal">${metric.score || 0}</td>
        <td>${metric.weight}</td>
      </tr>
    `).join('');
  }

  function loadNotifications() {
    updateNotificationFeed();
  }

  async function pollNotifications() {
    try {
      if (!employeeState.gameData || !employeeState.currentEmployee) return;
      const { data: rows } = await supabase
        .from('notifications')
        .select('*')
        .eq('game_id', employeeState.gameData.id)
        .eq('to_employee_id', employeeState.currentEmployee.id)
        .order('created_at', { ascending: false })
        .limit(20);
      if (rows) {
        employeeState.notifications = rows.map(n => ({
          id: n.id,
          type: n.kind,
          message: formatNotification(n),
          timestamp: n.created_at,
          read: !!n.read_at
        }));
        updateNotificationFeed();
      }
    } catch (e) { console.warn('[emp] poll notifications failed', e); }
  }

  function formatNotification(n) {
    if (n.kind === 'attack') {
      const success = n.payload?.success ? 'won' : 'lost';
      return `Attack on your territory ${success}. Tile: ${n.payload?.tile_id}`;
    }
    return n.kind || 'notification';
  }

  function updateNotificationFeed() {
    const feedEl = document.getElementById('notificationFeed');
    if (!feedEl) return;
    
    if (employeeState.notifications.length === 0 && !(employeeState.recognitions && employeeState.recognitions.length)) {
      feedEl.innerHTML = `
        <div class="notification-item" style="color: var(--muted); text-align: center;">
          No notifications yet
        </div>
      `;
      updateInboxCount();
      return;
    }
    
    const recogHtml = (employeeState.recognitions||[]).slice(0,3).map(r => `<div class=\"notification-item\" style=\"font-size:12px;background:rgba(34,197,94,0.06)\">üéâ ${r.text}</div>`).join('');
    
    feedEl.innerHTML = recogHtml + employeeState.notifications.map(notification => `
      <div class="notification-item" onclick="markNotificationRead('${notification.id}')" style="cursor:pointer; ${notification.read?'' :'background: rgba(59,130,246,0.06);'}">
        <div style="font-size: 10px; color: var(--muted); margin-bottom: 2px;">
          ${new Date(notification.timestamp).toLocaleString()}
        </div>
        <div style="color: var(--text);">
          ${notification.message}
        </div>
      </div>
    `).join('');
    updateInboxCount();
  }

  function updateInboxCount() {
    const unread = employeeState.notifications.filter(n => !n.read).length;
    const badge = document.getElementById('inboxCount');
    if (badge) badge.textContent = String(unread);
  }

  function openInbox() {
    // Simple inline view: scroll to notifications panel
    document.getElementById('notificationFeed')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  async function markNotificationRead(id) {
    try {
      const idx = employeeState.notifications.findIndex(n => String(n.id) === String(id));
      if (idx >= 0) {
        employeeState.notifications[idx].read = true;
        updateNotificationFeed();
      }
      if (employeeState.gameData) {
        await supabase.from('notifications').update({ read_at: new Date().toISOString() }).eq('id', id);
      }
    } catch (e) { console.warn('[emp] mark read failed', e); }
  }

  function initializeGameBoard() {
    // Initialize the game board (reuse existing logic)
    // This would connect to the same game state as the manager
    const grid = document.getElementById('grid');
    if (grid) {
      // Fallback small board
      const w = 8, h = 8;
      employeeState.board = { w, h, tiles: [] };
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          employeeState.board.tiles.push({ id: `tile_${x}_${y}`, x, y, owner: null, cost: 20 });
        }
      }
      renderBoardFromState();
    }
  }

  // Employee Actions
  function playTornadoQuiz() {
    // Open quiz modal
    const modal = document.getElementById('quizModal');
    if (modal) {
      modal.style.display = 'flex';
      
      // Load quiz content
      const quizContent = document.getElementById('quizContent');
      quizContent.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <h4 style="color: var(--text); margin-bottom: 1rem;">üéØ Performance Quiz</h4>
          <p style="color: var(--muted); margin-bottom: 1rem;">Complete this quiz to earn credits and points!</p>
          <button onclick="startQuiz()" style="background: #8b5cf6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 14px;">
            Start Quiz
          </button>
        </div>
      `;
    }
  }

  function startQuiz() {
    // Mock quiz completion
    setTimeout(() => {
      const creditsEarned = Math.floor(Math.random() * 10) + 5;
      const pointsEarned = Math.floor(Math.random() * 20) + 10;
      
      employeeState.credits += creditsEarned;
      employeeState.points += pointsEarned;
      
      updateEmployeeDashboard();
      
      // Add notification
      employeeState.notifications.unshift({
        id: Date.now(),
        type: 'award',
        message: `You earned ${creditsEarned} credits and ${pointsEarned} points for completing the quiz!`,
        timestamp: new Date().toISOString(),
        read: false
      });
      
      updateNotificationFeed();
      
      closeQuizModal();
      
      alert(`Quiz completed! You earned ${creditsEarned} credits and ${pointsEarned} points.`);
    }, 1000);
  }

  function closeQuizModal() {
    const modal = document.getElementById('quizModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  function viewAssignments() {
    // Open assignments modal
    const modal = document.getElementById('assignmentModal');
    if (modal) {
      modal.style.display = 'flex';
      
      // Load assignments from cloud
      loadEmployeeAssignments();
    }
  }

  async function loadEmployeeAssignments() {
    try {
      const list = document.getElementById('assignmentsList');
      if (!employeeState.gameData || !employeeState.currentEmployee) {
        list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:2rem">No game joined</div>';
        return;
      }
      const gameId = employeeState.gameData.id;
      // Audience: all or team-specific
      const { data: rows } = await supabase
        .from('assignments')
        .select('*')
        .eq('game_id', gameId)
        .order('created_at', { ascending: false })
        .limit(50);
      // Quests
      const { data: quests } = await supabase
        .from('quest_assignments')
        .select('*, quests!inner(title, points)')
        .eq('game_id', gameId)
        .eq('employee_id', employeeState.currentEmployee.id)
        .order('sent_at', { ascending: false })
        .limit(50);
      const myTeam = employeeState.team;
      const filtered = (rows||[]).filter(a => a.audience === 'all' || a.audience === `team:${myTeam}`);
      const questCards = (quests||[]).map(q => `
        <div style="border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px;background:rgba(34,197,94,0.06)">
          <div style="font-weight:600">${q.quests.title} (Quest)</div>
          <div style="font-size:12px;color:var(--muted);margin:4px 0">Worth ${q.quests.points||0} pts</div>
          <div style="margin-top:6px;display:flex;gap:8px;">
            <button onclick="completeQuest('${q.id}','${q.quests.points||0}')" class="pill" style="background:#10b981;color:#fff">Complete</button>
          </div>
        </div>
      `).join('');
      if (filtered.length === 0 && (!quests || quests.length === 0)) {
        list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:2rem">No assignments or quests yet</div>';
        return;
      }
      list.innerHTML = questCards + filtered.map(a => `
        <div style="border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px;">
          <div style="font-weight:600">${a.title}</div>
          <div style="font-size:12px;color:var(--muted);margin:4px 0">${a.body||''}</div>
          ${a.due_at ? `<div style=\"font-size:11px;color:var(--muted)\">Due: ${new Date(a.due_at).toLocaleDateString()}</div>` : ''}
          <div style="margin-top:6px;display:flex;gap:8px;">
            <button onclick="markAssignmentComplete('${a.id}')" class="pill" style="background:#10b981;color:#fff">Mark Complete</button>
          </div>
        </div>
      `).join('');
    } catch (e) {
      console.warn('[emp] load assignments failed', e);
    }
  }

  async function completeQuest(assignId, points) {
    try {
      await supabase.from('quest_assignments').update({ status:'completed', completed_at: new Date().toISOString() }).eq('id', assignId);
      // award points
      employeeState.points = (employeeState.points||0) + Number(points||0);
      await supabase.from('employees').update({ points: employeeState.points, balance: employeeState.points }).eq('id', employeeState.currentEmployee.id).eq('game_id', employeeState.gameData.id);
      updateEmployeeDashboard();
      loadEmployeeAssignments();
      alert(`‚úÖ Quest completed! +${points} pts`);
    } catch(e) { console.warn('[emp] complete quest failed', e); }
  }

  async function markAssignmentComplete(id) {
    try {
      await supabase.from('assignment_submissions').insert({
        assignment_id: id,
        game_id: employeeState.gameData.id,
        employee_id: employeeState.currentEmployee.id,
        status: 'completed'
      });
      alert('‚úÖ Marked complete');
      loadEmployeeAssignments();
    } catch (e) { console.warn('[emp] submit assignment failed', e); }
  }

  function closeAssignmentModal() {
    const modal = document.getElementById('assignmentModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  function viewLeaderboard() {
    alert('Team Leaderboard: Coming soon! This will show your team\'s performance rankings.');
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', initializeEmployeePage);
</script>
</body>
</html>
