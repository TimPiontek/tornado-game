<!doctype html>
<html>image.png
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tornado Business ‚Äì Roster Management</title>
  <style>
    :root { --bg:#0f172a; --panel:#0b1220; --border:#1f2a44; --text:#e5e7eb; --muted:#9aa3b2; --accent:#22d3ee; }
    * { box-sizing: border-box }
    body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position:sticky; top:0; z-index:2; background:#0d1628cc; border-bottom:1px solid var(--border); }
    .bar { display:flex; gap:8px; align-items:center; padding:12px 16px }
    .wrap { max-width:1200px; margin:0 auto; padding:16px }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:16px }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px }
    .btn { padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#0b1932; color:#fff; cursor:pointer; font-size:12px }
    .btn-primary { background:#3b82f6; }
    .btn-success { background:#059669; }
    .btn-danger { background:#dc2626; }
    input, textarea, select { width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#081125; color:var(--text); margin-bottom:8px }
    .roster-card { border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:8px; cursor:pointer; }
    .roster-card.active { border-color:#3b82f6; background:#1e3a8a20; }
    .roster-card:hover { border-color:#60a5fa; }
    .employee-list { max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; padding:8px; background:#081125; }
    .employee-item { display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px solid var(--border); }
    .employee-item:last-child { border-bottom:none; }
    .team-selector { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .team-option { padding:4px 8px; border:1px solid var(--border); border-radius:6px; background:var(--panel); color:var(--text); cursor:pointer; font-size:11px; }
    .team-option.active { background:#3b82f6; color:#fff; }
  </style>
</head>
<body>

<header>
  <div class="bar">
    <h1 style="cursor: pointer;" onclick="window.location.href = '/business-home.html'">üè¢ Tornado Business ‚Äì Roster Management</h1>
    <div style="flex:1"></div>
    <button class="btn" onclick="window.location.href = '/business-home.html'">‚Üê Back to Manager Hub</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- Existing Rosters -->
    <div class="card">
      <h3>üìã Existing Rosters</h3>
      <div id="rostersList">
        <!-- Rosters will be populated here -->
      </div>
    </div>

    <!-- Create New Roster -->
    <div class="card">
      <h3>‚ûï Create New Roster</h3>
      <input type="text" id="newRosterName" placeholder="Roster name..." />
      
      <div class="team-selector">
        <span style="font-size:12px; color:var(--muted);">Team Mode:</span>
        <div class="team-option active" data-mode="individual" onclick="setTeamMode('individual')">Individual</div>
        <div class="team-option" data-mode="teams" onclick="setTeamMode('teams')">Teams</div>
      </div>
      
      <div id="teamSetup" style="display:none;">
        <label style="font-size:12px; color:var(--muted);">Number of Teams:</label>
        <select id="teamCount">
          <option value="2">2 Teams</option>
          <option value="3">3 Teams</option>
          <option value="4">4 Teams</option>
        </select>
      </div>
      
      <button class="btn btn-primary" onclick="createNewRoster()">Create Roster</button>
    </div>

    <!-- Add Participants -->
    <div class="card">
      <h3>üë• Add Participants</h3>
      <input type="text" id="newParticipantName" placeholder="Participant name..." />
      <button class="btn btn-success" onclick="addParticipant()">Add Participant</button>
      
      <textarea id="bulkParticipants" rows="3" placeholder="Bulk add participants (one per line)"></textarea>
      <button class="btn btn-secondary" onclick="bulkAddParticipants()">Add All Participants</button>
    </div>

    <!-- Selected Roster Details -->
    <div class="card">
      <h3>üìä Selected Roster</h3>
      <div id="selectedRosterDetails">
        <p style="color:var(--muted);">Select a roster to view details</p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="/lib/supabaseClient.js"></script>

<script>
  const STORAGE_KEY = 'tornadoRosters';
  const DELETED_ROSTERS_KEY = 'tornadoDeletedRosters';
  let businessRosters = [];
  let currentRoster = null;
  let teamMode = 'individual';
  const supabaseClient = typeof window !== 'undefined' && window.getSupabaseClient ? window.getSupabaseClient() : null;

  // Get list of deleted roster IDs (to prevent re-adding from Supabase)
  function getDeletedRosterIds() {
    try {
      const deleted = localStorage.getItem(DELETED_ROSTERS_KEY);
      return deleted ? JSON.parse(deleted) : [];
    } catch (e) {
      return [];
    }
  }

  // Mark a roster as deleted
  function markRosterAsDeleted(rosterId) {
    const deleted = getDeletedRosterIds();
    if (!deleted.includes(rosterId)) {
      deleted.push(rosterId);
      localStorage.setItem(DELETED_ROSTERS_KEY, JSON.stringify(deleted));
    }
  }

  // Remove a roster from deleted list (if it gets recreated)
  function unmarkRosterAsDeleted(rosterId) {
    const deleted = getDeletedRosterIds();
    const filtered = deleted.filter(id => id !== rosterId);
    localStorage.setItem(DELETED_ROSTERS_KEY, JSON.stringify(filtered));
  }

  // Load rosters from localStorage (compatible with main war game)
  async function loadRosters() {
    try {
      // Load from localStorage using the same key as main war game
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        businessRosters = JSON.parse(saved);
        if (!Array.isArray(businessRosters)) {
          businessRosters = [];
        }
        console.log('[DEBUG] Loaded rosters from localStorage:', businessRosters.length);
      } else {
        businessRosters = [];
        console.log('[DEBUG] No rosters found in localStorage');
      }

      // Filter out deleted rosters first
      const deletedIds = getDeletedRosterIds();
      businessRosters = businessRosters.filter(r => !deletedIds.includes(r.id));

      // Merge in rosters from Supabase when available
      if (supabaseClient && supabaseClient.auth && supabaseClient.auth.getSession) {
        try {
          const { data: { session } } = await supabaseClient.auth.getSession();
          if (session) {
            const { data: cloudRosters, error } = await supabaseClient
              .from('rosters')
              .select('id, data, last_modified')
              .eq('teacher_id', session.user.id);

            if (error) {
              console.error('[DEBUG] Supabase error loading rosters:', error);
            } else if (Array.isArray(cloudRosters)) {
              const rosterMap = new Map((businessRosters || []).map(r => [r.id, r]));

              cloudRosters.forEach(record => {
                const cloudData = record?.data ? { ...record.data } : {};
                const rosterId = cloudData.id || record.id;
                if (!rosterId) return;
                
                // Skip if this roster was deleted
                if (deletedIds.includes(rosterId)) {
                  console.log('[DEBUG] Skipping deleted roster from Supabase:', rosterId);
                  return;
                }
                
                cloudData.id = rosterId;

                const existing = rosterMap.get(rosterId);
                const existingTimestamp = existing ? new Date(existing.lastModified || existing.last_modified || existing.created_at || 0).getTime() : 0;
                const cloudTimestamp = new Date(cloudData.lastModified || cloudData.last_modified || record.last_modified || 0).getTime();

                if (!existing || cloudTimestamp > existingTimestamp) {
                  rosterMap.set(rosterId, cloudData);
                }
              });

              businessRosters = Array.from(rosterMap.values());
              localStorage.setItem(STORAGE_KEY, JSON.stringify(businessRosters));
              console.log('[DEBUG] Merged rosters from Supabase. Total:', businessRosters.length);
            }
          }
        } catch (cloudError) {
          console.error('Failed to merge Supabase rosters:', cloudError);
        }
      }

      renderRosters();
    } catch (error) {
      console.error('Failed to load rosters:', error);
      businessRosters = [];
      renderRosters();
    }
  }

  // Save rosters to localStorage (compatible with main war game)
  async function saveRosters(rostersToSync = null) {
    console.log('[DEBUG] saveRosters() called');
    try {
      const previousValue = localStorage.getItem(STORAGE_KEY);
      const serialized = JSON.stringify(businessRosters);

      console.log('[DEBUG] Saving to localStorage:', businessRosters);
      localStorage.setItem(STORAGE_KEY, serialized);
      console.log('[DEBUG] Successfully saved rosters to localStorage');

      try {
        window.dispatchEvent(new StorageEvent('storage', {
          key: STORAGE_KEY,
          oldValue: previousValue,
          newValue: serialized
        }));
      } catch (eventError) {
        console.warn('Failed to dispatch storage event for roster changes:', eventError);
      }

      const rostersArray = Array.isArray(rostersToSync)
        ? rostersToSync.filter(Boolean)
        : rostersToSync
        ? [rostersToSync]
        : [];

      for (const roster of rostersArray) {
        await syncRosterToSupabase(roster);
      }
    } catch (error) {
      console.error('Failed to save rosters:', error);
    }
  }

  async function syncRosterToSupabase(roster) {
    if (!roster) {
      return false;
    }

    if (!supabaseClient || !supabaseClient.auth || !supabaseClient.auth.getSession) {
      console.log('[DEBUG] Supabase unavailable - roster saved locally only');
      return false;
    }

    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        console.log('[DEBUG] No active Supabase session - roster saved locally only');
        return false;
      }

      const payload = {
        id: roster.id,
        teacher_id: session.user.id,
        name: roster.name,
        data: roster,
        last_modified: new Date().toISOString()
      };

      const { error } = await supabaseClient.from('rosters').upsert(payload, { onConflict: 'id' });
      if (error) {
        console.error('Supabase error syncing roster:', error);
        // Graceful fallback if table missing
        if (error.code === 'PGRST205' || /Could not find the table 'public.rosters'/.test(error.message || '')) {
          console.warn("Supabase 'rosters' table missing. Roster saved locally only.");
        }
        return false;
      }

      console.log(`[DEBUG] Roster "${roster.name}" synced to Supabase`);
      return true;
    } catch (error) {
      console.error('Exception syncing roster to Supabase:', error);
      return false;
    }
  }

  async function deleteRosterFromSupabase(rosterId) {
    if (!supabaseClient || !supabaseClient.auth || !supabaseClient.auth.getSession) {
      console.log('[DEBUG] Supabase unavailable - roster deleted locally only');
      return false;
    }

    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        console.log('[DEBUG] No active Supabase session - roster deleted locally only');
        return false;
      }

      const { error } = await supabaseClient
        .from('rosters')
        .delete()
        .eq('id', rosterId)
        .eq('teacher_id', session.user.id);

      if (error) {
        console.error('Supabase error deleting roster:', error);
        if (error.code === 'PGRST205' || /Could not find the table 'public.rosters'/.test(error.message || '')) {
          console.warn("Supabase 'rosters' table missing. Roster deleted locally only.");
        }
        return false;
      }

      console.log('[DEBUG] Roster deleted from Supabase:', rosterId);
      return true;
    } catch (error) {
      console.error('Exception deleting roster from Supabase:', error);
      return false;
    }
  }

  // Generate UUID for new rosters and participants
  function generateUUID() {
    return 'roster_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  // Set team mode
  function setTeamMode(mode) {
    teamMode = mode;
    document.querySelectorAll('.team-option').forEach(el => el.classList.remove('active'));
    document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
    
    const teamSetup = document.getElementById('teamSetup');
    teamSetup.style.display = mode === 'teams' ? 'block' : 'none';
  }

  // Create new roster
  async function createNewRoster() {
    const name = document.getElementById('newRosterName').value.trim();
    if (!name) {
      alert('Please enter a roster name');
      return;
    }

    const timestamp = new Date().toISOString();
    const roster = {
      id: generateUUID(),
      name,
      roster: [], // Use 'roster' property to match main war game format
      teams: [],
      teamMode: teamMode,
      created_at: timestamp,
      createdAt: timestamp,
      lastModified: timestamp,
      last_modified: timestamp,
      gameState: {
        board: { w: 0, h: 0, tiles: [] },
        tiles: [],
        truces: []
      },
      isBusinessRoster: true
    };

    // If recreating a previously deleted roster, unmark it
    unmarkRosterAsDeleted(roster.id);
    
    businessRosters.push(roster);
    currentRoster = roster;
    await saveRosters(roster);
    
    // Clear form
    document.getElementById('newRosterName').value = '';
    
    renderRosters();
    updateSelectedRosterDetails();
    console.log('[DEBUG] Created new roster:', roster.name);
  }

  // Add participant to current roster
  async function addParticipant() {
    const name = document.getElementById('newParticipantName').value.trim();
    if (!name) {
      alert('Please enter a participant name');
      return;
    }

    if (!currentRoster) {
      alert('Please select a roster first');
      return;
    }

    const participant = {
      id: generateUUID(),
      name: name,
      points: 0,
      balance: 100,
      tilesOwned: 0,
      team: teamMode === 'teams' ? `Team ${Math.floor(Math.random() * parseInt(document.getElementById('teamCount').value)) + 1}` : null
    };

    currentRoster.roster.push(participant);
    currentRoster.lastModified = new Date().toISOString();
    currentRoster.last_modified = currentRoster.lastModified;
    await saveRosters(currentRoster);
    
    // Clear form
    document.getElementById('newParticipantName').value = '';
    
    renderRosters();
    updateSelectedRosterDetails();
    console.log('[DEBUG] Added participant:', participant.name);
  }

  // Bulk add participants
  async function bulkAddParticipants() {
    const names = document.getElementById('bulkParticipants').value.trim();
    if (!names) {
      alert('Please enter participant names');
      return;
    }

    if (!currentRoster) {
      alert('Please select a roster first');
      return;
    }

    const nameList = names.split('\n').filter(name => name.trim());
    const teamCount = parseInt(document.getElementById('teamCount').value);
    
    for (let i = 0; i < nameList.length; i++) {
      const participant = {
        id: generateUUID(),
        name: nameList[i].trim(),
        points: 0,
        balance: 100,
        tilesOwned: 0,
        team: teamMode === 'teams' ? `Team ${(i % teamCount) + 1}` : null
      };
      
      currentRoster.roster.push(participant);
    }

    currentRoster.lastModified = new Date().toISOString();
    currentRoster.last_modified = currentRoster.lastModified;
    await saveRosters(currentRoster);
    
    // Clear form
    document.getElementById('bulkParticipants').value = '';
    
    renderRosters();
    updateSelectedRosterDetails();
    console.log('[DEBUG] Added', nameList.length, 'participants');
  }

  // Render rosters list
  function renderRosters() {
    const container = document.getElementById('rostersList');
    
    // Filter out deleted rosters as a safety measure
    const deletedIds = getDeletedRosterIds();
    const visibleRosters = businessRosters.filter(r => !deletedIds.includes(r.id));
    
    if (visibleRosters.length === 0) {
      container.innerHTML = '<p style="color:var(--muted);">No rosters created yet</p>';
      return;
    }

    container.innerHTML = visibleRosters.map(roster => `
      <div class="roster-card ${currentRoster?.id === roster.id ? 'active' : ''}" onclick="selectRoster('${roster.id}')">
        <h4>${roster.name}</h4>
        <p style="font-size:12px; color:var(--muted);">
          ${roster.roster?.length || 0} participants ‚Ä¢ ${roster.teamMode || 'individual'} mode
        </p>
        <div style="margin-top:8px;">
          <button class="btn btn-danger" onclick="event.stopPropagation(); deleteRoster('${roster.id}')" style="font-size:10px;">Delete</button>
        </div>
      </div>
    `).join('');
  }

  // Select roster
  function selectRoster(rosterId) {
    currentRoster = businessRosters.find(r => r.id === rosterId);
    renderRosters();
    updateSelectedRosterDetails();
    console.log('[DEBUG] Selected roster:', currentRoster?.name);
  }

  // Update selected roster details
  function updateSelectedRosterDetails() {
    const container = document.getElementById('selectedRosterDetails');
    
    if (!currentRoster) {
      container.innerHTML = '<p style="color:var(--muted);">Select a roster to view details</p>';
      return;
    }

    container.innerHTML = `
      <h4>${currentRoster.name}</h4>
      <p style="font-size:12px; color:var(--muted);">
        ${currentRoster.roster?.length || 0} participants ‚Ä¢ ${currentRoster.teamMode || 'individual'} mode
      </p>
      <div class="employee-list">
        ${(currentRoster.roster || []).map(participant => `
          <div class="employee-item">
            <span>${participant.name}</span>
            <span style="font-size:11px; color:var(--muted);">
              ${participant.team || 'Individual'} ‚Ä¢ ${participant.balance || 100} pts
            </span>
          </div>
        `).join('')}
      </div>
    `;
  }

  // Delete roster
  async function deleteRoster(rosterId) {
    if (!confirm('Are you sure you want to delete this roster?')) {
      return;
    }

    const rosterToDelete = businessRosters.find(r => r.id === rosterId);
    
    // Step 1: Delete from Supabase FIRST (before removing from local array)
    const supabaseDeleted = await deleteRosterFromSupabase(rosterId);
    if (!supabaseDeleted) {
      console.warn('[DEBUG] Supabase deletion may have failed, but continuing with local deletion');
    }
    
    // Step 2: Mark as deleted (prevents re-adding from Supabase)
    markRosterAsDeleted(rosterId);
    
    // Step 3: Remove from local array
    businessRosters = businessRosters.filter(r => r.id !== rosterId);
    
    // Step 4: Clear current roster if it was deleted
    if (currentRoster?.id === rosterId) {
      currentRoster = null;
    }
    
    // Step 5: Save updated array to localStorage
    await saveRosters();
    
    // Step 6: Update UI
    renderRosters();
    updateSelectedRosterDetails();
    console.log('[DEBUG] Deleted roster:', rosterId, rosterToDelete ? rosterToDelete.name : 'unknown');
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('[DEBUG] Business roster page loaded');
    await loadRosters();
  });
</script>

</body>
</html>