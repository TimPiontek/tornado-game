<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tornado Business ‚Äì Roster Management</title>
  <style>
    :root { --bg:#0f172a; --panel:#0b1220; --border:#1f2a44; --text:#e5e7eb; --muted:#9aa3b2; --accent:#22d3ee; }
    * { box-sizing: border-box }
    body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position:sticky; top:0; z-index:2; background:#0d1628cc; border-bottom:1px solid var(--border); }
    .bar { display:flex; gap:8px; align-items:center; padding:12px 16px }
    .wrap { max-width:1200px; margin:0 auto; padding:16px }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:16px }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px }
    .btn { padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#0b1932; color:#fff; cursor:pointer; font-size:12px }
    .btn-primary { background:#3b82f6; }
    .btn-success { background:#059669; }
    .btn-danger { background:#dc2626; }
    input, textarea, select { width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#081125; color:var(--text); margin-bottom:8px }
    .roster-card { border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:8px; cursor:pointer; }
    .roster-card.active { border-color:#3b82f6; background:#1e3a8a20; }
    .roster-card:hover { border-color:#60a5fa; }
    .employee-list { max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; padding:8px; background:#081125; }
    .employee-item { display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px solid var(--border); }
    .employee-item:last-child { border-bottom:none; }
    .team-selector { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .team-option { padding:4px 8px; border:1px solid var(--border); border-radius:6px; background:var(--panel); color:var(--text); cursor:pointer; font-size:11px; }
    .team-option.active { background:#3b82f6; color:#fff; }
  </style>
</head>
<body>

<header>
  <div class="bar">
    <h1 style="cursor: pointer;" onclick="window.location.href = '/business-home.html'">üè¢ Tornado Business ‚Äì Roster Management</h1>
    <div style="flex:1"></div>
    <button class="btn" onclick="window.location.href = '/business-home.html'">‚Üê Back to Manager Hub</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- Existing Rosters -->
    <div class="card">
      <h3>üìã Existing Rosters</h3>
      <div id="rostersList">
        <!-- Rosters will be populated here -->
      </div>
    </div>

    <!-- Create New Roster -->
    <div class="card">
      <h3>‚ûï Create New Roster</h3>
      <input type="text" id="newRosterName" placeholder="Roster name..." />
      
      <div class="team-selector">
        <span style="font-size:12px; color:var(--muted);">Team Mode:</span>
        <div class="team-option active" data-mode="individual" onclick="setTeamMode('individual')">Individual</div>
        <div class="team-option" data-mode="teams" onclick="setTeamMode('teams')">Teams</div>
      </div>
      
      <div id="teamSetup" style="display:none;">
        <label style="font-size:12px; color:var(--muted);">Number of Teams:</label>
        <select id="teamCount">
          <option value="2">2 Teams</option>
          <option value="3">3 Teams</option>
          <option value="4">4 Teams</option>
        </select>
      </div>
      
      <button class="btn btn-primary" onclick="createNewRoster()">Create Roster</button>
    </div>

    <!-- Add Participants -->
    <div class="card">
      <h3>üë• Add Participants</h3>
      <input type="text" id="newParticipantName" placeholder="Participant name..." />
      <button class="btn btn-success" onclick="addParticipant()">Add Participant</button>
      
      <textarea id="bulkParticipants" rows="3" placeholder="Bulk add participants (one per line)"></textarea>
      <button class="btn btn-secondary" onclick="bulkAddParticipants()">Add All Participants</button>
    </div>

    <!-- Selected Roster Details -->
    <div class="card">
      <h3>üìä Selected Roster</h3>
      <div id="selectedRosterDetails">
        <p style="color:var(--muted);">Select a roster to view details</p>
      </div>
    </div>
  </div>
</div>

<script>
  let businessRosters = [];
  let currentRoster = null;
  let teamMode = 'individual';

  // Load rosters from localStorage (compatible with main war game)
  async function loadRosters() {
    try {
      // Load from localStorage using the same key as main war game
      const saved = localStorage.getItem('tornadoRosters');
      if (saved) {
        businessRosters = JSON.parse(saved);
        console.log('[DEBUG] Loaded rosters from localStorage:', businessRosters.length);
      } else {
        businessRosters = [];
        console.log('[DEBUG] No rosters found in localStorage');
      }
      
      renderRosters();
    } catch (error) {
      console.error('Failed to load rosters:', error);
      businessRosters = [];
      renderRosters();
    }
  }

  // Save rosters to localStorage (compatible with main war game)
  async function saveRosters() {
    console.log('[DEBUG] saveRosters() called');
    try {
      // Save to localStorage using the same key as main war game
      console.log('[DEBUG] Saving to localStorage:', businessRosters);
      localStorage.setItem('tornadoRosters', JSON.stringify(businessRosters));
      console.log('[DEBUG] Successfully saved rosters to localStorage');
    } catch (error) {
      console.error('Failed to save rosters:', error);
    }
  }

  // Generate UUID for new rosters and participants
  function generateUUID() {
    return 'roster_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  // Set team mode
  function setTeamMode(mode) {
    teamMode = mode;
    document.querySelectorAll('.team-option').forEach(el => el.classList.remove('active'));
    document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
    
    const teamSetup = document.getElementById('teamSetup');
    teamSetup.style.display = mode === 'teams' ? 'block' : 'none';
  }

  // Create new roster
  async function createNewRoster() {
    const name = document.getElementById('newRosterName').value.trim();
    if (!name) {
      alert('Please enter a roster name');
      return;
    }

    const roster = {
      id: generateUUID(),
      name: name,
      roster: [], // Use 'roster' property to match main war game format
      teamMode: teamMode,
      createdAt: new Date().toISOString()
    };

    businessRosters.push(roster);
    await saveRosters();
    
    // Clear form
    document.getElementById('newRosterName').value = '';
    
    renderRosters();
    console.log('[DEBUG] Created new roster:', roster.name);
  }

  // Add participant to current roster
  async function addParticipant() {
    const name = document.getElementById('newParticipantName').value.trim();
    if (!name) {
      alert('Please enter a participant name');
      return;
    }

    if (!currentRoster) {
      alert('Please select a roster first');
      return;
    }

    const participant = {
      id: generateUUID(),
      name: name,
      points: 0,
      balance: 100,
      tilesOwned: 0,
      team: teamMode === 'teams' ? `Team ${Math.floor(Math.random() * parseInt(document.getElementById('teamCount').value)) + 1}` : null
    };

    currentRoster.roster.push(participant);
    await saveRosters();
    
    // Clear form
    document.getElementById('newParticipantName').value = '';
    
    renderRosters();
    updateSelectedRosterDetails();
    console.log('[DEBUG] Added participant:', participant.name);
  }

  // Bulk add participants
  async function bulkAddParticipants() {
    const names = document.getElementById('bulkParticipants').value.trim();
    if (!names) {
      alert('Please enter participant names');
      return;
    }

    if (!currentRoster) {
      alert('Please select a roster first');
      return;
    }

    const nameList = names.split('\n').filter(name => name.trim());
    const teamCount = parseInt(document.getElementById('teamCount').value);
    
    for (let i = 0; i < nameList.length; i++) {
      const participant = {
        id: generateUUID(),
        name: nameList[i].trim(),
        points: 0,
        balance: 100,
        tilesOwned: 0,
        team: teamMode === 'teams' ? `Team ${(i % teamCount) + 1}` : null
      };
      
      currentRoster.roster.push(participant);
    }

    await saveRosters();
    
    // Clear form
    document.getElementById('bulkParticipants').value = '';
    
    renderRosters();
    updateSelectedRosterDetails();
    console.log('[DEBUG] Added', nameList.length, 'participants');
  }

  // Render rosters list
  function renderRosters() {
    const container = document.getElementById('rostersList');
    
    if (businessRosters.length === 0) {
      container.innerHTML = '<p style="color:var(--muted);">No rosters created yet</p>';
      return;
    }

    container.innerHTML = businessRosters.map(roster => `
      <div class="roster-card ${currentRoster?.id === roster.id ? 'active' : ''}" onclick="selectRoster('${roster.id}')">
        <h4>${roster.name}</h4>
        <p style="font-size:12px; color:var(--muted);">
          ${roster.roster?.length || 0} participants ‚Ä¢ ${roster.teamMode || 'individual'} mode
        </p>
        <div style="margin-top:8px;">
          <button class="btn btn-danger" onclick="deleteRoster('${roster.id}')" style="font-size:10px;">Delete</button>
        </div>
      </div>
    `).join('');
  }

  // Select roster
  function selectRoster(rosterId) {
    currentRoster = businessRosters.find(r => r.id === rosterId);
    renderRosters();
    updateSelectedRosterDetails();
    console.log('[DEBUG] Selected roster:', currentRoster?.name);
  }

  // Update selected roster details
  function updateSelectedRosterDetails() {
    const container = document.getElementById('selectedRosterDetails');
    
    if (!currentRoster) {
      container.innerHTML = '<p style="color:var(--muted);">Select a roster to view details</p>';
      return;
    }

    container.innerHTML = `
      <h4>${currentRoster.name}</h4>
      <p style="font-size:12px; color:var(--muted);">
        ${currentRoster.roster?.length || 0} participants ‚Ä¢ ${currentRoster.teamMode || 'individual'} mode
      </p>
      <div class="employee-list">
        ${(currentRoster.roster || []).map(participant => `
          <div class="employee-item">
            <span>${participant.name}</span>
            <span style="font-size:11px; color:var(--muted);">
              ${participant.team || 'Individual'} ‚Ä¢ ${participant.balance || 100} pts
            </span>
          </div>
        `).join('')}
      </div>
    `;
  }

  // Delete roster
  async function deleteRoster(rosterId) {
    if (!confirm('Are you sure you want to delete this roster?')) {
      return;
    }

    businessRosters = businessRosters.filter(r => r.id !== rosterId);
    
    if (currentRoster?.id === rosterId) {
      currentRoster = null;
    }
    
    await saveRosters();
    renderRosters();
    updateSelectedRosterDetails();
    console.log('[DEBUG] Deleted roster:', rosterId);
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('[DEBUG] Business roster page loaded');
    await loadRosters();
  });
</script>

</body>
</html>