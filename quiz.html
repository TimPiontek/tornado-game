<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Title & SEO -->
    <title>Tornado Quiz - Play Tornado</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="A fun quiz game to play in classrooms or with friends"
    />
    <meta
      property="og:description"
      content="A fun quiz game to play in classrooms or with friends"
    />
    <meta
      name="twitter:description"
      content="A fun quiz game to play in classrooms or with friends"
    />
    <meta
      name="keywords"
      content="ESL game, classroom trivia, online quiz, educational game, team quiz, interactive quiz, quiz maker, web quiz, trivia game, Q&A, browser quiz"
    />

    <!-- Schema.org markup -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Play Tornado: Classroom Game & Trivia Platform",
        "url": "https://playtornado.com/quiz",
        "description": "A versatile online quiz game ideal for ESL classrooms, study groups, and trivia nights, featuring Q&A support, team play, and interactive rewards.",
        "applicationCategory": "EducationalGame",
        "operatingSystem": "Web",
        "creator": { "@type": "Person", "name": "Timothy Piontek" }
      }
    </script>

    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* Base & Typography */
      html {
        font-size: 18px;
      }

      body {
        margin: 0;
        padding: 4px 20px 16px;
        font-family: "Lexend Deca", sans-serif;
        line-height: 1.5;
        background: #31727a;
        color: #333;
        text-align: center;
      }

      h1 {
        font-size: 2.5rem;
        margin: 0.5em 0 0.2em;
      }

      h2 {
        font-size: 1.5rem;
        margin: 0.2em 0 1em;
        color: #555;
      }

      h3 {
        font-size: 1.25rem;
        margin: 0.5em 0 0.5em;
      }

      p,
      label,
      button,
      select,
      input,
      textarea {
        font-size: 1rem;
      }

      :root {
        --teamA: #e57373;
        --teamB: #3498db;
        --btn-bg: #add8e6;
        --btn-hover: #87ceeb;
      }

      .hidden {
        display: none;
      }

      /* SETUP */
      #setupScreen {
        max-width: 1200px;
        margin: 0 auto;
        text-align: left;
        margin: 0;
        padding: 0;
      }

      #setupScreen p {
        margin-bottom: 15px;
      }

      #setupForm label {
        display: block;
        margin: 10px 0;
      }

      #setupForm input,
      #setupForm select,
      #setupForm textarea {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
      }

      #setupForm textarea {
        height: 120px;
        resize: vertical;
      }

      /* inline radio group */
      .inline-radio {
        display: inline-flex;
        align-items: center;
        gap: 1rem;
        margin: 1rem 0;
      }

      .inline-radio span {
        font-weight: 600;
      }

      #setupForm button {
        margin-top: 15px;
        padding: 10px 20px;
        cursor: pointer;
        font-weight: 600;
      }

      /* GAME */
      #gameScreen {
        max-width: none;
        margin: 0;
        width: 100%;
      }

      #grid {
        display: grid;
        gap: 6px;
        margin-bottom: 20px;
        /* Let JavaScript buildGrid function control the columns */
        width: 100%;
        max-height: 70vh;
        justify-items: stretch;
        align-items: stretch;
      }

      #grid button {
        font-size: clamp(1rem, 2vw, 1.5rem) !important;
        line-height: 1;
        min-width: 40px;
        min-height: 40px;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 2px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      #grid button:empty::before {
        content: "\200b";
      }

      #grid button:hover {
        background: var(--btn-hover);
      }

      #grid button:disabled {
        background: #ccc;
        cursor: not-allowed;
        font-size: 1.2em !important;
        transform: none !important;
      }

      #resetBtn {
        padding: 8px 16px;
        cursor: pointer;
        font-weight: 600;
      }

      .footer {
        font-size: 0.8em;
        color: #fff;
        margin-top: 30px;
      }

      /* Animations */
      @keyframes tornado {
        0% {
          transform: rotate(0deg) scale(1) translate(0, 0);
        }

        20% {
          transform: rotate(180deg) scale(1.5) translate(-100px, -50px);
        }

        40% {
          transform: rotate(360deg) scale(2) translate(100px, -100px);
        }

        60% {
          transform: rotate(540deg) scale(1.8) translate(-50px, 50px);
        }

        80% {
          transform: rotate(720deg) scale(1.3) translate(50px, 0);
        }

        100% {
          transform: rotate(1080deg) scale(1) translate(0, 0);
        }
      }

      @keyframes double {
        0% {
          transform: scale(1) rotate(0deg);
        }

        20% {
          transform: scale(1.4) rotate(-10deg);
        }

        40% {
          transform: scale(1.8) rotate(10deg);
        }

        60% {
          transform: scale(1.6) rotate(-5deg);
        }

        80% {
          transform: scale(1.2) rotate(5deg);
        }

        100% {
          transform: scale(1) rotate(0deg);
        }
      }

      @keyframes sad {
        0% {
          transform: translateY(0) rotate(0deg);
        }

        20% {
          transform: translateY(-30px) rotate(-15deg);
        }

        40% {
          transform: translateY(0) rotate(0deg);
        }

        60% {
          transform: translateY(-20px) rotate(15deg);
        }

        80% {
          transform: translateY(-10px) rotate(-5deg);
        }

        100% {
          transform: translateY(0) rotate(0deg);
        }
      }

      @keyframes kangaroo {
        0% {
          transform: translateY(0) rotate(0deg);
        }

        20% {
          transform: translateY(-60px) rotate(-20deg);
        }

        40% {
          transform: translateY(0) rotate(0deg);
        }

        60% {
          transform: translateY(-40px) rotate(20deg);
        }

        80% {
          transform: translateY(-20px) rotate(-10deg);
        }

        100% {
          transform: translateY(0) rotate(0deg);
        }
      }

      @keyframes pointsReveal {
        0% {
          transform: perspective(1000px) rotateX(0deg) scale(0.5)
            translateY(20px);
          opacity: 0;
        }

        20% {
          transform: perspective(1000px) rotateX(20deg) scale(1.4)
            translateY(-20px);
          opacity: 1;
        }

        40% {
          transform: perspective(1000px) rotateX(-15deg) scale(1.2)
            translateY(10px);
        }

        60% {
          transform: perspective(1000px) rotateX(10deg) scale(1.3)
            translateY(-5px);
        }

        80% {
          transform: perspective(1000px) rotateX(-5deg) scale(1.1)
            translateY(2px);
        }

        100% {
          transform: perspective(1000px) rotateX(0deg) scale(1) translateY(0);
        }
      }
      
      @keyframes pointsBreakdown {
        0% {
          transform: perspective(1000px) rotateX(0deg) scale(0.8)
            translateY(15px);
          opacity: 0;
        }

        20% {
          transform: perspective(1000px) rotateX(15deg) scale(1.2)
            translateY(-10px);
          opacity: 1;
        }

        40% {
          transform: perspective(1000px) rotateX(-10deg) scale(1.1)
            translateY(5px);
        }

        60% {
          transform: perspective(1000px) rotateX(8deg) scale(1.15)
            translateY(-3px);
        }

        80% {
          transform: perspective(1000px) rotateX(-3deg) scale(1.05)
            translateY(1px);
        }

        100% {
          transform: perspective(1000px) rotateX(0deg) scale(1) translateY(0);
        }
      }

      @keyframes pointsTextGlow {
        0% {
          text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }

        100% {
          text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
      }

      @keyframes specialPopup3D {
        0% {
          transform: perspective(1000px) rotateX(0deg) scale(0.5);
          opacity: 0;
        }

        20% {
          transform: perspective(1000px) rotateX(30deg) scale(1.4);
          opacity: 1;
        }

        40% {
          transform: perspective(1000px) rotateX(-20deg) scale(1.3);
        }

        60% {
          transform: perspective(1000px) rotateX(15deg) scale(1.4);
        }

        80% {
          transform: perspective(1000px) rotateX(-5deg) scale(1.2);
        }

        100% {
          transform: perspective(1000px) rotateX(0deg) scale(1);
        }
      }

      .tornado-animation {
        animation: tornado 2s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }

      .double-animation {
        animation: double 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }

      .sad-animation {
        animation: sad 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }

      .kangaroo-animation {
        animation: kangaroo 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }

      .points-reveal-animation {
        animation: pointsReveal 2.2s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }
      
      .points-breakdown-animation {
        animation: pointsBreakdown 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }

      .points-text-glow {
        animation: pointsTextGlow 2s ease-in-out infinite;
      }

      .special-popup-3d {
        animation: specialPopup3D 2.2s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }

      .special-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(111, 92, 145, 0.95);
        color: #fff;
        font-size: 2.5rem;
        font-weight: 900;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
        padding: 2rem 3rem;
        z-index: 1000;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
        max-width: 90vw;
      }

      .special-popup.show {
        opacity: 1;
      }

      .special-popup .emoji {
        font-size: 4rem;
        margin-bottom: 1rem;
        display: block;
      }

      .special-popup .slogan {
        font-size: 1.8rem;
        line-height: 1.2;
        margin: 0;
      }

      /* Game Info */
      .game-info {
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 10px;
        margin: 20px auto;
        max-width: 600px;
        text-align: left;
        position: relative;
      }

      .how-to-play-section {
        margin-top: 2rem;
        display: flex;
        justify-content: center;
        width: 100%;
      }

      .how-to-play {
        margin-top: 0;
        padding-top: 0;
        background: rgba(255, 255, 255, 0.93);
        border-radius: 12px;
        padding: 1.2rem 1.5rem;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.07);
      }

      .how-title {
        font-weight: 900;
        font-size: 1.3rem;
        margin: 0 0 8px 0;
        text-align: center;
      }

      .how-body {
        margin: 0 0 8px 0;
        font-size: 1.08rem;
        text-align: center;
      }

      .special-items.compact {
        margin: 0;
        gap: 1.5rem;
        justify-content: space-around;
      }

      .special-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1rem;
        margin: 0 0 0 0;
      }

      .emoji-big {
        font-size: 2.2rem;
        line-height: 1;
        display: flex;
        align-items: center;
        height: 2.2rem;
      }

      .logo-start-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
        margin-top: 2rem;
      }

      .logo-large {
        max-width: 200px;
        height: 200px;
      }

      .start-large,
      #startGameBtnBottom.compact-start-btn {
        font-size: 2.2rem;
        padding: 0.7rem 0;
        font-weight: 900;
        background: #6f5c91;
        color: #fff;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        display: block;
        width: 100%;
        min-width: 0;
        min-height: 60px;
        max-width: 100%;
        margin: 0 auto 1.2rem auto;
        height: auto;
      }

      .start-large:hover {
        background: #59487a;
        transform: scale(1.05);
      }

      .special-item-selectors {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        justify-content: center;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .special-item-selectors label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.1rem;
        background: #f6f6f6;
        border-radius: 8px;
        padding: 0.4rem 0.8rem;
      }

      .special-item-selectors select {
        font-size: 1.1rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        border: 1px solid #ccc;
        margin-left: 0.3rem;
      }

      .slogan {
        font-size: 1.15rem;
        font-weight: 700;
        margin-left: 0.5rem;
        color: #333;
        display: inline-block;
      }

      .special-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.97);
        color: #222;
        font-size: 2.5rem;
        font-weight: 900;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
        padding: 2rem 3rem;
        z-index: 1000;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .special-popup.show {
        opacity: 1;
        pointer-events: auto;
      }

      .score-animate {
        transition: transform 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55),
          color 0.7s;
      }

      .kangaroo-jump {
        animation: kangarooJump 0.7s;
      }

      @keyframes kangarooJump {
        0% {
          transform: translateY(0);
        }

        30% {
          transform: translateY(-40px) scale(1.2);
        }

        60% {
          transform: translateY(0) scale(1);
        }

        100% {
          transform: translateY(0);
        }
      }

      .lion-roar {
        animation: lionRoar 0.7s;
      }

      @keyframes lionRoar {
        0% {
          transform: scale(1);
        }

        20% {
          transform: scale(1.3) rotate(-5deg);
        }

        40% {
          transform: scale(1.1) rotate(5deg);
        }

        60% {
          transform: scale(1.2);
        }

        100% {
          transform: scale(1);
        }
      }

      .skunk-cloud {
        animation: skunkCloud 1s;
        color: #6e7f5c !important;
        opacity: 0.5;
      }

      @keyframes skunkCloud {
        0% {
          filter: blur(0);
          opacity: 1;
        }

        50% {
          filter: blur(2px);
          opacity: 0.7;
        }

        100% {
          filter: blur(6px);
          opacity: 0;
        }
      }

      .special-popup.tornado-mode {
        background: transparent;
        box-shadow: none;
        padding: 0;
        font-size: 3.5rem;
        color: #333;
        pointer-events: none;
      }

      .tornado-emoji-big {
        font-size: 7rem;
        animation: tornadoSpinBig 1.2s linear;
        display: block;
        margin: 0 auto;
        filter: drop-shadow(0 8px 32px rgba(0, 0, 0, 0.18));
      }

      @keyframes tornadoSpinBig {
        0% {
          transform: scale(1) rotate(0deg);
        }

        40% {
          transform: scale(1.5) rotate(180deg);
        }

        70% {
          transform: scale(2.2) rotate(360deg);
        }

        100% {
          transform: scale(1) rotate(720deg);
        }
      }

      .tornado-text {
        font-size: 3rem;
        font-weight: 900;
        color: #6f5c91;
        letter-spacing: 0.2em;
        margin-top: 0.5rem;
        animation: tornadoTextScroll 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        white-space: nowrap;
        overflow: hidden;
        text-shadow: 2px 2px 8px #fff, 0 0 8px #6f5c91;
      }

      @keyframes tornadoTextScroll {
        0% {
          transform: translateX(-120%);
          opacity: 0;
        }

        30% {
          opacity: 1;
        }

        60% {
          transform: translateX(10%);
          opacity: 1;
        }

        100% {
          transform: translateX(0);
          opacity: 0;
        }
      }

      .purple-btn {
        background: #6f5c91;
        color: #fff;
        font-weight: 700;
        border: none;
        border-radius: 8px;
        padding: 12px 32px;
        font-size: 1.2rem;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: background 0.2s, transform 0.2s;
      }

      .purple-btn:hover {
        background: #59487a;
        transform: scale(1.05);
      }

      .special-legend {
        margin-top: 1.2rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        font-size: 1.1rem;
        text-align: left;
        align-items: flex-start;
        justify-content: center;
      }

      .compact-info {
        padding: 10px 10px 10px 10px;
        max-width: 480px;
      }

      .special-item-compact-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .special-item-compact {
        margin-bottom: 0.2rem;
      }

      .special-row {
        display: flex;
        align-items: center;
        gap: 0.7em;
        min-width: 320px;
      }

      .special-row select {
        font-size: 1.1rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        border: 1px solid #ccc;
        margin-left: 0.3rem;
      }

      .special-desc {
        font-size: 0.98rem;
        color: #333;
        margin-left: 2.2rem;
        margin-top: 0.1rem;
        margin-bottom: 0.2rem;
      }

      .questions-block {
        margin: 1.2rem auto 0 auto;
        max-width: 480px;
        background: rgba(255, 255, 255, 0.85);
        border-radius: 10px;
        padding: 1rem 1.2rem 0.5rem 1.2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }

      #questionsInput {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        height: 120px;
        font-family: inherit;
        font-size: 1rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        margin-bottom: 0.5rem;
      }

      .game-controls {
        display: flex;
        justify-content: center;
        gap: 1.2rem;
        margin-bottom: 0.7rem;
      }

      #questionAnswerRow {
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
        min-height: 90px;
        margin-bottom: 0.5rem;
        width: 100%;
      }

      .bubble-left,
      .bubble-right {
        max-width: 28vw;
        min-width: 180px;
        background: #fff;
        color: #222;
        border-radius: 18px;
        padding: 0.7rem 1rem 0.7rem 1rem;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0.2rem;
        margin-top: 0.2rem;
        word-break: break-word;
        overflow-wrap: break-word;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        min-height: 40px;
      }

      .bubble-left {
        margin-left: 2vw;
        align-items: flex-start;
        border-top-left-radius: 0;
      }

      .bubble-right {
        margin-left: auto;
        margin-right: 2vw;
        align-items: flex-end;
        border-top-right-radius: 0;
      }

      #question {
        color: #6f5c91;
        font-size: 1.5em;
        font-weight: 900;
        text-align: left;
        margin-bottom: 0.3em;
        line-height: 1.2;
      }

      #answer {
        color: #31727a;
        font-size: 1.1em;
        font-style: italic;
        text-align: left;
        margin-top: 0.2em;
        line-height: 1.2;
      }

      @media (max-width: 900px) {
        .bubble-left,
        .bubble-right {
          max-width: 90vw;
          min-width: 0;
          font-size: 1.1rem;
          padding: 0.7rem 1rem;
        }

        #question {
          font-size: 1.1em;
        }
      }

      .scorebar-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1.2rem;
        margin-bottom: 0.7rem;
        width: 100%;
        max-width: 900px;
        margin: 20px auto 0;
        padding: 0 20px;
      }

      .team-left,
      .team-right {
        flex: 0 0 220px;
        min-width: 180px;
        max-width: 260px;
      }

      .center-controls {
        flex: 1 1 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 0;
        max-width: 400px;
      }

      #turnDisplay {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.3rem;
      }

      .compact-controls {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        align-items: center;
      }

      .game-footer-btns {
        display: none;
      }

      #gameScreen:not(.hidden) .game-footer-btns {
        display: flex !important;
      }

      #resetBtn,
      #homeBtn {
        padding: 8px 16px;
        font-weight: 700;
        cursor: pointer;
        background: #6f5c91;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        transition: background 0.2s, transform 0.2s;
      }

      #resetBtn:hover,
      #homeBtn:hover {
        background: #59487a;
        transform: scale(1.05);
      }

      .setup-flex-row {
        display: flex;
        flex-direction: row;
        gap: 2.2rem;
        align-items: flex-start;
        justify-content: center;
        margin-bottom: 0.5rem;
        flex-wrap: nowrap;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
      }

      .game-info.compact-info {
        min-width: 320px;
        max-width: 420px;
        flex: 1 1 0;
      }

      .compact-setup-form {
        min-width: 180px;
        max-width: 220px;
        flex: 0 0 220px;
      }

      @media (max-width: 900px) {
        .setup-flex-row {
          flex-direction: column;
          gap: 1.2rem;
          align-items: center;
          max-width: 98vw;
        }

        .game-info.compact-info,
        .compact-setup-form {
          min-width: 0;
          max-width: 98vw;
          width: 100%;
        }

        #grid {
          gap: 6px;
          padding: 0 10px;
          max-height: 60vh;
          margin-bottom: 80px;
        }

        .game-footer-btns {
          margin-top: 2.2rem;
          margin-bottom: 2.2rem;
        }
      }

      .slightly-wider-questions-block {
        max-width: 270px;
        width: 100%;
        margin-top: 1.2rem;
        margin-bottom: 0;
        padding-left: 0;
        padding-right: 0;
      }

      .compact-questions-block {
        padding: 1.2rem 1.5rem 0.8rem 1.5rem;
      }

      .setup-form-and-questions {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        min-width: 180px;
        max-width: 240px;
        flex: 0 0 240px;
      }

      @keyframes flip {
        0% {
          transform: rotateY(0deg);
        }

        100% {
          transform: rotateY(180deg);
        }
      }

      .flip {
        animation: flip 0.5s forwards;
      }

      /* Responsive design polish */
      @media (max-width: 700px) {
        .setup-flex-row {
          flex-direction: column;
          gap: 1.2rem;
          align-items: center;
          max-width: 98vw;
        }

        .game-info.compact-info,
        .compact-setup-form,
        .setup-form-and-questions,
        .slightly-wider-questions-block {
          min-width: 0;
          max-width: 98vw;
          width: 100%;
        }

        #grid {
          padding: 0 2vw;
          gap: 6px;
        }

        #grid button {
          font-size: clamp(0.8rem, 1.5vw, 1.2rem) !important;
          padding: 2px;
          min-width: 35px;
          min-height: 35px;
        }

        .scorebar-row {
          flex-direction: column;
          gap: 0.7rem;
          max-width: 98vw;
        }

        .team-left,
        .team-right {
          min-width: 0;
          max-width: 98vw;
          width: 100%;
        }

        .center-controls {
          min-width: 0;
          width: 100%;
        }

        .game-controls.compact-controls {
          flex-direction: column;
          gap: 0.7rem;
        }
      }

      html,
      body {
        max-width: 100vw;
        overflow-x: hidden;
      }

      /* Make optgroup labels bold and black in quiz dropdown */
      select#quizSelect optgroup {
        color: #111;
        font-weight: bold;
        font-size: 1.05em;
      }

      #startGameBtnBottom.purple-btn {
        font-size: 2.2rem;
        padding: 0.7rem 2.5rem;
        font-weight: 900;
        border-radius: 12px;
        margin-top: 8px !important;
        margin-bottom: 1.2rem;
        min-width: 200px;
        min-height: 60px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .setup-grid-row.home-grid {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 2rem;
        gap: 60px;
      }

      .home-grid > #startGameBtnBottom {
        grid-column: 1 / -1;
        width: 100%;
        margin: 8px 0 0 0;
        position: static;
      }

      .special-effects-sidebar {
        width: 500px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.93);
        border-radius: 12px;
        padding: 15px 18px 15px 18px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.07);
        height: 600px;
        overflow-y: auto;
      }
      
      /* Unified Game Layout */
      .game-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 1rem;
        padding: 1rem 1rem 1rem 0;
        min-height: calc(100vh - 2rem);
        margin-left: 0;
      }
      
      .game-sidebar {
        background: #fff;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
      }
      
      .sidebar-section h3 {
        color: #6f5c91;
        margin: 0 0 1rem 0;
        font-size: 1.25rem;
        font-weight: 600;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.5rem;
      }
      
      .team-scores {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      
      .team-score-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }
      
      .team-score-item.active {
        background: rgba(111, 92, 145, 0.1);
        border-color: #6f5c91;
      }
      
      .team-name {
        font-weight: 600;
        color: #1e293b;
      }
      
      .team-score {
        font-size: 1.25rem;
        font-weight: 700;
        color: #6f5c91;
      }
      
      .team-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding-bottom: 0.3rem;
        border-bottom: 1px solid #e0e0e0;
      }
      
      .student-list {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }
      
      .student-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.3rem 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.85em;
        transition: all 0.2s ease;
      }
      
      .student-item.current-student {
        background: #6f5c91;
        color: white;
        font-weight: bold;
      }
      
      .student-name {
        flex: 1;
        text-align: left;
      }
      
      .student-points {
        font-weight: bold;
        color: #28a745;
      }
      
      .student-item.current-student .student-points {
        color: #fff;
      }
      
      .game-controls {
        text-align: center;
      }
      
      .control-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
      }
      
      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1rem;
      }
      
      .btn-primary {
        background: #6f5c91;
        color: white;
      }
      
      .btn-primary:hover {
        background: #5a4a7a;
        transform: translateY(-1px);
      }
      
      .btn-secondary {
        background: #64748b;
        color: white;
      }
      
      .btn-secondary:hover {
        background: #475569;
        transform: translateY(-1px);
      }
      
      
      .game-main {
        background: #fff;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .special-effects-title {
        font-size: 1.05rem;
        font-weight: 700;
        color: #333;
        margin: 0 0 0.6rem 0;
        text-align: center;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 0.3rem;
      }

      .special-effects-content {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .special-effects-content .special-item-compact {
        margin-bottom: 0.5rem;
      }
      
      .special-effects-content .special-item-compact:last-child {
        margin-bottom: 0;
      }

      .how-to-play-sym {
        flex: 0 0 320px;
        min-width: 260px;
        max-width: 340px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
        background: rgba(255, 255, 255, 0.93);
        border-radius: 12px;
        padding: 18px 18px 18px 18px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.07);
        margin-top: 0;
      }

      .setup-main-card {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        flex: 0 0 auto;
        min-width: 0;
        max-width: 500px;
        width: 500px;
        gap: 0;
        justify-content: flex-start;
        margin: 0;
      }

      /* Match the height of the special effects sidebar */
      .setup-main-card .setup-unified-card {
        height: 600px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .setup-main-card .setup-unified-card .setup-unified-grid {
        overflow: visible;
      }

      .setup-main-grid {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        flex: 1 1 0;
        min-width: 400px;
        max-width: 600px;
        gap: 0.2rem;
        justify-content: flex-start;
      }

      .setup-row {
        display: flex;
        flex-direction: row;
        gap: 1.5rem;
        margin-bottom: 0.2rem;
      }

      .team-box,
      .quiz-box,
      .grid-box {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.07);
        padding: 10px 16px 10px 16px;
        flex: 1 1 0;
        min-width: 160px;
        max-width: 240px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: flex-start;
        min-height: 80px;
        height: 80px;
        margin-bottom: 0.5rem;
      }

      .quiz-box,
      .grid-box {
        margin-top: 0;
      }

      .questions-block {
        margin-top: 1.2rem;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.07);
        padding: 1.2rem 1.5rem 0.8rem 1.5rem;
        max-width: 500px;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
      }

      #startGameBtnBottom.start-large {
        margin: 1.2rem auto 0.7rem auto;
        display: block;
        width: 80%;
        max-width: 420px;
        min-width: 220px;
        font-size: 2.2rem;
        padding: 1.1rem 0;
      }
      .library-section {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .hidden {
        display: none !important;
      }
      @media (max-width: 900px) {
        .setup-grid-row.home-grid {
          display: grid;
          grid-template-columns: 1fr;
          gap: 8px;
          width: 98vw;
        }

        .special-effects-sidebar,
        .how-to-play-sym,
        .setup-main-card,
        .setup-main-grid {
          min-width: 0;
          max-width: 98vw;
          width: 100%;
        }

        .special-effects-sidebar {
          max-height: none;
          overflow-y: visible;
        }

        .setup-row {
          flex-direction: column;
          gap: 0.7rem;
        }

        .team-box,
        .quiz-box,
        .grid-box {
          min-width: 0;
          max-width: 98vw;
          width: 100%;
        }

        .questions-block {
          max-width: 98vw;
        }

        #startGameBtnBottom.start-large {
          width: 100%;
          min-width: 0;
          max-width: 98vw;
        }
      }

      /* Make quiz/grid/start button the same width */
      .quiz-box,
      .grid-box,
      #startGameBtnBottom.compact-start-btn {
        max-width: 240px;
        width: 100%;
        margin-left: 0;
        margin-right: 0;
      }

      /* Align Q&A and How to Play boxes at the bottom */
      .setup-grid-row {
        align-items: stretch;
      }

      .align-bottom {
        margin-top: 0.5rem;
        margin-bottom: 0;
        align-self: flex-end;
      }

      .team-box label[for^="singlePlayerCheckbox"],
      .team-box label:has(#singlePlayerCheckbox) {
        margin-bottom: 0.2em;
        margin-top: 0.2em;
        align-items: center;
        display: flex;
      }

      #singlePlayerCheckbox {
        margin-top: 0.1em;
        margin-bottom: 0.1em;
        vertical-align: middle;
      }

      .quiz-box select,
      .grid-box select {
        margin-top: 8px !important;
        margin-bottom: 0;
        display: block;
        vertical-align: middle;
      }

      .quiz-box label,
      .grid-box label {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
      }

      .team-b-name-container {
        display: flex;
        align-items: center;
        gap: 0.5em;
        justify-content: center;
      }

      .team-b-name-container.single-player {
        justify-content: flex-start;
      }

      /* Custom quiz dropdown */
      .custom-quiz-dropdown-container {
        position: relative;
        width: 100%;
        max-width: none;
        margin: 0;
      }

      .custom-quiz-dropdown {
        background: #fff;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 0.7em 1em;
        cursor: pointer;
        min-height: 2.2em;
        font-size: 1.1em;
        text-align: left;
        position: relative;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        justify-content: flex-start;
      }

      .custom-quiz-dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        min-width: 0;
        max-width: none;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12);
        z-index: 100;
        max-height: 320px;
        overflow-y: auto;
        margin-top: 4px;
        box-sizing: border-box;
      }

      .custom-quiz-category,
      .custom-quiz-folder {
        font-weight: 700;
        font-size: 1.08em;
        cursor: pointer;
        background: #eee;
        padding: 0.5em 1em;
        border-radius: 6px;
        margin-bottom: 0.3em;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .custom-quiz-category.open,
      .custom-quiz-folder.open {
        background: #d6d6f6;
      }

      .custom-quiz-category-arrow,
      .custom-quiz-folder-arrow {
        margin-left: 0.7em;
        font-size: 0.9em;
        transition: transform 0.2s;
      }

      .custom-quiz-category.open .custom-quiz-category-arrow,
      .custom-quiz-folder.open .custom-quiz-folder-arrow {
        transform: rotate(90deg);
      }

      .custom-quiz-quizlist,
      .custom-quiz-folderlist {
        list-style: none;
        padding-left: 1.2em;
        margin: 0 0 0.5em 0;
      }

      .custom-quiz-quizlist li,
      .custom-quiz-folderlist li {
        margin-bottom: 0.4em;
        cursor: pointer;
        padding: 0.2em 0.5em;
        border-radius: 4px;
        white-space: normal;
        word-break: break-word;
        background: none;
      }

      .custom-quiz-quizlist li.selected,
      .custom-quiz-quizlist li:hover,
      .custom-quiz-folderlist li.selected,
      .custom-quiz-folderlist li:hover {
        background: #e6e6fa;
      }

      /* Add styles for the unified card and grid */
      .setup-unified-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        padding: 1em 1.2em 1em 1.2em;
        margin: 0;
        max-width: none;
        width: 100%;
      }

      .setup-unified-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto auto;
        gap: 0.6em 1em;
        align-items: flex-start;
      }

      .setup-unified-cell {
        min-width: 0;
        width: 100%;
      }

      .setup-unified-cell.full-width {
        grid-column: 1 / span 2;
      }

      /* Style the Q&A section within the unified card */
      .setup-unified-cell.full-width label small {
        display: inline-block;
        color: #666;
        font-size: 0.9em;
        margin-left: 0.5em;
        font-style: italic;
      }

      .setup-unified-cell.full-width textarea {
        margin-top: 0.4em;
        margin-bottom: 0.6em;
      }

      .setup-unified-cell.full-width .inline-radio {
        margin-top: 0.5em;
      }

      @media (max-width: 700px) {
        .setup-unified-card {
          padding: 1.2em 0.7em 1em 0.7em;
        }

        .setup-unified-grid {
          grid-template-columns: 1fr;
          grid-template-rows: none;
          gap: 1.2em 0;
        }

        .setup-unified-cell.full-width {
          grid-column: 1 / span 1;
        }
      }

      .game-footer-btns button {
        position: relative;
        font-size: 1.2rem;
        padding: 0.7em 2em;
        font-weight: 700;
        border-radius: 12px;
        background: #6f5c91;
        color: #fff;
        border: none;
        cursor: pointer;
        margin: 0 0.5em;
        display: flex;
        align-items: center;
        gap: 0.5em;
      }

      .game-footer-btns button span.emoji {
        font-size: 2.1em;
        line-height: 1;
        display: inline-block;
        vertical-align: middle;
      }

      .game-footer-btns div[style*="font-size: 1rem"] {
        margin-top: 0.5rem;
      }

      @media (max-width: 900px) {
        #gameScreen {
          min-height: 100vh;
        }

        #grid {
          margin-bottom: 0;
        }

        .game-footer-btns {
          padding: 1.2rem 0 1.2rem 0;
        }
      }

      .team {
        background: white;
        padding: 10px 20px;
        border-radius: 15px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        min-width: 150px;
        max-width: 220px;
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #nameA {
        color: var(--teamA);
        font-size: 2.5rem;
        font-weight: 700;
        margin: 5px 0 0;
      }

      #nameB {
        color: var(--teamB);
        font-size: 2.5rem;
        font-weight: 700;
        margin: 5px 0 0;
      }

      .team p {
        font-size: 2em;
        margin: 5px 0 0;
      }

      .team,
      .team h2,
      .team p,
      .announcement,
      #turnDisplay {
        font-family: "Lexend Deca", sans-serif !important;
      }

      /* Library Game Options Modal Styles */
      #libraryGameOptionsModal input:focus,
      #libraryGameOptionsModal select:focus {
        border-color: #6f5c91 !important;
        outline: none;
        box-shadow: 0 0 0 3px rgba(111, 92, 145, 0.1);
      }

      #libraryGameOptionsModal input:hover,
      #libraryGameOptionsModal select:hover {
        border-color: #6f5c91;
      }

      #closeLibraryGameOptionsModal:hover {
        color: #e57373 !important;
        transform: scale(1.1);
        transition: all 0.2s;
      }

      #startLibraryGameBtn:hover {
        background: #59487a !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Responsive design for modal */
      @media (max-width: 700px) {
        #libraryGameOptionsModal > div {
          padding: 2em 1.5em !important;
          margin: 1em;
        }
        
        #libraryGameOptionsModal .grid {
          grid-template-columns: 1fr !important;
          gap: 1.5em !important;
        }
      }

      /* Question Modal Styles */
      .question-action-btn {
        padding: 1em 1.5em;
        border: none;
        border-radius: 12px;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5em;
        min-height: 60px;
      }

      .correct-btn {
        background: #4caf50;
        color: white;
      }

      .correct-btn:hover {
        background: #45a049;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
      }

      .incorrect-btn {
        background: #f44336;
        color: white;
      }

      .incorrect-btn:hover {
        background: #da190b;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
      }

      .secondary-btn {
        background: #6f5c91;
        color: white;
      }

      .secondary-btn:hover {
        background: #59487a;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(111, 92, 145, 0.3);
      }

      #closeQuestionModal:hover {
        opacity: 1 !important;
        color: #e57373 !important;
        transform: scale(1.1);
      }

      /* Question Modal Animation */
      @keyframes questionModalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-30px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      #questionModal > div {
        animation: questionModalSlideIn 0.4s ease-out;
      }

      /* Answer transition effects */
      #modalAnswer {
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateY(10px);
      }

      #modalAnswer[style*="display: flex"] {
        opacity: 1;
        transform: translateY(0);
      }

      /* Responsive design for question modal */
      @media (max-width: 700px) {
        #questionModal > div {
          padding: 2em 1.5em !important;
          margin: 1em;
        }
        
        #modalQuestion {
          font-size: 2rem !important;
          min-height: 100px !important;
        }
        
        #modalAnswer {
          font-size: 1.5rem !important;
          min-height: 60px !important;
        }
        
        .question-action-btn {
          font-size: 1rem !important;
          padding: 0.8em 1.2em !important;
        }
      }

      /* Multi-team support styles */
      .team-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .team-card {
        background: white;
        padding: 1rem;
        border-radius: 15px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        position: relative;
        transition: all 0.3s ease;
      }

      .team-card h2 {
        font-size: 1.1rem !important;
        font-weight: 600;
        line-height: 1.2;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        text-align: center;
        color: inherit;
        margin: 0 0 0.5rem 0;
      }

      .team-card p {
        font-size: 1rem !important;
        font-weight: 500;
        line-height: 1.1;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        text-align: center;
        margin: 0;
      }

      .team-card.active {
        border: 3px solid #6f5c91;
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(111, 92, 145, 0.3);
      }

      .team-card.frozen {
        opacity: 0.6;
        background: #f0f8ff;
      }

      .team-status {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        align-items: center;
      }

      .status-icon {
        font-size: 1.2rem;
        padding: 0.2rem;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .status-label {
        font-size: 0.7rem;
        color: #666;
        text-align: center;
        max-width: 60px;
        line-height: 1;
      }



      .shield-icon {
        color: #32cd32;
      }

      .hotstreak-icon {
        color: #ff4500;
      }

      /* Coin flip animation */
      @keyframes coinFlip {
        0% { transform: rotateY(0deg) scale(1); }
        25% { transform: rotateY(90deg) scale(1.2); }
        50% { transform: rotateY(180deg) scale(1.1); }
        75% { transform: rotateY(270deg) scale(1.2); }
        100% { transform: rotateY(360deg) scale(1); }
      }

      .coin-flipping {
        animation: coinFlip 1.5s ease-in-out;
      }

      /* Grid border highlight for active team */
      #grid.active-team-A { border: 3px solid var(--teamA); }
      #grid.active-team-B { border: 3px solid var(--teamB); }
      #grid.active-team-C { border: 3px solid #ff6b6b; }
      #grid.active-team-D { border: 3px solid #4ecdc4; }
      #grid.active-team-E { border: 3px solid #45b7d1; }
      #grid.active-team-F { border: 3px solid #96ceb4; }
    </style>
  </head>

  <body>
    <!-- NAVIGATION BAR -->
    <nav
      id="mainNav"
      style="
        background: #6f5c91;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 2rem;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
      "
    >
      <div
        id="logoTitleHome"
        style="display: flex; align-items: center; gap: 1rem; cursor: pointer"
        onclick="window.location.href = '/'"
      >
        <img
          src="tornado-logo.png"
          alt="PlayTornado Logo"
          style="
            height: 64px;
            width: 64px;
            border-radius: 8px;
            background: #fff;
            padding: 2px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
          "
        />
        <span
          style="
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: 1px;
            color: #fff;
          "
          >Play Tornado</span
        >
      </div>
      <div
        style="
          display: flex;
          align-items: center;
          gap: 2.2rem;
          font-size: 1.1rem;
          font-weight: 600;
        "
      >
        <a
          href="/"
          style="
            color: #fff;
            text-decoration: none;
            padding: 0.3em 0.7em;
            border-radius: 6px;
            transition: background 0.2s;
          "
          >Home</a
        >
        <a
          href="#"
          id="myLibraryLink"
          style="
            color: #fff;
            text-decoration: none;
            padding: 0.3em 0.7em;
            border-radius: 6px;
            transition: background 0.2s;
          "
          >My Library</a
        >
        <a
          href="#"
          id="publicLibraryLink"
          style="
            color: #fff;
            text-decoration: none;
            padding: 0.3em 0.7em;
            border-radius: 6px;
            transition: background 0.2s;
          "
          >Play Tornado Library</a
        >
        <button
          id="loginLogoutBtn"
          style="
            background: #fff;
            color: #6f5c91;
            border: none;
            border-radius: 6px;
            padding: 0.3em 1.1em;
            font-weight: 700;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background 0.2s, color 0.2s;
          "
        >
          Login
        </button>
      </div>
    </nav>
    <!-- END NAVIGATION BAR -->

    <!-- SETUP SCREEN -->
    <div id="setupScreen" style="position: relative">
      <!-- Game Selection Section -->
      <div id="gameSelectionSection" style="display: none;">
        
        <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center; align-items: center; max-width: 1000px;">
          <!-- Logo on the left -->
          <div style="flex: 0 0 auto; margin-right: 2rem;">
            <img src="tornado-logo.png" alt="Play Tornado Logo" style="width: 120px; height: 120px; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.10); background: #fff;">
          </div>
          
          <!-- Game Cards -->
          <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center;">
          <!-- Tornado Quiz Card -->
          <div style="
            background: #fff;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
            flex: 1;
            min-width: 300px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
          " 
          id="quizCard"
          onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0,0,0,0.15)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0,0,0,0.1)'"
          onclick="window.location.href = '/quiz'">
            <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
            <h2 style="color: #6f5c91; margin: 0 0 1rem 0; font-size: 1.8rem;">Tornado Quiz</h2>
            <p style="color: #666; line-height: 1.5; margin: 0 0 1.5rem 0;">
              Interactive quiz game perfect for classrooms, study groups, and trivia nights. 
              Create custom quizzes or choose from our library of educational content.
            </p>
            <div style="
              background: #6f5c91;
              color: white;
              padding: 0.8rem 1.5rem;
              border-radius: 8px;
              font-weight: 600;
              display: inline-block;
            ">Start Quiz Game</div>
          </div>

          <!-- Tornado War Card -->
          <div style="
            background: #fff;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
            flex: 1;
            min-width: 300px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
          " 
          id="warCard"
          onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0,0,0,0.15)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0,0,0,0.1)'"
          onclick="window.location.href = '/war'">
            <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
            <h2 style="color: #6f5c91; margin: 0 0 1rem 0; font-size: 1.8rem;">Tornado War</h2>
            <p style="color: #666; line-height: 1.5; margin: 0 0 1.5rem 0;">
              Strategic classroom game where students compete for territory. 
              Teachers control the game, students strategize and collaborate through truces.
            </p>
            <div style="
              background: #6f5c91;
              color: white;
              padding: 0.8rem 1.5rem;
              border-radius: 8px;
              font-weight: 600;
              display: inline-block;
            ">Start War Game</div>
          </div>
          </div>
        </div>
      </div>

      <!-- Quiz Setup Section -->
      <div style="
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 80vh;
        margin-top: 2rem;
        padding: 0 1rem;
      ">
        <div class="setup-grid-row home-grid" style="margin-top: 0.2rem;" >
          <!-- Main Setup Card (Center) -->
          <div class="setup-main-card">
            <form id="setupForm" onsubmit="return false;">
              <div class="setup-unified-card">
                <div class="setup-unified-grid">
                  <!-- 1. Load Roster Section (First) -->
                  <div class="setup-unified-cell full-width">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                      <button type="button" id="loadRosterBtn" style="
                        background: #6f5c91;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        padding: 0.5rem 1rem;
                        font-weight: 600;
                        cursor: pointer;
                      ">Load Roster</button>
                      <span id="rosterStatus" style="color: #666; font-size: 0.9em;">No roster loaded</span>
                    </div>
                    <div id="rosterPreview" style="font-size: 0.9em; color: #666; margin-top: 0.5rem;"></div>
                  </div>
                  <!-- 2. Questions & Answers Section (Expanded) -->
                  <div class="setup-unified-cell full-width">
                    <label style="display: block; margin-bottom: 0.5em; font-weight: 600;">
                      Questions & Answers:
                    </label>
                    <small style="display: block; margin-bottom: 0.5em; color: #666;">
                      Q on one line, A on next, blank line between pairs
                    </small>
                    <textarea
                      id="questionsInput"
                      placeholder="What city is home to Fenway Park?&#10;Boston&#10;&#10;What is the capital of France?&#10;Paris"
                      style="
                        width: 100%;
                        height: 120px;
                        padding: 0.75rem;
                        border: 2px solid #e2e8f0;
                        border-radius: 8px;
                        font-family: inherit;
                        font-size: 0.9rem;
                        resize: vertical;
                        min-height: 120px;
                      "
                    ></textarea>
                  </div>

                  <!-- 3. Question Order Section -->
                  <div class="setup-unified-cell">
                    <label style="display: block; margin-bottom: 0.5em; font-weight: 600;">
                      Question Order:
                    </label>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                      <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="radio" name="order" value="inorder" checked>
                        <span>In order</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="radio" name="order" value="random">
                        <span>Random</span>
                      </label>
                    </div>
                  </div>

                  <!-- 4. Select Quiz Section -->
                  <div class="setup-unified-cell">
                    <label style="display: block; margin-bottom: 0.5em; font-weight: 600;">
                      Choose a Quiz:
                    </label>
                    <div class="custom-quiz-dropdown-container" style="width: 100%">
                      <div id="customQuizDropdown" class="custom-quiz-dropdown">
                        --
                      </div>
                    </div>
                  </div>

                  <!-- 5. Game Options Row -->
                  <div class="setup-unified-cell">
                    <label style="display: block; margin-bottom: 0.5em; font-weight: 600;">
                      Number of Teams:
                    </label>
                    <select id="teamCountInput" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                      <option value="1">1 Team (Single Player)</option>
                      <option value="2" selected>2 Teams</option>
                      <option value="3">3 Teams</option>
                      <option value="4">4 Teams</option>
                      <option value="5">5 Teams</option>
                      <option value="6">6 Teams</option>
                    </select>
                  </div>

                  <!-- 6. Grid Size Section (Auto-adjusting) -->
                  <div class="setup-unified-cell">
                    <label style="display: block; margin-bottom: 0.5em; font-weight: 600;">
                      Grid Size:
                    </label>
                    <select id="gridSizeInput" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
                      <option>8</option>
                      <option>10</option>
                      <option>16</option>
                      <option selected>18</option>
                      <option>20</option>
                      <option>24</option>
                      <option>30</option>
                      <option>32</option>
                      <option>40</option>
                    </select>
                  </div>
                  
                  <!-- Point Configuration Section -->
                  <div class="setup-unified-cell full-width">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                      <div>
                        <label style="display:block; margin-bottom:0.3em; font-size:0.9em;">Individual Correct Answer:</label>
                        <input type="number" id="individualPoints" min="1" max="1000" value="100" style="width:100%;">
                      </div>
                      <div>
                        <label style="display:block; margin-bottom:0.3em; font-size:0.9em;">Team Victory Bonus:</label>
                        <input type="number" id="teamVictoryPoints" min="0" max="5000" value="500" style="width:100%;">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Start Game Button -->

            </form>
          </div>
          
          <!-- Special Effects Sidebar (Right) -->
          <div class="special-effects-sidebar" aria-label="Special Effects">
            <h3 class="special-effects-title">Special Effects</h3>
            <div class="special-effects-content">
              <div class="special-item-compact" style="width: 100%">
                <div
                  class="special-row"
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.7em;
                    min-width: 320px;
                  "
                >
                  <span
                    class="emoji-big"
                    style="
                      width: 48px;
                      display: inline-flex;
                      justify-content: center;
                    "
                    ></span
                  >
                  <b
                    style="
                      min-width: 90px;
                      max-width: 120px;
                      font-size: 1.05em;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      text-align: left;
                    "
                    >Tornado</b
                  >
                  <select
                    id="tornadoCount"
                    style="
                      width: 2.5em;
                      min-width: 2.5em;
                      max-width: 2.5em;
                      text-align: center;
                    "
                  >
                    <option>0</option>
                    <option>1</option>
                    <option selected>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                  </select>
                  <span
                    class="special-desc"
                    style="
                      margin-left: 0.5em;
                      font-size: 0.98em;
                      display: block;
                    "
                    >Steal points</span
                  >
                </div>
              </div>
              <div class="special-item-compact" style="width: 100%">
                <div
                  class="special-row"
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.7em;
                    min-width: 320px;
                  "
                >
                  <span
                    class="emoji-big"
                    style="
                      width: 48px;
                      display: inline-flex;
                      justify-content: center;
                    "
                    ></span
                  >
                  <b
                    style="
                      min-width: 90px;
                      max-width: 120px;
                      font-size: 1.05em;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      text-align: left;
                      line-height: 1.1;
                      margin: 0;
                      padding: 0;
                    "
                  >
                    <span style="margin: 0; padding: 0">Double</span
                    ><span style="margin: 0; padding: 0">Lion</span>
                  </b>
                  <select
                    id="doubleCount"
                    style="
                      width: 2.5em;
                      min-width: 2.5em;
                      max-width: 2.5em;
                      text-align: center;
                    "
                  >
                    <option>0</option>
                    <option>1</option>
                    <option selected>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                  </select>
                  <span
                    class="special-desc"
                    style="
                      margin-left: 0.5em;
                      font-size: 0.98em;
                      display: block;
                    "
                    >Double points</span
                  >
                </div>
              </div>
              <div class="special-item-compact" style="width: 100%">
                <div
                  class="special-row"
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.7em;
                    min-width: 320px;
                  "
                >
                  <span
                    class="emoji-big"
                    style="
                      width: 48px;
                      display: inline-flex;
                      justify-content: center;
                    "
                    ></span
                  >
                  <b
                    style="
                      min-width: 90px;
                      max-width: 120px;
                      font-size: 1.05em;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      text-align: left;
                    "
                    >Skunk</b
                  >
                  <select
                    id="loseCount"
                    style="
                      width: 2.5em;
                      min-width: 2.5em;
                      max-width: 2.5em;
                      text-align: center;
                    "
                  >
                    <option>0</option>
                    <option>1</option>
                    <option selected>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                  </select>
                  <span
                    class="special-desc"
                    style="
                      margin-left: 0.5em;
                      font-size: 0.98em;
                      display: block;
                      line-height: 2.1em;
                      vertical-align: middle;
                    "
                    >Lose all points</span
                  >
                </div>
              </div>
              <div class="special-item-compact" style="width: 100%">
                <div
                  class="special-row"
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.7em;
                    min-width: 320px;
                  "
                >
                  <span
                    class="emoji-big"
                    style="
                      width: 48px;
                      display: inline-flex;
                      justify-content: center;
                    "
                    ></span
                  >
                  <b
                    style="
                      min-width: 90px;
                      max-width: 120px;
                      font-size: 1.05em;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      text-align: left;
                      line-height: 1.1;
                    "
                  >
                    <span>Kangaroo</span><span>Hop</span><span>Swap</span>
                  </b>
                  <select
                    id="swapCount"
                    style="
                      width: 2.5em;
                      min-width: 2.5em;
                      max-width: 2.5em;
                      text-align: center;
                    "
                  >
                    <option>0</option>
                    <option>1</option>
                    <option selected>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                  </select>
                  <span
                    class="special-desc"
                    style="
                      margin-left: 0.5em;
                      font-size: 0.98em;
                      display: block;
                      line-height: 2.1em;
                      vertical-align: middle;
                    "
                    >Swap points</span
                  >
                </div>
              </div>
              
              <!-- New Special Items -->
              <div class="special-item-compact" style="width: 100%">
                <div
                  class="special-row"
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.7em;
                    min-width: 320px;
                  "
                >
                  <span
                    class="emoji-big"
                    style="
                      width: 48px;
                      display: inline-flex;
                      justify-content: center;
                    "
                    ></span
                  >
                  <b
                    style="
                      min-width: 90px;
                      max-width: 120px;
                      font-size: 1.05em;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      text-align: left;
                      line-height: 1.1;
                    "
                  >
                    <span>Shield</span>
                  </b>
                  <select
                    id="shieldCount"
                    style="
                      width: 2.5em;
                      min-width: 2.5em;
                      max-width: 2.5em;
                      text-align: center;
                    "
                  >
                    <option>0</option>
                    <option selected>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                  </select>
                  <span
                    class="special-desc"
                    style="
                      margin-left: 0.5em;
                      font-size: 0.98em;
                      display: block;
                      line-height: 2.1em;
                      vertical-align: middle;
                    "
                    >Block negative effects</span
                  >
                </div>
              </div>
              
              <div class="special-item-compact" style="width: 100%">
                <div
                  class="special-row"
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.7em;
                    min-width: 320px;
                  "
                >
                  <span
                    class="emoji-big"
                    style="
                      width: 48px;
                      display: inline-flex;
                      justify-content: center;
                    "
                    ></span
                  >
                  <b
                    style="
                      min-width: 90px;
                      max-width: 120px;
                      font-size: 1.05em;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      text-align: left;
                      line-height: 1.1;
                    "
                  >
                    <span>Hot Streak</span>
                  </b>
                  <select
                    id="hotStreakCount"
                    style="
                      width: 2.5em;
                      min-width: 2.5em;
                      max-width: 2.5em;
                      text-align: center;
                    "
                  >
                    <option>0</option>
                    <option selected>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                  </select>
                  <span
                    class="special-desc"
                    style="
                      margin-left: 0.5em;
                      font-size: 0.98em;
                      display: block;
                      line-height: 2.1em;
                      vertical-align: middle;
                    "
                    >Triple next answer</span
                  >
                </div>
              </div>
              
              <div class="special-item-compact" style="width: 100%">
                <div
                  class="special-row"
                  style="
                    display: flex;
                    align-items: center;
                    gap: 0.7em;
                    min-width: 320px;
                  "
                >
                  <span
                    class="emoji-big"
                    style="
                      width: 48px;
                      display: inline-flex;
                      justify-content: center;
                    "
                    ></span
                  >
                  <b
                    style="
                      min-width: 90px;
                      max-width: 120px;
                      font-size: 1.05em;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      text-align: left;
                      line-height: 1.1;
                    "
                  >
                    <span>Coin Flip</span>
                  </b>
                  <select
                    id="coinFlipCount"
                    style="
                      width: 2.5em;
                      min-width: 2.5em;
                      max-width: 2.5em;
                      text-align: center;
                    "
                  >
                    <option>0</option>
                    <option selected>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                  </select>
                  <span
                    class="special-desc"
                    style="
                      margin-left: 0.5em;
                      font-size: 0.98em;
                      display: block;
                      line-height: 2.1em;
                      vertical-align: middle;
                    "
                    >Double or lose points</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
        

            <!-- Start Game Button spanning both cards -->
            <div style="display: flex; justify-content: center; margin-top: 2rem;">
              <button
                id="startGameBtnBottom"
                class="purple-btn"
                style="width: 100%; max-width: 1060px; font-size: 1.7rem; padding: 0.8rem 0; font-weight: 800;"
              >
                Start Game
              </button>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>
 
        <!-- GAME SCREEN -->
    <div id="gameScreen" class="hidden">
      <!-- Remove the logo image from here -->
      <div id="specialPopup" class="special-popup hidden"></div>
      
      <!-- Unified Layout with Sidebar -->
      <div class="game-layout">
        <!-- Left Sidebar -->
        <div class="game-sidebar">
          <div class="sidebar-section">
            <h3>Teams & Scores</h3>
            <div id="teamScores" class="team-scores">
              <!-- Team scores will be dynamically generated here -->
            </div>
          </div>
          
          <div class="sidebar-section">
            <h3>Game Actions</h3>
            <div class="game-controls">
              <div class="control-buttons">
                <button id="resetButtonsBtn" class="btn btn-secondary" onclick="resetAllButtonStates()" title="Reset all buttons if they get stuck">Reset Buttons</button>
                <button id="endGameBtn" class="btn btn-danger" onclick="endGameAndAwardPoints()" title="End game and award points to roster">End Game</button>
              </div>
            </div>
          </div>
          
        </div>
        
        <!-- Main Game Area -->
        <div class="game-main">
          <!-- Game Status Bar -->
          <div id="gameStatusBar" style="background: white; border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <!-- Turn Indicator -->
            <div id="mainTurnDisplay" style="font-size: 1.2rem; font-weight: 600; color: #6f5c91; flex: 1; min-width: 200px;">
              <span id="currentTurnText">Team A's turn</span>
            </div>
            
            <!-- Game Controls -->
            <div id="mainGameControls" style="display: flex; gap: 0.5rem; align-items: center;">
              <button id="passBtn" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Pass</button>
              <button id="skipBtn" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Skip</button>
              <button id="nextQuestionBtn" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Next Question</button>
            </div>
            
            <!-- Team Scores -->
            <div id="mainTeamScores" style="display: flex; gap: 2rem; flex-wrap: wrap; align-items: center;">
              <!-- Team scores will be populated here -->
            </div>
          </div>
          
          <div id="grid" style="flex: 1 1 auto; display: grid; min-height: 400px; background: #f8f9fa; border-radius: 8px; padding: 1rem;"></div>
        </div>
      </div>

      <!-- New Question Modal -->
      <div id="questionModal" class="hidden" style="position:fixed;top:0;left:300px;right:0;height:100vh;background:rgba(49,114,122,0.9);z-index:2000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
        <div style="background:#fff;padding:3em 4em;border-radius:24px;max-width:800px;width:90%;box-shadow:0 12px 48px rgba(0,0,0,0.25);position:relative;text-align:center;">
          <!-- Close button (for emergencies) -->
          <button id="closeQuestionModal" style="position:absolute;top:15px;right:20px;background:none;border:none;font-size:2em;cursor:pointer;color:#6F5C91;opacity:0.7;">&times;</button>
          
          
          <!-- Question Display -->
          <div id="modalQuestion" style="font-size:2.5rem;font-weight:700;color:#6F5C91;margin-bottom:2em;line-height:1.3;min-height:120px;display:flex;align-items:center;justify-content:center;"></div>
          
          <!-- Answer Display (hidden initially) -->
          <div id="modalAnswer" style="font-size:2rem;font-weight:600;color:#31727a;margin-bottom:2.5em;line-height:1.3;min-height:80px;display:none;align-items:center;justify-content:center;font-style:italic;"></div>
          
          <!-- Action Buttons -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5em;margin-bottom:2em;">
            <button id="correctBtn" class="question-action-btn correct-btn">
              <span style="font-size:1.5em;"></span>
              <span>Correct!</span>
            </button>
            <button id="incorrectBtn" class="question-action-btn incorrect-btn">
              <span style="font-size:1.5em;"></span>
              <span>Incorrect</span>
            </button>
          </div>
          
          <!-- Secondary Action Buttons -->
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1em;">
            <button id="skipQuestionBtn" class="question-action-btn secondary-btn">
              <span style="font-size:1.3em;"></span>
              <span>Skip Question</span>
            </button>
            <button id="changeTeamsBtn" class="question-action-btn secondary-btn">
              <span style="font-size:1.3em;"></span>
              <span>Change Teams</span>
            </button>
            <button id="revealAnswerBtn" class="question-action-btn secondary-btn">
              <span style="font-size:1.3em;"></span>
              <span>Reveal Answer</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Old question display (keeping for now, will remove later) -->
      <div id="questionAnswerRow" style="display: none">
        <div id="questionBubble" class="bubble-left">
          <div id="question"></div>
          <div id="answer"></div>
        </div>
      </div>

      <footer
        class="game-footer-btns"
        style="
          width: 100%;
          background: #6f5c91;
          color: #fff;
          display: flex;
          flex-direction: row;
          align-items: center;
          justify-content: center;
          padding: 1.2rem 0 1.2rem 0;
          margin: 0;
          position: relative;
        "
      >
        <div style="display: flex; gap: 1.2rem; align-items: center">
          <button id="resetBtn">
            <span class="emoji"></span> Reset Game
          </button>
          <button id="homeBtn"><span class="emoji"></span> Home</button>
        </div>
        <div style="flex: 1 1 auto"></div>
        <div
          style="
            font-size: 1rem;
            opacity: 0.85;
            margin-left: 2rem;
            white-space: nowrap;
            padding-right: 2rem;
          "
        >
          Created by Timothy Piontek
        </div>
      </footer>
    </div>

    <!-- Remove duplicate tabbed interface below navbar and replace with a single #librarySection container -->
    <div
      id="librarySection"
      class="hidden library-section"
      style="max-width: 95vw; margin: 2rem auto 0 auto; padding: 0 1rem;"
    ></div>

    <!-- AUTH MODAL -->
    <div
      id="authModal"
      class="hidden"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(49, 114, 122, 0.85);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #fff;
          padding: 2.2em 2.5em;
          border-radius: 16px;
          max-width: 420px;
          width: 95vw;
          box-shadow: 0 4px 32px rgba(0, 0, 0, 0.18);
          position: relative;
        "
      >
        <button
          id="closeAuthModal"
          style="
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6f5c91;
          "
        >
          &times;
        </button>
        <div>
          <div id="authError" style="color: #e57373; margin-bottom: 1em"></div>
          <div style="display: flex; gap: 0.5em; margin-bottom: 1em">
            <button
              id="tabLogin"
              type="button"
              style="
                flex: 1;
                font-weight: 700;
                padding: 0.5em 0;
                background: #eee;
                border: none;
                border-radius: 6px 0 0 6px;
              "
            >
              Login
            </button>
            <button
              id="tabSignup"
              type="button"
              style="
                flex: 1;
                font-weight: 700;
                padding: 0.5em 0;
                background: #fff;
                border: none;
                border-radius: 0 6px 6px 0;
              "
            >
              Sign Up
            </button>
          </div>
          <form id="loginForm" style="display: block">
            <input
              id="loginEmail"
              type="email"
              placeholder="Email"
              required
              style="
                width: 100%;
                margin-bottom: 0.7em;
                padding: 0.7em;
                border-radius: 6px;
                border: 1px solid #ccc;
              "
            />
            <input
              id="loginPassword"
              type="password"
              placeholder="Password"
              required
              style="
                width: 100%;
                margin-bottom: 0.7em;
                padding: 0.7em;
                border-radius: 6px;
                border: 1px solid #ccc;
              "
            />
            <button
              type="submit"
              style="
                width: 100%;
                background: #6f5c91;
                color: #fff;
                font-weight: 700;
                border: none;
                border-radius: 6px;
                padding: 0.7em;
                font-size: 1.1em;
                cursor: pointer;
                margin-bottom: 0.7em;
              "
            >
              Login
            </button>
            <button
              type="button"
              id="googleLoginBtn"
              style="
                width: 100%;
                background: #fff;
                color: #6f5c91;
                font-weight: 700;
                border: 1px solid #6f5c91;
                border-radius: 6px;
                padding: 0.7em;
                font-size: 1.1em;
                cursor: pointer;
              "
            >
              Login with Google
            </button>
          </form>
          <form id="signupForm" style="display: none">
            <input
              id="signupEmail"
              type="email"
              placeholder="Email"
              required
              style="
                width: 100%;
                margin-bottom: 0.7em;
                padding: 0.7em;
                border-radius: 6px;
                border: 1px solid #ccc;
              "
            />
            <input
              id="signupPassword"
              type="password"
              placeholder="Password"
              required
              style="
                width: 100%;
                margin-bottom: 0.7em;
                padding: 0.7em;
                border-radius: 6px;
                border: 1px solid #ccc;
              "
            />
            <button
              type="submit"
              style="
                width: 100%;
                background: #6f5c91;
                color: #fff;
                font-weight: 700;
                border: none;
                border-radius: 6px;
                padding: 0.7em;
                font-size: 1.1em;
                cursor: pointer;
                margin-bottom: 0.7em;
              "
            >
              Sign Up
            </button>
          </form>
        </div>
      </div>
    </div>
    <!-- === END AUTH MODAL === -->

    <!-- Move Supabase CDN script and main script block to the end of <body> -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // === QUIZ PAGE ===
        // This is the dedicated quiz page - no game selection needed
        
        // Initialize quiz roster integration
        initializeQuizRosterIntegration();

        // === SUPABASE INIT ===
        const supabaseClient = supabase.createClient(
          "https://dmbbsrcwqpmdxqtzvtqj.supabase.co",
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYmJzcmN3cXBtZHhxdHp2dHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NDg1OTYsImV4cCI6MjA2MjMyNDU5Nn0.E7EYSLCFXMYw5f4Wv7EXXj7-5yAT__BoYXklDB4uE2w"
        );

        // Show navigation for quiz page
        document.getElementById('mainNav').style.display = 'flex';

        // // Debug: Log session on page load
        // supabaseClient.auth.getUser().then(({ data: { user }, error }) => {
        //   console.log('[DEBUG] On page load, supabaseClient.auth.getUser:', user, error);
        // });

        // === FOLDER MANAGEMENT ===
        let myLibraryFolders = [];

        function loadMyLibraryFolders() {
          const stored = localStorage.getItem("myLibraryFolders");
          myLibraryFolders = stored ? JSON.parse(stored) : [];
        }

        function saveMyLibraryFolders() {
          localStorage.setItem(
            "myLibraryFolders",
            JSON.stringify(myLibraryFolders)
          );
        }

        // Load folders immediately
        loadMyLibraryFolders();

        // === DOM REFS ===
        const setupScreen = document.getElementById("setupScreen");
        const gameScreen = document.getElementById("gameScreen");
        const myLibraryLink = document.getElementById("myLibraryLink");
        const publicLibraryLink = document.getElementById("publicLibraryLink");
        const librarySection = document.getElementById("librarySection");
        const startBtnBottom = document.getElementById("startGameBtnBottom");
        const resetBtn = document.getElementById("resetBtn");
        const passBtn = document.getElementById("passBtn");
        const skipBtn = document.getElementById("skipBtn");
        const revealBtn = document.getElementById("revealBtn");
        let gridEl = document.getElementById("grid");
        const annA = document.getElementById("annA");
        const annB = document.getElementById("annB");
        const nameAEl = document.getElementById("nameA");
        const nameBEl = document.getElementById("nameB");
        const scoreAEl = document.getElementById("scoreA");
        const scoreBEl = document.getElementById("scoreB");
        const turnEl = document.getElementById("turnDisplay");
        const questionEl = document.getElementById("question");
        const answerEl = document.getElementById("answer");
        const specialPopup = document.getElementById("specialPopup");
        const teamBNameInput = document.getElementById("teamBNameInput");
        const singlePlayerCheckbox = document.getElementById(
          "singlePlayerCheckbox"
        );
        const androidImg = document.getElementById("androidImg");
        const teamBNameContainer =
          document.getElementById("teamBNameContainer");
        const quizSelect = document.getElementById("quizSelect");
        const questionsInput = document.getElementById("questionsInput");

        // === LIBRARY SECTION LOGIC ===
        // Helper: get current user
        async function getCurrentUser() {
          const {
            data: { user },
          } = await supabaseClient.auth.getUser();
          return user;
        }

        function getQuizControlsHTML(folders = [], isPublic = false) {
          return `
            <button id="createQuizBtn" is_public="${isPublic}" class="purple-btn" style="margin:1em auto 1em auto;">+ Create Quiz</button>
            <div id="createQuizModal" is_public="${isPublic}" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(49,114,122,0.85);z-index:3000;display:none;align-items:center;justify-content:center;">
              <div style="background:#fff;padding:2.2em 2.5em;border-radius:16px;max-width:420px;width:95vw;box-shadow:0 4px 32px rgba(0,0,0,0.18);position:relative;">
                <button id="closeCreateQuizModal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#6F5C91;">&times;</button>
                <h3 style="margin-top:0;">Create a New Quiz</h3>
                <form id="createQuizForm">
                  <label>Title:<br><input id="quizTitleInput" required maxlength="60" style="width:100%;margin-bottom:0.7em;"></label>
                  <label>Category:<br>
                    <select id="quizCategorySelect" style="width:100%;margin-bottom:0.7em;"></select>
                  </label>
                  <div id="newCategoryContainer" class="hidden" style="margin-bottom:0.7em;">
                    <input id="newCategoryInput" placeholder="New category name" maxlength="32" style="width:100%;">
                  </div>
                  <label>Folder:<br>
                    <select id="quizFolderSelect" style="width:100%;margin-bottom:0.7em;">
                      <option value="">Uncategorized</option>
                      ${folders
                        .map((f) => `<option value="${f}">${f}</option>`)
                        .join("")}
                    </select>
                  </label>
                 ${
                   !isPublic &&
                   `<label style="display:flex;align-items:center;gap:0.5em;margin-bottom:0.7em;">
                    <input type="checkbox" id="quizIsPublicInput">
                    <span>Publish to Play Tornado Library</span>
                  </label>`
                 }
                <label>Q&A:<br>
                  <textarea id="quizQuestionsInput" required placeholder="Enter questions and answers in one of these formats:\n\nFormat 1 (with answers):\nWhat is the capital of France?\nParis\n\nWhat is 2+2?\n4\n\nFormat 2 (questions only):\nWhat is the capital of France?\nWhat is 2+2?\nWhat is the largest planet in our solar system?" style="width:100%;height:120px;margin-bottom:0.7em;"></textarea>
                </label>
                  <div style="display:flex;gap:0.7em;margin-bottom:1em;">
                    <button type="submit" class="purple-btn" style="flex:1;">Create Quiz</button>
                  </div>
                  <div id="createQuizError" style="color:#e57373;margin-top:0.7em;"></div>
                  <div id="quizPreview" class="hidden" style="margin-top:1em;padding:1em;background:#f9f9f9;border-radius:8px;"></div>
                </form>
              </div>
            </div>
            <button id="createFolderBtn" is_public="${isPublic}" class="purple-btn" style="margin-bottom:1.2em;">+ Create Folder</button>
          `;
        }

        // Refactored renderPublicLibrary
        async function renderPublicLibrary() {
          librarySection.innerHTML =
            "<h2>Play Tornado Library</h2><div>Loading public quizzes...</div>";
          const user = await getCurrentUser();
          const isAdminUser =
            user &&
            (user?.email === "piontek.timothy@gmail.com" ||
              user?.email === "piontek.timothyhb@gmail.com");
          try {
            // Try to fetch from database first
            let { data: quizLibrary, error } = await supabaseClient
              .from("quizzes")
              .select("*")
              .eq("is_public", true)
              .order("title", { ascending: true }); // Sort by title A-Z
            
            if (error) {
              console.error("Database error, using fallback quizzes:", error);
              quizLibrary = fallbackQuizzes;
            }
            
            if (!quizLibrary || quizLibrary.length === 0) {
              quizLibrary = fallbackQuizzes;
            }
            // Group quizzes by category, then by folder
            const categories = {};
            quizLibrary.forEach((quiz, i) => {
              const cat = quiz.category || "Other";
              const folder = quiz.folder || null;
              if (!categories[cat]) categories[cat] = { folders: {}, root: [] };
              if (folder) {
                if (!categories[cat].folders[folder])
                  categories[cat].folders[folder] = [];
                categories[cat].folders[folder].push({ ...quiz, index: i });
              } else {
                categories[cat].root.push({ ...quiz, index: i });
              }
            });
            
            // Sort quizzes within each category/folder by title (A-Z)
            Object.keys(categories).forEach(cat => {
              // Sort root quizzes by title
              categories[cat].root.sort((a, b) => a.title.localeCompare(b.title));
              
              // Sort quizzes within each folder by title
              Object.keys(categories[cat].folders).forEach(folder => {
                categories[cat].folders[folder].sort((a, b) => a.title.localeCompare(b.title));
              });
            });
            
            // Build folder UI
            let html =
              '<div id="publicLibraryList" style="width:100%;max-width:700px;text-align:left;margin:0 auto;">';
            html += '<div style="text-align:center;margin-bottom:1.5em;color:#666;font-size:0.9em;"> Quizzes sorted alphabetically by title</div>';
            Object.keys(categories)
              .sort((a, b) => a.localeCompare(b))
              .forEach((cat) => {
                html += `<details style="margin-bottom:1.2em;">
              <summary style="font-size:1.2em;font-weight:700;cursor:pointer;background:#eee;padding:0.6em 1em;border-radius:8px;">${cat}</summary>
              <ul style="list-style:none;padding-left:1.2em;">`;
                // Folders first
                const folderNames = Object.keys(categories[cat].folders).sort(
                  (a, b) => a.localeCompare(b)
                );
                folderNames.forEach((folder) => {
                  html += `<details style="margin-bottom:0.7em;">
                <summary style="font-size:1.08em;font-weight:600;cursor:pointer;background:#f6f6f6;padding:0.4em 1em;border-radius:6px;">${folder}</summary>
                <ul style="list-style:none;padding-left:1.2em;">`;
                  categories[cat].folders[folder].forEach((quiz) => {
                    html += `<li style="margin-bottom:0.5em;display:flex;align-items:center;justify-content:space-between;">
                  <div style='flex:1;min-width:0;'>
                    <a href="#quiz-${
                      quiz.id
                    }" style="font-weight:bold;text-decoration:underline;cursor:pointer;">${
                      quiz.title
                    }</a>
                    <span style="color:#888;font-size:0.95em;">(${
                      quiz.questions && quiz.questions.length
                        ? quiz.questions.length
                        : 0
                    } questions)</span>
                  </div>
                  <div style='display:flex;gap:0.5em;'>
                    <button class="purple-btn play-btn" data-quizid="${
                      quiz.id
                    }">Play</button> 
                   ${
                     isAdminUser
                       ? `<button class="purple-btn delete-quiz-btn" is_owner="${
                           quiz.owner === user?.id
                         }" is_public='true' data-quizid="${
                           quiz.id
                         }">Delete</button>`
                       : ""
                   }
                    <button class="purple-btn add-to-my-lib" data-quizid="${
                      quiz.id
                    }">Add to My Library</button>
                  </div>
                </li>`;
                  });
                  html += "</ul></details>";
                });
                // Quizzes not in a folder
                categories[cat].root.forEach((quiz) => {
                  html += `<li style="margin-bottom:0.5em;display:flex;align-items:center;justify-content:space-between;">
                <div style='flex:1;min-width:0;'>
                  <a href="#quiz-${
                    quiz.id
                  }" style="font-weight:bold;text-decoration:underline;cursor:pointer;">${
                    quiz.title
                  }</a>
                  <span style="color:#888;font-size:0.95em;">(${
                    quiz.questions && quiz.questions.length
                      ? quiz.questions.length
                      : 0
                  } questions)</span>
                </div>
                <div style='display:flex;gap:0.5em;'>
                 <button class="purple-btn play-btn" data-quizid="${
                   quiz.id
                 }">Play</button>
                 ${
                   isAdminUser
                     ? `<button class="purple-btn delete-quiz-btn" is_owner="${
                         quiz.owner === user?.id
                       }" is_public='true' data-quizid="${
                         quiz.id
                       }">Delete</button>`
                     : ""
                 }
                  <button class="purple-btn add-to-my-lib" data-quizid="${
                    quiz.id
                  }">Add to My Library</button>
                </div>
              </li>`;
                });
                html += "</ul></details>";
              });
            html += "</div>";
            librarySection.innerHTML = `
            <h2>Play Tornado Library</h2>
            ${isAdminUser ? getQuizControlsHTML(myLibraryFolders, true) : ""}
            ${html}
          `;
          } catch (err) {
            console.log(err, "public quiz error");
            librarySection.innerHTML =
              '<div style="color:red;">Error loading public quizzes.</div>';
          }
        }
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("play-btn")) {
            const id = e.target.getAttribute("data-quizid");
            if (id && window.startQuizFromLibrary) {
              window.startQuizFromLibrary(id);
            }
          }
        });
        document.addEventListener("click", (e) => {
          if (e.target.id === "createFolderBtn") {
            const is_public = e.target.getAttribute("is_public") === "true";
            showCreateFolderModal(is_public);
          }
        });

        document.addEventListener("click", (e) => {
          if (e.target.id === "closeCreateQuizModal") {
            document.getElementById("createQuizModal").style.display = "none";
          }
        });

        document.addEventListener("click", (e) => {
          if (e.target.id === "createQuizBtn") {
            const is_public = e.target.getAttribute("is_public") === "true";
            openCreateQuizModal(is_public); // or just call openCreateQuizModal() if false case doesn't need argument
          }
        });

        document.addEventListener("click", (e) => {
          if (e.target.id === "createQuizModal") {
            // If user clicks outside the modal content
            if (e.target === document.getElementById("createQuizModal")) {
              document.getElementById("createQuizModal").style.display = "none";
            }
          }
        });
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("delete-quiz-btn")) {
            const id = e.target.getAttribute("data-quizid");
            const is_public = e.target.getAttribute("is_public") === "true";
            const is_owner = e.target.getAttribute("is_owner") === "true";

            if (id && window.deleteQuiz) {
              window.deleteQuiz(id, is_public, is_owner);
            }
          }
        });

        document.addEventListener("click", async (e) => {
          if (e.target.classList.contains("add-to-my-lib")) {
            const quizId = e.target.getAttribute("data-quizid");
            if (quizId && window.saveQuizToMyLibrary) {
              window.saveQuizToMyLibrary(quizId);
            }
          }
        });

        // New: Render Quiz Detail Page
        async function renderQuizDetailPage(quizId) {
          console.log("quizDetailPage", quizId);
          librarySection.innerHTML = "<h2>Loading quiz...</h2>";
          let { data: quiz, error } = await supabaseClient
            .from("quizzes")
            .select("*")
            .eq("id", quizId)
            .single();

          if (!quiz) {
            librarySection.innerHTML =
              '<div style="color:red;">Quiz not found.</div>';
            return;
          }
          let html = `<div style='max-width:700px;margin:0 auto;'>
          <h2>${quiz.title}</h2>
          <div style='margin-bottom:1em;color:#888;'>${
            quiz.category || ""
          } &mdash; ${
            quiz.questions && quiz.questions.length ? quiz.questions.length : 0
          } questions</div>
          <div style='display:flex;gap:0.5em;margin-bottom:1.5em;'>
            <button class="purple-btn play-btn" data-quizid="${
              quiz.id
            }">Play</button> 
            <button class="purple-btn add-to-my-lib" data-quizid="${
              quiz.id
            }">Add to My Library</button>
            <button class="purple-btn" onclick="navigator.clipboard.writeText(window.location.href)">Share</button>
          </div>
          <ol style='background:#f9f9f9;padding:1.2em 1.5em;border-radius:10px;'>`;
          quiz.questions.forEach((q, i) => {
            html += `<li style='margin-bottom:1em;'><b>Q:</b> ${
              q.question
            }<br><b>A:</b> ${q.answer || ""}</li>`;
          });
          html += "</ol></div>";
          librarySection.innerHTML = html;
        }

        // Render My Library (user's quizzes)
        async function renderMyLibrary() {
          console.log("[DEBUG] renderMyLibrary called");
          loadMyLibraryFolders();
          const user = await getCurrentUser();
          if (!user) {
            librarySection.innerHTML =
              '<h2>My Library</h2><div style="color:#e57373;">Please log in to view your library.</div>';
            return;
          }
          // Add Create Folder button
          librarySection.innerHTML = `
          <h2>My Library</h2>
          ${getQuizControlsHTML(myLibraryFolders)}
          <div id="myLibraryList">Loading your quizzes...</div>
        `;

          // ... rest of createQuizBtn/modal logic ...
          // Fetch quizzes
          let { data: createdQuizzes, error: createdError } =
            await supabaseClient
              .from("quizzes")
              .select("*")
              .eq("owner", user.id)
              .order("title", { ascending: true }); // Sort by title A-Z

          if (createdError) {
            document.getElementById("myLibraryList").innerHTML =
              '<div style="color:red;">Error loading your quizzes.</div>';
            return;
          }

          // Step 2: Get quizzes saved via user_quiz_links (join with quizzes)
          let { data: linkedQuizzes, error: linkedError } = await supabaseClient
            .from("user_quiz_links")
            .select("quiz_id, quizzes(*)")
            .eq("user_id", user.id);

          if (linkedError) {
            document.getElementById("myLibraryList").innerHTML =
              '<div style="color:red;">Error loading your saved quizzes.</div>';
            return;
          }

          // Normalize linked quiz data
          const savedQuizzes = linkedQuizzes
            .map((link) => link.quizzes)
            .filter(Boolean); // remove nulls if any

          // Merge created and saved quizzes (optional: filter duplicates if needed)
          const allQuizzes = [...createdQuizzes, ...savedQuizzes];

          // Optionally remove duplicates by quiz ID (in case saved their own quiz)
          const uniqueQuizzes = Object.values(
            allQuizzes.reduce((acc, quiz) => {
              acc[quiz.id] = quiz;
              return acc;
            }, {})
          );

          if (!uniqueQuizzes || uniqueQuizzes.length === 0) {
            document.getElementById("myLibraryList").innerHTML =
              "<div>You have no quizzes yet.</div>";
            return;
          }
          // Group quizzes by folder
          const folderGroups = {};
          myLibraryFolders.forEach((f) => (folderGroups[f] = []));
          folderGroups["Uncategorized"] = [];
          uniqueQuizzes.forEach((q) => {
            if (q.folder && myLibraryFolders.includes(q.folder)) {
              folderGroups[q.folder].push(q);
            } else {
              folderGroups["Uncategorized"].push(q);
            }
          });
          
          // Sort quizzes within each folder by title (A-Z)
          Object.keys(folderGroups).forEach(folder => {
            folderGroups[folder].sort((a, b) => a.title.localeCompare(b.title));
          });
          
          // Render folders (collapsible), always show all folders
          let html = "";
          Object.keys(folderGroups).forEach((folder) => {
            html += `<details open style="margin-bottom:1.2em;" class="folder-dropzone" data-folder="${folder}">
            <summary style="font-size:1.1em;font-weight:700;cursor:pointer;background:#eee;padding:0.5em 1em;border-radius:8px;display:flex;justify-content:space-between;align-items:center;">
              <span>${folder}</span>
              ${
                folder !== "Uncategorized"
                  ? `<button class="delete-folder-btn" data-folder="${folder}" style="background:none;border:none;color:#e57373;cursor:pointer;font-size:1.2em;padding:0 0.5em;"></button>`
                  : ""
              }
            </summary>
            <ul style="list-style:none;padding-left:1.2em;">`;
            if (folderGroups[folder].length === 0) {
              html += `<li style='color:#888;font-size:0.98em;margin-bottom:0.7em;'>No quizzes in this folder.</li>`;
            }
            folderGroups[folder].forEach((quiz) => {
              const dropdownId = `moveFolderDropdown-${quiz.id}`;
              html += `<li style="background:#fff;border-radius:10px;padding:1.2em;margin-bottom:1em;box-shadow:0 2px 8px rgba(0,0,0,0.07);text-align:left;" draggable="true" data-quizid="${
                quiz.id
              }">
              <a href="#myquiz-${
                quiz.id
              }" style="font-weight:bold;text-decoration:underline;cursor:pointer;">${
                quiz.title
              }</a> <span style="color:#888;font-size:0.95em;">(${
                quiz.category || "Uncategorized"
              })</span><br>
              <span style="font-size:0.95em;color:#888;">${
                quiz.questions
                  ? Array.isArray(quiz.questions)
                    ? quiz.questions.length
                    : Object.keys(quiz.questions).length
                  : 0
              } questions</span>
              <div style="margin-top:0.7em;display:flex;gap:1em;align-items:center;">
                <button class="purple-btn play-btn" data-quizid="${
                  quiz.id
                }">Play</button>
                <button class="purple-btn publish-btn" data-quizid="${
                  quiz.id
                }">Publish to Play Tornado Library</button>
                <button class="purple-btn edit-btn" data-quizid="${
                  quiz.id
                }">Edit</button>
                <button class="purple-btn delete-quiz-btn" is_owner="${
                  quiz.owner === user?.id
                }" is_public="false"   data-quizid="${quiz.id}">Delete</button>
                <select class="move-folder-dropdown" id="${dropdownId}" data-quizid="${
                quiz.id
              }" style="margin-left:1em;">
                  <option value="">Select folder...</option>
                  ${myLibraryFolders
                    .map(
                      (f) =>
                        `<option value="${f}"${
                          quiz.folder === f ? " selected" : ""
                        }>${f}</option>`
                    )
                    .join("")}
                  <option value="Uncategorized"${
                    !quiz.folder ? " selected" : ""
                  }>Uncategorized</option>
                </select>
                <button class="purple-btn move-btn" data-quizid="${
                  quiz.id
                }" data-dropdownid="${dropdownId}" style="padding:6px 16px;font-size:1em;">Move</button>
              </div>
            </li>`;
            });
            html += "</ul></details>";
          });
          document.getElementById("myLibraryList").innerHTML = html;

          // Attach event listeners for Move, Play, Publish, Edit, Delete after rendering
          const myLibraryList = document.getElementById("myLibraryList");
          if (myLibraryList) {
            // Move button
            myLibraryList.querySelectorAll(".move-btn").forEach((btn) => {
              btn.onclick = async function () {
                const quizId = btn.getAttribute("data-quizid");
                const dropdownId = btn.getAttribute("data-dropdownid");
                const sel = document.getElementById(dropdownId);
                if (!sel) {
                  console.log("Dropdown not found for quiz", quizId);
                  return;
                }
                const folder = sel.value;
                console.log("Move button clicked:", { quizId, folder });
                const { error } = await supabaseClient
                  .from("quizzes")
                  .update({
                    folder: folder === "Uncategorized" ? null : folder,
                  })
                  .eq("id", quizId);
                if (error) {
                  console.error("Supabase update error:", error);
                  alert("Error moving quiz: " + error.message);
                } else {
                  console.log("Quiz moved successfully");
                  await renderMyLibrary();
                }
              };
            });
            // Drag-and-drop support
            myLibraryList
              .querySelectorAll('li[draggable="true"]')
              .forEach((li) => {
                li.ondragstart = function (e) {
                  e.dataTransfer.setData(
                    "text/plain",
                    li.getAttribute("data-quizid")
                  );
                  li.style.opacity = "0.5";
                  console.log("Drag start:", li.getAttribute("data-quizid"));
                };
                li.ondragend = function (e) {
                  li.style.opacity = "1";
                };
              });
            myLibraryList
              .querySelectorAll(".folder-dropzone")
              .forEach((folderEl) => {
                folderEl.ondragover = function (e) {
                  e.preventDefault();
                  folderEl.style.background = "#e6e6fa";
                };
                folderEl.ondragleave = function (e) {
                  folderEl.style.background = "";
                };
                folderEl.ondrop = async function (e) {
                  e.preventDefault();
                  folderEl.style.background = "";
                  const quizId = e.dataTransfer.getData("text/plain");
                  const folder = folderEl.getAttribute("data-folder");
                  console.log("Drop event:", { quizId, folder });
                  const { error } = await supabaseClient
                    .from("quizzes")
                    .update({
                      folder: folder === "Uncategorized" ? null : folder,
                    })
                    .eq("id", quizId);
                  if (error) {
                    console.error("Supabase update error:", error);
                    alert("Error moving quiz: " + error.message);
                  } else {
                    console.log("Quiz moved successfully (drag-and-drop)");
                    await renderMyLibrary();
                  }
                };
              });

            myLibraryList.querySelectorAll(".publish-btn").forEach((btn) => {
              btn.onclick = () =>
                window.publishQuizToPublic &&
                window.publishQuizToPublic(btn.getAttribute("data-quizid"));
            });
            myLibraryList.querySelectorAll(".edit-btn").forEach((btn) => {
              btn.onclick = () =>
                window.editQuiz &&
                window.editQuiz(btn.getAttribute("data-quizid"));
            });
          }

          // Add delete folder functionality
          myLibraryList
            .querySelectorAll(".delete-folder-btn")
            .forEach((btn) => {
              btn.onclick = async function (e) {
                e.stopPropagation(); // Prevent folder from toggling
                const folder = btn.getAttribute("data-folder");
                if (
                  !confirm(
                    `Are you sure you want to delete the folder "${folder}"? All quizzes in this folder will be moved to Uncategorized.`
                  )
                ) {
                  return;
                }
                // Move all quizzes in this folder to Uncategorized
                const { error } = await supabaseClient
                  .from("quizzes")
                  .update({ folder: null })
                  .eq("folder", folder);
                if (error) {
                  alert("Error moving quizzes: " + error.message);
                  return;
                }
                // Remove folder from myLibraryFolders
                myLibraryFolders = myLibraryFolders.filter((f) => f !== folder);
                saveMyLibraryFolders();
                await renderMyLibrary();
              };
            });
        }

        // Expose actions globally for inline onclick
        window.startQuizFromLibrary = async function (quizId) {
          console.log("quizId:", quizId);
          window.scrollTo(0, 0);
          if (!quizId) return alert("Quiz ID is required.");
          
          // Show game options modal for library quizzes
          showGameOptionsModalFromLibrary(quizId);
        };
        window.saveQuizToMyLibrary = async function (quizId) {
          console.log(quizId, "quizId");

          const user = await getCurrentUser();
          console.log(user, "test");

          if (!user) {
            alert("Please log in to save quizzes.");
            return;
          }

          // Step 1: Check if user is the creator of the quiz
          const { data: quiz, error: quizFetchError } = await supabaseClient
            .from("quizzes")
            .select("id, owner")
            .eq("id", quizId)
            .maybeSingle();

          if (quizFetchError) {
            alert("Error checking quiz ownership: " + quizFetchError.message);
            return;
          }

          if (quiz?.owner === user.id) {
            alert("You created this quiz. It's already in your library.");
            return;
          }

          // Step 2: Check if it's already saved in user_quiz_links
          const { data: existing, error: linkFetchError } = await supabaseClient
            .from("user_quiz_links")
            .select("id")
            .eq("user_id", user.id)
            .eq("quiz_id", quizId)
            .maybeSingle();

          if (linkFetchError) {
            alert("Error checking saved quizzes: " + linkFetchError.message);
            return;
          }

          if (existing) {
            alert("This quiz is already in your library.");
            return;
          }

          // Step 3: Save the quiz to the user's library
          const { error, data } = await supabaseClient
            .from("user_quiz_links")
            .insert([{ user_id: user.id, quiz_id: quizId }]);

          console.log(data, "response");

          if (error) {
            alert("Error saving quiz: " + error.message);
          } else {
            alert("Quiz saved to your library!");
            showLibrary("my");
          }
        };

        window.publishQuizToPublic = async function (quizId) {
          // Get quiz from Supabase
          const { data, error } = await supabaseClient
            .from("quizzes")
            .select("*")
            .eq("id", quizId)
            .single();
          if (error || !data) {
            alert("Error: Quiz not found.");
            return;
          }
          if (data.is_public) {
            alert("This quiz is already public.");
            return;
          }
          // Mark as public in DB
          const { data: response, error: updateError } = await supabaseClient
            .from("quizzes")
            .update({ is_public: true })
            .eq("id", quizId);

          if (updateError) {
            alert("Error publishing quiz: " + updateError.message);
            return;
          }
          alert("Quiz published successfully!"); // <-- Success alert
          try {
            showLibrary("public");
          } catch (e) {
            alert("Error refreshing public library: " + e.message);
          }
        };

        window.editQuiz = function (quizId) {
          alert("TODO: Edit quiz with ID: " + quizId);
          // You can implement quiz editing logic here
        };
        // Delete quiz function
        window.deleteQuiz = async function (quizId, is_public, is_owner) {
          const user = await getCurrentUser();
          if (!user) {
            alert("Please log in first.");
            return;
          }

          if (!confirm("Are you sure you want to delete this quiz?")) return;

          console.log({ quizId, is_public, is_owner });

          if (is_owner) {
            // Delete quiz from quizzes table
            const { data, error } = await supabaseClient
              .from("quizzes")
              .delete()
              .eq("id", quizId);
            if (error) {
              alert("Error deleting quiz: " + error.message);
              return;
            }

            // Optional: clean up links
            await supabaseClient
              .from("user_quiz_links")
              .delete()
              .eq("quiz_id", quizId);
          } else {
            if (is_public) {
              const { data: response, error: updateError } =
                await supabaseClient
                  .from("quizzes")
                  .update({ is_public: false })
                  .eq("id", quizId);
            } else {
              const { error } = await supabaseClient
                .from("user_quiz_links")
                .delete()
                .eq("user_id", user.id)
                .eq("quiz_id", quizId);

              if (error) {
                alert("Error removing quiz from library: " + error.message);
                return;
              }
            }
          }

          alert("Quiz deleted.");

          // Refresh the correct section
          is_public ? renderPublicLibrary() : renderMyLibrary();
        };

        // Show/hide library section and main screens
        function showLibrary(which) {
          hideGameAndSetUpScreen();
          if (which === "my") {
            renderMyLibrary();
            window.location.hash = "#my-library";
          } else if (which === "public") {
            renderPublicLibrary();
            window.location.hash = "#public-library";
          }
        }
        function hideLibraryScreen() {
          librarySection.classList.add("hidden");
          setupScreen.classList.remove("hidden");
          gameScreen.classList.add("hidden"); // Ensure game screen is hidden
          
          // Restore the Start Game button visibility when returning to setup
          const startGameBtn = document.getElementById("startGameBtnBottom");
          if (startGameBtn) {
            startGameBtn.style.display = "block";
            console.log("Start Game button restored via hideLibraryScreen");
          }
        }

        // Navbar link handlers
        myLibraryLink.onclick = function (e) {
          e.preventDefault();
          showLibrary("my");
        };
        publicLibraryLink.onclick = function (e) {
          e.preventDefault();
          showLibrary("public");
        };
        // Home link returns to main page
        document.getElementById("logoTitleHome").onclick = function (e) {
          e.preventDefault();
          window.location.href = '/';
        };
        function hideGameAndSetUpScreen() {
          setupScreen.classList.add("hidden");
          gameScreen.classList.add("hidden");
          librarySection.classList.remove("hidden");
        }

        // Hash-based navigation
        function handleHash() {
          console.log("first hash change", window.location.hash);

          if (window.location.hash.startsWith("#quiz-")) {
            hideGameAndSetUpScreen();
            const quizId = window.location.hash.replace("#quiz-", "");
            renderQuizDetailPage(quizId);
          } else if (window.location.hash.startsWith("#myquiz-")) {
            hideGameAndSetUpScreen();
            const quizId = window.location.hash.replace("#myquiz-", "");
            renderMyQuizDetailPage(quizId);
          } else if (window.location.hash === "#my-library") {
            showLibrary("my");
          } else if (window.location.hash === "#public-library") {
            showLibrary("public");
          } else if (window.location.hash === "#how-to-play") {
            hideGameAndSetUpScreen();
            renderHowToPlayPage();
          } else {
            console.log("first", "hash is empty or not recognized");
            hideLibraryScreen();
          }
        }

        window.addEventListener("hashchange", handleHash);
        handleHash();

        // Re-render My Library on auth state change
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
          console.log(session.user, "session user");
          const hash = window.location.hash;
          if (hash.includes("my-library")) {
            await showLibrary("my");
          } else if (hash.includes("public-library")) {
            await showLibrary("public");
          }
        });

        // === AUTH MODAL LOGIC ===
        function showAuthModal() {
          const modal = document.getElementById("authModal");
          modal.style.display = "flex";
          modal.classList.remove("hidden");
          const authError = document.getElementById("authError");
          if (authError) authError.textContent = "";
        }
        function hideAuthModal() {
          const modal = document.getElementById("authModal");
          modal.style.display = "none";
          modal.classList.add("hidden");
        }
        var loginBtn =
          document.getElementById("loginLogoutBtn") ||
          document.getElementById("loginBtn");
        if (loginBtn) {
          loginBtn.onclick = function () {
            if (loginBtn.textContent === "Login") {
              showAuthModal();
            } else {
              supabaseClient.auth.signOut();
            }
          };
        }
        if (document.getElementById("closeAuthModal")) {
          document.getElementById("closeAuthModal").onclick = hideAuthModal;
        }
        if (document.getElementById("authModal")) {
          document.getElementById("authModal").onclick = function (e) {
            if (e.target === this) hideAuthModal();
          };
        }

        // === TAB LOGIC ===
        const tabLogin = document.getElementById("tabLogin");
        const tabSignup = document.getElementById("tabSignup");
        const loginForm = document.getElementById("loginForm");
        const signupForm = document.getElementById("signupForm");
        if (tabLogin) {
          tabLogin.onclick = function () {
            tabLogin.style.background = "#eee";
            tabSignup.style.background = "#fff";
            loginForm.style.display = "block";
            signupForm.style.display = "none";
            document.getElementById("authError").textContent = "";
          };
        }
        if (tabSignup) {
          tabSignup.onclick = function () {
            tabLogin.style.background = "#fff";
            tabSignup.style.background = "#eee";
            loginForm.style.display = "none";
            signupForm.style.display = "block";
            document.getElementById("authError").textContent = "";
          };
        }
        // Default to login tab
        if (tabLogin) tabLogin.click();

        // === LOGIN FORM ===
        if (loginForm)
          loginForm.onsubmit = async function (e) {
            e.preventDefault();
            const email = document.getElementById("loginEmail").value.trim();
            const password = document.getElementById("loginPassword").value;

            const { data, error } =
              await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
              document.getElementById("authError").textContent = error.message;
              return;
            }
          };
        // === SIGNUP FORM ===
        if (signupForm)
          signupForm.onsubmit = async function (e) {
            e.preventDefault();
            const email = document.getElementById("signupEmail").value.trim();
            const password = document.getElementById("signupPassword").value;
            let { error } = await supabaseClient.auth.signUp({
              email,
              password,
            });
            if (error) {
              document.getElementById("authError").textContent = error.message;
              return;
            }
            document.getElementById("authError").textContent =
              "Check your email to confirm your account!";
          };
        // === GOOGLE LOGIN ===
        if (document.getElementById("googleLoginBtn")) {
          document.getElementById("googleLoginBtn").onclick =
            async function () {
              const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: "google",
                options: { redirectTo: window.location.origin },
              });
              if (error)
                document.getElementById("authError").textContent =
                  error.message;
            };
        }

        // === LOGIN BUTTON STATE ===
        async function updateLoginBtn() {
          const {
            data: { user },
          } = await supabaseClient.auth.getUser();
          const btn = document.getElementById("loginLogoutBtn");
          if (!btn) return;
          if (user) {
            btn.textContent = "Logout";
            btn.style.background = "#fff";
            btn.style.color = "#e57373";
            btn.title = user.email || "";
          } else {
            btn.textContent = "Login";
            btn.style.background = "#fff";
            btn.style.color = "#6F5C91";
            btn.title = "";
          }
        }
        // updateLoginBtn();
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
          const btn = document.getElementById("loginLogoutBtn");
          if (event === "SIGNED_IN") {
            hideAuthModal();
            const user = session.user;
            if (user && btn) {
              btn.textContent = "Logout";
              btn.style.background = "#fff";
              btn.style.color = "#e57373";
              btn.title = user.email || "";
            }
          } else if (event === "SIGNED_OUT") {
            btn.textContent = "Login";
            btn.style.background = "#fff";
            btn.style.color = "#6F5C91";
            btn.title = "";
          }
        });

        // === BEGIN YOUR GAME/QUIZ LOGIC (leave untouched) ===
        // State
        let rewards = [],
          scores = {},
          picks = {},
          turn = "A",
          turnCount = 0,
          names = {},
          total = 20,
          questions = [],
          qIndex = 0,
          usedQuestionIndices = [],
          teamCount = 2,
          teamOrder = ["A", "B", "C", "D", "E", "F"],
          teamColors = {
            A: "#e57373",
            B: "#3498db", 
            C: "#ff6b6b",
            D: "#4ecdc4",
            E: "#45b7d1",
            F: "#96ceb4"
          };
        let singlePlayer = false;
        
        // Team status tracking for special effects
        let teamStatus = {};
        let pendingPromises = []; // Track pending points breakdown promises



        // QUIZ LIBRARY LOGIC
        let quizLibrary = [];
        let selectedQuizId = null;

        // Add fallback quiz library in case database is down
        const fallbackQuizzes = [
          {
            id: 'fallback-1',
            title: 'General Knowledge',
            category: 'Trivia',
            questions: [
              { question: 'What is the capital of France?', answer: 'Paris' },
              { question: 'How many continents are there?', answer: '7' },
              { question: 'What is the largest planet in our solar system?', answer: 'Jupiter' },
              { question: 'Who wrote Romeo and Juliet?', answer: 'William Shakespeare' },
              { question: 'What is the chemical symbol for gold?', answer: 'Au' }
            ]
          },
          {
            id: 'fallback-2',
            title: 'Science Facts',
            category: 'Science',
            questions: [
              { question: 'What is the hardest natural substance on Earth?', answer: 'Diamond' },
              { question: 'What is the study of fossils called?', answer: 'Paleontology' },
              { question: 'What gas do plants absorb from the air?', answer: 'Carbon dioxide' },
              { question: 'What is the largest organ in the human body?', answer: 'Skin' },
              { question: 'What is the speed of light?', answer: '186,000 miles per second' }
            ]
          },
          {
            id: 'fallback-3',
            title: 'Geography Quiz',
            category: 'Geography',
            questions: [
              { question: 'What is the largest ocean on Earth?', answer: 'Pacific Ocean' },
              { question: 'Which country has the most people?', answer: 'China' },
              { question: 'What is the longest river in the world?', answer: 'Nile River' },
              { question: 'What is the smallest country in the world?', answer: 'Vatican City' },
              { question: 'What continent is Egypt in?', answer: 'Africa' }
            ]
          }
        ];

        // Debug: Log fetch start
        async function fetchQuizzes(params) {
          try {
            let { data, error } = await supabaseClient
              .from("quizzes")
              .select("*")
              .eq("is_public", true)
              .order("title", { ascending: true }); // Sort by title A-Z
            
            if (error) {
              console.error("Database error, using fallback quizzes:", error);
              quizLibrary = fallbackQuizzes;
              return fallbackQuizzes;
            }
            
            quizLibrary = data || fallbackQuizzes;
            console.log("Fetched quizzes from database:", quizLibrary.length);
            console.log("Quiz library contents:", quizLibrary);
            return quizLibrary;
          } catch (err) {
            console.error("Network error, using fallback quizzes:", err);
            quizLibrary = fallbackQuizzes;
            return fallbackQuizzes;
          }
        }
        
        // Call fetchQuizzes and then populate the dropdown
        fetchQuizzes().then(() => {
          console.log("After fetchQuizzes, quizLibrary length:", quizLibrary.length);
          // Update the dropdown text if we have quizzes
          if (quizLibrary.length > 0) {
            const dropdown = document.getElementById("customQuizDropdown");
            if (dropdown) {
              dropdown.textContent = "Select a quiz...";
            }
          }
        });

        // Team count change handler
        const teamCountInput = document.getElementById("teamCountInput");
        if (teamCountInput) {
          console.log("Team count input found, adding event listener");
          
          // Debug: Check team containers on page load
          const teamCContainer = document.getElementById("teamCContainer");
          const teamDContainer = document.getElementById("teamDContainer");
          const teamEContainer = document.getElementById("teamEContainer");
          const teamFContainer = document.getElementById("teamFContainer");
          
          console.log("Team containers found:", {
            teamC: !!teamCContainer,
            teamD: !!teamDContainer,
            teamE: !!teamEContainer,
            teamF: !!teamFContainer
          });
          
          teamCountInput.addEventListener("change", function() {
            console.log("Team count changed to:", this.value);
            const teamCount = parseInt(this.value);
            
            // Handle single player mode
            singlePlayer = (teamCount === 1);
            if (singlePlayer) {
              teamBNameInput.value = "Android";
              teamBNameInput.disabled = true;
            } else {
              teamBNameInput.value = "Team B";
              teamBNameInput.disabled = false;
            }
            
            // Hide all team containers first
            if (teamCContainer) teamCContainer.style.display = "none";
            if (teamDContainer) teamDContainer.style.display = "none";
            if (teamEContainer) teamEContainer.style.display = "none";
            if (teamFContainer) teamFContainer.style.display = "none";
            
            // Show containers based on team count
            if (teamCount >= 3 && teamCContainer) {
              console.log("Showing team C container");
              teamCContainer.style.display = "block";
            }
            if (teamCount >= 4 && teamDContainer) {
              console.log("Showing team D container");
              teamDContainer.style.display = "block";
            }
            if (teamCount >= 5 && teamEContainer) {
              console.log("Showing team E container");
              teamEContainer.style.display = "block";
            }
            if (teamCount >= 6 && teamFContainer) {
              console.log("Showing team F container");
              teamFContainer.style.display = "block";
            }
          });
        } else {
          console.error("Team count input not found!");
        }
        // Remove quizSelect.onchange and all quizSelect references
        // ... existing code ...
        // Modify Start Game logic to use selected quiz if chosen
        if (startBtnBottom) {
          startBtnBottom.onclick = () => {
            //  Step 1: Check if user is logged in
            const user = getCurrentUser();
            if (!user) {
              alert("Please log in to start the game.");
              return;
            }
            //  check if a quiz is selected or questions are provided (optional for grid-only play)
            const questionsInputEl = document.getElementById("questionsInput");
            const hasQuestions = (questionsInputEl && questionsInputEl.value.trim() !== "") || selectedQuizId !== null;
            
            // Allow starting without questions for grid-only play
            if (!hasQuestions) {
              console.log("Starting game without questions - grid-only mode");
            }

            // Get team count and determine single player status
            const teamCountInput = document.getElementById("teamCountInput");
            const selectedTeamCount = teamCountInput ? parseInt(teamCountInput.value) : 2;
            singlePlayer = (selectedTeamCount === 1);
            
            // In single player mode, we need 2 teams (A and Android) for display purposes
            teamCount = singlePlayer ? 2 : selectedTeamCount;
            
            // Initialize team names AFTER getting teamCount
            names = {};
            console.log("Initializing team names for", teamCount, "teams");
            
            // In single player mode, we need both Team A and Android
            if (singlePlayer) {
              // Team A
              const teamAInput = document.getElementById("teamANameInput");
              names.A = teamAInput ? teamAInput.value.trim() || "Team A" : "Team A";
              // Android
              names.B = "Android";
              console.log("Single player mode - Team A:", names.A, "Android:", names.B);
            } else {
              // Multiplayer mode - use the normal loop
              for (let i = 0; i < teamCount; i++) {
                const teamId = teamOrder[i];
                if (i === 0) {
                  const teamAInput = document.getElementById("teamANameInput");
                  names[teamId] = teamAInput ? teamAInput.value.trim() || "Team A" : "Team A";
                } else if (i === 1) {
                  const teamBInput = document.getElementById("teamBNameInput");
                  names[teamId] = teamBInput ? teamBInput.value.trim() || "Team B" : "Team B";
                } else if (i === 2) {
                  const teamCInput = document.getElementById("teamCNameInput");
                  names[teamId] = teamCInput ? teamCInput.value.trim() || "Team C" : "Team C";
                } else if (i === 3) {
                  const teamDInput = document.getElementById("teamDNameInput");
                  names[teamId] = teamDInput ? teamDInput.value.trim() || "Team D" : "Team D";
                } else if (i === 4) {
                  const teamEInput = document.getElementById("teamENameInput");
                  names[teamId] = teamEInput ? teamEInput.value.trim() || "Team E" : "Team E";
                } else if (i === 5) {
                  const teamFInput = document.getElementById("teamFNameInput");
                  names[teamId] = teamFInput ? teamFInput.value.trim() || "Team F" : "Team F";
                } else {
                  names[teamId] = `Team ${teamId}`;
                }
                console.log("Team", teamId, "name set to:", names[teamId]);
              }
            }
            console.log("Final team names object:", names);
            const gridSizeInput = document.getElementById("gridSizeInput");
            total = gridSizeInput ? +gridSizeInput.value : 18;
            
            // Get special item counts from selectors
            let tornadoCount = parseInt(
              document.getElementById("tornadoCount")?.value || "2"
            );
            let doubleCount = parseInt(
              document.getElementById("doubleCount")?.value || "2"
            );
            let loseCount = parseInt(
              document.getElementById("loseCount")?.value || "2"
            );
            let swapCount = parseInt(
              document.getElementById("swapCount")?.value || "2"
            );
            
            let shieldCount = parseInt(
              document.getElementById("shieldCount")?.value || "2"
            );
            let hotStreakCount = parseInt(
              document.getElementById("hotStreakCount")?.value || "2"
            );
            let coinFlipCount = parseInt(
              document.getElementById("coinFlipCount")?.value || "2"
            );

            // Only adjust for very small grids (8 or less), but still respect user selections
            if (total <= 8) {
              // For very small grids, cap the total special effects but maintain proportions
              const totalSpecial = tornadoCount + doubleCount + loseCount + swapCount + shieldCount + hotStreakCount + coinFlipCount;
              if (totalSpecial > total - 4) { // Leave at least 4 points
                const scaleFactor = (total - 4) / totalSpecial;
                tornadoCount = Math.max(1, Math.floor(tornadoCount * scaleFactor));
                doubleCount = Math.max(1, Math.floor(doubleCount * scaleFactor));
                loseCount = Math.max(1, Math.floor(loseCount * scaleFactor));
                swapCount = Math.max(1, Math.floor(swapCount * scaleFactor));
                shieldCount = Math.max(1, Math.floor(shieldCount * scaleFactor));
                hotStreakCount = Math.max(1, Math.floor(hotStreakCount * scaleFactor));
                coinFlipCount = Math.max(1, Math.floor(coinFlipCount * scaleFactor));
              }
            }
            
            // Debug: Log the final values being used
            console.log("Special effect counts being used:", {
              tornadoCount, doubleCount, loseCount, swapCount, 
              shieldCount, hotStreakCount, coinFlipCount, 
              total, gridSize: total
            });

            // Use quiz if selected, otherwise use textarea
            if (selectedQuizId !== null) {
              const quiz = quizLibrary.find((q) => q.id === selectedQuizId);
              if (!quiz) {
                return alert("Selected quiz not found.");
              }
              // Only support the new format: questions as array of objects
              if (
                quiz.questions &&
                Array.isArray(quiz.questions) &&
                typeof quiz.questions[0] === "object"
              ) {
                questions = quiz.questions.map((q) => ({
                  question: q.question,
                  answer: q.answer || null,
                }));
              } else {
                questions = [];
              }
              console.log(
                "DEBUG: Selected quiz:",
                quiz.title,
                "Questions loaded:",
                questions.length,
                questions
              );
            } else if (questionsInputEl && questionsInputEl.value.trim() !== "") {
              // Parse custom questions from textarea
              const raw = questionsInputEl.value;
              // split blocks on blank line
              const blocks = raw
                .split(/\n\s*\n/)
                .map((b) => b.trim())
                .filter((b) => b);
              // detect Q&A blocks
              if (blocks.some((b) => b.split("\n").length > 1)) {
                questions = blocks.map((b) => {
                  const [q, a] = b.split("\n");
                  return { question: q.trim(), answer: a?.trim() || null };
                });
              } else {
                questions = raw
                  .split("\n")
                  .map((l) => l.trim())
                  .filter((l) => l)
                  .map((q) => ({
                    question: q.replace(/^\d+\.\s*/, ""),
                    answer: null,
                  }));
              }
            } else {
              // No questions provided - grid-only mode
              questions = [];
              console.log("No questions provided - starting grid-only game");
            }
            // Prepare usedQuestionIndices for unique rotation
            usedQuestionIndices = [];
            const orderRadio = document.querySelector('input[name="order"]:checked');
            let order = orderRadio ? orderRadio.value : "inorder";
            console.log("DEBUG: Questions array at game start:", questions);
            if (order === "random") {
              // Shuffle indices
              usedQuestionIndices = Array.from(
                { length: questions.length },
                (_, i) => i
              );
              for (let i = usedQuestionIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [usedQuestionIndices[i], usedQuestionIndices[j]] = [
                  usedQuestionIndices[j],
                  usedQuestionIndices[i],
                ];
              }
            } else {
              usedQuestionIndices = Array.from(
                { length: questions.length },
                (_, i) => i
              );
            }
            qIndex = 0;
            if (setupScreen) setupScreen.classList.add("hidden");
            if (gameScreen) gameScreen.classList.remove("hidden");
            // Hide the Start Game button
            const startGameBtn = document.getElementById("startGameBtnBottom");
            console.log("Start Game clicked, looking for Start Game button:", startGameBtn);
            if (startGameBtn) {
              startGameBtn.style.display = "none";
              console.log("Start Game button hidden");
            } else {
              console.error("Start Game button not found when trying to hide");
            }
            // Show Android image if single player
            if (singlePlayer) {
              if (androidImg) androidImg.style.display = "inline-block";
              if (nameBEl) nameBEl.textContent = "Android";
              if (teamBNameContainer) teamBNameContainer.classList.add("single-player");
            } else {
              if (androidImg) androidImg.style.display = "none";
              if (nameBEl) nameBEl.textContent = names.B;
              if (teamBNameContainer) teamBNameContainer.classList.remove("single-player");
            }
            // Use startGameWithSettings to properly load roster data
            const quiz = selectedQuizId ? quizLibrary.find(q => q.id === selectedQuizId) : { questions: [] };
            const settings = {
              teamA: names.A || "Team A",
              teamB: names.B || "Team B", 
              singlePlayer: singlePlayer,
              gridSize: total,
              tornadoCount, doubleCount, loseCount, swapCount,
              shieldCount, hotStreakCount, coinFlipCount
            };
            
            startGameWithSettings(quiz, settings);
          };
        }

        if (passBtn)
          passBtn.onclick = () => {
            // Use the centralized advanceTurn function for consistency
            advanceTurn();
            
            if (typeof updateTurn === 'function') {
              updateTurn();
            }
            
            // Hide current modal and show next question
            const questionModal = document.getElementById("questionModal");
            if (questionModal && !questionModal.classList.contains("hidden")) {
              questionModal.style.display = "none";
              questionModal.classList.add("hidden");
            }
            
            if (typeof showQuestion === 'function') {
              showQuestion();
            }
            // In single player mode, if it's now the computer's turn, trigger computer move
            if (singlePlayer && turn === "B" && typeof computerTurn === 'function') {
              setTimeout(computerTurn, 2000);
            }
          };
        if (skipBtn)
          skipBtn.onclick = () => {
            qIndex = (qIndex + 1) % usedQuestionIndices.length;
            
            // Hide current modal and show next question
            const questionModal = document.getElementById("questionModal");
            if (questionModal && !questionModal.classList.contains("hidden")) {
              questionModal.style.display = "none";
              questionModal.classList.add("hidden");
            }
            
            if (typeof showQuestion === 'function') {
              showQuestion();
            }
          };
        if (document.getElementById("nextQuestionBtn"))
          document.getElementById("nextQuestionBtn").onclick = () => {
            hideNextQuestionButton();
            showQuestion();
          };

        // === NEW QUESTION MODAL BUTTON HANDLERS ===
        
        // Correct button - show answer, hide modal, show board
        if (document.getElementById("correctBtn")) {
          document.getElementById("correctBtn").onclick = () => {
            const qObj = questions[usedQuestionIndices[qIndex]] || {
              question: "",
              answer: null,
            };
            
            // Award points to current student
            if (rosterData && rosterData.roster) {
              let currentStudent = null;
              
              if (teamMode && getCurrentStudent()) {
                // Team mode - get current student from team
                currentStudent = getCurrentStudent();
              } else if (!teamMode) {
                // Individual mode - get student by turn index
                const studentIndex = turn.charCodeAt(0) - 65; // A=0, B=1, C=2, etc.
                currentStudent = rosterData.roster[studentIndex];
              }
              
              if (currentStudent) {
                awardStudentPoints(currentStudent.name, individualPoints);
                updateTeamScores(); // Update the display
              }
            }
            
            // Show answer with animation
            const modalAnswer = document.getElementById("modalAnswer");
            if (modalAnswer) {
              modalAnswer.textContent = qObj.answer || "No answer provided";
              modalAnswer.style.display = "flex";
              modalAnswer.style.animation = "questionModalSlideIn 0.3s ease-out";
            }
            
            // Hide modal after a short delay to show the answer
            setTimeout(() => {
              const questionModal = document.getElementById("questionModal");
              if (questionModal) {
                questionModal.style.display = "none";
                questionModal.classList.add("hidden");
              }
              
              // Ensure the grid is visible for number selection
              if (gridEl) {
                gridEl.style.display = "grid";
                gridEl.style.visibility = "visible";
              }
            }, 2000); // Show answer for 2 seconds
          };
        }

        // Incorrect button - show options
        if (document.getElementById("incorrectBtn")) {
          document.getElementById("incorrectBtn").onclick = () => {
            // Show the secondary action buttons more prominently
            const secondaryButtons = document.querySelectorAll('.secondary-btn');
            if (secondaryButtons && secondaryButtons.length > 0) {
              secondaryButtons.forEach(btn => {
                if (btn) {
                  btn.style.transform = 'scale(1.05)';
                  btn.style.boxShadow = '0 6px 20px rgba(111, 92, 145, 0.4)';
                }
              });
            }
            
            // Add a subtle highlight to indicate these are now the focus
            const modalAnswer = document.getElementById("modalAnswer");
            if (modalAnswer) {
              modalAnswer.innerHTML = '<span style="color:#f44336;font-style:normal;">Choose an action below:</span>';
              modalAnswer.style.display = "flex";
            }
            
            // Reset after animation
            setTimeout(() => {
              if (secondaryButtons && secondaryButtons.length > 0) {
                secondaryButtons.forEach(btn => {
                  if (btn) {
                    btn.style.transform = '';
                    btn.style.boxShadow = '';
                  }
                });
              }
            }, 300);
          };
        }

        // Skip question button
        if (document.getElementById("skipQuestionBtn")) {
          document.getElementById("skipQuestionBtn").onclick = () => {
            // Go to next question
            qIndex = (qIndex + 1) % usedQuestionIndices.length;
            
            // Hide modal and show next question
            const questionModal = document.getElementById("questionModal");
            if (questionModal) {
              questionModal.style.display = "none";
              questionModal.classList.add("hidden");
            }
            
            // Small delay for smooth transition
            setTimeout(() => {
              if (typeof showQuestion === 'function') {
                showQuestion();
              }
            }, 150);
          };
        }

        // Change teams button
        if (document.getElementById("changeTeamsBtn")) {
          document.getElementById("changeTeamsBtn").onclick = () => {
            // Use the centralized advanceTurn function for consistency
            advanceTurn();
            
            // Reduce freeze count
            if (teamStatus[turn]?.frozen > 0) {
              teamStatus[turn].frozen--;
            }
            
            if (typeof updateTurn === 'function') {
              updateTurn();
            }
            
            // Hide modal and show next question
            const questionModal = document.getElementById("questionModal");
            if (questionModal) {
              questionModal.style.display = "none";
              questionModal.classList.add("hidden");
            }
            
            // Small delay for smooth transition
            setTimeout(() => {
              if (typeof showQuestion === 'function') {
                showQuestion();
              }
            }, 100);
          };
        }

        // Reveal answer button
        if (document.getElementById("revealAnswerBtn")) {
          document.getElementById("revealAnswerBtn").onclick = () => {
            const qObj = questions[usedQuestionIndices[qIndex]] || {
              question: "",
              answer: null,
            };
            
            // Show answer with animation
            const modalAnswer = document.getElementById("modalAnswer");
            if (modalAnswer) {
              modalAnswer.textContent = qObj.answer || "No answer provided";
              modalAnswer.style.display = "flex";
              modalAnswer.style.animation = "questionModalSlideIn 0.3s ease-out";
            }
          };
        }

        // Close question modal button
        if (document.getElementById("closeQuestionModal")) {
          document.getElementById("closeQuestionModal").onclick = () => {
            const questionModal = document.getElementById("questionModal");
            if (questionModal) {
              questionModal.style.display = "none";
              questionModal.classList.add("hidden");
            }
          };
        }

        // Close modal when clicking outside
        if (document.getElementById("questionModal")) {
          document.getElementById("questionModal").onclick = function(e) {
            if (e.target === this) {
              if (this) {
                this.style.display = "none";
                this.classList.add("hidden");
              }
            }
          };
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            const questionModal = document.getElementById("questionModal");
            if (questionModal && !questionModal.classList.contains("hidden")) {
              questionModal.style.display = "none";
              questionModal.classList.add("hidden");
            }
          }
        });

        if (resetBtn)
          resetBtn.onclick = () => {
            // Get current special item counts
            let tornadoCount = parseInt(
              document.getElementById("tornadoCount")?.value || "2"
            );
            let doubleCount = parseInt(
              document.getElementById("doubleCount")?.value || "2"
            );
            let loseCount = parseInt(
              document.getElementById("loseCount")?.value || "2"
            );
            let swapCount = parseInt(
              document.getElementById("swapCount")?.value || "1"
            );
            
            let shieldCount = parseInt(
              document.getElementById("shieldCount")?.value || "1"
            );
            let hotStreakCount = parseInt(
              document.getElementById("hotStreakCount")?.value || "1"
            );
            let coinFlipCount = parseInt(
              document.getElementById("coinFlipCount")?.value || "1"
            );
            qIndex = 0;
            // Fully reset game state and grid
            if (typeof initGame === 'function') {
              initGame(tornadoCount, doubleCount, loseCount, swapCount, shieldCount, hotStreakCount, coinFlipCount);
            }
            if (typeof buildGrid === 'function') {
              buildGrid(total);
            }
            
            // Hide question modal if it's open
            const questionModal = document.getElementById("questionModal");
            if (questionModal) {
              questionModal.style.display = "none";
              questionModal.classList.add("hidden");
            }
            
            if (typeof showQuestion === 'function') {
              showQuestion();
            }
          };
        if (document.getElementById("homeBtn")) {
          document.getElementById("homeBtn").onclick = () => {
            if (gameScreen) gameScreen.classList.add("hidden");
            if (setupScreen) setupScreen.classList.remove("hidden");
            
            // Restore the Start Game button visibility
            const startGameBtn = document.getElementById("startGameBtnBottom");
            console.log("Home button clicked, looking for Start Game button:", startGameBtn);
            if (startGameBtn) {
              startGameBtn.style.display = "block";
              console.log("Start Game button restored to visible");
            } else {
              console.error("Start Game button not found when trying to restore");
            }
            
            // Reset everything to initial state
            scores = {};
            picks = {};
            teamStatus = {};
            teamCount = 2;
            
            // Clear team grid
            const teamGrid = document.getElementById("teamGrid");
            if (teamGrid) {
              teamGrid.innerHTML = "";
            }
            
            if (typeof updateScores === 'function') {
              updateScores();
            }
            turn = "A";
            if (typeof updateTurn === 'function') {
              updateTurn();
            }
            if (gridEl) gridEl.innerHTML = "";
            const questionAnswerRow = document.getElementById("questionAnswerRow");
            if (questionAnswerRow) {
              questionAnswerRow.style.display = "none";
            }
            
            // Hide question modal if it's open
            const questionModal = document.getElementById("questionModal");
            if (questionModal) {
              questionModal.style.display = "none";
              questionModal.classList.add("hidden");
            }
            
            // No need to reassign selector values; UI is already reset
            if (typeof showQuestion === 'function') {
              showQuestion();
            }
          };
        }

        function initGame(
          tornadoCount,
          doubleCount,
          loseCount,
          swapCount,
          shieldCount,
          hotStreakCount,
          coinFlipCount
        ) {
          console.log('initGame called with total:', total, 'teamCount:', teamCount);
          
          // Initialize scores and picks for all teams
          scores = {};
          picks = {};
          teamStatus = {};
          
          for (let i = 0; i < teamCount; i++) {
            const teamId = teamOrder[i];
            scores[teamId] = 0;
            picks[teamId] = 0;
            teamStatus[teamId] = {
              frozen: 0,
              shield: false,
              hotStreak: false
            };
          }
          
          // Clear announcements
          const teamGrid = document.getElementById("teamGrid");
          if (teamGrid) {
            teamGrid.querySelectorAll(".announcement").forEach(ann => ann.textContent = "");
          }
          
          updateTeamDisplay();
          updateScores();
          turn = "A";
          updateTurn();
          
          console.log('About to call buildRewards and buildGrid with total:', total);
          buildRewards(total, tornadoCount, doubleCount, loseCount, swapCount, shieldCount, hotStreakCount, coinFlipCount);
          buildGrid(total);
          showQuestion();
        }

        function buildRewards(
          n,
          tornadoCount,
          doubleCount,
          loseCount,
          swapCount,
          shieldCount,
          hotStreakCount,
          coinFlipCount
        ) {
          // Always include the exact number of each special item
          let specialTotal = tornadoCount + doubleCount + loseCount + swapCount + shieldCount + hotStreakCount + coinFlipCount;
          let ptsCount = n - specialTotal;
          if (ptsCount < 0) ptsCount = 0;
          
          console.log("Building rewards with counts:", {
            tornadoCount, doubleCount, loseCount, swapCount, 
            shieldCount, hotStreakCount, coinFlipCount, 
            specialTotal, ptsCount, total: n
          });
          
          rewards = [];
          for (let i = 0; i < ptsCount; i++)
            rewards.push({
              type: "points",
              value: (Math.floor(Math.random() * 10) + 1) * 100,
            });
          for (let i = 0; i < loseCount; i++) rewards.push({ type: "lose" });
          for (let i = 0; i < tornadoCount; i++)
            rewards.push({ type: "steal" });
          for (let i = 0; i < doubleCount; i++)
            rewards.push({ type: "double" });
          for (let i = 0; i < swapCount; i++) rewards.push({ type: "swap" });
          for (let i = 0; i < shieldCount; i++) rewards.push({ type: "shield" });
          for (let i = 0; i < hotStreakCount; i++) rewards.push({ type: "hotStreak" });
          for (let i = 0; i < coinFlipCount; i++) rewards.push({ type: "coinFlip" });
          
          console.log("Rewards array created:", rewards.map(r => r.type));
          
          // Shuffle rewards to randomize placement
          for (let i = rewards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [rewards[i], rewards[j]] = [rewards[j], rewards[i]];
          }
          
          console.log("Final shuffled rewards:", rewards.map(r => r.type));
        }

        function buildGrid(n) {
          console.log('buildGrid called with n:', n, 'gridEl:', gridEl);
          
          // Try to find gridEl if not already found
          if (!gridEl) {
            gridEl = document.getElementById("grid");
            console.log('Re-finding gridEl:', gridEl);
          }
          
          if (!gridEl) {
            console.error('gridEl not found! Creating fallback...');
            // Create a fallback grid element
            const gameMain = document.querySelector('.game-main');
            if (gameMain) {
              const fallbackGrid = document.createElement('div');
              fallbackGrid.id = 'grid';
              fallbackGrid.style.cssText = 'flex: 1 1 auto; display: grid; min-height: 400px; background: #f8f9fa; border-radius: 8px; padding: 1rem;';
              gameMain.appendChild(fallbackGrid);
              gridEl = fallbackGrid;
              console.log('Created fallback grid element');
            } else {
              console.error('Cannot create fallback grid - game-main not found');
              return;
            }
          }
          
          // Ensure n is valid
          if (!n || n <= 0) {
            n = 20; // Default fallback
            console.log('Invalid n, using default:', n);
          }
          
          gridEl.innerHTML = "";
          let cols;
          if (n === 8) {
            cols = 4;
          } else if (n === 10) {
            cols = 5;
          } else if (n === 16) {
            cols = 4;
          } else if (n === 18) {
            cols = 6;
          } else if (n === 20) {
            cols = 5;
          } else if (n === 24) {
            cols = 6;
          } else if (n === 30) {
            cols = 6;
          } else if (n === 32) {
            cols = 6;
          } else if (n === 40) {
            cols = 6;
          } else {
            // Find the widest possible layout (favor wide)
            let bestCols = 1;
            for (let c = Math.floor(Math.sqrt(n)); c <= n; c++) {
              if (n % c === 0 && c >= bestCols) {
                bestCols = c;
              }
            }
            cols = bestCols > 1 ? bestCols : Math.floor(Math.sqrt(n));
            if (n / cols > cols) {
              for (let c = cols + 1; c <= n; c++) {
                if (n % c === 0 && c > cols) {
                  cols = c;
                }
              }
            }
          }
          gridEl.style.gridTemplateColumns = `repeat(${cols},1fr)`;
          console.log(`Building grid: ${n} items, ${cols} columns, template: repeat(${cols},1fr)`);
          
          for (let i = 0; i < n; i++) {
            const btn = document.createElement("button");
            btn.textContent = i + 1;
            btn.style.cssText = `
              background: #6f5c91;
              color: white;
              border: none;
              border-radius: 8px;
              padding: 1rem;
              font-size: 1.2rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s ease;
              min-height: 60px;
              display: flex;
              align-items: center;
              justify-content: center;
            `;
            btn.onclick = () => handlePick(btn, i);
            gridEl.appendChild(btn);
          }
          
          console.log(`Grid built with ${n} buttons`);
          
          // Force grid to be visible
          gridEl.style.display = 'grid';
          gridEl.style.visibility = 'visible';
        }

        let isResolvingTurn = false;
        
        // Safety function to reset all button states
        function resetAllButtonStates() {
          const allButtons = document.querySelectorAll('#grid button');
          allButtons.forEach(btn => {
            btn.disabled = false;
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
          });
          isResolvingTurn = false;
          console.log('All button states reset');
        }
        
        // Add keyboard shortcut to reset buttons (press 'R')
        document.addEventListener('keydown', function(event) {
          if (event.key === 'r' || event.key === 'R') {
            if (event.ctrlKey || event.metaKey) {
              event.preventDefault();
              resetAllButtonStates();
              alert('All buttons have been reset!');
            }
          }
        });

        function handlePick(btn, i) {
          if (isResolvingTurn) {
            return;
          }
          isResolvingTurn = true;
          
          let r = rewards[i],
            me = turn;
          
          console.log(`Team ${me} picked position ${i}:`, r);
          
          // Special effects should work on first pick - don't convert them to points
          picks[me]++;
          let out = "";
          let pointsEarned = 0;
          
          // Check if team has points for certain special effects
          const hasPoints = scores[me] > 0;
          
          // Handle points first
          if (r.type === "points") {
            pointsEarned = r.value;
            let breakdown = null;
            
            // Apply Hot Streak if active
            if (teamStatus[me]?.hotStreak) {
              const basePoints = pointsEarned;
              pointsEarned *= 3;
              teamStatus[me].hotStreak = false;
              teamStatus[me].hotStreakUsed = true;
              
              breakdown = {
                basePoints: basePoints,
                effect: ` Hot Streak: ${basePoints}  3 = ${pointsEarned} points!`,
                finalTotal: pointsEarned
              };
              
              // Don't show special popup here - let the points breakdown show the math
              // showSpecialPopup("", "Hot Streak! Triple points!");
            }
            
            scores[me] += pointsEarned;
            out = pointsEarned;
            btn.style.color = teamColors[me];
            
            // CRITICAL: Update button and scores IMMEDIATELY for all points
            btn.innerHTML = `<span>${out}</span>`;
            btn.disabled = true;
            updateScores();
            updateTeamDisplay();
            
            // Show points breakdown with math (if breakdown exists)
            if (breakdown) {
              // Wait for points breakdown to be dismissed before continuing
              const breakdownPromise = showPointsPopup(out, me, breakdown);
              if (breakdownPromise) {
                pendingPromises.push(breakdownPromise); // Track this promise
                breakdownPromise.then(() => {
                  // After breakdown is dismissed, show the special effect popup
                  showSpecialPopup("", `Hot Streak! +${pointsEarned} points!`);
                  
                  // CRITICAL: Advance turn AFTER breakdown is dismissed
                  advanceTurn();
                });
              } else {
                // Fallback if no promise returned
                showSpecialPopup("", `Hot Streak! +${pointsEarned} points!`);
                advanceTurn();
              }
              
              return; // Important: return here to prevent further execution
            } else {
              // No breakdown, show simple points
              showPointsPopup(out, me);
            }
          }
          
          // Handle special effects
          if (r.type === "lose") {
            // Skunk effect - only if team has points to lose
            if (!hasPoints) {
              // Give points instead of negative effect when team has no points
              pointsEarned = (Math.floor(Math.random() * 10) + 1) * 100;
              scores[me] += pointsEarned;
              out = pointsEarned;
              btn.style.color = teamColors[me];
              
              // CRITICAL: Update button and scores before return
              btn.innerHTML = `<span>${out}</span>`;
              btn.disabled = true;
              updateScores();
              updateTeamDisplay();
              
              showPointsPopup(out, me);
              
              // CRITICAL: Advance turn before returning
              advanceTurn();
              return;
            }
            
            if (teamStatus[me]?.shield) {
              // Shield blocks the effect
              teamStatus[me].shield = false;
              teamStatus[me].shieldUsed = true;
              out = "";
              showSpecialPopup("", "Shield blocked the Skunk effect!");
              animateShieldBlock(me);
            } else {
              scores[me] = 0;
              out = "";
              styleSpecial(btn, me);
              
              // CRITICAL: Update button content and disable it
              btn.innerHTML = `<span>${out}</span>`;
              btn.disabled = true;
              
              showSpecialPopup("", "Skunked! Lose all your points!");
              animateSkunk(me);
              playSad();
            }
          } else if (r.type === "steal") {
            // Tornado effect - only if there are points to steal
            let targetTeam = null;
            let highestScore = -1;
            for (let teamId in scores) {
              if (teamId !== me && scores[teamId] > highestScore) {
                highestScore = scores[teamId];
                targetTeam = teamId;
              }
            }
            
            if (!targetTeam || scores[targetTeam] <= 0) {
              // Give points instead of negative effect when no one has points to steal
              pointsEarned = (Math.floor(Math.random() * 10) + 1) * 100;
              scores[me] += pointsEarned;
              out = pointsEarned;
              btn.style.color = teamColors[me];
              
              // CRITICAL: Update button and scores before return
              btn.innerHTML = `<span>${out}</span>`;
              btn.disabled = true;
              updateScores();
              updateTeamDisplay();
              
              showPointsPopup(out, me);
              
              // CRITICAL: Advance turn before returning
              advanceTurn();
              return;
            }
            
            if (teamStatus[targetTeam]?.shield) {
              // Shield blocks the effect
              teamStatus[targetTeam].shield = false;
              teamStatus[targetTeam].shieldUsed = true;
              out = "";
              showSpecialPopup("", `${names[targetTeam]}'s Shield blocked the Tornado!`);
              animateShieldBlock(targetTeam);
            } else {
              // If more than 2 teams, let the player choose which team to steal from
              if (teamCount > 2) {
                showTeamSelectionModal(me, "steal");
              } else {
                // Just 2 teams, steal directly
                scores[me] += scores[targetTeam];
                scores[targetTeam] = 0;
                out = "";
                styleSpecial(btn, me);
                // Add white background for better tornado visibility
                btn.style.background = "#fff";
                btn.style.color = "#333";
                
                // CRITICAL: Update button content and disable it
                btn.innerHTML = `<span>${out}</span>`;
                btn.disabled = true;
                
                btn.classList.add("tornado-animation");
                showSpecialPopup("", "Tornado! Steal the other team's points!", true);
                animateKangarooSwap();
              }
            }
          } else if (r.type === "swap") {
            // Kangaroo swap - only if there are points to swap
            let targetTeam = null;
            let highestScore = -1;
            for (let teamId in scores) {
              if (teamId !== me && scores[teamId] > highestScore) {
                highestScore = scores[teamId];
                targetTeam = teamId;
              }
            }
            
            if (!targetTeam || scores[targetTeam] <= 0) {
              // Give points instead of negative effect when no one has points to swap
              pointsEarned = (Math.floor(Math.random() * 10) + 1) * 100;
              scores[me] += pointsEarned;
              out = pointsEarned;
              btn.style.color = teamColors[me];
              
              // CRITICAL: Update button and scores before return
              btn.innerHTML = `<span>${out}</span>`;
              btn.disabled = true;
              updateScores();
              updateTeamDisplay();
              
              showPointsPopup(out, me);
              
              // CRITICAL: Advance turn before returning
              advanceTurn();
              return;
            }
            
            // Check if shield protects from negative swap
            const wouldLosePoints = scores[targetTeam] > scores[me];
            if (wouldLosePoints && teamStatus[me]?.shield) {
              // Shield protects from negative swap - give points instead
              pointsEarned = (Math.floor(Math.random() * 10) + 1) * 100;
              scores[me] += pointsEarned;
              out = pointsEarned;
              btn.style.color = teamColors[me];
              
              // CRITICAL: Update button and scores before return
              btn.innerHTML = `<span>${out}</span>`;
              btn.disabled = true;
              updateScores();
              updateTeamDisplay();
              
              // Use up the shield
              teamStatus[me].shield = false;
              teamStatus[me].shieldUsed = true;
              updateTeamDisplay();
              
              showPointsPopup(out, me);
              showSpecialPopup("", "Shield protected you from negative swap! +100 bonus points!", false, false);
              
              // CRITICAL: Advance turn before returning
              advanceTurn();
              return;
            }
            
            let temp = scores[me];
            scores[me] = scores[targetTeam];
            scores[targetTeam] = temp;
            out = "";
            styleSpecial(btn, me);
            
            // CRITICAL: Update button content and disable it
            btn.innerHTML = `<span>${out}</span>`;
            btn.disabled = true;
            
            showSpecialPopup("", "Kangaroo Hop Swap! Teams swap points!");
            animateKangarooSwap();
          } else if (r.type === "double") {
            // Double effect - only if team has points to double
            if (!hasPoints) {
              // Give points instead of negative effect when team has no points to double
              pointsEarned = (Math.floor(Math.random() * 10) + 1) * 100;
              scores[me] += pointsEarned;
              out = pointsEarned;
              btn.style.color = teamColors[me];
              showPointsPopup(out, me);
              return;
            }
            
            const basePoints = scores[me];
            pointsEarned = basePoints; // Points earned = original score (doubled)
            scores[me] *= 2;
            const finalTotal = pointsEarned; // Final total = points earned from doubling
            out = pointsEarned; // Show actual points earned, not emoji
            btn.style.color = teamColors[me];
            
            const breakdown = {
              basePoints: basePoints,
              effect: " Double Lion Roar: Double your points!",
              finalTotal: finalTotal
            };
            
            // Wait for points breakdown to be dismissed before continuing
            const breakdownPromise = showPointsPopup(finalTotal, me, breakdown);
            if (breakdownPromise) {
              pendingPromises.push(breakdownPromise); // Track this promise
              breakdownPromise.then(() => {
                showSpecialPopup("", "Double Lion Roar! Double your points!");
                animateScore(me, "double-bounce");
              });
            } else {
              showSpecialPopup("", "Double Lion Roar! Double your points!");
              animateScore(me, "double-bounce");
            }
          } else if (r.type === "shield") {
            // Shield effect - give points AND shield
            pointsEarned = (Math.floor(Math.random() * 10) + 1) * 100;
            scores[me] += pointsEarned;
            out = pointsEarned;
            btn.style.color = teamColors[me];
            
            // CRITICAL: Update button content and disable it immediately
            btn.innerHTML = `<span>${out}</span>`;
            btn.disabled = true;
            updateScores();
            updateTeamDisplay();
            
            // Show points first, then shield effect (no math breakdown needed)
            showPointsPopup(out, me);
            
            // Activate shield immediately and update display
            teamStatus[me] = teamStatus[me] || {};
            teamStatus[me].shield = true;
            teamStatus[me].shieldUsed = false; // Mark as not used yet
            updateTeamDisplay(); // Show shield icon immediately
            
            // Then show shield effect
            setTimeout(() => {
              showSpecialPopup("", `Shield activated! +${out} points! Protects from negative effects until used.`, false, false);
            }, 1000);
            
            // Advance turn after shield activation
            advanceTurn();
            return;
                    } else if (r.type === "hotStreak") {
            // Hot Streak effect - give points AND hot streak
            pointsEarned = (Math.floor(Math.random() * 10) + 1) * 100;
            scores[me] += pointsEarned;
            out = pointsEarned;
            btn.style.color = teamColors[me];
            
            // CRITICAL: Update button content and disable it immediately
            btn.innerHTML = `<span>${out}</span>`;
            btn.disabled = true;
            updateScores();
            updateTeamDisplay();
            
            // Show points first, then hot streak effect (no math breakdown needed for activation)
            showPointsPopup(out, me);
            
            // Activate hot streak immediately and update display
            if (teamStatus[me]?.hotStreak) {
              scores[me] += 100;
              updateScores();
              updateTeamDisplay();
              showSpecialPopup("", "Hot Streak already active! +100 bonus points!", false, false);
              animateScore(me, "hot-streak-bounce");
            } else {
              teamStatus[me] = teamStatus[me] || {};
              teamStatus[me].hotStreak = true;
              teamStatus[me].hotStreakUsed = false; // Mark as not used yet
              updateTeamDisplay(); // Show hot streak icon immediately
              showSpecialPopup("", "Hot Streak! Next correct answer worth 3x points!", false, false);
            }
            
            // CRITICAL: Don't return here - let the turn advance normally
            // The hot streak will be applied on the next points pick
          } else if (r.type === "coinFlip") {
            // Coin Flip effect - give points AND coin flip
            pointsEarned = (Math.floor(Math.random() * 10) + 1) * 100;
            scores[me] += pointsEarned;
            out = pointsEarned;
            btn.style.color = teamColors[me];
            
            // CRITICAL: Update button content and disable it immediately
            btn.innerHTML = `<span>${out}</span>`;
            btn.disabled = true;
            updateScores();
            updateTeamDisplay();
            
            // Show points first, then coin flip modal (no math breakdown needed for activation)
            showPointsPopup(out, me);
            
            // Check if this is the last block in the game
            const done = document.querySelectorAll("#grid button:disabled").length + 1; // +1 because this button isn't disabled yet
            const isLastBlock = done === total;
            
            // Then show coin flip modal
            setTimeout(() => {
              if (isLastBlock) {
                // If this is the last block, don't show coin flip modal - just end the game
                console.log("Last block is coin flip - ending game immediately");
                // The game will end naturally when the button is disabled below
              } else {
                showCoinFlipModal();
              }
            }, 1000);
            
            // CRITICAL: Always return here to prevent the button from being overwritten later
            // The turn will change after the coin flip is processed in handleCoinFlip
            return;
          }
          
          // Update announcement
          const annEl = document.getElementById(`ann${me}`);
          if (annEl) {
            annEl.textContent = `${names[me]} got ${out}`;
          }
          
          // For special effects that give points, show the points value on the grid
          let displayValue = out;
          if (r.type !== "points" && pointsEarned > 0) {
            displayValue = pointsEarned; // Show the actual points earned
          }
          
          btn.innerHTML = `<span>${displayValue}</span>`;
          btn.disabled = true;
          
          if (r.type === "points" && pointsEarned >= 800) {
            confettiBurst(btn);
          }
          
          updateScores();
          updateTeamDisplay();
          
          const done = document.querySelectorAll("#grid button:disabled").length;
          if (done === total) {
            // Game over - show end game screen
            showEndGameResults();
          } else {
            // Use the centralized advanceTurn function
            advanceTurn();
          }
        }

        function advanceTurn() {
          // Increment turn count
          turnCount++;
          
          console.log('=== ADVANCE TURN ===');
          console.log('Before advance:', {
            turn,
            currentStudentIndex,
            teamMode,
            currentTeamStudents: currentTeamStudents?.length
          });
          
          // Move to next team or next student
          do {
            if (teamMode) {
              // In team mode, alternate between teams while keeping same student index
              // Only advance student when we've gone through all teams
              let currentIndex = teamOrder.indexOf(turn);
              currentIndex = (currentIndex + 1) % teamCount;
              turn = teamOrder[currentIndex];
              
              // If we've cycled back to the first team, advance to next student
              if (currentIndex === 0) {
                advanceStudentTurn();
              }
              
              // Update current team students but preserve the student index
              updateCurrentTeamStudents(true);
              
              console.log('Moved to next team:', {
                newTurn: turn,
                newTeamName: names[turn],
                newTeamStudents: currentTeamStudents?.length,
                preservedStudentIndex: currentStudentIndex,
                currentStudent: getCurrentStudent()?.name
              });
            } else {
              let currentIndex = teamOrder.indexOf(turn);
              currentIndex = (currentIndex + 1) % teamCount;
              turn = teamOrder[currentIndex];
            }
          } while (teamStatus[turn]?.frozen > 0);
          
          console.log('After advance:', {
            turn,
            currentStudentIndex,
            currentStudent: getCurrentStudent()?.name,
            display: getCurrentStudentDisplay()
          });
          
          // Clear team status effects that should disappear after turn
          clearTeamStatusEffects();
          
          // Advance to next unique question
          qIndex++;
          if (qIndex >= usedQuestionIndices.length) qIndex = 0;
          updateTurn();
          
          // Wait for all pending promises (points breakdowns) to resolve before showing next question
          if (pendingPromises.length > 0) {
            Promise.all(pendingPromises).then(() => {
              // Clear the promises array
              pendingPromises = [];
              // Next Question button is always visible, no need to show it
            });
          } else {
            // No pending promises, Next Question button is always visible
          }
          
          // If single player and it's now Android's turn, trigger computer move
          if (singlePlayer && turn === "B") {
            setTimeout(computerTurn, 2500);
          }
        }

        function showNextQuestionButton() {
          // The Next Question button is now always visible in the game controls
          // No need to show/hide a separate container
        }
        
        function hideNextQuestionButton() {
          // The Next Question button is now always visible in the game controls
          // No need to show/hide a separate container
        }
        
        function showQuestion() {
          console.log(qIndex, "qIndex");
          console.warn(usedQuestionIndices, "usedQuestionIndices");
          
          // Next Question button is always visible, no need to hide it
          
          const qObj = questions[usedQuestionIndices[qIndex]] || {
            question: "",
            answer: null,
          };
          
          // Hide question bubble if no questions
          const questionRow = document.getElementById("questionAnswerRow");
          if (!qObj.question) {
            questionRow.style.display = "none";
            return;
          }
          
          // Show the new question modal
          const questionModal = document.getElementById("questionModal");
          const modalQuestion = document.getElementById("modalQuestion");
          const modalAnswer = document.getElementById("modalAnswer");
          const modalTeamName = document.getElementById("modalTeamName");
          
          // Set question text
          modalQuestion.textContent = qObj.question;
          modalAnswer.textContent = "";
          modalAnswer.style.display = "none";
          
          
          // Show modal
          questionModal.style.display = "flex";
          questionModal.classList.remove("hidden");
          
          // Focus on the correct button for accessibility
          const correctBtn = document.getElementById("correctBtn");
          if (correctBtn) {
            setTimeout(() => correctBtn.focus(), 100);
          }
          
          // Hide the old question bubble
          questionRow.style.display = "none";
          
          console.log(
            "DEBUG: Showing question in modal:",
            qObj.question,
            "| Expected answer:",
            qObj.answer
          );
        }

        function updateScores() {
          // Update all team scores
          for (let i = 0; i < teamCount; i++) {
            const teamId = teamOrder[i];
            const scoreEl = document.getElementById(`score${teamId}`);
            if (scoreEl) {
              scoreEl.textContent = scores[teamId];
            }
          }
          
          // Update sidebar scores
          updateTeamScores();
        }
        function clearTeamStatusEffects() {
          // Clear status effects that should disappear after each turn
          for (let teamId in teamStatus) {
            if (teamStatus[teamId]) {
              // Clear shield only after it's used (it persists until needed)
              if (teamStatus[teamId].shieldUsed) {
                teamStatus[teamId].shield = false;
                teamStatus[teamId].shieldUsed = false;
              }
              
              // Clear hot streak after it's used (it's a one-time bonus)
              if (teamStatus[teamId].hotStreakUsed) {
                teamStatus[teamId].hotStreak = false;
                teamStatus[teamId].hotStreakUsed = false;
              }
            }
          }
        }
        
        function updateTeamDisplay() {
          const teamGrid = document.getElementById("teamGrid");
          if (!teamGrid) return;
          
          teamGrid.innerHTML = "";
          
          for (let i = 0; i < teamCount; i++) {
            const teamId = teamOrder[i];
            const teamCard = document.createElement("div");
            teamCard.className = `team-card ${turn === teamId ? 'active' : ''}`;
            teamCard.id = `teamCard${teamId}`;
            
            const statusDiv = document.createElement("div");
            statusDiv.className = "team-status";
            
            // Add status icons (only show active effects)
            if (teamStatus[teamId]?.shield) {
              const shieldIcon = document.createElement("div");
              shieldIcon.className = "status-icon shield-icon";
              shieldIcon.innerHTML = "";
              shieldIcon.title = "Protects from negative effects until used";
              statusDiv.appendChild(shieldIcon);
            }
            
            if (teamStatus[teamId]?.hotStreak) {
              const hotStreakIcon = document.createElement("div");
              hotStreakIcon.className = "status-icon hotstreak-icon";
              hotStreakIcon.innerHTML = "";
              hotStreakIcon.title = "Next correct answer worth 3x points";
              statusDiv.appendChild(hotStreakIcon);
            }
            
            teamCard.appendChild(statusDiv);
            
            const announcement = document.createElement("div");
            announcement.className = "announcement";
            announcement.id = `ann${teamId}`;
            teamCard.appendChild(announcement);
            
            const teamName = document.createElement("h2");
            teamName.id = `name${teamId}`;
            
            // Add logo for Android in single player mode
            if (singlePlayer && teamId === "B") {
              teamName.innerHTML = `<img src="Daft-Punk-PNG-Photo.png" style="width:20px;height:20px;vertical-align:middle;margin-right:5px;" alt="Android">${names[teamId]}`;
            } else {
              teamName.textContent = names[teamId];
            }
            
            teamName.style.color = teamColors[teamId];
            teamCard.appendChild(teamName);
            
            const score = document.createElement("p");
            score.id = `score${teamId}`;
            score.textContent = scores[teamId];
            teamCard.appendChild(score);
            
            teamGrid.appendChild(teamCard);
          }
          
          // Update grid border for active team
          const grid = document.getElementById("grid");
          if (grid) {
            grid.className = `active-team-${turn}`;
          }
        }

        function updateTurn() {
          // Update turn display safely
          if (turnEl) {
            turnEl.textContent = `${names[turn]}'s turn`;
            turnEl.style.color = teamColors[turn] || "#6f5c91";
          }
          
          updateTeamDisplay();
          
          // Update sidebar
          updateTeamScores();
          updateTurnDisplay();
          
          // Force update the turn display in the main game area
          const mainTurnDisplay = document.querySelector('.turn-display, #turnDisplay, .current-turn');
          if (mainTurnDisplay) {
            mainTurnDisplay.textContent = getCurrentStudentDisplay();
          }
          
          // Allow next team to act
          isResolvingTurn = false;
        }

        function styleSpecial(btn, team) {
          const clr = team === "A" ? "var(--teamA)" : "var(--teamB)";
          btn.style.background = clr;
          btn.style.color = "#fff";
          btn.style.fontSize = "1.2em";
        }

        function playWind() {
          const C = new (window.AudioContext || window.webkitAudioContext)(),
            buf = C.createBuffer(1, C.sampleRate * 0.5, C.sampleRate),
            d = buf.getChannelData(0);
          for (let i = 0; i < d.length; i++) d[i] = Math.random() * 2 - 1;
          const src = C.createBufferSource(),
            f = C.createBiquadFilter();
          src.buffer = buf;
          f.type = "lowpass";
          f.frequency.value = 800;
          src.connect(f).connect(C.destination);
          src.start();
          setTimeout(() => src.stop(), 500);
        }
        function playSad() {
          const C = new (window.AudioContext || window.webkitAudioContext)(),
            o = C.createOscillator(),
            g = C.createGain();
          o.type = "triangle";
          o.frequency.value = 220;
          o.connect(g).connect(C.destination);
          o.start();
          g.gain.setValueAtTime(1, C.currentTime);
          g.gain.exponentialRampToValueAtTime(0.001, C.currentTime + 0.8);
          setTimeout(() => o.stop(), 800);
        }

        function showSpecialPopup(emoji, slogan, tornadoMode = false, persistent = false) {
          if (!specialPopup) return;
          
          if (tornadoMode) {
            specialPopup.innerHTML = `
            <div class="special-popup-3d">
              <span class="emoji"></span>
              <div class="slogan">TORNADO!</div>
            </div>`;
            specialPopup.classList.add("show", "tornado-mode");
            specialPopup.classList.remove("hidden");
            setTimeout(() => {
              if (specialPopup) {
                specialPopup.classList.remove("show");
                setTimeout(() => {
                  if (specialPopup) specialPopup.classList.add("hidden");
                }, 400);
                specialPopup.classList.remove("tornado-mode");
              }
            }, 5000);
            return;
          }
          
          specialPopup.innerHTML = `
          <div class="special-popup-3d" style="background: rgba(255, 255, 255, 0.98); padding: 2rem; border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);">
            <span class="emoji" style="font-size: 3rem; margin-bottom: 1rem;">${emoji}</span>
            <div class="slogan" style="font-size: 1.5rem; font-weight: 600; color: #333; line-height: 1.3;">${slogan}</div>
            ${persistent ? '<div style="margin-top: 1.5rem; padding: 0.8em 1.5em; background: #6f5c91; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-block; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">Click to Continue</div>' : ''}
          </div>`;
          specialPopup.classList.add("show");
          specialPopup.classList.remove("hidden");
          
          // Only auto-hide if not persistent
          if (!persistent) {
            setTimeout(() => {
              if (specialPopup) {
                specialPopup.classList.remove("show");
                setTimeout(() => {
                  if (specialPopup) specialPopup.classList.add("hidden");
                }, 400);
              }
            }, 4000);
          } else {
            // For persistent popups, add click handler to dismiss
            specialPopup.onclick = () => {
              specialPopup.classList.remove("show");
              setTimeout(() => {
                if (specialPopup) {
                  specialPopup.classList.add("hidden");
                  specialPopup.onclick = null; // Remove click handler
                }
              }, 400);
            };
          }
        }

        function animateScore(team, animationClass) {
          const el = team === "A" ? scoreAEl : scoreBEl;
          if (el) {
            el.classList.add("score-animate", animationClass);
            setTimeout(() => {
              if (el) el.classList.remove(animationClass);
            }, 800);
          }
        }
        function animateKangarooSwap() {
          if (scoreAEl) scoreAEl.classList.add("score-animate", "kangaroo-jump");
          if (scoreBEl) scoreBEl.classList.add("score-animate", "kangaroo-jump");
          setTimeout(() => {
            if (scoreAEl) scoreAEl.classList.remove("kangaroo-jump");
            if (scoreBEl) scoreBEl.classList.remove("kangaroo-jump");
          }, 800);
        }
        function animateSkunk(team) {
          const el = team === "A" ? scoreAEl : scoreBEl;
          if (el) {
            el.classList.add("skunk-cloud");
            setTimeout(() => {
              if (el) el.classList.remove("skunk-cloud");
            }, 1100);
          }
        }

        // Confetti burst function
        function confettiBurst(targetBtn) {
          const effect = document.createElement("div");
          effect.style.position = "absolute";
          effect.style.left =
            targetBtn.offsetLeft + targetBtn.offsetWidth / 2 + "px";
          effect.style.top =
            targetBtn.offsetTop + targetBtn.offsetHeight / 2 + "px";
          effect.style.pointerEvents = "none";
          effect.style.zIndex = 10000;

          // Create a circular burst of particles
          const particles = [];
          const numParticles = 12;
          const colors = [
            "#FFD700",
            "#FFA500",
            "#FF69B4",
            "#87CEEB",
            "#98FB98",
          ];

          for (let i = 0; i < numParticles; i++) {
            const particle = document.createElement("div");
            const angle = (i / numParticles) * Math.PI * 2;
            const color = colors[Math.floor(Math.random() * colors.length)];

            particle.style.position = "absolute";
            particle.style.width = "8px";
            particle.style.height = "8px";
            particle.style.background = color;
            particle.style.borderRadius = "50%";
            particle.style.transform = "translate(-50%, -50%)";

            const animation = particle.animate(
              [
                { transform: "translate(-50%, -50%) scale(1)", opacity: 1 },
                {
                  transform: `translate(${Math.cos(angle) * 100}px, ${
                    Math.sin(angle) * 100
                  }px) scale(0)`,
                  opacity: 0,
                },
              ],
              {
                duration: 1500,
                easing: "cubic-bezier(0.4, 0, 0.2, 1)",
              }
            );

            particles.push({ element: particle, animation });
            effect.appendChild(particle);
          }

          document.body.appendChild(effect);

          // Remove the effect after animation completes
          setTimeout(() => {
            effect.remove();
          }, 1500);
        }

        // Sound effect stubs
        function playWin() {
          const C = new (window.AudioContext || window.webkitAudioContext)(),
            o = C.createOscillator(),
            g = C.createGain();
          o.type = "triangle";
          o.frequency.value = 880;
          o.connect(g).connect(C.destination);
          o.start();
          g.gain.setValueAtTime(1, C.currentTime);
          g.gain.exponentialRampToValueAtTime(0.001, C.currentTime + 0.7);
          setTimeout(() => o.stop(), 700);
        }

        function computerTurn() {
          // Find all enabled grid buttons
          const available = Array.from(
            document.querySelectorAll("#grid button:not(:disabled)")
          );
          if (available.length === 0) return;
          
          // Always answer correctly: click correct button in modal
          const correctBtn = document.getElementById("correctBtn");
          if (correctBtn) {
            correctBtn.click();
          }
          
          // Pick a random button after the modal closes and board appears
          setTimeout(() => {
            const btn = available[Math.floor(Math.random() * available.length)];
            // Check if special popup is visible after a short delay (to allow popup to show)
            setTimeout(() => {
              const popup = document.getElementById("specialPopup");
              if (popup && popup.classList.contains("show")) {
                // Wait for popup to disappear (2.65s), then wait 2.0s, then pick
                setTimeout(() => {
                  setTimeout(() => {
                    btn.click();
                  }, 2000);
                }, 2650);
              } else {
                // No popup, normal delay
                setTimeout(() => {
                  btn.click();
                }, 2000);
              }
            }, 100); // Give popup a moment to appear
          }, 3000); // Wait for modal to close and board to appear
        }

        // --- Custom Expandable Quiz Dropdown Logic ---
        const customQuizDropdown =
          document.getElementById("customQuizDropdown");
        let customQuizDropdownList = null;
        let customQuizDropdownOpen = false;
        function closeCustomQuizDropdown() {
          if (customQuizDropdownList) {
            customQuizDropdownList.remove();
            customQuizDropdownList = null;
          }
          customQuizDropdownOpen = false;
        }
        function openCustomQuizDropdown() {
          if (customQuizDropdownOpen) return;
          if (!quizLibrary || !quizLibrary.length) {
            quizLibrary = fallbackQuizzes;
          }
          // Group quizzes by category/folder
          const categories = {};
          quizLibrary.forEach((quiz, i) => {
            const cat = quiz.category || "Other";
            const folder = quiz.folder || null;
            if (!categories[cat]) categories[cat] = { folders: {}, root: [] };
            if (folder) {
              if (!categories[cat].folders[folder])
                categories[cat].folders[folder] = [];
              categories[cat].folders[folder].push({ ...quiz, index: i });
            } else {
              categories[cat].root.push({ ...quiz, index: i });
            }
          });
          
          // Sort quizzes within each category/folder by title (A-Z)
          Object.keys(categories).forEach(cat => {
            // Sort root quizzes by title
            categories[cat].root.sort((a, b) => a.title.localeCompare(b.title));
            
            // Sort quizzes within each folder by title
            Object.keys(categories[cat].folders).forEach(folder => {
              categories[cat].folders[folder].sort((a, b) => a.title.localeCompare(b.title));
            });
          });
          
          // Build dropdown list (no <details> or <summary>)
          customQuizDropdownList = document.createElement("div");
          customQuizDropdownList.className = "custom-quiz-dropdown-list";
          Object.keys(categories)
            .sort((a, b) => a.localeCompare(b))
            .forEach((cat) => {
              // Category header
              const catDiv = document.createElement("div");
              catDiv.className = "custom-quiz-category";
              catDiv.tabIndex = 0;
              catDiv.innerHTML = `<span>${cat}</span><span class="custom-quiz-category-arrow"></span>`;
              let open = false;
              const quizList = document.createElement("ul");
              quizList.className = "custom-quiz-quizlist";
              quizList.style.display = "none";
              // Folders
              const folderNames = Object.keys(categories[cat].folders).sort(
                (a, b) => a.localeCompare(b)
              );
              folderNames.forEach((folder) => {
                const folderDiv = document.createElement("div");
                folderDiv.className = "custom-quiz-folder";
                folderDiv.tabIndex = 0;
                folderDiv.innerHTML = `<span>${folder}</span><span class="custom-quiz-folder-arrow"></span>`;
                let folderOpen = false;
                const folderList = document.createElement("ul");
                folderList.className = "custom-quiz-folderlist";
                folderList.style.display = "none";
                categories[cat].folders[folder].forEach((quiz) => {
                  const li = document.createElement("li");
                  li.textContent = quiz.title;
                  li.onclick = function (e) {
                    e.stopPropagation();
                    customQuizDropdown.textContent = quiz.title;
                    selectedQuizId = quiz.id;
                    closeCustomQuizDropdown();
                  };
                  if (selectedQuizId === quiz.id) li.classList.add("selected");
                  folderList.appendChild(li);
                });
                folderDiv.onclick = function (e) {
                  e.stopPropagation();
                  folderOpen = !folderOpen;
                  folderDiv.classList.toggle("open", folderOpen);
                  folderList.style.display = folderOpen ? "" : "none";
                };
                folderDiv.appendChild(folderList);
                quizList.appendChild(folderDiv);
              });
              // Root quizzes
              categories[cat].root.forEach((quiz) => {
                const li = document.createElement("li");
                li.textContent = quiz.title;
                li.onclick = function (e) {
                  e.stopPropagation();
                  customQuizDropdown.textContent = quiz.title;
                  selectedQuizId = quiz.id;
                  closeCustomQuizDropdown();
                };
                if (selectedQuizId === quiz.id) li.classList.add("selected");
                quizList.appendChild(li);
              });
              catDiv.onclick = function (e) {
                e.stopPropagation();
                open = !open;
                catDiv.classList.toggle("open", open);
                quizList.style.display = open ? "" : "none";
              };
              customQuizDropdownList.appendChild(catDiv);
              customQuizDropdownList.appendChild(quizList);
            });
          customQuizDropdown.parentNode.appendChild(customQuizDropdownList);
          customQuizDropdownOpen = true;
        }
        if (customQuizDropdown) {
          customQuizDropdown.onclick = function (e) {
            e.stopPropagation();
            console.log("Dropdown clicked! quizLibrary length:", quizLibrary.length);
            if (customQuizDropdownOpen) {
              closeCustomQuizDropdown();
            } else {
              openCustomQuizDropdown();
            }
          };
          document.addEventListener("click", function (e) {
            if (customQuizDropdownOpen) closeCustomQuizDropdown();
          });
        }
        // Remove old quizSelect logic (dropdown and onchange)
        // ... existing code ...

        function showPointsPopup(points, team, breakdown = null) {
          const specialPopup = document.getElementById("specialPopup");
          if (!specialPopup) return;
          
          // Clear any existing timeouts or click handlers
          if (specialPopup._timeout) {
            clearTimeout(specialPopup._timeout);
            specialPopup._timeout = null;
          }
          specialPopup.onclick = null;
          
          if (breakdown) {
            // Show detailed breakdown with click to continue
            specialPopup.innerHTML = `
              <div class="points-breakdown-animation" style="text-align:center;padding:1rem;">
                <div style="font-size:1.1rem;margin-bottom:0.8rem;color:#666;font-weight:600;">Points Breakdown:</div>
                <div style="font-size:1.4rem;font-weight:bold;color:#4caf50;margin-bottom:0.5rem;">+${breakdown.basePoints}</div>
                <div style="font-size:1rem;color:#666;margin-bottom:0.8rem;font-style:italic;">${breakdown.effect}</div>
                <div style="font-size:1.6rem;font-weight:bold;color:#6f5c91;border-top:2px solid #ddd;padding-top:0.8rem;margin-top:0.8rem;">= +${breakdown.finalTotal}</div>
                <div style="margin-top:1.5rem;padding:0.8em 1.5em;background:#6f5c91;color:white;border-radius:8px;font-weight:600;cursor:pointer;display:inline-block;box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                  Click to Continue
                </div>
              </div>
            `;
            
            // Return a promise that resolves when the popup is dismissed
            return new Promise((resolve) => {
              specialPopup.onclick = () => {
                console.log("Points breakdown clicked - hiding popup");
                specialPopup.classList.remove("show");
                setTimeout(() => {
                  if (specialPopup) {
                    specialPopup.classList.add("hidden");
                    specialPopup.classList.remove("points-mode");
                    specialPopup.onclick = null; // Remove click handler
                    console.log("Points breakdown hidden");
                    resolve(); // Resolve the promise when dismissed
                  }
                }, 400);
              };
            });
          } else {
            // Show simple points
            specialPopup.innerHTML = `<div class="points-reveal-animation points-text-glow">${points}</div>`;
          }
          
          specialPopup.classList.add("show", "points-mode");
          specialPopup.classList.remove("hidden");
          specialPopup.style.color =
            team === "A" ? "var(--teamA)" : "var(--teamB)";
          
          // For simple points, auto-hide after 3.5 seconds
          if (!breakdown) {
            specialPopup._timeout = setTimeout(() => {
              if (specialPopup) {
                specialPopup.classList.remove("show");
                specialPopup._timeout = setTimeout(() => {
                  if (specialPopup) {
                    specialPopup.classList.add("hidden");
                    specialPopup.classList.remove("points-mode");
                    specialPopup._timeout = null;
                  }
                }, 400);
              }
            }, 3500);
          }
          
          // Return undefined for simple points (no promise needed)
          return undefined;
        }

        // 1. Make quiz titles in 'My Library' clickable and add detail page
        async function renderMyQuizDetailPage(quizId) {
          console.log("renderMyQuizDetailPage called with quizId:", quizId);
          librarySection.innerHTML = "<h2>Loading quiz...</h2>";
          // Try to fetch from Supabase
          const { data, error } = await supabaseClient
            .from("quizzes")
            .select("*")
            .eq("id", quizId)
            .single();
          if (error || !data) {
            librarySection.innerHTML =
              '<div style="color:red;">Quiz not found.</div>';
            return;
          }
          const quiz = data;
          let html = `<div style='max-width:700px;margin:0 auto;'>
          <h2>${quiz.title}</h2>
          <div style='margin-bottom:1em;color:#888;'>${
            quiz.category || ""
          } &mdash; ${
            quiz.questions && quiz.questions.length ? quiz.questions.length : 0
          } questions</div>
          <div style='display:flex;gap:0.5em;margin-bottom:1.5em;'>
           <button class="purple-btn play-btn" data-quizid="${
             quiz.id
           }">Play</button>
            <button class="purple-btn" onclick="window.publishQuizToPublic && window.publishQuizToPublic(${
              quiz.id
            })">Publish to Play Tornado Library</button>
            <button class="purple-btn" onclick="navigator.clipboard.writeText(window.location.href)">Share</button>
          </div>
          <ol style='background:#f9f9f9;padding:1.2em 1.5em;border-radius:10px;'>`;
          (quiz.questions || []).forEach((q, i) => {
            html += `<li style='margin-bottom:1em;'><b>Q:</b> ${
              q.question
            }<br><b>A:</b> ${q.answer || ""}</li>`;
          });
          html += "</ol></div>";
          librarySection.innerHTML = html;
        }

        // Add Create Folder button and modal
        function showCreateFolderModal() {
          const modal = document.createElement("div");
          modal.style.position = "fixed";
          modal.style.top = "0";
          modal.style.left = "0";
          modal.style.width = "100vw";
          modal.style.height = "100vh";
          modal.style.background = "rgba(49,114,122,0.85)";
          modal.style.zIndex = "4000";
          modal.style.display = "flex";
          modal.style.alignItems = "center";
          modal.style.justifyContent = "center";
          modal.innerHTML = `<div style="background:#fff;padding:2.2em 2.5em;border-radius:16px;max-width:420px;width:95vw;box-shadow:0 4px 32px rgba(0,0,0,0.18);position:relative;">
          <button id="closeCreateFolderModal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#6F5C91;">&times;</button>
          <h3 style="margin-top:0;">Create a New Folder</h3>
          <input id="newFolderNameInput" placeholder="Folder name" maxlength="32" style="width:100%;margin-bottom:1em;">
          <button id="createFolderConfirmBtn" class="purple-btn" style="width:100%;">Create Folder</button>
          <div id="createFolderError" style="color:#e57373;margin-top:0.7em;"></div>
        </div>`;
          document.body.appendChild(modal);
          document.getElementById("closeCreateFolderModal").onclick = () =>
            modal.remove();
          modal.onclick = function (e) {
            if (e.target === modal) modal.remove();
          };
          document.getElementById("createFolderConfirmBtn").onclick =
            async function () {
              const name = document
                .getElementById("newFolderNameInput")
                .value.trim();
              if (!name) {
                document.getElementById("createFolderError").textContent =
                  "Please enter a folder name.";
                return;
              }
              if (myLibraryFolders.includes(name)) {
                document.getElementById("createFolderError").textContent =
                  "Folder already exists.";
                return;
              }
              myLibraryFolders.push(name);
              saveMyLibraryFolders();
              modal.remove();
              await renderMyLibrary();
            };
        }

        // ... inside renderMyLibrary, after rendering the buttons ...

        async function openCreateQuizModal(is_public) {
          const createQuizModal = document.getElementById("createQuizModal");
          if (createQuizModal) {
            createQuizModal.style.display = "flex";
            createQuizModal.classList.remove("hidden");
            // Inline logic to attach form listeners and logic
            const createQuizForm = document.getElementById("createQuizForm");
            const quizTitleInput = document.getElementById("quizTitleInput");
            const quizCategorySelect =
              document.getElementById("quizCategorySelect");
            const newCategoryContainer = document.getElementById(
              "newCategoryContainer"
            );
            const newCategoryInput =
              document.getElementById("newCategoryInput");
            const quizFolderSelect =
              document.getElementById("quizFolderSelect");
            const quizIsPublicInput =
              document.getElementById("quizIsPublicInput");
            const quizQuestionsInput =
              document.getElementById("quizQuestionsInput");
            const createQuizError = document.getElementById("createQuizError");
            if (createQuizForm) {
              // Populate categories
              (async function loadCategories() {
                quizCategorySelect.innerHTML =
                  '<option value="">Select category</option>';
                let { data, error } = await supabaseClient
                  .from("quizzes")
                  .select("category")
                  .neq("category", null);
                let cats = (data || []).map((q) => q.category).filter(Boolean);
                cats = Array.from(new Set(cats)).sort((a, b) =>
                  a.localeCompare(b)
                );
                cats.forEach((cat) => {
                  const opt = document.createElement("option");
                  opt.value = cat;
                  opt.textContent = cat;
                  quizCategorySelect.appendChild(opt);
                });
                // Add 'Create new category...' option
                const newOpt = document.createElement("option");
                newOpt.value = "__new__";
                newOpt.textContent = "Create new category...";
                quizCategorySelect.appendChild(newOpt);
              })();
              // Show/hide new category input
              quizCategorySelect.onchange = function () {
                if (quizCategorySelect.value === "__new__") {
                  newCategoryContainer.classList.remove("hidden");
                  newCategoryInput.required = true;
                } else {
                  newCategoryContainer.classList.add("hidden");
                  newCategoryInput.required = false;
                }
              };
              // Form submit logic
              createQuizForm.onsubmit = async function (e) {
                e.preventDefault();
                createQuizError.textContent = "";
                const title = quizTitleInput.value.trim();
                let category = quizCategorySelect.value;
                if (category === "__new__") {
                  category = newCategoryInput.value.trim();
                }
                const folder = quizFolderSelect.value || null;
                const isPublic = is_public ? true : quizIsPublicInput.checked;
                const rawQaText = quizQuestionsInput.value;

                if (!title || !category || !rawQaText) {
                  createQuizError.textContent = "All fields are required.";
                  return;
                }
                // Parse Q&A
                let questions = [];
                // split blocks on blank line
                const blocks = rawQaText
                  .split(/\n\s*\n/)
                  .map((b) => b.trim())
                  .filter((b) => b);
                // detect Q&A blocks
                if (blocks.some((b) => b.split("\n").length > 1)) {
                  questions = blocks.map((b) => {
                    const [q, a] = b.split("\n");
                    return { question: q.trim(), answer: a?.trim() || null };
                  });
                } else {
                  questions = rawQaText
                    .split("\n")
                    .map((l) => l.trim())
                    .filter((l) => l)
                    .map((q) => ({
                      question: q.replace(/^\d+\.\s*/, ""),
                      answer: null,
                    }));
                }
                console.log(questions, "Parsed questions");
                if (questions.length === 0) {
                  createQuizError.textContent =
                    "Please enter at least one Q&A pair.";
                  return;
                }
                // Insert into Supabase
                try {
                  const user = await getCurrentUser();
                  if (!user) {
                    createQuizError.textContent =
                      "You must be logged in to create a quiz.";
                    return;
                  }
                  const { error } = await supabaseClient
                    .from("quizzes")
                    .insert([
                      {
                        title,
                        category,
                        folder,
                        questions,
                        is_public: isPublic,
                        owner: user.id,
                      },
                    ]);
                  if (error) {
                    createQuizError.textContent =
                      "Error saving quiz: " + error.message;
                    return;
                  }
                  createQuizError.style.color = "green";
                  createQuizError.textContent = "Quiz saved!";
                  setTimeout(() => {
                    document.getElementById("createQuizModal").style.display =
                      "none";
                    if (is_public) {
                      renderPublicLibrary();
                    } else {
                      renderMyLibrary();
                    }
                  }, 1000);
                } catch (err) {
                  createQuizError.textContent = "Network error.";
                }
              };
            }
            // ... existing code ...
          }
        }

        // Move quiz to folder (button-based)
        window.moveQuizToFolderBtn = async function (quizId, dropdownId) {
          const sel = document.getElementById(dropdownId);
          if (!sel) return;
          const folder = sel.value;
          await supabaseClient
            .from("quizzes")
            .update({ folder: folder === "Uncategorized" ? null : folder })
            .eq("id", quizId);
          await renderMyLibrary();
        };

        // 1. Change Home to How to Play in the header
        // In the nav bar HTML:
        // <a href="#" id="myLibraryLink" ...>My Library</a>
        // <a href="#" id="publicLibraryLink" ...>Play Tornado Library</a>
        // <button id="loginLogoutBtn" ...>Login</button>
        // Change the Home link:
        document.querySelector('nav a[href="/"]').textContent = "How to Play";
        document.querySelector('nav a[href="/"]').id = "howToPlayLink";

        // 2. Add How to Play page/section
        function renderHowToPlayPage() {
          librarySection.innerHTML = `
          <div style="display:flex;flex-wrap:wrap;align-items:flex-start;justify-content:center;gap:2.5rem;max-width:1100px;margin:2.5rem auto 0 auto;">
            <div style="flex:0 0 220px;max-width:220px;display:flex;align-items:center;justify-content:center;">
              <img src="tornado-logo.png" alt="Play Tornado Logo" style="width:200px;height:200px;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.10);background:#fff;">
            </div>
            <div style="flex:1 1 400px;min-width:320px;max-width:700px;text-align:left;">
              <h1 style="font-size:2.2rem;margin-top:0;display:flex;align-items:center;gap:0.5em;"> How to Play Tornado</h1>
              <p style="font-size:1.13rem;line-height:1.7;">Tornado is a fun, flexible classroom game that works great for review, practice, or just getting students excited to participate. You can use it with any content you already have: quizzes, worksheets, discussion questions, or even just verbal prompts. The game can be played as a whole class activity led by a teacher or host, or in single-player mode against the computer.</p>
              <h2 style="margin-top:2.2em;display:flex;align-items:center;gap:0.5em;"> Objective</h2>
              <p>Earn the most points by answering questions correctly and avoiding surprise penalties hidden on the board.</p>
              <h2 style="margin-top:2.2em;display:flex;align-items:center;gap:0.5em;"> Game Setup</h2>
              <ul style="margin-bottom:1.2em;">
                <li><b>Enter Team Names:</b> Choose two teams (or just one if playing solo).</li>
                <li><b>Choose Grid Size:</b> Pick how many boxes you want in the game (e.g., 5x5).</li>
                <li><b>Select Question Source:</b> Type in your questions, or leave it blank and use your own worksheet, quiz, or verbal questions.</li>
                <li><b>Set Power-Ups and Penalties:</b> Choose how many of each special box to include. These are explained below.</li>
              </ul>
              <h2 style="margin-top:2.2em;display:flex;align-items:center;gap:0.5em;"> How It Works</h2>
              <ul style="margin-bottom:1.2em;">
                <li>One team takes a turn choosing a numbered box.</li>
                <li>The teacher or host reads a question.</li>
                <li>If the team answers correctly, the host clicks the number.</li>
                <li>The box reveals either a point value or a surprise effect.</li>
                <li>If incorrect, the host decides whether to let the other team try or move on.</li>
              </ul>
              <p style="margin-bottom:1.2em;">You can use the <b>Skip</b> and <b>Pass</b> buttons to control the flow. The teacher or host has full control over pacing, turns, and score updates. In single-player mode, turns alternate automatically between the player and the computer.<br>Answers can be revealed at the teacher's or host's discretion.</p>
              <h2 style="margin-top:2.2em;display:flex;align-items:center;gap:0.5em;"> Power-Ups and Penalties</h2>
              <table style="width:100%;max-width:500px;background:#f9f9f9;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.04);margin-bottom:1.2em;">
                <thead><tr style="font-weight:700;background:#eee;"><td style="padding:0.5em;">Emoji</td><td style="padding:0.5em;">Name</td><td style="padding:0.5em;">What It Does</td></tr></thead>
                <tbody>
                  <tr><td style="padding:0.5em;"></td><td style="padding:0.5em;">Tornado</td><td style="padding:0.5em;">Steal all of the other team's current points.</td></tr>
                  <tr><td style="padding:0.5em;"></td><td style="padding:0.5em;">Double Lion</td><td style="padding:0.5em;">Double the number of points your team just earned.</td></tr>
                  <tr><td style="padding:0.5em;"></td><td style="padding:0.5em;">Skunk</td><td style="padding:0.5em;">Lose all of your team's points.</td></tr>
                  <tr><td style="padding:0.5em;"></td><td style="padding:0.5em;">Kangaroo Hop Swap</td><td style="padding:0.5em;">Swap your team's total score with the other team.</td></tr>
  
                  <tr><td style="padding:0.5em;"></td><td style="padding:0.5em;">Shield</td><td style="padding:0.5em;">Protects from negative effects until used.</td></tr>
                  <tr><td style="padding:0.5em;"></td><td style="padding:0.5em;">Hot Streak</td><td style="padding:0.5em;">Next correct answer worth 3x points.</td></tr>
                  <tr><td style="padding:0.5em;"></td><td style="padding:0.5em;">Coin Flip</td><td style="padding:0.5em;">Double or lose revealed points.</td></tr>
                </tbody>
              </table>
              <p style="margin-bottom:1.2em;">You can choose how many of each to include before the game begins.</p>
              <h2 style="margin-top:2.2em;display:flex;align-items:center;gap:0.5em;"> Tips for a Smooth Game</h2>
              <ul style="margin-bottom:1.2em;">
                <li>Keep the pace lively by preparing questions in advance.</li>
                <li>Encourage team collaboration before answering.</li>
                <li>Adjust difficulty and surprise settings based on your group.</li>
                <li>Use it to reinforce key ideas, prep for a test, or wrap up a unit in a fun way.</li>
              </ul>
              <button class="purple-btn" id="backToMainBtn" style="margin-top:2.5em;"> Back</button>
            </div>
          </div>
        `;
          document.getElementById("backToMainBtn").onclick = function () {
            hideLibraryScreen();
            window.location.hash = "";
          };
        }

        // 3. Hook up How to Play link in header
        const howToPlayLink = document.getElementById("howToPlayLink");
        if (howToPlayLink) {
          howToPlayLink.onclick = function (e) {
            e.preventDefault();
            window.location.hash = "#how-to-play";
          };
        }

        // 4. On main page, remove instructional text from How to Play box, leaving only the special item selectors
        // Find the element that contains the How to Play instructions and remove its text content, keeping only the selectors
        const howToPlayBox = document.querySelector(".how-to-play");
        if (howToPlayBox) {
          howToPlayBox.innerHTML = "";
          // Move the special item selectors (if any) back in
          const selectors = document.querySelector(
            ".special-item-compact-list"
          );
          if (selectors) howToPlayBox.appendChild(selectors);
        }

        // ... existing code ...
        if (window.location.hash === "#my-library") {
          renderMyLibrary();
        }

        // === LIBRARY GAME OPTIONS MODAL FUNCTIONS ===
        
        // Function to show game options modal for library quizzes
        async function showGameOptionsModalFromLibrary(quizId) {
          // Fetch the quiz data first
          const { data: quiz, error } = await supabaseClient
            .from("quizzes")
            .select("*")
            .eq("id", quizId)
            .single();

          if (error || !quiz) {
            alert("Error loading quiz. Please try again.");
            return;
          }

          // Show the library game options modal
          const modal = document.getElementById('libraryGameOptionsModal');
          modal.style.display = 'flex';
          modal.classList.remove('hidden');

          // Set quiz title
          document.getElementById('libraryQuizTitle').textContent = quiz.title;
          
          // Set default values
          document.getElementById('libraryTeamAName').value = 'Team A';
          document.getElementById('libraryTeamBName').value = 'Team B';
          document.getElementById('librarySinglePlayer').checked = false;
          document.getElementById('libraryGridSize').value = '18';
          document.getElementById('libraryTornadoCount').value = '2';
          document.getElementById('libraryDoubleCount').value = '2';
          document.getElementById('libraryLoseCount').value = '2';
          document.getElementById('librarySwapCount').value = '1';
  
          document.getElementById('libraryShieldCount').value = '1';
          document.getElementById('libraryHotStreakCount').value = '1';
          document.getElementById('libraryCoinFlipCount').value = '1';

          // Handle close button
          document.getElementById('closeLibraryGameOptionsModal').onclick = function() {
            modal.style.display = 'none';
            modal.classList.add('hidden');
          };

          // Handle start game button
          document.getElementById('startLibraryGameBtn').onclick = async function() {
            // Get all the values
            const teamA = document.getElementById('libraryTeamAName').value.trim() || 'Team A';
            const teamB = document.getElementById('libraryTeamBName').value.trim() || 'Team B';
            const singlePlayer = document.getElementById('librarySinglePlayer').checked;
            const gridSize = +document.getElementById('libraryGridSize').value;
            const tornadoCount = +document.getElementById('libraryTornadoCount').value;
            const doubleCount = +document.getElementById('libraryDoubleCount').value;
            const loseCount = +document.getElementById('libraryLoseCount').value;
            const swapCount = +document.getElementById('librarySwapCount').value;
  
            const shieldCount = +document.getElementById('libraryShieldCount').value;
            const hotStreakCount = +document.getElementById('libraryHotStreakCount').value;
            const coinFlipCount = +document.getElementById('libraryCoinFlipCount').value;

            // Close modal
            modal.style.display = 'none';
            modal.classList.add('hidden');

            // Start the game with these settings
            await startGameWithSettings(quiz, {
              teamA, teamB, singlePlayer, gridSize, 
              tornadoCount, doubleCount, loseCount, swapCount,
              shieldCount, hotStreakCount, coinFlipCount
            });
          };
        }

        // === ROSTER INTEGRATION ===
        let rosterData = null;
        let teamMode = false;
        let currentStudentIndex = 0;
        let currentTeamStudents = [];
        let studentPoints = {}; // Track individual student points
        
        // === POINT CONFIGURATION ===
        let individualPoints = 100;
        let teamVictoryPoints = 500;
        
        // === GAME INTEGRATION ===
        function savePointsToWarGame(studentPoints, teamVictoryBonus) {
            try {
                // Get existing rosters
                const rosters = JSON.parse(localStorage.getItem('tornadoRosters') || '[]');
                
                if (rosters.length === 0) {
                    // Create a new roster automatically
                    createAutoRoster(studentPoints, teamVictoryBonus);
                    return;
                }
                
                // Find the roster that matches our current roster data
                let targetRoster = null;
                if (rosterData && rosterData.id) {
                    targetRoster = rosters.find(r => r.id === rosterData.id);
                }
                
                // If no matching roster found, use the most recent one
                if (!targetRoster) {
                    targetRoster = rosters.reduce((latest, roster) => {
                        return new Date(roster.lastModified || roster.created_at) > new Date(latest.lastModified || latest.created_at) ? roster : latest;
                    });
                }
                
                // Add points to students in the roster
                if (targetRoster && targetRoster.roster) {
                    targetRoster.roster.forEach(student => {
                        if (studentPoints[student.name]) {
                            student.points = (student.points || 0) + studentPoints[student.name];
                        }
                    });
                    
                    // Add team victory bonuses
                    if (teamVictoryBonus && targetRoster.teams) {
                        targetRoster.teams.forEach(team => {
                            if (teamVictoryBonus[team.name]) {
                                team.students.forEach(studentName => {
                                    const student = targetRoster.roster.find(s => s.name === studentName);
                                    if (student) {
                                        student.points = (student.points || 0) + teamVictoryBonus[team.name];
                                    }
                                });
                            }
                        });
                    }
                    
                    // Update last modified timestamp
                    targetRoster.lastModified = new Date().toISOString();
                    
                    // Save updated roster
                    const rosterIndex = rosters.findIndex(r => r.id === targetRoster.id);
                    if (rosterIndex >= 0) {
                        rosters[rosterIndex] = targetRoster;
                        localStorage.setItem('tornadoRosters', JSON.stringify(rosters));
                    }
                }
                
                console.log('Points transferred to roster:', targetRoster.name);
                
            } catch (error) {
                console.error('Error saving points to roster:', error);
            }
        }
        
        function createAutoRoster(studentPoints, teamVictoryBonus) {
            if (!rosterData || !rosterData.roster) return;
            
            const rosterId = 'auto_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Create roster with quiz points
            const roster = rosterData.roster.map(student => ({
                id: `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                name: student.name,
                points: 5 + (studentPoints[student.name] || 0),
                teamId: student.teamId,
                teamName: student.teamName,
                teamColor: student.teamColor
            }));
            
            const newRosterData = {
                id: rosterId,
                name: `Auto-Generated Roster - ${new Date().toLocaleDateString()}`,
                created_at: new Date().toISOString(),
                lastModified: new Date().toISOString(),
                roster: roster,
                teams: rosterData.teams || [],
                teamMode: rosterData.teamMode || false,
                gameState: {
                    board: { w: 0, h: 0, tiles: [] },
                    tiles: [],
                    truces: []
                }
            };
            
            // Save new roster
            const rosters = JSON.parse(localStorage.getItem('tornadoRosters') || '[]');
            rosters.push(newRosterData);
            localStorage.setItem('tornadoRosters', JSON.stringify(rosters));
            
            console.log('Auto-created roster:', newRosterData.name);
        }
        
        function transferQuizPointsToWar(winningTeam) {
            if (!teamMode || !rosterData) return;
            
            // Use the actual individual points students earned during the quiz
            const pointsToTransfer = {};
            
            // Transfer actual points earned by each student during the quiz
            rosterData.roster.forEach(student => {
                pointsToTransfer[student.name] = studentPoints[student.name] || 0;
            });
            
            // Calculate team victory bonus
            const teamVictoryBonus = {};
            const winningTeamName = names[winningTeam];
            
            if (winningTeamName) {
                teamVictoryBonus[winningTeamName] = teamVictoryPoints;
            }
            
            // Save points to war game
            savePointsToWarGame(pointsToTransfer, teamVictoryBonus);
            
            // Show notification
            const totalPointsTransferred = Object.values(pointsToTransfer).reduce((a, b) => a + b, 0) +
                                         Object.values(teamVictoryBonus).reduce((a, b) => a + b, 0);
            
            setTimeout(() => {
                alert(` Quiz Complete!\n\nPoints transferred to Tornado War:\n Individual quiz points: ${Object.values(pointsToTransfer).reduce((a, b) => a + b, 0)} total\n Team ${winningTeamName} victory bonus: ${teamVictoryPoints} points\n\nTotal points transferred: ${totalPointsTransferred}\n\nCheck the War game to see updated student balances!`);
            }, 2000);
        }
        
        function transferIndividualQuizPointsToWar() {
            if (!rosterData) return;
            
            // Use the actual individual points students earned during the quiz
            const pointsToTransfer = {};
            
            // Transfer actual points earned by each student during the quiz
            rosterData.roster.forEach(student => {
                pointsToTransfer[student.name] = studentPoints[student.name] || 0;
            });
            
            // Save points to war game (no team victory bonus in individual mode)
            savePointsToWarGame(pointsToTransfer, {});
            
            // Show notification
            const totalPointsTransferred = Object.values(pointsToTransfer).reduce((a, b) => a + b, 0);
            
            setTimeout(() => {
                alert(` Quiz Complete!\n\nPoints transferred to Tornado War:\n Individual quiz points: ${totalPointsTransferred} total\n\nCheck the War game to see updated student balances!`);
            }, 2000);
        }
        
        function showEndGameResults() {
          // Find winner
          let winner = null;
          let highestScore = -1;
          let allScores = [];
          
          if (teamMode && rosterData && rosterData.teams) {
            // Team mode - find winning team
            rosterData.teams.forEach((team, index) => {
              const teamLetter = String.fromCharCode(65 + index);
              const teamScore = scores[teamLetter] || 0;
              allScores.push({ name: names[teamLetter] || `Team ${teamLetter}`, score: teamScore, id: teamLetter });
              if (teamScore > highestScore) {
                highestScore = teamScore;
                winner = teamLetter;
              }
            });
          } else {
            // Individual mode - find winning student
            rosterData.roster.forEach(student => {
              const studentScore = studentPoints[student.name] || 0;
              allScores.push({ name: student.name, score: studentScore, id: student.name });
              if (studentScore > highestScore) {
                highestScore = studentScore;
                winner = student.name;
              }
            });
          }
          
          // Sort scores for display
          allScores.sort((a, b) => b.score - a.score);
          
          // Create results display
          let resultsHTML = `
            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; margin: 20px 0;">
              <h2 style="margin: 0 0 20px 0; font-size: 2.5rem;"> GAME COMPLETE! </h2>
              <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3 style="margin: 0 0 15px 0; color: #ffd700;">Final Results</h3>
          `;
          
          allScores.forEach((entry, index) => {
            const isWinner = index === 0;
            const medal = index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : '';
            resultsHTML += `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: ${isWinner ? 'rgba(255,215,0,0.2)' : 'rgba(255,255,255,0.1)'}; border-radius: 8px;">
                <span style="font-size: 1.5rem;">${medal}</span>
                <span style="font-weight: ${isWinner ? 'bold' : 'normal'}; font-size: ${isWinner ? '1.2rem' : '1rem'};">${entry.name}</span>
                <span style="font-weight: bold; color: ${isWinner ? '#ffd700' : 'white'};">${entry.score} points</span>
              </div>
            `;
          });
          
          resultsHTML += `
              </div>
              <div style="margin: 20px 0;">
                <button id="saveAndReturnBtn" style="background: #10b981; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin: 10px;">
                   Save Points & Return Home
                </button>
              </div>
            </div>
          `;
          
          // Replace the main content with results
          const mainContent = document.querySelector('.wrap') || document.querySelector('#main-content');
          if (mainContent) {
            mainContent.innerHTML = resultsHTML;
          }
          
          // Add click handler for save button
          setTimeout(() => {
            const saveBtn = document.getElementById('saveAndReturnBtn');
            if (saveBtn) {
              saveBtn.onclick = () => {
                // Transfer points to war game
                if (rosterData) {
                  if (teamMode) {
                    transferQuizPointsToWar(winner);
                  } else {
                    transferIndividualQuizPointsToWar();
                  }
                }
                
                // Return to home screen
                setTimeout(() => {
                  window.location.href = '/';
                }, 2000);
              };
            }
          }, 100);
          
          // Play win sound
          if (typeof playWin === 'function') {
            playWin();
          }
        }
        
        window.endGameAndAwardPoints = function() {
            if (!rosterData) {
                alert('No roster data available to award points.');
                return;
            }
            
            // Find winner based on current scores
            let winner = null;
            let highestScore = -1;
            
            if (teamMode && rosterData.teams) {
                // Team mode - find winning team
                rosterData.teams.forEach((team, index) => {
                    const teamLetter = String.fromCharCode(65 + index);
                    const teamScore = scores[teamLetter] || 0;
                    if (teamScore > highestScore) {
                        highestScore = teamScore;
                        winner = teamLetter;
                    }
                });
            } else {
                // Individual mode - find winning student
                rosterData.roster.forEach(student => {
                    const studentScore = studentPoints[student.name] || 0;
                    if (studentScore > highestScore) {
                        highestScore = studentScore;
                        winner = student.name;
                    }
                });
            }
            
            if (winner) {
                // Transfer points to roster
                if (teamMode) {
                    transferQuizPointsToWar(winner);
                } else {
                    transferIndividualQuizPointsToWar();
                }
                
                // Show winner announcement
                const winnerName = teamMode ? (names[winner] || `Team ${winner}`) : winner;
                alert(` Game Ended!\n\nWinner: ${winnerName}\nScore: ${highestScore} points\n\nPoints have been saved to the roster and will carry over to Tornado War!`);
            } else {
                alert('No winner determined. Points have been saved to the roster.');
                transferIndividualQuizPointsToWar();
            }
        }
        
        // === QUIZ SETUP ROSTER INTEGRATION ===
        let quizRosterData = null;
        let quizTeamAssignment = null;
        
        function initializeQuizRosterIntegration() {
            const loadRosterBtn = document.getElementById('loadRosterBtn');
            const randomTeamsBtn = document.getElementById('randomTeamsBtn');
            const manualTeamsBtn = document.getElementById('manualTeamsBtn');
            
            if (loadRosterBtn) {
                loadRosterBtn.addEventListener('click', loadQuizRoster);
            }
            
            if (randomTeamsBtn) {
                randomTeamsBtn.addEventListener('click', () => assignRandomTeams());
            }
            
            if (manualTeamsBtn) {
                manualTeamsBtn.addEventListener('click', () => showManualTeamAssignment());
            }
        }
        
        function loadQuizRoster() {
            // Show roster selection modal with multiple roster options
            showQuizRosterSelectionModal();
        }
        
        function showQuizRosterSelectionModal() {
            // Get all saved rosters
            const allRosters = getAllQuizRosters();
            
            if (allRosters.length === 0) {
                showNoRostersModal();
                return;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'quizRosterSelectionModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                font-family: 'Lexend Deca', sans-serif;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 16px;
                    max-width: 700px;
                    width: 90vw;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="margin: 0; color: #6f5c91; font-size: 1.8rem;">Select Roster for Quiz</h2>
                        <button id="closeQuizRosterModal" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 0.5rem 1rem;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        "> Close</button>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #333;">Choose a roster to use for the quiz:</h3>
                        <div id="quizRosterList" style="max-height: 400px; overflow-y: auto;">
                            ${allRosters.map(roster => `
                                <div class="quiz-roster-item" data-roster-id="${roster.id}" style="
                                    background: #f8f9fa;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                    padding: 1rem;
                                    margin-bottom: 0.75rem;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4 style="margin: 0 0 0.25rem 0; color: #6f5c91;">${roster.name}</h4>
                                            <p style="margin: 0; color: #666; font-size: 0.9rem;">
                                                ${roster.roster.length} students  
                                                ${roster.teamMode === 'individual' ? 'Individual Mode' : 
                                                  roster.teams ? `${roster.teams.length} Teams` : 'No Teams'}
                                            </p>
                                            <p style="margin: 0; color: #999; font-size: 0.8rem;">
                                                Last modified: ${new Date(roster.lastModified).toLocaleString()}
                                            </p>
                                        </div>
                                        <button class="select-roster-btn" data-roster-id="${roster.id}" style="
                                            background: #6f5c91;
                                            color: white;
                                            border: none;
                                            padding: 0.5rem 1rem;
                                            border-radius: 6px;
                                            cursor: pointer;
                                            font-size: 0.9rem;
                                        ">Select</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('closeQuizRosterModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            document.querySelectorAll('.select-roster-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const rosterId = btn.getAttribute('data-roster-id');
                    document.body.removeChild(modal);
                    selectQuizRoster(rosterId);
                });
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        function getAllQuizRosters() {
            const saved = localStorage.getItem('tornadoRosters');
            return saved ? JSON.parse(saved) : [];
        }
        
        function showNoRostersModal() {
            // Create a helpful modal when no rosters exist
            const modal = document.createElement('div');
            modal.id = 'noRostersModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                font-family: 'Lexend Deca', sans-serif;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 16px;
                    max-width: 500px;
                    width: 90vw;
                    text-align: center;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                ">
                    <div style="margin-bottom: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                        <h2 style="margin: 0 0 1rem 0; color: #6f5c91; font-size: 1.8rem;">No Rosters Found</h2>
                        <p style="margin: 0; color: #666; line-height: 1.5;">
                            You need to create a roster of students before you can start a quiz game.
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button id="goToRosterManagement" style="
                            background: #6f5c91;
                            color: white;
                            border: none;
                            padding: 1rem 2rem;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 1rem;
                        "> Manage Rosters</button>
                        
                        <button id="closeNoRostersModal" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 1rem 2rem;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 1rem;
                        "> Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('closeNoRostersModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            document.getElementById('goToRosterManagement').addEventListener('click', () => {
                document.body.removeChild(modal);
                // Navigate to roster management page
                window.location.href = '/roster';
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        function selectQuizRoster(rosterId) {
            const allRosters = getAllQuizRosters();
            const selectedRoster = allRosters.find(r => r.id === rosterId);
            
            if (selectedRoster) {
                quizRosterData = selectedRoster;
                updateRosterStatus(`Loaded: ${selectedRoster.name} (${selectedRoster.roster.length} students)`);
                
                // Auto-adjust grid size based on roster size
                updateGridSizeForRoster(selectedRoster.roster.length);
                
                showRosterTeamAssignmentModal();
            } else {
                updateRosterStatus('Error: Roster not found');
            }
        }
        
        function updateGridSizeForRoster(studentCount) {
            // Calculate optimal grid size: student count + 1 for odd numbers, or student count for even
            let optimalSize = studentCount;
            if (studentCount % 2 === 1) {
                optimalSize = studentCount + 1;
            }
            
            // Ensure minimum size of 8 and maximum of 40
            optimalSize = Math.max(8, Math.min(40, optimalSize));
            
            // Update the grid size select
            const gridSizeInput = document.getElementById('gridSizeInput');
            if (gridSizeInput) {
                // Set the value
                gridSizeInput.value = optimalSize;
                
                // Update the info text
                const gridSizeInfo = document.getElementById('gridSizeInfo');
                if (gridSizeInfo) {
                    gridSizeInfo.textContent = `Auto-adjusted to ${optimalSize} tiles for ${studentCount} students`;
                }
            }
        }
        
        function showRosterTeamAssignmentModal() {
            // Create a clean, dedicated modal for roster team assignment
            const modal = document.createElement('div');
            modal.id = 'rosterTeamModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                font-family: 'Lexend Deca', sans-serif;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 16px;
                    max-width: 800px;
                    width: 90vw;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="margin: 0; color: #6f5c91; font-size: 1.8rem;">Team Assignment</h2>
                        <button id="closeRosterModal" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 0.5rem 1rem;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        "> Close</button>
                    </div>
                    
                    <div style="margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #333;">${quizRosterData.roster.length} Students Loaded</h3>
                        <p style="margin: 0; color: #666; font-size: 0.9rem;">
                            ${quizRosterData.roster.map(s => s.name).join(', ')}
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #333;">Choose Team Mode:</h3>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button id="individualModeBtn" style="
                                background: #28a745;
                                color: white;
                                border: none;
                                padding: 1rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 1rem;
                                font-weight: 600;
                                flex: 1;
                                min-width: 150px;
                            ">Individual Mode</button>

                            <button id="randomTeamsBtn" style="
                                background: #007bff;
                                color: white;
                                border: none;
                                padding: 1rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 1rem;
                                font-weight: 600;
                                flex: 1;
                                min-width: 150px;
                            ">Random Teams</button>

                            <button id="manualTeamsBtn" style="
                                background: #6f5c91;
                                color: white;
                                border: none;
                                padding: 1rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 1rem;
                                font-weight: 600;
                                flex: 1;
                                min-width: 150px;
                            ">Manual Teams</button>
                        </div>
                    </div>
                    
                    <div id="teamAssignmentContent" style="min-height: 200px;">
                        <!-- Team assignment content will be populated here -->
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('closeRosterModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            document.getElementById('individualModeBtn').addEventListener('click', () => {
                showIndividualModeContent();
            });
            
            document.getElementById('randomTeamsBtn').addEventListener('click', () => {
                showRandomTeamsContent();
            });
            
            document.getElementById('manualTeamsBtn').addEventListener('click', () => {
                showManualTeamsContent();
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        function showIndividualModeContent() {
            const content = document.getElementById('teamAssignmentContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #28a745;">Individual Mode</h3>
                        <p style="margin: 0; color: #666;">Students will play individually without teams.</p>
                    </div>
                    
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid #ddd;">
                        <h4 style="margin: 0 0 1rem 0; color: #333;">Students:</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                            ${quizRosterData.roster.map(s => `
                                <span style="
                                    background: #f8f9fa;
                                    padding: 0.5rem 1rem;
                                    border-radius: 20px;
                                    border: 1px solid #ddd;
                                    font-size: 0.9rem;
                                ">${s.name}</span>
                            `).join('')}
                        </div>
                    </div>
                    
                    <button id="saveIndividualBtn" style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 1rem 2rem;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 1.1rem;
                    "> Save Individual Mode</button>
                </div>
            `;
            
            document.getElementById('saveIndividualBtn').addEventListener('click', () => {
                saveTeamMode('individual');
                document.body.removeChild(document.getElementById('rosterTeamModal'));
            });
        }
        
        function showRandomTeamsContent() {
            const content = document.getElementById('teamAssignmentContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="background: #e3f2fd; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #007bff;">Random Teams</h3>
                        <p style="margin: 0; color: #666;">Students will be randomly assigned to teams.</p>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #333;">Choose number of teams:</h4>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            ${[2, 3, 4, 5, 6].map(num => `
                                <button class="team-count-btn" data-count="${num}" style="
                                    background: #007bff;
                                    color: white;
                                    border: none;
                                    padding: 1rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    min-width: 100px;
                                ">${num} Teams</button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div id="randomTeamsPreview" style="min-height: 100px;"></div>
                </div>
            `;
            
            // Add event listeners for team count buttons
            document.querySelectorAll('.team-count-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const numTeams = parseInt(btn.getAttribute('data-count'));
                    createRandomTeamsPreview(numTeams);
                });
            });
        }
        
        function showManualTeamsContent() {
            const content = document.getElementById('teamAssignmentContent');
            content.innerHTML = `
                <div style="padding: 2rem;">
                    <div style="background: #f3e5f5; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; text-align: center;">
                        <h3 style="margin: 0 0 1rem 0; color: #6f5c91;">Manual Teams</h3>
                        <p style="margin: 0; color: #666;">Click students to assign them to teams.</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 2px solid #6f5c91;">
                            <h4 style="margin: 0 0 1rem 0; color: #6f5c91;">Team A</h4>
                            <input type="text" id="teamA-name" placeholder="Team A Name" style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 1px solid #ddd;
                                border-radius: 6px;
                                margin-bottom: 1rem;
                                font-size: 1rem;
                            " value="Team A">
                            <div id="teamA-students" style="
                                min-height: 120px;
                                border: 2px dashed #6f5c91;
                                border-radius: 8px;
                                padding: 1rem;
                                background: rgba(111, 92, 145, 0.05);
                            "></div>
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 2px solid #6f5c91;">
                            <h4 style="margin: 0 0 1rem 0; color: #6f5c91;">Team B</h4>
                            <input type="text" id="teamB-name" placeholder="Team B Name" style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 1px solid #ddd;
                                border-radius: 6px;
                                margin-bottom: 1rem;
                                font-size: 1rem;
                            " value="Team B">
                            <div id="teamB-students" style="
                                min-height: 120px;
                                border: 2px dashed #6f5c91;
                                border-radius: 8px;
                                padding: 1rem;
                                background: rgba(111, 92, 145, 0.05);
                            "></div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #666;">Unassigned Students</h4>
                        <div id="unassigned-students" style="
                            display: flex;
                            flex-wrap: wrap;
                            gap: 0.75rem;
                            padding: 1rem;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            background: white;
                            min-height: 80px;
                        ">
                            ${quizRosterData.roster.map(student => `
                                <div class="student-chip" data-student-id="${student.id}" style="
                                    background: #6f5c91;
                                    color: white;
                                    padding: 0.75rem 1.25rem;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 0.95rem;
                                    transition: all 0.2s ease;
                                    user-select: none;
                                ">${student.name}</div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button id="saveManualBtn" style="
                            background: #6f5c91;
                            color: white;
                            border: none;
                            padding: 1rem 2rem;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 1.1rem;
                        "> Save Manual Teams</button>
                    </div>
                </div>
            `;
            
            // Add event listeners for student chips
            document.querySelectorAll('.student-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    moveStudentToTeam(chip.getAttribute('data-student-id'));
                });
            });
            
            document.getElementById('saveManualBtn').addEventListener('click', () => {
                saveManualTeams();
                document.body.removeChild(document.getElementById('rosterTeamModal'));
            });
        }
        
        function showRosterSelectionScreen() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            // Get existing rosters
            const existingRosters = getExistingRosters();
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 2rem;
                    max-width: 600px;
                    width: 90vw;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 32px rgba(0,0,0,0.18);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; color: #6f5c91; font-size: 1.8rem;">Select or Create Roster</h2>
                        <button class="modal-close-btn" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 0.5rem 1rem;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1rem;
                        "> Close</button>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #6f5c91; margin-bottom: 1rem;"> Create New Roster</h3>
                        <p style="color: #666; margin-bottom: 1rem;">
                            Enter student names (one per line or separated by commas):
                        </p>
                        <textarea id="newRosterNames" placeholder="Enter student names here...&#10;Example:&#10;John Smith&#10;Jane Doe&#10;Mike Johnson" style="
                            width: 100%;
                            height: 120px;
                            padding: 1rem;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            font-size: 1rem;
                            resize: vertical;
                            margin-bottom: 1rem;
                        "></textarea>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="text" id="newRosterName" placeholder="Roster name (optional)" style="
                                flex: 1;
                                padding: 0.75rem;
                                border: 1px solid #ddd;
                                border-radius: 8px;
                                font-size: 1rem;
                            ">
                            <button class="create-roster-btn" style="
                                background: #28a745;
                                color: white;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 1rem;
                                font-weight: 600;
                            "> Save New Roster</button>
                        </div>
                    </div>
                    
                    ${existingRosters.length > 0 ? `
                        <div>
                            <h3 style="color: #6f5c91; margin-bottom: 1rem;"> Existing Rosters</h3>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${existingRosters.map((roster, index) => `
                                    <div style="
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        padding: 1rem;
                                        border: 1px solid #e0e0e0;
                                        border-radius: 8px;
                                        background: #f8f9fa;
                                    ">
                                        <div>
                                            <strong>${roster.name || 'Untitled Roster'}</strong>
                                            <br>
                                            <small style="color: #666;">${roster.roster.length} students  ${new Date(roster.lastModified).toLocaleDateString()}</small>
                                        </div>
                                        <button class="select-roster-btn" data-roster-index="${index}" style="
                                            background: #6f5c91;
                                            color: white;
                                            border: none;
                                            padding: 0.5rem 1rem;
                                            border-radius: 6px;
                                            cursor: pointer;
                                            font-size: 0.9rem;
                                        ">Select</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>No existing rosters found. Create your first roster above!</p>
                        </div>
                    `}
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            modal.querySelector('.modal-close-btn').addEventListener('click', () => {
                modal.remove();
            });
            
            modal.querySelector('.create-roster-btn').addEventListener('click', () => {
                createNewRoster(modal);
            });
            
            // Add event listeners for select roster buttons
            modal.querySelectorAll('.select-roster-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.getAttribute('data-roster-index'));
                    selectExistingRoster(index, modal);
                });
            });
        }
        
        function getExistingRosters() {
            const rosters = [];
            
            // Check for main roster
            const mainRoster = localStorage.getItem('tornadoRoster');
            if (mainRoster) {
                try {
                    const roster = JSON.parse(mainRoster);
                    rosters.push(roster);
                } catch (e) {
                    console.error('Error parsing main roster:', e);
                }
            }
            
            // Check for additional rosters
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tornadoRoster_')) {
                    try {
                        const roster = JSON.parse(localStorage.getItem(key));
                        rosters.push(roster);
                    } catch (e) {
                        console.error('Error parsing roster:', key, e);
                    }
                }
            }
            
            return rosters;
        }
        
        function createNewRoster(modal) {
            const namesText = document.getElementById('newRosterNames').value.trim();
            const rosterName = document.getElementById('newRosterName').value.trim();
            
            if (!namesText) {
                alert('Please enter at least one student name.');
                return;
            }
            
            // Parse names (support both line breaks and commas)
            const names = namesText.split(/[\n,]+/)
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            if (names.length === 0) {
                alert('Please enter valid student names.');
                return;
            }
            
            // Create roster object
            const roster = {
                name: rosterName || `Roster ${new Date().toLocaleDateString()}`,
                roster: names.map((name, index) => ({
                    id: `student_${Date.now()}_${index}`,
                    name: name
                })),
                lastModified: new Date().toISOString(),
                teams: [],
                teamMode: false
            };
            
            // Save roster
            const rosterKey = rosterName ? `tornadoRoster_${rosterName.replace(/[^a-zA-Z0-9]/g, '_')}` : 'tornadoRoster';
            localStorage.setItem(rosterKey, JSON.stringify(roster));
            
            // Set as current roster
            quizRosterData = roster;
            
            // Close modal and proceed to team creation
            modal.remove();
            showTeamCreationScreen(roster);
            
            // Update status
            updateRosterStatus(`Created roster: ${roster.name} (${roster.roster.length} students)`);
        }
        
        function selectExistingRoster(index, modal) {
            const existingRosters = getExistingRosters();
            if (index >= 0 && index < existingRosters.length) {
                const selectedRoster = existingRosters[index];
                
                // Set as current roster
                quizRosterData = selectedRoster;
                
                // Close modal and proceed to team creation
                modal.remove();
                showTeamCreationScreen(selectedRoster);
                
                // Update status
                updateRosterStatus(`Selected roster: ${selectedRoster.name} (${selectedRoster.roster.length} students)`);
            }
        }
        
        // Make functions globally accessible
        window.createNewRoster = createNewRoster;
        window.selectExistingRoster = selectExistingRoster;
        
        function updateRosterStatus(message) {
            const statusEl = document.getElementById('rosterStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }
        
        function showTeamCreationScreen(rosterData) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 2rem;
                    max-width: 800px;
                    width: 90vw;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 32px rgba(0,0,0,0.18);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; color: #6f5c91; font-size: 1.8rem;">Create Teams</h2>
                        <button class="modal-close-btn" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 0.5rem 1rem;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1rem;
                        "> Close</button>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <p style="margin: 0 0 1rem 0; color: #666; font-size: 1rem;">
                            You have <strong>${rosterData.roster.length} students</strong> in your roster. 
                            Choose how to organize them for the quiz:
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                        <button id="individualModeBtn" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            padding: 1rem 1.5rem;
                            cursor: pointer;
                            font-size: 1rem;
                            font-weight: 600;
                            flex: 1;
                            min-width: 200px;
                        ">
                             Individual Mode<br>
                            <small style="font-weight: normal; opacity: 0.9;">No teams, students play individually</small>
                        </button>
                        
                        <button id="randomTeamsBtn" style="
                            background: #007bff;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            padding: 1rem 1.5rem;
                            cursor: pointer;
                            font-size: 1rem;
                            font-weight: 600;
                            flex: 1;
                            min-width: 200px;
                        ">
                             Random Teams<br>
                            <small style="font-weight: normal; opacity: 0.9;">Automatically assign students to teams</small>
                        </button>
                        
                        <button id="manualTeamsBtn" style="
                            background: #6f5c91;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            padding: 1rem 1.5rem;
                            cursor: pointer;
                            font-size: 1rem;
                            font-weight: 600;
                            flex: 1;
                            min-width: 200px;
                        ">
                             Manual Teams<br>
                            <small style="font-weight: normal; opacity: 0.9;">Drag and drop students into teams</small>
                        </button>
                    </div>
                    
                    <div id="teamCreationContent" style="min-height: 200px;">
                        <!-- Content will be populated based on selection -->
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            modal.querySelector('.modal-close-btn').addEventListener('click', () => {
                modal.remove();
            });
            
            document.getElementById('individualModeBtn').addEventListener('click', () => {
                createIndividualMode(rosterData, modal);
            });
            
            document.getElementById('randomTeamsBtn').addEventListener('click', () => {
                showRandomTeamOptions(rosterData, modal);
            });
            
            document.getElementById('manualTeamsBtn').addEventListener('click', () => {
                showManualTeamInterface(rosterData, modal);
            });
        }
        
        function createIndividualMode(rosterData, modal) {
            const content = document.getElementById('teamCreationContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h3 style="color: #28a745; margin-bottom: 1rem;"> Individual Mode</h3>
                    <p style="color: #666; margin-bottom: 2rem;">
                        Students will play individually without teams. Each student will have their own turn.
                    </p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                        <strong>Students (${rosterData.roster.length}):</strong><br>
                        ${rosterData.roster.map(s => s.name).join(', ')}
                    </div>
                    <button class="save-individual-btn" style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 1rem 2rem;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1.1rem;
                        font-weight: 600;
                    "> Save Individual Mode</button>
                </div>
            `;
            
            // Add event listener for save button
            content.querySelector('.save-individual-btn').addEventListener('click', () => {
                saveTeamAssignment('individual', null, modal);
            });
        }
        
        function showRandomTeamOptions(rosterData, modal) {
            const content = document.getElementById('teamCreationContent');
            content.innerHTML = `
                <div style="padding: 2rem;">
                    <h3 style="color: #007bff; margin-bottom: 1rem; text-align: center;"> Random Teams</h3>
                    <p style="color: #666; margin-bottom: 2rem; text-align: center;">
                        Choose how many teams to create. Students will be randomly assigned.
                    </p>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap;">
                        ${[2, 3, 4, 5, 6].map(num => `
                            <button class="create-random-teams-btn" data-num-teams="${num}" style="
                                background: #007bff;
                                color: white;
                                border: none;
                                padding: 1rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 1rem;
                                font-weight: 600;
                                min-width: 80px;
                            ">${num} Teams</button>
                        `).join('')}
                    </div>
                    
                    <div id="randomTeamsPreview" style="display: none;">
                        <!-- Team preview will be populated here -->
                    </div>
                </div>
            `;
            
            // Add event listeners for random team buttons
            content.querySelectorAll('.create-random-teams-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const numTeams = parseInt(btn.getAttribute('data-num-teams'));
                    showRandomTeamsPreview(rosterData, numTeams, modal);
                });
            });
        }
        
        function showRandomTeamsPreview(rosterData, numTeams, modal) {
            const preview = document.getElementById('randomTeamsPreview');
            
            // Shuffle students
            const shuffled = [...rosterData.roster].sort(() => Math.random() - 0.5);
            const teams = [];
            
            // Create teams
            for (let i = 0; i < numTeams; i++) {
                teams.push({
                    id: String.fromCharCode(65 + i), // A, B, C, etc.
                    name: `Team ${String.fromCharCode(65 + i)}`,
                    students: []
                });
            }
            
            // Distribute students evenly
            shuffled.forEach((student, index) => {
                const teamIndex = index % numTeams;
                teams[teamIndex].students.push(student);
            });
            
            // Display teams
            preview.innerHTML = `
                <h4 style="color: #007bff; margin-bottom: 1rem; text-align: center;">Team Assignment Preview</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    ${teams.map(team => `
                        <div style="
                            border: 2px solid #007bff;
                            border-radius: 8px;
                            padding: 1rem;
                            background: rgba(0, 123, 255, 0.05);
                        ">
                            <h5 style="margin: 0 0 1rem 0; color: #007bff; text-align: center;">${team.name}</h5>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${team.students.map(student => `
                                    <div style="
                                        background: #007bff;
                                        color: white;
                                        padding: 0.5rem;
                                        border-radius: 4px;
                                        font-size: 0.9rem;
                                        text-align: center;
                                    ">${student.name}</div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="text-align: center;">
                    <button class="save-random-teams-btn" data-teams='${JSON.stringify(teams)}' style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 1rem 2rem;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1.1rem;
                        font-weight: 600;
                    "> Save Random Teams</button>
                </div>
            `;
            
            preview.style.display = 'block';
            
            // Add event listener for save button
            preview.querySelector('.save-random-teams-btn').addEventListener('click', () => {
                const teamsData = JSON.parse(preview.querySelector('.save-random-teams-btn').getAttribute('data-teams'));
                saveTeamAssignment('random', teamsData, modal);
            });
        }
        
        function showManualTeamInterface(rosterData, modal) {
            const content = document.getElementById('teamCreationContent');
            content.innerHTML = `
                <div style="padding: 2rem;">
                    <h3 style="color: #6f5c91; margin-bottom: 1rem; text-align: center;"> Manual Team Assignment</h3>
                    <p style="color: #666; margin-bottom: 2rem; text-align: center;">
                        Drag students from the list below into team boxes, or click to move them.
                    </p>
                    
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 1rem; color: #6f5c91;">Team A</h4>
                            <div id="teamA-dropzone" style="
                                min-height: 200px;
                                border: 2px dashed #6f5c91;
                                border-radius: 8px;
                                padding: 1rem;
                                background: rgba(111, 92, 145, 0.05);
                            ">
                                <input type="text" id="teamA-name" placeholder="Team A Name" style="
                                    width: 100%;
                                    padding: 0.5rem;
                                    border: 1px solid #ddd;
                                    border-radius: 4px;
                                    margin-bottom: 1rem;
                                " value="Team A">
                            </div>
                        </div>
                        
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 1rem; color: #6f5c91;">Team B</h4>
                            <div id="teamB-dropzone" style="
                                min-height: 200px;
                                border: 2px dashed #6f5c91;
                                border-radius: 8px;
                                padding: 1rem;
                                background: rgba(111, 92, 145, 0.05);
                            ">
                                <input type="text" id="teamB-name" placeholder="Team B Name" style="
                                    width: 100%;
                                    padding: 0.5rem;
                                    border: 1px solid #ddd;
                                    border-radius: 4px;
                                    margin-bottom: 1rem;
                                " value="Team B">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: #666;">Unassigned Students</h4>
                        <div id="unassigned-students" style="
                            display: flex;
                            flex-wrap: wrap;
                            gap: 0.5rem;
                            padding: 1rem;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            background: #f8f9fa;
                        ">
                            ${rosterData.roster.map(student => `
                                <div class="student-chip" data-student-id="${student.id}" style="
                                    background: #6f5c91;
                                    color: white;
                                    padding: 0.5rem 1rem;
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-size: 0.9rem;
                                    transition: all 0.2s ease;
                                " onclick="moveStudentToTeam('${student.id}', this)">
                                    ${student.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="save-manual-teams-btn" style="
                            background: #6f5c91;
                            color: white;
                            border: none;
                            padding: 1rem 2rem;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1.1rem;
                            font-weight: 600;
                        "> Save Team Assignment</button>
                    </div>
                </div>
            `;
            
            // Initialize drag and drop
            initializeManualTeamDragDrop();
            
            // Add event listener for save button
            content.querySelector('.save-manual-teams-btn').addEventListener('click', () => {
                saveManualTeams(modal);
            });
        }
        
        
        function moveStudentToTeam(studentId, element) {
            const student = quizRosterData.roster.find(s => s.id === studentId);
            if (!student) return;
            
            // Remove from current location
            element.remove();
            
            // Determine which team to add to based on which dropzone is closest
            const teamADropzone = document.getElementById('teamA-dropzone');
            const teamBDropzone = document.getElementById('teamB-dropzone');
            
            // For now, just cycle through teams - user can drag manually
            const currentTeamA = teamADropzone.querySelectorAll('.student-chip').length;
            const currentTeamB = teamBDropzone.querySelectorAll('.student-chip').length;
            
            const targetDropzone = currentTeamA <= currentTeamB ? teamADropzone : teamBDropzone;
            
            // Create new chip
            const newChip = document.createElement('div');
            newChip.className = 'student-chip';
            newChip.setAttribute('data-student-id', studentId);
            newChip.style.cssText = `
                background: #6f5c91;
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.2s ease;
                margin: 0.25rem;
                display: inline-block;
            `;
            newChip.textContent = student.name;
            newChip.onclick = () => moveStudentToTeam(studentId, newChip);
            
            targetDropzone.appendChild(newChip);
        }
        
        function moveStudentToSpecificTeam(studentId, teamId) {
            const student = quizRosterData.roster.find(s => s.id === studentId);
            if (!student) return;
            
            // Remove from current location
            const currentChip = document.querySelector(`[data-student-id="${studentId}"]`);
            if (currentChip) currentChip.remove();
            
            // Add to specific team
            const targetDropzone = document.getElementById(`${teamId}-dropzone`);
            if (!targetDropzone) return;
            
            // Create new chip
            const newChip = document.createElement('div');
            newChip.className = 'student-chip';
            newChip.setAttribute('data-student-id', studentId);
            newChip.style.cssText = `
                background: #6f5c91;
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.2s ease;
                margin: 0.25rem;
                display: inline-block;
            `;
            newChip.textContent = student.name;
            newChip.onclick = () => moveStudentToTeam(studentId, newChip);
            
            targetDropzone.appendChild(newChip);
        }
        
        function saveTeamAssignment(mode, teams, modal) {
            const teamAssignment = {
                mode: mode,
                teams: teams,
                rosterData: quizRosterData
            };
            
            // Store in global variable for use in quiz setup
            window.quizTeamAssignment = teamAssignment;
            
            // Update the quiz setup form
            applyTeamAssignment();
            
            // Close modal
            modal.remove();
            
            // Update status
            updateRosterStatus(`Teams created (${mode})`);
        }
        
        // Simple helper functions for inline team creation
        function createRandomTeamsPreview(numTeams) {
            const preview = document.getElementById('randomTeamsPreview');
            if (!preview) return;
            
            // Shuffle students
            const shuffled = [...quizRosterData.roster].sort(() => Math.random() - 0.5);
            const teams = [];
            
            // Create teams
            for (let i = 0; i < numTeams; i++) {
                teams.push({
                    id: String.fromCharCode(65 + i),
                    name: `Team ${String.fromCharCode(65 + i)}`,
                    students: []
                });
            }
            
            // Distribute students evenly
            shuffled.forEach((student, index) => {
                const teamIndex = index % numTeams;
                teams[teamIndex].students.push(student);
            });
            
            // Display teams
            preview.innerHTML = `
                <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid #ddd;">
                    <h4 style="margin: 0 0 1rem 0; color: #007bff;">Team Preview:</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        ${teams.map(team => `
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; border: 1px solid #ddd;">
                                <h5 style="margin: 0 0 0.5rem 0; color: #007bff;">${team.name}</h5>
                                <div style="font-size: 0.9rem; color: #666;">
                                    ${team.students.map(s => s.name).join(', ')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <button id="saveRandomBtn" style="
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 1rem 2rem;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 1.1rem;
                "> Save Random Teams</button>
            `;
            
            // Add event listener for save button
            document.getElementById('saveRandomBtn').addEventListener('click', () => {
                saveRandomTeams(numTeams);
                document.body.removeChild(document.getElementById('rosterTeamModal'));
            });
        }
        
        function moveStudentToTeam(studentId) {
            const student = quizRosterData.roster.find(s => s.id === studentId);
            if (!student) return;
            
            // Remove from current location
            const currentChip = document.querySelector(`[data-student-id="${studentId}"]`);
            if (currentChip) currentChip.remove();
            
            // Determine which team to add to
            const teamAStudents = document.getElementById('teamA-students');
            const teamBStudents = document.getElementById('teamB-students');
            
            const currentTeamA = teamAStudents.querySelectorAll('.student-chip').length;
            const currentTeamB = teamBStudents.querySelectorAll('.student-chip').length;
            
            const targetTeam = currentTeamA <= currentTeamB ? teamAStudents : teamBStudents;
            
            // Create new chip
            const newChip = document.createElement('div');
            newChip.className = 'student-chip';
            newChip.setAttribute('data-student-id', studentId);
            newChip.style.cssText = `
                background: #6f5c91;
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.2s ease;
                margin: 0.25rem;
                display: inline-block;
            `;
            newChip.textContent = student.name;
            newChip.onclick = () => moveStudentToTeam(studentId);
            
            targetTeam.appendChild(newChip);
        }
        
        function saveTeamMode(mode) {
            if (mode === 'individual') {
                const teamAssignment = {
                    mode: 'individual',
                    teams: null,
                    rosterData: quizRosterData
                };
                window.quizTeamAssignment = teamAssignment;
                applyTeamAssignment();
                updateRosterStatus('Individual mode saved');
            }
        }
        
        function saveRandomTeams(numTeams) {
            // Recreate the teams (same logic as createRandomTeams)
            const shuffled = [...quizRosterData.roster].sort(() => Math.random() - 0.5);
            const teams = [];
            
            for (let i = 0; i < numTeams; i++) {
                teams.push({
                    id: String.fromCharCode(65 + i),
                    name: `Team ${String.fromCharCode(65 + i)}`,
                    students: []
                });
            }
            
            shuffled.forEach((student, index) => {
                const teamIndex = index % numTeams;
                teams[teamIndex].students.push(student);
            });
            
            const teamAssignment = {
                mode: 'random',
                teams: teams,
                rosterData: quizRosterData
            };
            window.quizTeamAssignment = teamAssignment;
            applyTeamAssignment();
            updateRosterStatus(`Random teams saved (${numTeams} teams)`);
        }
        
        function saveManualTeams() {
            const teamAName = document.getElementById('teamA-name').value || 'Team A';
            const teamBName = document.getElementById('teamB-name').value || 'Team B';
            
            const teamAStudents = Array.from(document.querySelectorAll('#teamA-students .student-chip')).map(el => {
                const studentId = el.getAttribute('data-student-id');
                return quizRosterData.roster.find(s => s.id === studentId);
            }).filter(Boolean);
            
            const teamBStudents = Array.from(document.querySelectorAll('#teamB-students .student-chip')).map(el => {
                const studentId = el.getAttribute('data-student-id');
                return quizRosterData.roster.find(s => s.id === studentId);
            }).filter(Boolean);
            
            const teams = [
                {
                    id: 'A',
                    name: teamAName,
                    students: teamAStudents
                },
                {
                    id: 'B',
                    name: teamBName,
                    students: teamBStudents
                }
            ];
            
            const teamAssignment = {
                mode: 'manual',
                teams: teams,
                rosterData: quizRosterData
            };
            window.quizTeamAssignment = teamAssignment;
            applyTeamAssignment();
            updateRosterStatus('Manual teams saved');
        }
        
        // Functions are now handled by event listeners in the modals
        
        function saveManualTeams(modal) {
            const teamAName = document.getElementById('teamA-name').value || 'Team A';
            const teamBName = document.getElementById('teamB-name').value || 'Team B';
            
            const teamAStudents = Array.from(document.querySelectorAll('#teamA-dropzone .student-chip')).map(el => {
                const studentId = el.getAttribute('data-student-id');
                return quizRosterData.roster.find(s => s.id === studentId);
            }).filter(Boolean);
            
            const teamBStudents = Array.from(document.querySelectorAll('#teamB-dropzone .student-chip')).map(el => {
                const studentId = el.getAttribute('data-student-id');
                return quizRosterData.roster.find(s => s.id === studentId);
            }).filter(Boolean);
            
            const teams = [
                {
                    id: 'A',
                    name: teamAName,
                    students: teamAStudents
                },
                {
                    id: 'B', 
                    name: teamBName,
                    students: teamBStudents
                }
            ];
            
            saveTeamAssignment('manual', teams, modal);
        }
        
        window.saveManualTeams = saveManualTeams;
        
        function assignRandomTeams() {
            if (!quizRosterData || !quizRosterData.roster) return;
            
            const numTeams = prompt('How many teams? (2-6)', '2');
            if (!numTeams || numTeams < 2 || numTeams > 6) return;
            
            const students = [...quizRosterData.roster];
            const teams = [];
            
            // Create teams
            for (let i = 0; i < numTeams; i++) {
                teams.push({
                    id: String.fromCharCode(65 + i), // A, B, C, etc.
                    name: `Team ${String.fromCharCode(65 + i)}`,
                    students: []
                });
            }
            
            // Randomly assign students
            for (let i = 0; i < students.length; i++) {
                const teamIndex = i % numTeams;
                teams[teamIndex].students.push(students[i]);
            }
            
            quizTeamAssignment = { teams, mode: 'random' };
            applyTeamAssignment();
        }
        
        function showManualTeamAssignment() {
            if (!quizRosterData || !quizRosterData.roster) return;
            
            // Create a modal for manual team assignment
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; max-width: 800px; width: 90vw; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-top: 0;">Manual Team Assignment</h3>
                    <div id="manualTeamContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 1rem 0;">
                        <div>
                            <h4>Unassigned Students</h4>
                            <div id="unassignedStudents" style="min-height: 200px; border: 2px dashed #ccc; padding: 1rem; border-radius: 8px;">
                                ${quizRosterData.roster.map(s => `
                                    <div class="student-chip" data-student-id="${s.id}" style="
                                        background: #f8f9fa;
                                        padding: 0.5rem;
                                        margin: 0.25rem;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        display: inline-block;
                                    ">${s.name}</div>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <h4>Teams</h4>
                            <div id="teamContainers">
                                <div class="team-container" data-team="A" style="margin-bottom: 1rem;">
                                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Team A</div>
                                    <div class="team-drop-zone" style="min-height: 100px; border: 2px dashed #007bff; padding: 1rem; border-radius: 8px; background: #f0f8ff;"></div>
                                </div>
                                <div class="team-container" data-team="B" style="margin-bottom: 1rem;">
                                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Team B</div>
                                    <div class="team-drop-zone" style="min-height: 100px; border: 2px dashed #28a745; padding: 1rem; border-radius: 8px; background: #f0fff0;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button id="cancelManualTeams" style="padding: 0.5rem 1rem; border: 1px solid #ccc; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button id="saveManualTeams" style="padding: 0.5rem 1rem; background: #6f5c91; color: white; border: none; border-radius: 6px; cursor: pointer;">Save Teams</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('cancelManualTeams').onclick = () => {
                document.body.removeChild(modal);
            };
            
            document.getElementById('saveManualTeams').onclick = () => {
                saveManualTeams();
                document.body.removeChild(modal);
            };
            
            // Add drag and drop functionality
            initializeManualTeamDragDrop();
        }
        
        function initializeManualTeamDragDrop() {
            const studentChips = document.querySelectorAll('.student-chip');
            const teamDropZones = document.querySelectorAll('.team-drop-zone');
            
            studentChips.forEach(chip => {
                chip.draggable = true;
                chip.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', chip.dataset.studentId);
                });
            });
            
            teamDropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.style.backgroundColor = '#e0e0e0';
                });
                
                zone.addEventListener('dragleave', (e) => {
                    zone.style.backgroundColor = '';
                });
                
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const studentId = e.dataTransfer.getData('text/plain');
                    const studentChip = document.querySelector(`[data-student-id="${studentId}"]`);
                    
                    if (studentChip) {
                        zone.appendChild(studentChip);
                        zone.style.backgroundColor = '';
                    }
                });
            });
        }
        
        function saveManualTeams() {
            const teams = [];
            const teamContainers = document.querySelectorAll('.team-container');
            
            teamContainers.forEach(container => {
                const teamId = container.dataset.team;
                const students = Array.from(container.querySelectorAll('.student-chip')).map(chip => {
                    const studentId = chip.dataset.studentId;
                    return quizRosterData.roster.find(s => s.id === studentId);
                }).filter(Boolean);
                
                if (students.length > 0) {
                    teams.push({
                        id: teamId,
                        name: `Team ${teamId}`,
                        students: students
                    });
                }
            });
            
            quizTeamAssignment = { teams, mode: 'manual' };
            applyTeamAssignment();
        }
        
        function applyTeamAssignment() {
            if (!quizTeamAssignment) return;
            
            // Update team name inputs
            const teamAInput = document.getElementById('teamANameInput');
            const teamBInput = document.getElementById('teamBNameInput');
            
            if (quizTeamAssignment.mode === 'individual') {
                // Individual mode - set default team names
                if (teamAInput) teamAInput.value = 'Individual Students';
                if (teamBInput) teamBInput.value = 'Individual Students';
            } else if (quizTeamAssignment.teams && quizTeamAssignment.teams.length >= 2) {
                // Team mode
                if (teamAInput && quizTeamAssignment.teams[0]) {
                    teamAInput.value = quizTeamAssignment.teams[0].name;
                }
                
                if (teamBInput && quizTeamAssignment.teams[1]) {
                    teamBInput.value = quizTeamAssignment.teams[1].name;
                }
            }
            
            // Update roster preview
            const previewEl = document.getElementById('rosterPreview');
            if (previewEl) {
                if (quizTeamAssignment.mode === 'individual') {
                    const studentNames = quizTeamAssignment.rosterData.roster.map(s => s.name).join(', ');
                    previewEl.textContent = `Individual Mode: ${studentNames}`;
                } else if (quizTeamAssignment.teams) {
                    const teamInfo = quizTeamAssignment.teams.map(team => 
                        `${team.name}: ${team.students.map(s => s.name).join(', ')}`
                    ).join(' | ');
                    previewEl.textContent = `Assignment: ${teamInfo}`;
                }
            }
            
            updateRosterStatus(`Teams assigned (${quizTeamAssignment.mode})`);
            
            // Store the team assignment for use during game start
            window.quizTeamAssignment = quizTeamAssignment;
        }
        
        function applyQuizTeamAssignment(teamAssignment) {
            if (!teamAssignment) return;
            
            console.log('Applying quiz team assignment:', teamAssignment);
            
            // Update the roster data with team assignments
            if (rosterData && rosterData.roster) {
                if (teamAssignment.mode === 'individual') {
                    // Individual mode - no teams
                    rosterData.teams = [];
                    rosterData.teamMode = false;
                    teamMode = false;
                    
                    console.log('Applied individual mode:', rosterData);
                } else if (teamAssignment.teams && teamAssignment.teams.length > 0) {
                    // Team mode - update roster data with team assignments
                    rosterData.roster.forEach(student => {
                        // Find which team this student belongs to
                        const team = teamAssignment.teams.find(t => 
                            t.students && t.students.some(s => s.id === student.id)
                        );
                        
                        if (team) {
                            student.teamId = team.id;
                            student.teamName = team.name;
                            student.teamColor = team.color || '#6f5c91';
                        }
                    });
                    
                    // Update rosterData teams
                    rosterData.teams = teamAssignment.teams;
                    rosterData.teamMode = true;
                    teamMode = true;
                    
                    console.log('Applied quiz team assignment:', {
                        rosterData,
                        teams: rosterData.teams,
                        teamMode: rosterData.teamMode
                    });
                }
            } else {
                console.log('No roster data available for team assignment');
            }
        }
        
        function initializeStudentPoints() {
            if (!rosterData || !rosterData.roster) return;
            
            // Initialize all students with 0 points
            rosterData.roster.forEach(student => {
                studentPoints[student.name] = 0;
                student.points = 0;
            });
            
            console.log('Initialized student points:', studentPoints);
        }
        
        function awardStudentPoints(studentName, points) {
            if (!studentPoints.hasOwnProperty(studentName)) {
                studentPoints[studentName] = 0;
            }
            
            studentPoints[studentName] += points;
            
            // Update the student object in roster data
            if (rosterData && rosterData.roster) {
                const student = rosterData.roster.find(s => s.name === studentName);
                if (student) {
                    student.points = studentPoints[studentName];
                }
            }
            
            console.log(`Awarded ${points} points to ${studentName}. Total: ${studentPoints[studentName]}`);
        }
        
        function loadRosterData() {
            console.log('=== LOAD ROSTER DATA ===');
            console.log('window.quizTeamAssignment:', window.quizTeamAssignment);
            
            // First try to load from quizTeamAssignment (set during roster selection)
            if (window.quizTeamAssignment && window.quizTeamAssignment.rosterData) {
                rosterData = window.quizTeamAssignment.rosterData;
                console.log('Roster loaded from quizTeamAssignment:', rosterData);
                return true;
            }
            
            // If no explicit roster assignment, start fresh
            rosterData = null;
            console.log('No roster assignment found - starting fresh game');
            return false;
        }
        
        function initializeTeamMode() {
            console.log('=== INITIALIZE TEAM MODE ===');
            console.log('rosterData:', rosterData);
            console.log('window.quizTeamAssignment:', window.quizTeamAssignment);
            
            if (!rosterData || !rosterData.teams || rosterData.teams.length === 0) {
                teamMode = false;
                console.log('No teams found, using individual mode');
                return false;
            }
            
            teamMode = true;
            currentStudentIndex = 0;
            
            // Set up team names from roster and update team count
            if (rosterData.teams.length >= 2) {
                // Update team count to match roster
                teamCount = rosterData.teams.length;
                console.log('Updated team count to:', teamCount);
                
                // Set team names for all teams
                rosterData.teams.forEach((team, index) => {
                    const teamLetter = String.fromCharCode(65 + index); // A, B, C, D, etc.
                    names[teamLetter] = team.name;
                });
                
                console.log('Set team names:', names);
                
                // Store all teams for reference
                window.allTeams = rosterData.teams;
                console.log('All teams stored:', window.allTeams);
            }
            
            // Initialize current team students
            updateCurrentTeamStudents();
            
            console.log('Team mode initialized:', {
                teamMode,
                teams: rosterData.teams,
                currentTeamStudents,
                names: { A: names.A, B: names.B }
            });
            
            return true;
        }
        
        function updateCurrentTeamStudents(preserveIndex = false) {
            if (!teamMode || !rosterData) return;
            
            // Find the team index based on the turn letter (A=0, B=1, C=2, etc.)
            const teamIndex = turn.charCodeAt(0) - 65; // A=0, B=1, C=2, etc.
            const currentTeam = rosterData.teams[teamIndex];
            currentTeamStudents = currentTeam ? currentTeam.students : [];
            
            // Only reset index if not preserving it
            if (!preserveIndex) {
                currentStudentIndex = 0;
            } else {
                // If preserving index, make sure it's within bounds
                if (currentStudentIndex >= currentTeamStudents.length) {
                    currentStudentIndex = currentStudentIndex % currentTeamStudents.length;
                }
            }
        }
        
        function getCurrentStudent() {
            if (!teamMode || currentTeamStudents.length === 0) return null;
            return currentTeamStudents[currentStudentIndex];
        }
        
        function advanceStudentTurn() {
            if (!teamMode || currentTeamStudents.length === 0) return;
            
            currentStudentIndex = (currentStudentIndex + 1) % currentTeamStudents.length;
        }
        
        function getCurrentStudentDisplay() {
            if (!teamMode) {
                // Individual mode - show individual student names
                if (rosterData && rosterData.roster && rosterData.roster.length > 0) {
                    // Find current student by turn index
                    const studentIndex = turn.charCodeAt(0) - 65; // A=0, B=1, C=2, etc.
                    const student = rosterData.roster[studentIndex];
                    if (student && student.name) {
                        return `${student.name}'s turn`;
                    }
                }
                return names[turn] || `Team ${turn}`;
            }
            
            // Get the current student directly from roster data
            const teamIndex = turn.charCodeAt(0) - 65; // A=0, B=1, C=2, etc.
            const currentTeam = rosterData?.teams?.[teamIndex];
            const student = currentTeam?.students?.[currentStudentIndex];
            const teamName = currentTeam?.name || names[turn] || `Team ${turn}`;
            
            if (student && student.name) {
                return `${teamName} - ${student.name}'s turn`;
            }
            
            return `${teamName}'s turn`;
        }
        
        // === DYNAMIC GRID SIZING ===
        function calculateOptimalGridSize() {
            if (!rosterData || !rosterData.roster || rosterData.roster.length === 0) {
                return 20; // Default size for 5x4 grid
            }
            
            const studentCount = rosterData.roster.length;
            
            // For small rosters, use specific grid sizes that work well
            if (studentCount <= 20) {
                return 20; // 5x4 grid
            } else if (studentCount <= 24) {
                return 24; // 6x4 grid
            } else if (studentCount <= 30) {
                return 30; // 6x5 grid
            } else {
                return 36; // 6x6 grid
            }
        }

        // === SIDEBAR MANAGEMENT ===
        function updateTeamScores() {
            const teamScoresContainer = document.getElementById('teamScores');
            if (!teamScoresContainer) {
                console.log('updateTeamScores: teamScoresContainer not found');
                return;
            }
            
            // Also update the main game status bar
            updateMainTeamScores();
            
            console.log('updateTeamScores called with:', {
                rosterData: rosterData ? {
                    teams: rosterData.teams?.length,
                    students: rosterData.roster?.length,
                    teamMode: rosterData.teamMode
                } : null,
                teamMode,
                turn,
                scores
            });
            
            const currentTeam = turn; // turn is already the team letter (A, B, C, D, etc.)
            
            // If we have roster data and team mode, show all teams and their students
            if (rosterData && teamMode && rosterData.teams && rosterData.teams.length >= 2) {
                const teamScoreMap = {
                    'A': scores.A || 0,
                    'B': scores.B || 0,
                    'C': scores.C || 0,
                    'D': scores.D || 0,
                    'E': scores.E || 0,
                    'F': scores.F || 0
                };
                
                teamScoresContainer.innerHTML = rosterData.teams.map((team, index) => {
                    const teamLetter = String.fromCharCode(65 + index); // A, B, C, D, etc.
                    const isActive = currentTeam === teamLetter;
                    
                    return `
                        <div class="team-score-item ${isActive ? "active" : ""}">
                            <div class="team-header">
                                <span class="team-name">${team.name || `Team ${teamLetter}`}</span>
                                <span class="team-score">${teamScoreMap[teamLetter] || 0}</span>
                            </div>
                            <div class="student-list">
                                ${team.students.map(student => `
                                    <div class="student-item ${getCurrentStudent() && getCurrentStudent().id === student.id ? 'current-student' : ''}">
                                        <span class="student-name">${student.name}</span>
                                        <span class="student-points">${studentPoints[student.name] || 0}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            } else if (rosterData && rosterData.roster && rosterData.roster.length > 0) {
                // Individual mode - show all students
                teamScoresContainer.innerHTML = `
                    <div class="team-score-item">
                        <div class="team-header">
                            <span class="team-name">Individual Students</span>
                            <span class="team-score">${Object.values(studentPoints).reduce((sum, points) => sum + points, 0)}</span>
                        </div>
                        <div class="student-list">
                            ${rosterData.roster.map(student => `
                                <div class="student-item ${getCurrentStudent() && getCurrentStudent().id === student.id ? 'current-student' : ''}">
                                    <span class="student-name">${student.name}</span>
                                    <span class="student-points">${studentPoints[student.name] || 0}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                // Fallback to team-only display
                teamScoresContainer.innerHTML = `
                    <div class="team-score-item ${currentTeam === "A" ? "active" : ""}">
                        <span class="team-name">${names.A || "Team A"}</span>
                        <span class="team-score">${scores.A || 0}</span>
                    </div>
                    <div class="team-score-item ${currentTeam === "B" ? "active" : ""}">
                        <span class="team-name">${names.B || "Team B"}</span>
                        <span class="team-score">${scores.B || 0}</span>
                    </div>
                `;
            }
        }
        
        
        function updateTurnDisplay() {
            const turnDisplayEl = document.getElementById('turnDisplay');
            if (turnDisplayEl) {
                turnDisplayEl.textContent = getCurrentStudentDisplay();
            }
            
            // Also update the main game status bar
            const mainTurnDisplay = document.getElementById('currentTurnText');
            if (mainTurnDisplay) {
                mainTurnDisplay.textContent = getCurrentStudentDisplay();
            }
        }
        
        function updateMainTeamScores() {
            const mainTeamScoresEl = document.getElementById('mainTeamScores');
            if (!mainTeamScoresEl) return;
            
            if (rosterData && teamMode && rosterData.teams && rosterData.teams.length >= 2) {
                // Team mode - show all teams
                mainTeamScoresEl.innerHTML = rosterData.teams.map((team, index) => {
                    const teamLetter = String.fromCharCode(65 + index);
                    const teamScore = scores[teamLetter] || 0;
                    const isActive = turn === teamLetter;
                    
                    return `
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 8px; background: ${isActive ? '#f0f8ff' : '#f8f9fa'}; border: 2px solid ${isActive ? '#6f5c91' : '#e9ecef'};">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${team.color || '#6f5c91'};"></div>
                            <span style="font-weight: 600; color: #333;">${team.name || `Team ${teamLetter}`}</span>
                            <span style="font-weight: 700; color: #6f5c91; font-size: 1.1rem;">${teamScore}</span>
                        </div>
                    `;
                }).join('');
            } else if (rosterData && rosterData.roster && rosterData.roster.length > 0) {
                // Individual mode - show total points
                const totalPoints = Object.values(studentPoints).reduce((sum, points) => sum + points, 0);
                mainTeamScoresEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 8px; background: #f8f9fa; border: 2px solid #e9ecef;">
                        <span style="font-weight: 600; color: #333;">Total Points</span>
                        <span style="font-weight: 700; color: #6f5c91; font-size: 1.1rem;">${totalPoints}</span>
                    </div>
                `;
            } else {
                // Fallback - show Team A and B
                mainTeamScoresEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 8px; background: ${turn === 'A' ? '#f0f8ff' : '#f8f9fa'}; border: 2px solid ${turn === 'A' ? '#6f5c91' : '#e9ecef'};">
                        <span style="font-weight: 600; color: #333;">${names.A || 'Team A'}</span>
                        <span style="font-weight: 700; color: #6f5c91; font-size: 1.1rem;">${scores.A || 0}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 8px; background: ${turn === 'B' ? '#f0f8ff' : '#f8f9fa'}; border: 2px solid ${turn === 'B' ? '#6f5c91' : '#e9ecef'};">
                        <span style="font-weight: 600; color: #333;">${names.B || 'Team B'}</span>
                        <span style="font-weight: 700; color: #6f5c91; font-size: 1.1rem;">${scores.B || 0}</span>
                    </div>
                `;
            }
        }

        // Function to reset game state for new games
        function resetGameState() {
          // Only clear roster data, not the assignment (that gets cleared when starting fresh)
          rosterData = null;
          teamMode = false;
          currentStudentIndex = 0;
          currentTeamStudents = [];
          studentPoints = {};
          
          console.log('Game state reset for new game');
        }
        
        // Function to start game with specific settings
        async function startGameWithSettings(quiz, settings) {
          // Reset game state first
          resetGameState();
          
          // Load roster data only if explicitly selected
          loadRosterData();
          
          // Apply quiz team assignment if available BEFORE initializing team mode
          if (window.quizTeamAssignment) {
            applyQuizTeamAssignment(window.quizTeamAssignment);
          }
          
          // Now initialize team mode with the updated roster data
          initializeTeamMode();
          
          // Initialize individual student points
          initializeStudentPoints();
          
          // Load point configuration
          const individualPointsInput = document.getElementById('individualPoints');
          const teamVictoryPointsInput = document.getElementById('teamVictoryPoints');
          
          if (individualPointsInput) {
            individualPoints = parseInt(individualPointsInput.value) || 100;
          }
          if (teamVictoryPointsInput) {
            teamVictoryPoints = parseInt(teamVictoryPointsInput.value) || 500;
          }
          
          console.log('Point configuration:', { individualPoints, teamVictoryPoints });
          
          // Set up game state
          questions = quiz.questions && Array.isArray(quiz.questions)
            ? quiz.questions.map((q) => ({
                question: q.question,
                answer: q.answer || null,
              }))
            : [];
          
          usedQuestionIndices = Array.from(
            { length: questions.length },
            (_, i) => i
          );
          
          // Shuffle questions
          for (let i = usedQuestionIndices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [usedQuestionIndices[i], usedQuestionIndices[j]] = [
              usedQuestionIndices[j],
              usedQuestionIndices[i],
            ];
          }
          
          qIndex = 0;
          
          // Use roster team names if available, otherwise use settings
          if (teamMode && rosterData && rosterData.teams && rosterData.teams.length >= 2) {
            // Set names for all teams
            rosterData.teams.forEach((team, index) => {
              const teamLetter = String.fromCharCode(65 + index); // A, B, C, D, etc.
              names[teamLetter] = team.name;
            });
            console.log('Using roster team names:', names);
          } else {
            names.A = settings.teamA;
            names.B = settings.singlePlayer ? 'Android' : settings.teamB;
            console.log('Using settings team names:', { A: names.A, B: names.B });
          }
          
          // Initialize scores for all teams
          scores = {};
          for (let i = 0; i < teamCount; i++) {
            const teamLetter = String.fromCharCode(65 + i); // A, B, C, D, etc.
            scores[teamLetter] = 0;
          }
          console.log('Initialized scores for', teamCount, 'teams:', scores);
          
          singlePlayer = settings.singlePlayer;
          
          // Use dynamic grid sizing if roster is available
          if (rosterData && rosterData.roster && rosterData.roster.length > 0) {
            total = calculateOptimalGridSize();
            console.log('Using dynamic grid size:', total, 'for', rosterData.roster.length, 'students');
          } else {
            // Fallback to grid size input or default
            const gridSizeInput = document.getElementById("gridSizeInput");
            total = gridSizeInput ? parseInt(gridSizeInput.value) || 20 : (settings.gridSize || 20);
            console.log('Using grid size:', total, 'from input:', gridSizeInput?.value, 'or settings:', settings.gridSize);
          }
          
          // Ensure total is always a valid number
          if (!total || total <= 0) {
            total = 20; // Default fallback
            console.log('Total was invalid, using default:', total);
          }
          
          // Hide library, show game
          if (setupScreen) setupScreen.classList.add("hidden");
          if (gameScreen) gameScreen.classList.remove("hidden");
          if (librarySection) librarySection.classList.add("hidden");
          
          // Show Android image if single player
          if (settings.singlePlayer) {
            if (androidImg) androidImg.style.display = "inline-block";
            if (nameBEl) nameBEl.textContent = "Android";
            if (teamBNameContainer) teamBNameContainer.classList.add("single-player");
          } else {
            if (androidImg) androidImg.style.display = "none";
            if (nameBEl) nameBEl.textContent = names.B;
            if (teamBNameContainer) teamBNameContainer.classList.remove("single-player");
          }
          
          // Initialize and start game
          console.log('Starting game with total:', total, 'settings:', settings);
          
          if (typeof initGame === 'function') {
            console.log('Calling initGame');
            initGame(settings.tornadoCount, settings.doubleCount, settings.loseCount, settings.swapCount, 
                     settings.shieldCount, settings.hotStreakCount, settings.coinFlipCount);
          }
          if (typeof buildGrid === 'function') {
            console.log('Calling buildGrid with total:', total);
            buildGrid(total);
          } else {
            console.error('buildGrid function not found!');
          }
          
          // Ensure grid is visible
          if (gridEl) {
            gridEl.style.display = 'grid';
            gridEl.style.visibility = 'visible';
            console.log('Grid element made visible');
          } else {
            console.error('Grid element not found! Creating emergency grid...');
            // Emergency fallback - create grid directly
            const gameMain = document.querySelector('.game-main');
            if (gameMain) {
              const emergencyGrid = document.createElement('div');
              emergencyGrid.id = 'grid';
              emergencyGrid.style.cssText = 'flex: 1 1 auto; display: grid; min-height: 400px; background: #f8f9fa; border-radius: 8px; padding: 1rem;';
              gameMain.appendChild(emergencyGrid);
              gridEl = emergencyGrid;
              // Build a simple grid
              buildGrid(20);
              console.log('Emergency grid created and built');
            }
          }
          if (typeof showQuestion === 'function') {
            console.log('Calling showQuestion');
            showQuestion();
          }
          
          // Set up Next Question button event listener
          const nextQuestionBtn = document.getElementById("nextQuestionBtn");
          if (nextQuestionBtn) {
            nextQuestionBtn.onclick = () => {
              hideNextQuestionButton();
              showQuestion();
            };
          }
          
          // Update sidebar displays
          updateTeamScores();
          updateTurnDisplay();
          
          // Force update the turn display in the main game area
          const mainTurnDisplay = document.querySelector('.turn-display, #turnDisplay, .current-turn');
          if (mainTurnDisplay) {
            mainTurnDisplay.textContent = getCurrentStudentDisplay();
          }
          
          console.log('Game started with:', {
            teamMode,
            teamCount,
            rosterData: rosterData ? {
              teams: rosterData.teams?.length,
              students: rosterData.roster?.length
            } : null,
            names,
            scores
          });
        }

        // Coin Flip Modal Functions
        function showCoinFlipModal() {
          const modal = document.getElementById("coinFlipModal");
          const description = document.getElementById("coinFlipDescription");
          const resultDiv = document.getElementById("coinFlipResult");
          const buttons = document.getElementById("coinFlipButtons");
          const wagerDiv = document.getElementById("coinFlipWager");
          const wagerInput = document.getElementById("wagerInput");
          const wagerError = document.getElementById("wagerError");
          const scoresDiv = document.getElementById("coinFlipScores");
          const scoresDisplay = document.getElementById("coinFlipScoresDisplay");
          
          if (!modal || !description || !resultDiv || !buttons || !wagerDiv || !wagerInput || !wagerError || !scoresDiv || !scoresDisplay) {
            console.error("Coin flip modal elements not found!");
            return;
          }
          
          // Reset modal state completely
          resultDiv.style.display = "none";
          wagerDiv.style.display = "block";
          buttons.style.display = "flex";
          wagerError.style.display = "none";
          scoresDiv.style.display = "block";
          
          // Clear any previous results
          const animation = document.getElementById("coinFlipAnimation");
          const outcome = document.getElementById("coinFlipOutcome");
          if (animation) {
            animation.innerHTML = "";
            animation.classList.remove("coin-flipping");
          }
          if (outcome) {
            outcome.textContent = "";
            outcome.style.color = "";
          }
          
          // Populate team scores display - only show teams that are actually playing
          const activeTeams = teamOrder.slice(0, teamCount); // Only show teams up to teamCount
          scoresDisplay.innerHTML = activeTeams.map(teamId => {
            const teamColor = teamColors[teamId] || "#6f5c91";
            const isCurrentTeam = teamId === turn;
            const isAndroid = singlePlayer && teamId === "B";
            return `
              <div style="text-align:center;padding:0.5em;border-radius:6px;${isCurrentTeam ? `background:${teamColor};color:white;` : ''}">
                <div style="font-weight:600;font-size:0.9rem;">
                  ${isAndroid ? '<img src="Daft-Punk-PNG-Photo.png" style="width:20px;height:20px;vertical-align:middle;margin-right:5px;" alt="Android">' : ''}
                  ${names[teamId] || `Team ${teamId}`}
                </div>
                <div style="font-size:1.2rem;font-weight:bold;">${scores[teamId] || 0}</div>
              </div>
            `;
          }).join("");
          
          // Set wager input max value to current team's score
          wagerInput.max = scores[turn];
          wagerInput.value = "";
          wagerInput.placeholder = `Max: ${scores[turn]}`;
          
          // Show modal
          modal.style.display = "flex";
          modal.classList.remove("hidden");
          
          // Ensure event handlers are attached
          attachCoinFlipHandlers();
        }

        function hideCoinFlipModal() {
          const modal = document.getElementById("coinFlipModal");
          if (modal) {
            modal.style.display = "none";
            modal.classList.add("hidden");
          }
          
          // After coin flip is completed, change to next team and continue game
          // This is called after the coin flip result is shown
          setTimeout(() => {
            // Move to next team
            do {
              let currentIndex = teamOrder.indexOf(turn);
              currentIndex = (currentIndex + 1) % teamCount;
              turn = teamOrder[currentIndex];
            } while (teamStatus[turn]?.frozen > 0);
            
            // Clear team status effects that should disappear after turn
            clearTeamStatusEffects();
            
            // Advance to next unique question
            qIndex++;
            if (qIndex >= usedQuestionIndices.length) qIndex = 0;
            updateTurn();
            
            // Wait for all pending promises (points breakdowns) to resolve before showing next question
            if (pendingPromises.length > 0) {
              Promise.all(pendingPromises).then(() => {
                // Clear the promises array
                pendingPromises = [];
                // Next Question button is always visible, no need to show it
              });
            } else {
              // No pending promises, Next Question button is always visible
            }
            
            // If single player and it's now Android's turn, trigger computer move
            if (singlePlayer && turn === "B") {
              setTimeout(computerTurn, 2500);
            }
          }, 500); // Small delay to ensure modal is fully hidden
        }

        // Coin Flip Event Handlers
        function attachCoinFlipHandlers() {
          const coinFlipModal = document.getElementById("coinFlipModal");
          const headsBtn = document.getElementById("coinFlipHeads");
          const tailsBtn = document.getElementById("coinFlipTails");
          const skipBtn = document.getElementById("coinFlipSkip");
          
          if (!coinFlipModal || !headsBtn || !tailsBtn || !skipBtn) {
            console.error("Coin flip elements not found for handlers!");
            return;
          }
          
          // Remove existing handlers to prevent duplicates
          headsBtn.onclick = null;
          tailsBtn.onclick = null;
          skipBtn.onclick = null;
          coinFlipModal.onclick = null;
          
          // Close modal when clicking outside
          coinFlipModal.onclick = function(e) {
            if (e.target === this) {
              hideCoinFlipModal();
            }
          };
          
          // Heads button
          headsBtn.onclick = function() {
            console.log("Heads button clicked!");
            handleCoinFlip("heads");
          };
          
          // Tails button
          tailsBtn.onclick = function() {
            console.log("Tails button clicked!");
            handleCoinFlip("tails");
          };
          
          // Skip button
          skipBtn.onclick = function() {
            console.log("Skip button clicked!");
            hideCoinFlipModal();
          };
        }
        
        // Attach handlers when DOM is ready
        document.addEventListener("DOMContentLoaded", function() {
          attachCoinFlipHandlers();
        });

        function handleCoinFlip(choice) {
          console.log("handleCoinFlip called with choice:", choice);
          
          const modal = document.getElementById("coinFlipModal");
          const wagerInput = document.getElementById("wagerInput");
          const wagerError = document.getElementById("wagerError");
          const resultDiv = document.getElementById("coinFlipResult");
          const buttons = document.getElementById("coinFlipButtons");
          const animation = document.getElementById("coinFlipAnimation");
          const outcome = document.getElementById("coinFlipOutcome");
          
          if (!modal || !wagerInput || !wagerError || !resultDiv || !buttons || !animation || !outcome) {
            console.error("Coin flip result elements not found!");
            return;
          }
          
          // Get wager amount
          const wager = parseInt(wagerInput.value);
          const maxWager = scores[turn];
          
          // Validate wager
          if (!wager || wager <= 0) {
            wagerError.textContent = "Please enter a valid wager amount!";
            wagerError.style.display = "block";
            return;
          }
          
          if (wager > maxWager) {
            wagerError.textContent = "Wager cannot exceed your team's total points!";
            wagerError.style.display = "block";
            return;
          }
          
          // Hide wager input and buttons, show result
          document.getElementById("coinFlipWager").style.display = "none";
          buttons.style.display = "none";
          resultDiv.style.display = "block";
          
          // Run coin flip animation
          animation.classList.add("coin-flipping");
          
          // Determine result
          const isCorrect = Math.random() < 0.5;
          const result = isCorrect ? choice : (choice === "heads" ? "tails" : "heads");
          
          console.log("Coin flip result:", result, "Correct:", isCorrect, "Wager:", wager);
          
          setTimeout(() => {
            animation.classList.remove("coin-flipping");
            animation.innerHTML = result === "heads" ? "" : "";
            outcome.textContent = result.toUpperCase();
            
            if (isCorrect) {
              outcome.style.color = "#4caf50";
              outcome.textContent += " - CORRECT! +" + wager;
              scores[turn] += wager;
              console.log("Player won! Added", wager, "points");
              
              // Show points breakdown for coin flip win
              const breakdown = {
                basePoints: wager,
                effect: " Coin Flip: Correct guess - Double points!",
                finalTotal: wager
              };
              showPointsPopup(wager, turn, breakdown);
            } else {
              outcome.style.color = "#f44336";
              outcome.textContent += " - WRONG! -" + wager;
              scores[turn] -= wager;
              if (scores[turn] < 0) scores[turn] = 0;
              console.log("Player lost! Subtracted", wager, "points");
            }
            
            updateScores();
            updateTeamDisplay();
            
            // Close modal after 2 seconds
            setTimeout(() => {
              hideCoinFlipModal();
            }, 2000);
          }, 1500);
        }

        // Team selection modal for Tornado and other effects
        function showTeamSelectionModal(currentTeam, action) {
          const modal = document.createElement("div");
          modal.style.position = "fixed";
          modal.style.top = "0";
          modal.style.left = "0";
          modal.style.width = "100vw";
          modal.style.height = "100vh";
          modal.style.background = "rgba(49,114,122,0.9)";
          modal.style.zIndex = "3000";
          modal.style.display = "flex";
          modal.style.alignItems = "center";
          modal.style.justifyContent = "center";
          
          let actionText = "";
          if (action === "steal") actionText = " Choose which team to steal points from:";
          
          modal.innerHTML = `
            <div style="background:#fff;padding:2em;border-radius:16px;max-width:500px;width:95vw;box-shadow:0 4px 32px rgba(0,0,0,0.18);">
              <h3 style="margin-top:0;color:#6F5C91;">${actionText}</h3>
              <div id="teamSelectionButtons" style="display:flex;flex-wrap:wrap;gap:1em;justify-content:center;">
                ${teamOrder.map(teamId => {
                  if (teamId === currentTeam) return "";
                  return `<button class="purple-btn" onclick="selectTargetTeam('${teamId}', '${action}')" style="min-width:120px;">${names[teamId] || `Team ${teamId}`}</button>`;
                }).join("")}
              </div>
              <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="margin-top:1em;background:#6c757d;color:white;border:none;padding:0.5em 1em;border-radius:8px;cursor:pointer;">Cancel</button>
            </div>
          `;
          
          document.body.appendChild(modal);
        }
        
        // Make selectTargetTeam globally accessible
        window.selectTargetTeam = function(targetTeam, action) {
          const modal = document.querySelector('div[style*="position: fixed"]');
          if (modal) modal.remove();
          
          if (action === "steal") {
            // Steal points from selected team
            if (teamStatus[targetTeam]?.shield) {
              teamStatus[targetTeam].shield = false;
              teamStatus[targetTeam].shieldUsed = true;
              showSpecialPopup("", `${names[targetTeam]}'s Shield blocked the Tornado!`);
              animateShieldBlock(targetTeam);
            } else {
              scores[turn] += scores[targetTeam];
              scores[targetTeam] = 0;
              showSpecialPopup("", `Tornado! Stole ${names[targetTeam]}'s points!`, true);
              animateKangarooSwap();
            }
          }
          
          updateScores();
          updateTeamDisplay();
        };

        // New animation functions for special effects


        function animateShield(teamId) {
          const teamCard = document.getElementById(`teamCard${teamId}`);
          if (teamCard) {
            teamCard.style.animation = "double 1.5s ease-in-out";
            setTimeout(() => {
              teamCard.style.animation = "";
            }, 1500);
          }
        }

        function animateShieldBlock(teamId) {
          const teamCard = document.getElementById(`teamCard${teamId}`);
          if (teamCard) {
            teamCard.style.animation = "kangaroo 1.5s ease-in-out";
            setTimeout(() => {
              teamCard.style.animation = "";
            }, 1500);
          }
        }
      });

      window.onerror = function (message, source, lineno, colno, error) {
        alert(
          "JavaScript Error: " +
            message +
            "\n" +
            source +
            ":" +
            lineno +
            ":" +
            colno
        );
        console.error(
          "Global JS Error:",
          message,
          source,
          lineno,
          colno,
          error
        );
      };
    </script>

    <!-- === LIBRARY GAME OPTIONS MODAL === -->
    <div id="libraryGameOptionsModal" class="hidden" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(49,114,122,0.85);z-index:3000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
      <div style="background:#fff;padding:2.5em 3em;border-radius:20px;max-width:600px;width:95vw;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative;animation:modalSlideIn 0.3s ease-out;">
        <button id="closeLibraryGameOptionsModal" style="position:absolute;top:15px;right:15px;background:none;border:none;font-size:1.8em;cursor:pointer;color:#6F5C91;">&times;</button>
        
        <!-- Quiz Title Header -->
        <div style="text-align:center;margin-bottom:2em;">
          <h2 id="libraryQuizTitle" style="margin:0;color:#6F5C91;font-size:2rem;">Quiz Title</h2>
          <p style="margin:0.5em 0 0 0;color:#666;font-size:1.1rem;">Customize your game settings</p>
        </div>
        
        <!-- Game Settings Form -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:2em;margin-bottom:2.5em;">
          <!-- Left Column -->
          <div>
            <label style="display:block;margin-bottom:1em;">
              <span style="display:block;margin-bottom:0.5em;font-weight:600;color:#333;">Team A Name:</span>
              <input id="libraryTeamAName" type="text" value="Team A" style="width:100%;padding:0.8em;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem;transition:border-color 0.2s;" placeholder="Team A">
            </label>
            
            <label style="display:block;margin-bottom:1em;">
              <span style="display:block;margin-bottom:0.5em;font-weight:600;color:#333;">Team B Name:</span>
              <input id="libraryTeamBName" type="text" value="Team B" style="width:100%;padding:0.8em;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem;transition:border-color 0.2s;" placeholder="Team B">
            </label>
            
            <label style="display:flex;align-items:center;gap:0.8em;margin-bottom:1em;">
              <input type="checkbox" id="librarySinglePlayer" style="width:1.2em;height:1.2em;">
              <span style="font-weight:600;color:#333;">Single Player Mode</span>
            </label>
            
            <label style="display:block;margin-bottom:1em;">
              <span style="display:block;margin-bottom:0.5em;font-weight:600;color:#333;">Grid Size:</span>
              <select id="libraryGridSize" style="width:100%;padding:0.8em;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem;background:#fff;">
                <option>8</option>
                <option>10</option>
                <option>16</option>
                <option selected>18</option>
                <option>20</option>
                <option>24</option>
                <option>30</option>
                <option>32</option>
                <option>40</option>
              </select>
            </label>
          </div>
          
          <!-- Right Column - Special Items -->
          <div>
            <h3 style="margin:0 0 1em 0;color:#333;font-size:1.2rem;">Special Items</h3>
            
            <div style="display:flex;flex-direction:column;gap:1em;">
              <div style="display:flex;align-items:center;justify-content:space-between;padding:0.8em;background:#f8f9fa;border-radius:8px;">
                <div style="display:flex;align-items:center;gap:0.8em;">
                  <span style="font-size:1.5em;"></span>
                  <span style="font-weight:600;color:#333;">Tornado</span>
                </div>
                <select id="libraryTornadoCount" style="padding:0.5em;border:1px solid #ddd;border-radius:4px;background:#fff;">
                  <option>0</option>
                  <option>1</option>
                  <option selected>2</option>
                  <option>3</option>
                  <option>4</option>
                  <option>5</option>
                </select>
              </div>
              
              <div style="display:flex;align-items:center;justify-content:space-between;padding:0.8em;background:#f8f9fa;border-radius:8px;">
                <div style="display:flex;align-items:center;gap:0.8em;">
                  <span style="font-size:1.5em;"></span>
                  <span style="font-weight:600;color:#333;">Double Lion</span>
                </div>
                <select id="libraryDoubleCount" style="padding:0.5em;border:1px solid #ddd;border-radius:4px;background:#fff;">
                  <option>0</option>
                  <option>1</option>
                  <option selected>2</option>
                  <option>3</option>
                  <option>4</option>
                  <option>5</option>
                </select>
              </div>
              
              <div style="display:flex;align-items:center;justify-content:space-between;padding:0.8em;background:#f8f9fa;border-radius:8px;">
                <div style="display:flex;align-items:center;gap:0.8em;">
                  <span style="font-size:1em;"></span>
                  <span style="font-weight:600;color:#333;">Skunk</span>
                </div>
                <select id="libraryLoseCount" style="padding:0.5em;border:1px solid #ddd;border-radius:4px;background:#fff;">
                  <option>0</option>
                  <option>1</option>
                  <option selected>2</option>
                  <option>3</option>
                  <option>4</option>
                  <option>5</option>
                </select>
              </div>
              
              <div style="display:flex;align-items:center;justify-content:space-between;padding:0.8em;background:#f8f9fa;border-radius:8px;">
                <div style="display:flex;align-items:center;gap:0.8em;">
                  <span style="font-size:1.5em;"></span>
                  <span style="font-weight:600;color:#333;">Kangaroo Hop</span>
                </div>
                <select id="librarySwapCount" style="padding:0.5em;border:1px solid #ddd;border-radius:4px;background:#fff;">
                  <option>0</option>
                  <option>1</option>
                  <option selected>1</option>
                  <option>2</option>
                  <option>3</option>
                  <option>4</option>
                </select>
              </div>
              
              <!-- New Special Items -->

              
              <div style="display:flex;align-items:center;justify-content:space-between;padding:0.8em;background:#f8f9fa;border-radius:8px;">
                <div style="display:flex;align-items:center;gap:0.8em;">
                  <span style="font-size:1.5em;"></span>
                  <span style="font-weight:600;color:#333;">Shield</span>
                  <span style="font-size:0.9rem;color:#666;display:block;margin-top:0.2em;">Protects from negative effects until used</span>
                </div>
                <select id="libraryShieldCount" style="padding:0.5em;border:1px solid #ddd;border-radius:4px;background:#fff;">
                  <option>0</option>
                  <option>1</option>
                  <option selected>1</option>
                  <option>2</option>
                  <option>3</option>
                  <option>4</option>
                </select>
              </div>
              
              <div style="display:flex;align-items:center;justify-content:space-between;padding:0.8em;background:#f8f9fa;border-radius:8px;">
                <div style="display:flex;align-items:center;gap:0.8em;">
                  <span style="font-size:1.5em;"></span>
                  <span style="font-weight:600;color:#333;">Hot Streak</span>
                  <span style="font-size:0.9rem;color:#666;display:block;margin-top:0.2em;">Next correct answer worth 3x points</span>
                </div>
                <select id="libraryHotStreakCount" style="padding:0.5em;border:1px solid #ddd;border-radius:4px;background:#fff;">
                  <option>0</option>
                  <option>1</option>
                  <option selected>1</option>
                  <option>2</option>
                  <option>3</option>
                  <option>4</option>
                </select>
              </div>
              
              <div style="display:flex;align-items:center;justify-content:space-between;padding:0.8em;background:#f8f9fa;border-radius:8px;">
                <div style="display:flex;align-items:center;gap:0.8em;">
                  <span style="font-size:1.5em;"></span>
                  <span style="font-weight:600;color:#333;">Coin Flip</span>
                </div>
                <select id="libraryCoinFlipCount" style="padding:0.5em;border:1px solid #ddd;border-radius:4px;background:#fff;">
                  <option>0</option>
                  <option>1</option>
                  <option selected>1</option>
                  <option>2</option>
                  <option>3</option>
                  <option>4</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Start Game Button -->
        <div style="text-align:center;">
          <button id="startLibraryGameBtn" class="purple-btn" style="font-size:1.3rem;padding:1em 3em;background:#6f5c91;color:#fff;border:none;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,0.1);transition:all 0.2s;">
             Start Game
          </button>
        </div>
      </div>
    </div>
    <!-- === END LIBRARY GAME OPTIONS MODAL === -->

    <!-- === COIN FLIP MODAL === -->
    <div id="coinFlipModal" class="hidden" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(49,114,122,0.9);z-index:2500;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
      <div style="background:#fff;padding:2.5em 3em;border-radius:20px;max-width:500px;width:95vw;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative;text-align:center;">
        <h2 style="margin:0 0 1em 0;color:#6F5C91;font-size:2rem;"> Coin Flip</h2>
        <p id="coinFlipDescription" style="margin:0 0 2em 0;color:#666;font-size:1.1rem;">Enter your wager amount and choose Heads or Tails. If you're right, you double your wager. If you're wrong, you lose your wager.</p>
        
        <div id="coinFlipScores" style="margin:1.5em 0;padding:1em;background:#f8f9fa;border-radius:8px;border:1px solid #e9ecef;">
          <div style="font-size:0.9rem;color:#666;margin-bottom:0.5em;text-align:center;">Current Team Scores:</div>
          <div id="coinFlipScoresDisplay" style="display:flex;justify-content:space-around;gap:1em;font-size:1rem;">
            <!-- Team scores will be populated here -->
          </div>
        </div>
        
        <div id="coinFlipWager" style="margin:2em 0;">
          <label for="wagerInput" style="display:block;margin-bottom:0.5em;color:#666;font-weight:600;">Wager Amount:</label>
          <input type="number" id="wagerInput" min="1" style="padding:0.8em;border:2px solid #ddd;border-radius:8px;font-size:1.1rem;width:150px;text-align:center;" placeholder="Enter amount">
          <div id="wagerError" style="color:#f44336;font-size:0.9rem;margin-top:0.5em;display:none;">Wager cannot exceed your team's total points!</div>
        </div>
        
        <div id="coinFlipResult" style="display:none;margin:2em 0;">
          <div id="coinFlipAnimation" style="font-size:4rem;margin:1em 0;"></div>
          <div id="coinFlipOutcome" style="font-size:1.5rem;font-weight:700;color:#6F5C91;"></div>
        </div>
        
        <div id="coinFlipButtons" style="display:flex;gap:1em;justify-content:center;margin-top:2em;">
          <button id="coinFlipHeads" class="purple-btn" style="padding:1em 2em;font-size:1.2rem;">Heads</button>
          <button id="coinFlipTails" class="purple-btn" style="padding:1em 2em;font-size:1.2rem;">Tails</button>
          <button id="coinFlipSkip" class="purple-btn" style="padding:1em 2em;font-size:1.2rem;background:#6c757d;">Skip</button>
        </div>
      </div>
    </div>
    <!-- === END COIN FLIP MODAL === -->

  </body>
</html>
