<!DOCTYPE html>
<html>
<head>
    <title>Test Starting Territories</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .test { margin: 20px 0; padding: 15px; background: #2a2a2a; border-radius: 8px; }
        button { padding: 10px 20px; background: #4ade80; color: #000; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .result { margin-top: 10px; padding: 10px; background: #3a3a3a; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üß™ Test Starting Territories</h1>
    
    <div class="test">
        <h3>Test Game Creation with Starting Territories</h3>
        <p>This will test if students get starting territories when a game is created.</p>
        <button onclick="testGameCreation()">Create Test Game</button>
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const supabase = supabase.createClient(
            "https://dmbbsrcwqpmdxqtzvtqj.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYmJzcmN3cXBtZHhxdHp2dHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NDg1OTYsImV4cCI6MjA2MjMyNDU5Nn0.E7EYSLCFXMYw5f4Wv7EXXj7-5yAT__BoYXklDB4uE2w"
        );

        async function testGameCreation() {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Creating test game...';

            try {
                // Test with a small roster
                const studentNames = "Alice\nBob\nCharlie";
                
                const { data, error } = await supabase.rpc('create_game_from_roster', {
                    p_class_name: 'Test Class',
                    p_game_name: 'Test Game - Starting Territories',
                    p_student_names: studentNames,
                    p_board_w: 8,
                    p_board_h: 8,
                    p_start_points: 5
                });

                if (error) {
                    resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
                    return;
                }

                resultDiv.innerHTML = `
                    <strong>Success!</strong><br>
                    Game ID: ${data.game_id}<br>
                    Board Size: ${data.board_w}x${data.board_h}<br>
                    Students: ${data.student_count}<br>
                    Starting tiles per student: ${data.starting_tiles_per_student || 'Not specified'}
                `;

                // Now check if tiles were assigned
                setTimeout(async () => {
                    const { data: tiles, error: tilesError } = await supabase
                        .from('tiles')
                        .select('*')
                        .eq('game_id', data.game_id);

                    if (tilesError) {
                        resultDiv.innerHTML += `<br><strong>Tiles Error:</strong> ${tilesError.message}`;
                        return;
                    }

                    const ownedTiles = tiles.filter(t => t.owner_game_student_id !== null);
                    resultDiv.innerHTML += `<br><strong>Tiles Check:</strong><br>
                        Total tiles: ${tiles.length}<br>
                        Owned tiles: ${ownedTiles.length}<br>
                        Empty tiles: ${tiles.length - ownedTiles.length}`;

                    if (ownedTiles.length > 0) {
                        resultDiv.innerHTML += '<br><strong>‚úÖ Starting territories working!</strong>';
                    } else {
                        resultDiv.innerHTML += '<br><strong>‚ùå No starting territories assigned</strong>';
                    }
                }, 1000);

            } catch (err) {
                resultDiv.innerHTML = `<strong>Exception:</strong> ${err.message}`;
            }
        }
    </script>
</body>
</html>
