<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Assignment - Tornado Game</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        :root {
            --primary: #8b5cf6;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            --text: #1f2937;
            --muted: #6b7280;
            --border: #e5e7eb;
            --background: #f9fafb;
            --card: #ffffff;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1rem 2rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .back-btn {
            background: var(--muted);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: #4b5563;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .assignment-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(139, 92, 246, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        .assignment-section h3 {
            margin: 0 0 1rem 0;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .roster-selection {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: rgba(16, 185, 129, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(16, 185, 129, 0.1);
        }

        .roster-selection h3 {
            margin: 0 0 1rem 0;
            color: var(--secondary);
            font-size: 1.2rem;
        }

        .roster-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .roster-item {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .roster-item:hover {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.05);
        }

        .roster-item.selected {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.1);
        }

        .roster-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .roster-name {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .roster-meta {
            font-size: 0.875rem;
            color: var(--muted);
        }

        .format-help {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .format-help strong {
            color: var(--info);
        }

        .format-help ul {
            margin: 0.5rem 0 0 0;
            padding-left: 1.5rem;
        }

        .format-help li {
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1rem;
        }

        .btn:hover {
            background: #7c3aed;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: var(--muted);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-secondary:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--muted);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .roster-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Create Assignment</h1>
            <a href="/" class="back-btn">‚Üê Back to Home</a>
        </div>

        <div class="main-content">
            <div id="statusMessage" class="status-message status-info">
                Create assignments with multiple choice and short answer questions. Assign to one or more of your rosters.
            </div>
            
            <form id="assignmentForm">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" onclick="openAssignmentBrowser()" style="width: 100%; margin-bottom: 1rem;">
                        üìÅ Browse Premade Assignments
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="assignmentTitle">Assignment Title</label>
                    <input type="text" id="assignmentTitle" placeholder="Enter assignment title" required>
                </div>
                
                <div class="form-group">
                    <label for="assignmentDescription">Description (Optional)</label>
                    <textarea id="assignmentDescription" rows="3" placeholder="Enter assignment description"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="assignmentFolder">Save to Folder (Optional)</label>
                    <select id="assignmentFolder">
                        <option value="">No folder (save to root)</option>
                        <option value="romeo-juliet-unit">üìÅ Romeo & Juliet Unit</option>
                        <option value="the-odyssey-unit">üìÅ The Odyssey Unit</option>
                        <option value="american-revolution-unit">üìÅ American Revolution Unit</option>
                    </select>
                    <button type="button" class="btn btn-link" onclick="createNewFolder()" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.9rem;">
                        + Create New Folder
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="assignmentType">Assignment Type</label>
                    <select id="assignmentType" onchange="toggleAssignmentType()">
                        <option value="multiple_choice">Multiple Choice Questions</option>
                        <option value="short_answer">Short Answer Questions</option>
                        <option value="mixed">Mixed (Multiple Choice + Short Answer)</option>
                        <option value="romeo_juliet_unit">Romeo & Juliet Unit Assignment</option>
                    </select>
                </div>
                
                <!-- Romeo & Juliet Unit Section -->
                <div id="romeoJulietSection" class="assignment-section" style="display: none;">
                    <h3>üé≠ Romeo & Juliet Unit Assignments</h3>
                    <div class="form-group">
                        <label for="romeoJulietDay">Select Day/Scene</label>
                        <select id="romeoJulietDay">
                            <option value="day1">Day 1: Act 1, Scene 1 (Street Fight & Prince's Decree)</option>
                            <option value="day2">Day 2: Act 1, Scenes 2-3 (Paris's Proposal & Capulet's Party Plan)</option>
                            <option value="day3">Day 3: Act 1, Scenes 4-5 (Queen Mab Speech & Romeo & Juliet Meet)</option>
                            <option value="day4">Day 4: Act 2, Scene 1-2 (Balcony Scene Opening)</option>
                            <option value="day5">Day 5: Act 2, Scene 2-3 (Balcony Scene Conclusion & Friar Laurence)</option>
                            <option value="day6">Day 6: Act 2, Scenes 4-5 (Mercutio/Tybalt Banter & Nurse as Go-Between)</option>
                            <option value="day7">Day 7: Act 2, Scene 6 (Romeo & Juliet's Secret Marriage)</option>
                            <option value="day8">Day 8: Act 3, Scene 1 (Mercutio Killed, Tybalt Killed, Romeo Banished)</option>
                            <option value="day9">Day 9: Act 3, Scenes 2-3 (Juliet Learns of Tybalt's Death, Romeo Despairs)</option>
                            <option value="day10">Day 10: Act 3, Scenes 4-5 (Capulet Sets Wedding Date, Romeo & Juliet's Farewell)</option>
                            <option value="day11">Day 11: Act 4, Scenes 1-2 (Friar Laurence's Plan, Juliet Agrees to Marry Paris)</option>
                            <option value="day12">Day 12: Act 4, Scenes 3-5 (Juliet Takes Potion, Family Discovers "Death")</option>
                            <option value="day13">Day 13: Act 5, Scenes 1-2 (Romeo's Dream, Balthasar's News, Friar John's Failure)</option>
                            <option value="day14">Day 14: Act 5, Scene 3 (Romeo and Juliet Die, Families Reconcile)</option>
                            <option value="tornado_quiz">Romeo & Juliet Tornado Quiz (30 Questions)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="romeoJulietPoints">Total Points for Assignment</label>
                        <input type="number" id="romeoJulietPoints" value="35" min="1" max="100">
                    </div>
                </div>
                
                <!-- Multiple Choice Section -->
                <div id="multipleChoiceSection" class="assignment-section">
                    <h3>üìù Multiple Choice Questions</h3>
                    <div class="form-group">
                        <label for="mcPointsPerQuestion">Points per Question (default: 5)</label>
                        <input type="number" id="mcPointsPerQuestion" value="5" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="mcQuestionsText">Questions (Copy & Paste Format)</label>
                        <div style="display:flex; gap:0.5rem; margin:0.25rem 0 0.5rem 0;">
                            <button type="button" class="btn btn-secondary" onclick="openStandardsPicker('mcQuestionsText')">Add Standards Tag</button>
                        </div>
                        <textarea id="mcQuestionsText" rows="10" placeholder="Enter questions in this format:

What is the capital of France?
A) London
B) Paris
C) Berlin
D) Madrid
Answer: B

What is 2+2?
A) 3
B) 4
C) 5
D) 6
Answer: B"></textarea>
                    </div>
                    <div class="format-help">
                        <strong>Format Instructions:</strong>
                        <ul>
                            <li>Each question on a new line</li>
                            <li>Choices labeled A), B), C), D)</li>
                            <li>Answer line: "Answer: [letter]"</li>
                            <li>Leave blank line between questions</li>
                            <li>Optional: tag standards inline like [STD: RL.9-10.1, W.9-10.2]</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Short Answer Section -->
                <div id="shortAnswerSection" class="assignment-section" style="display: none;">
                    <h3>‚úçÔ∏è Short Answer Questions</h3>
                    <div class="form-group">
                        <label for="saMaxPoints">Maximum Points per Question (default: 10)</label>
                        <input type="number" id="saMaxPoints" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="saQuestionsText">Questions</label>
                        <div style="display:flex; gap:0.5rem; margin:0.25rem 0 0.5rem 0;">
                            <button type="button" class="btn btn-secondary" onclick="openStandardsPicker('saQuestionsText')">Add Standards Tag</button>
                        </div>
                        <textarea id="saQuestionsText" rows="8" placeholder="Enter questions, one per line:

Explain the causes of World War I.
Describe the water cycle.
What is photosynthesis?"></textarea>
                    </div>
                    <div class="format-help">
                        <strong>Format Instructions:</strong>
                        <ul>
                            <li>One question per line</li>
                            <li>Optional: tag standards inline like [STD: RL.9-10.1, W.9-10.2]</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Roster Selection -->
                <div class="roster-selection">
                    <h3>üë• Assign to Rosters</h3>
                    <p>Select which rosters should receive this assignment:</p>
                    <div id="rosterList" class="roster-list">
                        <!-- Rosters will be populated here -->
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">Cancel</button>
                    <button type="button" class="btn btn-secondary" onclick="loadFromLibrary()">Load from Library</button>
                    <button type="button" class="btn" onclick="createAssignment()">Create Assignment</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // === SUPABASE CLIENT ===
        const supabaseClient = window.supabase.createClient(
            'https://dmbbsrcwqpmdxqtzvtqj.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYmJzcmN3cXBtZHhxdHp2dHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NDg1OTYsImV4cCI6MjA2MjMyNDU5Nn0.E7EYSLCFXMYw5f4Wv7EXXj7-5yAT__BoYXklDB4uE2w'
        );
        // === INITIALIZATION ===
        function init() {
            loadRosters();
            toggleAssignmentType();
        }

        function loadRosters() {
            const rosters = JSON.parse(localStorage.getItem('tornadoRosters') || '[]');
            const rosterList = document.getElementById('rosterList');
            
            if (rosters.length === 0) {
                rosterList.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="icon">üë•</div>
                        <p>No rosters found</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Create a roster first to assign assignments</p>
                        <a href="roster.html" class="btn btn-secondary">Manage Rosters</a>
                    </div>
                `;
                return;
            }
            
            rosterList.innerHTML = rosters.map(roster => `
                <div class="roster-item" onclick="toggleRosterSelection('${roster.id}')">
                    <input type="checkbox" id="roster_${roster.id}" value="${roster.id}" style="display: none;">
                    <div class="roster-name">${roster.name}</div>
                    <div class="roster-meta">
                        ${roster.roster.length} students ‚Ä¢ 
                        ${roster.teamMode === 'individual' ? 'Individual Mode' : 
                          roster.teams ? `${roster.teams.length} Teams` : 'No Teams'}
                    </div>
                </div>
            `).join('');
        }

        function toggleRosterSelection(rosterId) {
            const checkbox = document.getElementById(`roster_${rosterId}`);
            const rosterItem = checkbox.parentElement;
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                rosterItem.classList.add('selected');
            } else {
                rosterItem.classList.remove('selected');
            }
        }

        function openAssignmentBrowser() {
            window.open('/assignment-browser.html', '_blank', 'width=1000,height=700');
        }

        function createNewFolder() {
            const folderName = prompt('Enter folder name:');
            if (folderName && folderName.trim()) {
                const folderSelect = document.getElementById('assignmentFolder');
                const newOption = document.createElement('option');
                newOption.value = folderName.toLowerCase().replace(/\s+/g, '-');
                newOption.textContent = `üìÅ ${folderName}`;
                folderSelect.appendChild(newOption);
                newOption.selected = true;
                
                // Save to localStorage
                let folders = JSON.parse(localStorage.getItem('teacherFolders') || '[]');
                if (!folders.includes(folderName.toLowerCase().replace(/\s+/g, '-'))) {
                    folders.push(folderName.toLowerCase().replace(/\s+/g, '-'));
                    localStorage.setItem('teacherFolders', JSON.stringify(folders));
                }
            }
        }

        function toggleAssignmentType() {
            const assignmentType = document.getElementById('assignmentType').value;
            const mcSection = document.getElementById('multipleChoiceSection');
            const saSection = document.getElementById('shortAnswerSection');
            const rjSection = document.getElementById('romeoJulietSection');
            
            if (assignmentType === 'multiple_choice') {
                mcSection.style.display = 'block';
                saSection.style.display = 'none';
                rjSection.style.display = 'none';
            } else if (assignmentType === 'short_answer') {
                mcSection.style.display = 'none';
                saSection.style.display = 'block';
                rjSection.style.display = 'none';
            } else if (assignmentType === 'mixed') {
                mcSection.style.display = 'block';
                saSection.style.display = 'block';
                rjSection.style.display = 'none';
            } else if (assignmentType === 'romeo_juliet_unit') {
                mcSection.style.display = 'none';
                saSection.style.display = 'none';
                rjSection.style.display = 'block';
            }
        }

        async function createAssignment() {
            const title = document.getElementById('assignmentTitle').value.trim();
            const description = document.getElementById('assignmentDescription').value.trim();
            const assignmentType = document.getElementById('assignmentType').value;
            
            if (!title) {
                showStatus('Please enter an assignment title', 'error');
                return;
            }
            
            // Get selected rosters
            const selectedRosters = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedRosters.length === 0) {
                showStatus('Please select at least one roster', 'error');
                return;
            }
            
            // Parse questions based on type
            let questions = [];
            
            if (assignmentType === 'romeo_juliet_unit') {
                // Handle Romeo & Juliet unit assignments
                const rjDay = document.getElementById('romeoJulietDay').value;
                const rjPoints = parseInt(document.getElementById('romeoJulietPoints').value) || 35;
                
                // Create a special assignment that redirects to the appropriate day
                questions = [{
                    id: 'romeo_juliet_redirect',
                    type: 'romeo_juliet_unit',
                    day: rjDay,
                    points: rjPoints,
                    title: title,
                    description: description
                }];
            } else if (assignmentType === 'multiple_choice' || assignmentType === 'mixed') {
                const mcQuestions = parseMultipleChoiceQuestions();
                if (mcQuestions.length === 0) {
                    showStatus('Please enter at least one multiple choice question', 'error');
                    return;
                }
                questions = questions.concat(mcQuestions);
            }
            
            if (assignmentType === 'short_answer' || assignmentType === 'mixed') {
                const saQuestions = parseShortAnswerQuestions();
                if (saQuestions.length === 0) {
                    showStatus('Please enter at least one short answer question', 'error');
                    return;
                }
                questions = questions.concat(saQuestions);
            }
            
            // Enforce per-question standards tagging
            const missing = findQuestionsMissingStandards(questions);
            if (missing.length > 0) {
                const msg = `Please add standards to all questions before saving. Missing on: \n` +
                    missing.slice(0, 10).map(i => ` - Question ${i + 1}`).join('\n') +
                    (missing.length > 10 ? `\n ...and ${missing.length - 10} more` : '');
                showStatus(msg, 'error');
                return;
            }

            // Create assignment for each selected roster
            const assignments = JSON.parse(localStorage.getItem('tornadoAssignments') || '[]');
            let createdCount = 0;
            
            selectedRosters.forEach(rosterId => {
                const assignment = {
                    id: generateAssignmentId(),
                    title: title,
                    description: description,
                    type: assignmentType,
                    rosterId: rosterId,
                    createdAt: new Date().toISOString(),
                    questions: questions,
                    submissions: {}
                };
                
                assignments.push(assignment);
                createdCount++;
            });
            
            // Save assignments
            localStorage.setItem('tornadoAssignments', JSON.stringify(assignments));
            
            // Save to Supabase if logged in
            console.log('Attempting to save assignments to cloud...');
            if (supabaseClient && supabaseClient.auth && supabaseClient.auth.getSession) {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    console.log('Session check result:', session ? 'Found session' : 'No session');
                    if (session) {
                        console.log('Saving assignments to Supabase with teacher_id:', session.user.id);
                        for (const assignment of assignments.slice(-createdCount)) {
                            const { error } = await supabaseClient.from('assignments').upsert({
                                id: assignment.id,
                                teacher_id: session.user.id,
                                title: assignment.title,
                                description: assignment.description,
                                type: assignment.type,
                                roster_id: assignment.rosterId,
                                questions: assignment.questions,
                                submissions: assignment.submissions,
                                created_at: assignment.createdAt,
                                last_modified: new Date().toISOString()
                            });
                            if (error) {
                                console.error('Supabase error in createAssignment:', error);
                                // Graceful fallback if table missing
                                if (error.code === 'PGRST205' || /Could not find the table 'public.assignments'/.test(error.message||'')) {
                                    console.warn("Supabase 'assignments' table missing. Saved locally only.");
                                }
                            } else {
                                console.log('‚úÖ Assignment saved to Supabase successfully!');
                            }
                        }
                    } else {
                        console.log('‚ùå No active session - assignments saved locally only');
                    }
                } catch (error) {
                    console.error('Error saving assignments to Supabase:', error);
                    // Continue with local save even if Supabase fails
                }
            } else {
                console.log('‚ùå Supabase client not available - assignments saved locally only');
            }
            
            // Show success message
            showStatus(`Assignment "${title}" created successfully for ${createdCount} roster${createdCount !== 1 ? 's' : ''}! Students can now access it from their dashboard.`, 'success');
            
            // Reset form
            document.getElementById('assignmentForm').reset();
            document.getElementById('assignmentType').value = 'multiple_choice';
            toggleAssignmentType();
            
            // Clear roster selections
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                cb.parentElement.classList.remove('selected');
            });
        }

        function parseMultipleChoiceQuestions() {
            const text = document.getElementById('mcQuestionsText').value.trim();
            const pointsPerQuestion = parseInt(document.getElementById('mcPointsPerQuestion').value) || 5;
            
            if (!text) return [];
            
            const questions = [];
            const blocks = text.split('\n\n').filter(block => block.trim());
            
            blocks.forEach((block, index) => {
                const lines = block.trim().split('\n');
                if (lines.length < 4) return; // Need question + 4 choices + answer
                
                let question = lines[0].trim();
                const standards = extractStandards(question);
                question = stripStandards(question);
                const choices = [];
                let answer = '';
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.startsWith('Answer:')) {
                        answer = line.replace('Answer:', '').trim().toUpperCase();
                        break;
                    } else if (line.match(/^[A-D]\)/)) {
                        choices.push(line);
                    }
                }
                
                if (question && choices.length >= 2 && answer) {
                    questions.push({
                        id: `mc_${index}`,
                        type: 'multiple_choice',
                        question: question,
                        choices: choices,
                        correctAnswer: answer,
                        points: pointsPerQuestion,
                        standards: standards
                    });
                }
            });
            
            return questions;
        }

        function parseShortAnswerQuestions() {
            const text = document.getElementById('saQuestionsText').value.trim();
            const maxPoints = parseInt(document.getElementById('saMaxPoints').value) || 10;
            
            if (!text) return [];
            
            const questions = [];
            const lines = text.split('\n').filter(line => line.trim());
            
            lines.forEach((line, index) => {
                let question = line.trim();
                const standards = extractStandards(question);
                question = stripStandards(question);
                if (question) {
                    questions.push({
                        id: `sa_${index}`,
                        type: 'short_answer',
                        question: question,
                        maxPoints: maxPoints,
                        standards: standards
                    });
                }
            });
            
            return questions;
        }

        // === Standards Tagging Helpers ===
        function extractStandards(text) {
            if (!text) return [];
            const matches = [...text.matchAll(/\[STD:\s*([^\]]+)\]/gi)];
            const found = [];
            matches.forEach(m => {
                const parts = m[1].split(',').map(s => s.trim()).filter(Boolean);
                parts.forEach(p => found.push(p));
            });
            // De-duplicate while preserving order
            return [...new Set(found)];
        }

        function stripStandards(text) {
            return text.replace(/\s*\[STD:\s*[^\]]+\]/gi, '').trim();
        }

        function findQuestionsMissingStandards(questions) {
            const missing = [];
            (questions || []).forEach((q, idx) => {
                if (!Array.isArray(q.standards) || q.standards.length === 0) missing.push(idx);
            });
            return missing;
        }

        function generateAssignmentId() {
            // Generate a proper UUID v4
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
        }

        // === INITIALIZE ===
        document.addEventListener('DOMContentLoaded', init);
        
        // Make functions globally accessible
        window.createAssignment = createAssignment;
        window.toggleAssignmentType = toggleAssignmentType;
        window.openStandardsPicker = openStandardsPicker;
        window.loadFromLibrary = loadFromLibrary;
    </script>

    <!-- Standards Picker Modal -->
    <div id="standardsPickerOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:white; width:95%; max-width:800px; border-radius:12px; padding:1rem; max-height:90vh; overflow:auto;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
                <h3 style="margin:0;">Add Standards Tag</h3>
                <button class="btn btn-secondary" onclick="closeStandardsPicker()" style="background:#e5e7eb;">Close</button>
            </div>
            <div style="display:flex; gap:0.75rem; align-items:center; margin:0.75rem 0;">
                <label for="stdSubject" style="font-weight:600;">Subject</label>
                <select id="stdSubject" onchange="renderStandardsList()">
                    <option value="ela" selected>ELA (Common Core)</option>
                    <option value="math">Math (Common Core)</option>
                    <option value="science">Science (NGSS)</option>
                    <option value="history">History/Social Studies</option>
                </select>
                <input id="stdSearch" type="text" placeholder="Search standards (e.g., RL.9-10.1)" oninput="renderStandardsList()" style="flex:1; padding:0.5rem; border:1px solid #e5e7eb; border-radius:6px;">
            </div>
            <div id="stdList" style="border:1px solid #e5e7eb; border-radius:8px; padding:0.5rem; max-height:50vh; overflow:auto; background:#fafafa;"></div>
            <div style="display:flex; align-items:center; gap:0.5rem; margin-top:0.75rem;">
                <span style="font-weight:600;">Custom code:</span>
                <input id="stdCustomCode" type="text" placeholder="e.g., RL.9-10.7 or MyStd.1" style="flex:1; padding:0.5rem; border:1px solid #e5e7eb; border-radius:6px;">
                <button class="btn btn-secondary" onclick="addCustomStandardToList()">Add</button>
            </div>
            <div style="display:flex; gap:0.5rem; justify-content:flex-end; margin-top:0.75rem;">
                <button class="btn btn-secondary" onclick="insertSelectedStandards()">Insert tag at cursor</button>
            </div>
        </div>
    </div>

    <script>
        // === Standards Catalog (seed subset; can be expanded) ===
        const STANDARDS_CATALOG = {
            ela: [
                { code: 'RL.9-10.1', label: 'Cite strong and thorough textual evidence' },
                { code: 'RL.9-10.2', label: 'Determine themes; analyze development; objective summary' },
                { code: 'RL.9-10.3', label: 'Analyze how complex characters develop and advance plot' },
                { code: 'RL.9-10.4', label: 'Determine word meanings; analyze figurative and connotative meanings' },
                { code: 'RL.9-10.5', label: 'Analyze author‚Äôs choices in text structure and order' },
                { code: 'RL.9-10.6', label: 'Analyze point of view and cultural experience' },
                { code: 'RI.9-10.1', label: 'Cite textual evidence (informational)' },
                { code: 'W.9-10.1', label: 'Write arguments to support claims' },
                { code: 'W.9-10.2', label: 'Informative/explanatory writing' },
                { code: 'L.9-10.4', label: 'Determine or clarify the meaning of unknown words' }
            ],
            math: [
                { code: 'N-RN.1', label: 'Properties of rational and irrational exponents' },
                { code: 'A-REI.3', label: 'Solve linear equations/inequalities in one variable' },
                { code: 'F-IF.4', label: 'Interpret key features of functions' }
            ],
            science: [
                { code: 'HS-LS1-2', label: 'Develop and use models of systems of specialized cells' },
                { code: 'HS-ESS1-4', label: 'Use mathematical or computational representations' }
            ],
            history: [
                { code: 'RH.9-10.1', label: 'Cite specific textual evidence (history/social studies)' },
                { code: 'RH.9-10.2', label: 'Determine central ideas of a primary/secondary source' }
            ]
        };

        let standardsPickerTargetId = null;

        function openStandardsPicker(targetTextareaId) {
            standardsPickerTargetId = targetTextareaId;
            document.getElementById('standardsPickerOverlay').style.display = 'flex';
            renderStandardsList();
        }

        function closeStandardsPicker() {
            document.getElementById('standardsPickerOverlay').style.display = 'none';
            standardsPickerTargetId = null;
        }

        function renderStandardsList() {
            const subject = document.getElementById('stdSubject').value;
            const q = (document.getElementById('stdSearch').value || '').toLowerCase();
            const list = STANDARDS_CATALOG[subject] || [];
            const filtered = list.filter(item => item.code.toLowerCase().includes(q) || item.label.toLowerCase().includes(q));
            const html = filtered.map(item => `
                <label style="display:flex; align-items:center; gap:0.5rem; padding:0.25rem 0;">
                    <input type="checkbox" class="std-item" value="${item.code}">
                    <span style="font-weight:600; min-width:110px;">${item.code}</span>
                    <span style="color:#374151;">${item.label}</span>
                </label>
            `).join('');
            document.getElementById('stdList').innerHTML = html || '<div class="status-message status-info">No matching standards</div>';
        }

        function insertSelectedStandards() {
            if (!standardsPickerTargetId) return;
            const textarea = document.getElementById(standardsPickerTargetId);
            if (!textarea) return;
            const selected = Array.from(document.querySelectorAll('#stdList .std-item:checked')).map(cb => cb.value);
            const custom = (document.getElementById('stdCustomCode').value || '').trim();
            if (custom) selected.push(custom);
            if (selected.length === 0) { alert('Select at least one standard.'); return; }
            const tag = ` [STD: ${selected.join(', ')}]`;

            // Insert at cursor
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(end);
            textarea.value = before + tag + after;
            // Move cursor after inserted tag
            const newPos = start + tag.length;
            textarea.setSelectionRange(newPos, newPos);
            textarea.focus();
        }

        function addCustomStandardToList() {
            const code = (document.getElementById('stdCustomCode').value || '').trim();
            if (!code) { alert('Enter a custom standard code.'); return; }
            // Prepend a temporary custom item to the list for visibility and selection
            const listEl = document.getElementById('stdList');
            const tempId = `custom-${Date.now()}`;
            const row = document.createElement('label');
            row.style.cssText = 'display:flex; align-items:center; gap:0.5rem; padding:0.25rem 0;';
            row.innerHTML = `
                <input type="checkbox" class="std-item" value="${code}" checked>
                <span style="font-weight:600; min-width:110px;">${code}</span>
                <span style="color:#374151;">(custom)</span>
            `;
            listEl.prepend(row);
            document.getElementById('stdCustomCode').value = '';
        }

        // Heuristic standards auto-suggest for untagged questions
        function suggestStandardsForQuestion(text) {
            const t = (text||'').toLowerCase();
            const out = new Set();
            if (/(cite|evidence|quote|line|passage)/.test(t)) out.add('RL.9-10.1');
            if (/(theme|central idea|message)/.test(t)) out.add('RL.9-10.2');
            if (/(character|motivation|develop)/.test(t)) out.add('RL.9-10.3');
            if (/(figurative|metaphor|simile|diction|connotative|meaning)/.test(t)) out.add('RL.9-10.4');
            if (/(structure|plot|order|foreshadow|flashback)/.test(t)) out.add('RL.9-10.5');
            if (/(point of view|dramatic irony|cultural|perspective)/.test(t)) out.add('RL.9-10.6');
            return [...out];
        }

        function autoSuggestStandardsForAssignment(assignment) {
            (assignment?.questions||[]).forEach(q => {
                if (!Array.isArray(q.standards) || q.standards.length === 0) {
                    const base = q.question || q.q || '';
                    const guess = suggestStandardsForQuestion(base);
                    if (guess.length > 0) q.standards = guess;
                }
            });
            return assignment;
        }
    </script>
</body>
</html>
