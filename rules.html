<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tornado Business – Rules</title>
  <style>
    :root { --bg:#0f172a; --panel:#0b1220; --border:#1f2a44; --text:#e5e7eb; --muted:#9aa3b2; --accent:#22d3ee; }
    * { box-sizing: border-box }
    body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position:sticky; top:0; z-index:2; background:#0d1628cc; border-bottom:1px solid var(--border); }
    .bar { display:flex; gap:8px; align-items:center; padding:12px 16px }
    .wrap { max-width:800px; margin:0 auto; padding:16px }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px; margin-bottom:12px }
    input, textarea, select { width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#081125; color:var(--text) }
    .btn { padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#0b1932; color:#fff; cursor:pointer; font-size:12px }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="lib/rulesEngine.js"></script>
  <script>
    const SUPABASE_URL  = "https://dmbbsrcwqpmdxqtzvtqj.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYmJzcmN3cXBtZHhxdHp2dHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NDg1OTYsImV4cCI6MjA2MjMyNDU5Nn0.E7EYSLCFXMYw5f4Wv7EXXj7-5yAT__BoYXklDB4uE2w";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    let employees = [];

    async function loadEmployees() {
      const { data } = await supabase.from('employees').select('*');
      employees = data || [];
      
      // Populate employee dropdown
      const employeeSelect = document.getElementById('employee');
      if (employeeSelect) {
        employeeSelect.innerHTML = '<option value="">Select Employee</option>' +
          employees.map(emp => `<option value="${emp.id}">${emp.name} (${emp.team || 'Individual'})</option>`).join('');
      }
    }

    async function addRule(){
      const ruleType = document.getElementById('ruleType').value;
      const rule = {
        type: ruleType,
        metric_name: document.getElementById('metric').value,
        condition: document.getElementById('condition').value,
        badge_id: document.getElementById('badge').value,
        points: parseInt(document.getElementById('points').value||'0',10),
        notify: document.getElementById('notify').checked
      };

      // Add attribution-specific fields
      if (ruleType === 'attribution') {
        rule.employee_id = document.getElementById('employee').value;
        if (!rule.employee_id) {
          alert('Please select an employee for attribution rule');
          return;
        }
      }

      await saveRule(supabase, rule);
      alert('Rule saved');
      location.reload();
    }

    function updateRuleForm() {
      const ruleType = document.getElementById('ruleType').value;
      const employeeField = document.getElementById('employeeField');
      const badgeField = document.getElementById('badgeField');
      
      if (ruleType === 'attribution') {
        employeeField.style.display = 'block';
        badgeField.style.display = 'none';
      } else {
        employeeField.style.display = 'none';
        badgeField.style.display = 'block';
      }
    }

    window.addRule = addRule;
    window.updateRuleForm = updateRuleForm;
    
    document.addEventListener('DOMContentLoaded', loadEmployees);
  </script>
</head>
<body>
  <header>
    <div class="bar">
      <h1 style="margin:0; font-size:18px;">⚙️ Rules & Automation</h1>
      <div style="flex:1"></div>
      <button class="btn" onclick="window.location.href='business-home.html'">← Manager Hub</button>
    </div>
  </header>
  <div class="wrap">
    <div class="card">
      <h3 style="margin-top:0">Quick Rule Builder</h3>
      <div style="display:grid; gap:12px">
        <div>
          <label style="display:block; margin-bottom:4px; font-size:12px; color:var(--muted);">When this happens:</label>
          <select id="ruleType" onchange="updateRuleForm()" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#081125; color:var(--text)">
            <option value="points">Employee earns points</option>
            <option value="badge">Employee gets a badge</option>
            <option value="notification">Send notification</option>
            <option value="attribution">Auto-assign data to employee</option>
          </select>
        </div>
        
        <div>
          <label style="display:block; margin-bottom:4px; font-size:12px; color:var(--muted);">Metric name:</label>
          <input id="metric" placeholder="e.g., sales_deal, task_completed" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#081125; color:var(--text)" />
        </div>
        
        <div>
          <label style="display:block; margin-bottom:4px; font-size:12px; color:var(--muted);">Condition:</label>
          <select id="condition" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#081125; color:var(--text)">
            <option value="value >= 1">Value is 1 or more</option>
            <option value="value >= 5">Value is 5 or more</option>
            <option value="value >= 10">Value is 10 or more</option>
            <option value="value >= 100">Value is 100 or more</option>
            <option value="value == 1">Value equals exactly 1</option>
            <option value="value > 0">Value is greater than 0</option>
          </select>
        </div>
        
        <div id="badgeField">
          <label style="display:block; margin-bottom:4px; font-size:12px; color:var(--muted);">Badge name:</label>
          <input id="badge" placeholder="e.g., Sales Champion, Task Master" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#081125; color:var(--text)" />
        </div>
        
        <div id="employeeField" style="display:none;">
          <label style="display:block; margin-bottom:4px; font-size:12px; color:var(--muted);">Assign to employee:</label>
          <select id="employee" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#081125; color:var(--text)">
            <option value="">Select Employee</option>
          </select>
        </div>
        
        <div>
          <label style="display:block; margin-bottom:4px; font-size:12px; color:var(--muted);">Points to award:</label>
          <input id="points" type="number" placeholder="e.g., 50" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#081125; color:var(--text)" />
        </div>
        
        <label style="display:flex; align-items:center; gap:8px; margin-top:8px;">
          <input id="notify" type="checkbox" />
          <span style="font-size:12px; color:var(--muted);">Send notification to Slack/Teams</span>
        </label>
        
        <button class="btn" onclick="addRule()" style="background:#3b82f6; color:#fff; padding:12px; font-size:14px; font-weight:600;">Create Rule</button>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-top:0">How it works</h3>
      <p>Rules automatically trigger when employees complete actions. For example: "When someone closes a deal (sales_deal), give them 50 points and the Sales Champion badge."</p>
      
      <div style="margin-top:16px;">
        <h4 style="margin-bottom:8px;">Examples:</h4>
        <ul style="margin:0; padding-left:20px; font-size:13px; color:var(--muted);">
          <li>Close 1 deal → Get 50 points + "Deal Closer" badge</li>
          <li>Complete 5 tasks → Get 25 points + "Task Master" badge</li>
          <li>Reach 100 points → Get "Century Club" badge</li>
        </ul>
      </div>
    </div>
  </div>
</body>
</html>

