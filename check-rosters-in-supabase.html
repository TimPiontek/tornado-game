<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Rosters in Supabase</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #7c3aed; }
        .output {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { color: #155724; }
        .error { color: #721c24; }
        .info { color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Check Rosters in Supabase</h1>
        <p>This tool checks if rosters exist in Supabase and shows their class codes.</p>
        
        <button onclick="checkRosters()">Check Rosters</button>
        <button onclick="clearOutput()">Clear</button>
        
        <div id="output" class="output"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://dmbbsrcwqpmdxqtzvtqj.supabase.co";
        const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYmJzcmN3cXBtZHhxdHp2dHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NDg1OTYsImV4cCI6MjA2MjMyNDU5Nn0.E7EYSLCFXMYw5f4Wv7EXXj7-5yAT__BoYXklDB4uE2w";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            output.innerHTML += `<span class="${className}">${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }
        
        async function checkRosters() {
            clearOutput();
            log('ðŸ” Checking rosters in Supabase...\n', 'info');
            
            try {
                // Query all rosters
                const { data: rosters, error } = await supabase
                    .from('rosters')
                    .select('id, name, data, class_code, last_modified, teacher_id');
                
                if (error) {
                    log(`âŒ Error querying rosters: ${error.message}`, 'error');
                    log(`Error code: ${error.code}`, 'error');
                    log(`Error details: ${JSON.stringify(error, null, 2)}`, 'error');
                    return;
                }
                
                if (!rosters || rosters.length === 0) {
                    log('âš ï¸ No rosters found in Supabase database.', 'error');
                    log('\nThis means:', 'info');
                    log('1. Either no rosters have been created yet', 'info');
                    log('2. Or rosters were created but not saved to Supabase', 'info');
                    log('3. Or there is an RLS policy preventing access', 'info');
                    log('\nTo fix:', 'info');
                    log('1. Have the teacher log in and create a roster', 'info');
                    log('2. Make sure the roster is saved to Supabase (check browser console)', 'info');
                    log('3. Verify the teacher is logged in when creating the roster', 'info');
                    return;
                }
                
                log(`âœ… Found ${rosters.length} roster(s) in Supabase:\n`, 'success');
                
                rosters.forEach((roster, index) => {
                    log(`\n--- Roster ${index + 1} ---`, 'info');
                    log(`ID: ${roster.id}`, 'info');
                    log(`Name: ${roster.name}`, 'info');
                    log(`Teacher ID: ${roster.teacher_id}`, 'info');
                    log(`Last Modified: ${roster.last_modified}`, 'info');
                    
                    // Check for classCode in data JSONB
                    let classCode = null;
                    let rosterData = null;
                    
                    if (roster.data) {
                        if (typeof roster.data === 'string') {
                            try {
                                rosterData = JSON.parse(roster.data);
                            } catch (e) {
                                log(`âš ï¸ Could not parse data JSON: ${e.message}`, 'error');
                            }
                        } else {
                            rosterData = roster.data;
                        }
                        
                        if (rosterData && rosterData.classCode) {
                            classCode = rosterData.classCode;
                            log(`âœ… Class Code (from data.classCode): ${classCode}`, 'success');
                        } else {
                            log(`âš ï¸ No classCode found in data.classCode`, 'error');
                        }
                    } else {
                        log(`âš ï¸ No data field found`, 'error');
                    }
                    
                    // Check for class_code column
                    if (roster.class_code) {
                        log(`âœ… Class Code (from class_code column): ${roster.class_code}`, 'success');
                    } else {
                        log(`âš ï¸ No class_code column found`, 'error');
                    }
                    
                    // Show student count
                    if (rosterData && rosterData.roster) {
                        log(`Students: ${rosterData.roster.length}`, 'info');
                    }
                });
                
                // Summary
                log(`\n\n=== SUMMARY ===`, 'info');
                log(`Total rosters: ${rosters.length}`, 'info');
                const rostersWithCodes = rosters.filter(r => {
                    const d = r.data || (typeof r.data === 'string' ? JSON.parse(r.data) : {});
                    return d.classCode || r.class_code;
                });
                log(`Rosters with class codes: ${rostersWithCodes.length}`, 'info');
                
                if (rostersWithCodes.length > 0) {
                    log('\nAvailable class codes:', 'success');
                    rostersWithCodes.forEach(r => {
                        const d = r.data || (typeof r.data === 'string' ? JSON.parse(r.data) : {});
                        const code = d.classCode || r.class_code;
                        log(`  - ${r.name}: ${code}`, 'success');
                    });
                }
                
            } catch (err) {
                log(`âŒ Exception: ${err.message}`, 'error');
                log(err.stack, 'error');
            }
        }
        
        // Auto-check on load
        window.addEventListener('load', () => {
            log('Page loaded. Click "Check Rosters" to see what\'s in Supabase.\n', 'info');
        });
    </script>
</body>
</html>

