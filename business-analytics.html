<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tornado Business ‚Äì Analytics</title>
  <style>
    :root { --bg:#0f172a; --panel:#0b1220; --border:#1f2a44; --text:#e5e7eb; --muted:#9aa3b2; --accent:#22d3ee; }
    * { box-sizing: border-box }
    body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position:sticky; top:0; z-index:2; background:#0d1628cc; border-bottom:1px solid var(--border); }
    .bar { display:flex; gap:8px; align-items:center; padding:12px 16px }
    .wrap { max-width:1160px; margin:0 auto; padding:16px }
    .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px }
    .kpi { font-size:22px; font-weight:700 }
    .muted { color:var(--muted); font-size:12px }
    @media (max-width: 900px) { .grid { grid-template-columns: repeat(2,1fr) } }
    @media (max-width: 600px) { .grid { grid-template-columns: 1fr } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="lib/dataSync.js"></script>
  <script>
    const SUPABASE_URL  = "https://dmbbsrcwqpmdxqtzvtqj.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYmJzcmN3cXBtZHhxdHp2dHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NDg1OTYsImV4cCI6MjA2MjMyNDU5Nn0.E7EYSLCFXMYw5f4Wv7EXXj7-5yAT__BoYXklDB4uE2w";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    function downloadCSV(filename, rows) {
      const csv = rows.map(r => Object.values(r).map(v => '"'+String(v).replaceAll('"','""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob); link.download = filename; link.click();
    }

    async function loadAnalytics() {
      const kpiTotalPoints = document.getElementById('kpiTotalPoints');
      const kpiAvgEngagement = document.getElementById('kpiAvgEngagement');
      const kpiTopTeam = document.getElementById('kpiTopTeam');
      const kpiTopBadge = document.getElementById('kpiTopBadge');

      // Load real data from Supabase
      const { data: employees } = await supabase.from('employees').select('team, points');
      const { data: scoreEvents } = await supabase.from('score_events').select('*');
      const { data: metrics } = await supabase.from('metrics').select('*');
      
      const total = (employees||[]).reduce((s,e)=>s+(e.points||0),0);
      kpiTotalPoints.textContent = total.toLocaleString();

      const byTeam = {};
      (employees||[]).forEach(e=>{ byTeam[e.team]= (byTeam[e.team]||0)+(e.points||0) });
      const topTeam = Object.entries(byTeam).sort((a,b)=>b[1]-a[1])[0];
      kpiTopTeam.textContent = topTeam? `${topTeam[0]} (${topTeam[1]} pts)` : '‚Äî';
      
      // Calculate average engagement
      const avgEngagement = employees?.length ? Math.round(total / employees.length) : 0;
      kpiAvgEngagement.textContent = avgEngagement;
      
      // Find most awarded badge
      const badgeCounts = {};
      (scoreEvents||[]).forEach(event => {
        if (event.metric_name?.includes('Badge')) {
          badgeCounts[event.metric_name] = (badgeCounts[event.metric_name] || 0) + 1;
        }
      });
      const topBadge = Object.keys(badgeCounts).reduce((a, b) => badgeCounts[a] > badgeCounts[b] ? a : b, 'Sales Champion');
      kpiTopBadge.textContent = topBadge;
      
      // Load integration metrics
      await loadIntegrationMetrics(metrics);

      // Simple bar data text (placeholder for charts)
      const bars = document.getElementById('barTeams');
      bars.innerHTML = Object.entries(byTeam).map(([team,pts])=>`<div class="card"><div>${team}</div><div class="muted">${pts} pts</div><div style="height:6px;background:#1e293b;border-radius:4px"><div style="height:6px;width:${Math.min(100, pts/ (total||1)*100)}%;background:#22c55e;border-radius:4px"></div></div></div>`).join('');

      // Coaching suggestions
      const coach = document.getElementById('coaching');
      const avg = employees && employees.length ? Math.round(total/employees.length) : 0;
      const underperformers = (employees||[]).filter(e => (e.points||0) < avg * 0.6).slice(0,5);
      coach.innerHTML = underperformers.length ? underperformers.map(e => `<div class=\"card\"><div>${e.team || 'Team'} member below pace</div><div class=\"muted\">${e.points||0} pts (avg ${avg})</div></div>`).join('') : '<div class="card">All teams trending well üéâ</div>';

      // Bind export buttons
      document.getElementById('btnExportCsv').onclick = () => {
        const rows = Object.entries(byTeam).map(([team,pts])=>({ team, points: pts }));
        downloadCSV('points_by_team.csv', [{ team:'Team', points:'Points' }, ...rows]);
      };
      document.getElementById('btnExportPdf').onclick = () => {
        window.print();
      };
    }
    async function loadIntegrationMetrics(metrics) {
      const integrationMetrics = metrics?.filter(m => m.source && m.source !== 'manual') || [];
      
      if (integrationMetrics.length > 0) {
        const container = document.getElementById('integrationMetrics');
        if (container) {
          container.innerHTML = `
            <h3 style="margin-bottom:12px;">Integration Data</h3>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
              ${integrationMetrics.map(metric => `
                <div class="card">
                  <div style="font-size:11px; color:var(--muted); text-transform:uppercase;">${metric.source}</div>
                  <div class="kpi">${metric.value} ${metric.unit || ''}</div>
                  <div class="muted">${metric.name}</div>
                  <div style="font-size:11px; color:var(--accent);">Target: ${metric.target || 'N/A'}</div>
                </div>
              `).join('')}
            </div>
          `;
        }
      }
    }

    document.addEventListener('DOMContentLoaded', loadAnalytics);
  </script>
</head>
<body>
  <header>
    <div class="bar">
      <h1 style="margin:0; font-size:18px;">üìà Analytics</h1>
      <div style="flex:1"></div>
      <button class="btn" style="padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0b1932;color:#fff;cursor:pointer;font-size:12px" onclick="window.location.href='business-home.html'">‚Üê Manager Hub</button>
    </div>
  </header>
  <div class="wrap">
    <div class="grid">
      <div class="card"><div class="muted">Total Points</div><div id="kpiTotalPoints" class="kpi">‚Äî</div></div>
      <div class="card"><div class="muted">Average Engagement</div><div id="kpiAvgEngagement" class="kpi">‚Äî</div></div>
      <div class="card"><div class="muted">Top Team</div><div id="kpiTopTeam" class="kpi">‚Äî</div></div>
      <div class="card"><div class="muted">Most Awarded Badge</div><div id="kpiTopBadge" class="kpi">‚Äî</div></div>
    </div>
    <div style="display:flex; gap:8px; margin:12px 0;">
      <button id="btnExportCsv" class="btn" style="padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0b1932;color:#fff;cursor:pointer;font-size:12px">Export CSV</button>
      <button id="btnExportPdf" class="btn" style="padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0b1932;color:#fff;cursor:pointer;font-size:12px">Export PDF</button>
    </div>
    <h3 style="margin:16px 0">Points by Team</h3>
    <div id="barTeams" class="grid"></div>
    <h3 style="margin:16px 0">Coaching Suggestions</h3>
    <div id="coaching" class="grid"></div>
    <div id="integrationMetrics" style="margin-top:24px;"></div>
  </div>
</body>
</html>

