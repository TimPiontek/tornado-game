<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tornado Business – Home</title>
  <style>
    :root { --bg:#0f172a; --panel:#0b1220; --border:#1f2a44; --text:#e5e7eb; --muted:#9aa3b2; --accent:#22d3ee; }
    * { box-sizing: border-box }
    body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position:sticky; top:0; z-index:2; background:#0d1628cc; backdrop-filter: blur(6px); border-bottom:1px solid var(--border); }
    .bar { display:flex; gap:8px; align-items:center; padding:12px 16px }
    .wrap { max-width:1100px; margin:0 auto; padding:16px }
    .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; justify-items:center; }
    .grid .tile { width:100%; max-width:240px; }
    .tile { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px; cursor:pointer; text-decoration:none; color:var(--text); transition: transform .12s ease, border-color .12s ease }
    .tile:hover { transform: translateY(-2px); border-color:#334155 }
    .tile h3 { margin:8px 0 6px; font-size:16px }
    .tile p { margin:0; color:var(--muted); font-size:13px; line-height:1.4 }
    .tile.featured { background:linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-color:#60a5fa; }
    .tile.featured:hover { border-color:#93c5fd; transform: translateY(-4px); }
    .tile.featured h3 { font-size:18px; color:#fff; }
    .tile.featured p { color:#e0e7ff; }
    .pill { padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:var(--panel); color:var(--text); cursor:pointer; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL  = "https://dmbbsrcwqpmdxqtzvtqj.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYmJzcmN3cXBtZHhxdHp2dHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NDg1OTYsImV4cCI6MjA2MjMyNDU5Nn0.E7EYSLCFXMYw5f4Wv7EXXj7-5yAT__BoYXklDB4uE2w";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    function go(path) { window.location.href = path; }
    
    function showAnnouncementsPopup() {
      const modal = document.getElementById('announcementsModal');
      modal.style.display = 'block';
    }
    
    function hideAnnouncementsPopup() {
      const modal = document.getElementById('announcementsModal');
      modal.style.display = 'none';
    }
    
    async function postAnnouncement() {
      const title = document.getElementById('announcementTitle').value;
      const content = document.getElementById('announcementContent').value;
      
      if (!title || !content) {
        alert('Please fill in both title and content');
        return;
      }
      
      try {
        await supabase.from('announcements').insert({
          title,
          content,
          created_at: new Date().toISOString(),
          author: 'Manager'
        });
        
        alert('Announcement posted successfully!');
        hideAnnouncementsPopup();
        document.getElementById('announcementTitle').value = '';
        document.getElementById('announcementContent').value = '';
      } catch (error) {
        console.error('Post announcement error:', error);
        alert('Failed to post announcement: ' + error.message);
      }
    }
    
    function showLeaderboardPopup() {
      const modal = document.getElementById('leaderboardModal');
      modal.style.display = 'block';
      loadLeaderboard();
    }
    
    function hideLeaderboardPopup() {
      const modal = document.getElementById('leaderboardModal');
      modal.style.display = 'none';
    }
    
    async function loadLeaderboard() {
      try {
        const { data: employees } = await supabase.from('employees').select('*').order('points', { ascending: false });
        const container = document.getElementById('leaderboardContent');
        
        if (!employees?.length) {
          container.innerHTML = '<div style="text-align:center; color:var(--muted);">No employees found</div>';
          return;
        }
        
        const html = employees.map((emp, index) => `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid var(--border);">
            <div style="display:flex; align-items:center; gap:12px;">
              <div style="font-weight:600; color:var(--accent);">#${index + 1}</div>
              <div>
                <div style="font-weight:600;">${emp.name}</div>
                <div style="font-size:12px; color:var(--muted);">${emp.team || 'Individual'}</div>
              </div>
            </div>
            <div style="font-weight:600; color:#22c55e;">${emp.points || 0} pts</div>
          </div>
        `).join('');
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Load leaderboard error:', error);
        document.getElementById('leaderboardContent').innerHTML = '<div style="text-align:center; color:var(--muted);">Failed to load leaderboard</div>';
      }
    }
    
    function showMetricsPopup() {
      const modal = document.getElementById('metricsModal');
      modal.style.display = 'block';
      loadMetrics();
    }
    
    function hideMetricsPopup() {
      const modal = document.getElementById('metricsModal');
      modal.style.display = 'none';
    }
    
    async function loadMetrics() {
      try {
        const { data: metrics } = await supabase.from('metrics').select('*');
        const container = document.getElementById('metricsContent');
        
        if (!metrics?.length) {
          container.innerHTML = '<div style="text-align:center; color:var(--muted);">No metrics found</div>';
          return;
        }
        
        const html = metrics.map(metric => `
          <div style="border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <input type="text" value="${metric.name}" style="background:#081125; border:1px solid var(--border); border-radius:4px; padding:4px 8px; color:#e5e7eb; flex:1; margin-right:8px;" onchange="updateMetricName('${metric.id}', this.value)">
              <button onclick="deleteMetric('${metric.id}')" style="background:#dc2626; color:#fff; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">Delete</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
              <div>
                <label style="font-size:12px; color:var(--muted);">Current Value</label>
                <input type="number" value="${metric.value || 0}" style="width:100%; background:#081125; border:1px solid var(--border); border-radius:4px; padding:4px 8px; color:#e5e7eb;" onchange="updateMetricValue('${metric.id}', this.value)">
              </div>
              <div>
                <label style="font-size:12px; color:var(--muted);">Target</label>
                <input type="number" value="${metric.target || 0}" style="width:100%; background:#081125; border:1px solid var(--border); border-radius:4px; padding:4px 8px; color:#e5e7eb;" onchange="updateMetricTarget('${metric.id}', this.value)">
              </div>
            </div>
            <div style="margin-top:8px;">
              <label style="font-size:12px; color:var(--muted);">Unit</label>
              <input type="text" value="${metric.unit || ''}" placeholder="e.g., deals, hours, %" style="width:100%; background:#081125; border:1px solid var(--border); border-radius:4px; padding:4px 8px; color:#e5e7eb;" onchange="updateMetricUnit('${metric.id}', this.value)">
            </div>
          </div>
        `).join('');
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Load metrics error:', error);
        document.getElementById('metricsContent').innerHTML = '<div style="text-align:center; color:var(--muted);">Failed to load metrics</div>';
      }
    }
    
    async function updateMetricName(id, name) {
      try {
        await supabase.from('metrics').update({ name }).eq('id', id);
      } catch (error) {
        console.error('Update metric name error:', error);
      }
    }
    
    async function updateMetricValue(id, value) {
      try {
        await supabase.from('metrics').update({ value: parseFloat(value) }).eq('id', id);
      } catch (error) {
        console.error('Update metric value error:', error);
      }
    }
    
    async function updateMetricTarget(id, target) {
      try {
        await supabase.from('metrics').update({ target: parseFloat(target) }).eq('id', id);
      } catch (error) {
        console.error('Update metric target error:', error);
      }
    }
    
    async function updateMetricUnit(id, unit) {
      try {
        await supabase.from('metrics').update({ unit }).eq('id', id);
      } catch (error) {
        console.error('Update metric unit error:', error);
      }
    }
    
    async function deleteMetric(id) {
      if (!confirm('Are you sure you want to delete this metric?')) return;
      
      try {
        await supabase.from('metrics').delete().eq('id', id);
        loadMetrics();
      } catch (error) {
        console.error('Delete metric error:', error);
        alert('Failed to delete metric');
      }
    }
    
    async function addNewMetric() {
      const name = prompt('Enter metric name:');
      if (!name) return;
      
      try {
        await supabase.from('metrics').insert({
          name,
          value: 0,
          target: 100,
          unit: '',
          source: 'manual'
        });
        loadMetrics();
      } catch (error) {
        console.error('Add metric error:', error);
        alert('Failed to add metric');
      }
    }
  </script>
</head>
<body>
  <header>
    <div class="bar">
      <h1 style="margin:0; font-size:18px;">🏢 Tornado Business – Manager Hub</h1>
      <div style="flex:1"></div>
      <button class="pill" onclick="window.location.href='employee-login.html'">👤 Employee Portal</button>
      <button class="pill" onclick="window.location.href='/'">← Back to Home</button>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="tile" onclick="showLeaderboardPopup()">
        <div>📊</div>
        <h3>Leaderboard</h3>
        <p>See teams and employees ranked by points and progress.</p>
      </div>
      <div class="tile" onclick="showMetricsPopup()">
        <div>📈</div>
        <h3>Metrics</h3>
        <p>Track sales, products, satisfaction, features and more.</p>
      </div>
      <a class="tile" href="/teacher-assignments.html">
        <div>📝</div>
        <h3>Assignments</h3>
        <p>Create, edit and assign quizzes or tasks to employees.</p>
      </a>
      <div class="tile" onclick="showAnnouncementsPopup()">
        <div>📣</div>
        <h3>Announcements & Recognition</h3>
        <p>Post updates, recognize achievements and notify your teams.</p>
      </div>
      <a class="tile" href="/business-integrations.html">
        <div>🔌</div>
        <h3>Integrations</h3>
        <p>Connect Slack/Teams, Sheets, Salesforce, HubSpot (stubs).</p>
      </a>
      <a class="tile" href="/business-analytics.html">
        <div>📈</div>
        <h3>Analytics</h3>
        <p>KPI cards and simple charts from cloud data.</p>
      </a>
      <a class="tile" href="/business-roster.html">
        <div>👥</div>
        <h3>Roster</h3>
        <p>Manage employees, create teams, and track individual progress.</p>
      </a>
      <a class="tile" href="/business-attribution.html">
        <div>🎯</div>
        <h3>Data Attribution</h3>
        <p>Assign external data to teams/individuals and award/deduct points.</p>
      </a>
      <a class="tile" href="/rules.html">
        <div>⚙️</div>
        <h3>Rules & Automation</h3>
        <p>Define triggers to auto-award points and notify.</p>
      </a>
      <a class="tile featured" href="/war.html?scenario=businessMode">
        <div>🗺️</div>
        <h3>Tornado Business War</h3>
        <p>Open the strategy map to run live competitions and battles between teams.</p>
      </a>
      <a class="tile" href="/quiz.html?mode=business">
        <div>🧩</div>
        <h3>Tornado Quiz</h3>
        <p>Launch a quiz and award points for correct answers.</p>
      </a>
      
    </div>
  </div>

  <!-- Announcements Modal -->
  <div id="announcementsModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:24px; width:500px; max-width:90vw; box-shadow:0 20px 40px rgba(0,0,0,0.3);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="margin:0; font-size:18px;">📣 New Announcement</h2>
        <button onclick="hideAnnouncementsPopup()" style="background:none; border:none; color:var(--muted); cursor:pointer; font-size:20px;">×</button>
      </div>
      <input id="announcementTitle" placeholder="Title" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; background:#081125; color:#e5e7eb; margin-bottom:12px;">
      <textarea id="announcementContent" placeholder="Write your announcement..." style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; background:#081125; color:#e5e7eb; height:120px; resize:vertical; margin-bottom:16px;"></textarea>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button onclick="hideAnnouncementsPopup()" style="padding:8px 16px; border:1px solid var(--border); border-radius:8px; background:var(--panel); color:var(--text); cursor:pointer;">Cancel</button>
        <button onclick="postAnnouncement()" style="padding:8px 16px; border:none; border-radius:8px; background:#3b82f6; color:#fff; cursor:pointer;">Post</button>
      </div>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <div id="leaderboardModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:24px; width:600px; max-width:90vw; max-height:80vh; overflow-y:auto; box-shadow:0 20px 40px rgba(0,0,0,0.3);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="margin:0; font-size:18px;">📊 Leaderboard</h2>
        <button onclick="hideLeaderboardPopup()" style="background:none; border:none; color:var(--muted); cursor:pointer; font-size:20px;">×</button>
      </div>
      <div id="leaderboardContent"></div>
    </div>
  </div>

  <!-- Metrics Modal -->
  <div id="metricsModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <div style="background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:24px; width:700px; max-width:90vw; max-height:80vh; overflow-y:auto; box-shadow:0 20px 40px rgba(0,0,0,0.3);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="margin:0; font-size:18px;">📈 Edit Metrics</h2>
        <div style="display:flex; gap:8px;">
          <button onclick="addNewMetric()" style="padding:6px 12px; border:1px solid var(--border); border-radius:6px; background:var(--panel); color:var(--text); cursor:pointer; font-size:12px;">+ Add Metric</button>
          <button onclick="hideMetricsPopup()" style="background:none; border:none; color:var(--muted); cursor:pointer; font-size:20px;">×</button>
        </div>
      </div>
      <div id="metricsContent"></div>
    </div>
  </div>
</body>
</html>

