<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Title & SEO -->
  <title>Play Tornado</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A fun quiz game to play in classrooms or with friends">
  <meta property="og:description" content="A fun quiz game to play in classrooms or with friends">
  <meta name="twitter:description" content="A fun quiz game to play in classrooms or with friends">
  <meta name="keywords"
        content="ESL game, classroom trivia, online quiz, educational game, team quiz, interactive quiz, quiz maker, web quiz, trivia game, Q&A, browser quiz" />

  <!-- Schema.org markup -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Play Tornado: Classroom Game & Trivia Platform",
    "url": "https://playtornado.com/",
    "description": "A versatile online quiz game ideal for ESL classrooms, study groups, and trivia nights, featuring Q&A support, team play, and interactive rewards.",
    "applicationCategory": "EducationalGame",
    "operatingSystem": "Web",
    "creator": { "@type": "Person", "name": "Timothy Piontek" }
  }
  </script>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* Base & Typography */
    html { font-size: 18px; }
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Lexend Deca', sans-serif;
      line-height: 1.5;
      background: #31727A;
      color: #333;
      text-align: center;
    }
    h1 { font-size: 2.5rem; margin: .5em 0 .2em; }
    h2 { font-size: 1.5rem; margin: .2em 0 1em; color: #555; }
    h3 { font-size: 1.25rem; margin: .5em 0 .5em; }
    p, label, button, select, input, textarea { font-size: 1rem; }

    :root {
      --teamA: #e57373;
      --teamB: #3498db;
      --btn-bg: #add8e6;
      --btn-hover: #87ceeb;
    }
    .hidden { display: none; }

    /* SETUP */
    #setupScreen {
      max-width: 900px;
      margin: 0 auto;
      text-align: left;
      margin-top: 0.5rem;
    }
    #setupScreen p { margin-bottom: 15px; }
    #setupForm label { display: block; margin: 10px 0; }
    #setupForm input,
    #setupForm select,
    #setupForm textarea {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
    #setupForm textarea { height: 120px; resize: vertical; }

    /* inline radio group */
    .inline-radio {
      display: inline-flex;
      align-items: center;
      gap: 1rem;
      margin: 1rem 0;
    }
    .inline-radio span { font-weight: 600; }

    #setupForm button {
      margin-top: 15px;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 600;
    }

    /* GAME */
    #gameScreen {
      max-width: 900px;
      margin: auto;
    }
    #grid {
      display: grid;
      gap: 10px;
      margin-bottom: 60px;
      width: 100%;
      height: 100%;
      justify-items: stretch;
      align-items: stretch;
    }
    #grid button, #grid button > * {
      font-size: clamp(2rem, 4vw, 3.2rem) !important;
      line-height: 1;
      max-width: 100%;
      max-height: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      word-break: break-all;
      text-align: center;
    }
    #grid button:empty::before {
      content: '\200b';
    }
    #grid button:hover { background: var(--btn-hover); }
    #grid button:disabled {
      background: #ccc;
      cursor: not-allowed;
      font-size: 1.2em !important;
      transform: none !important;
    }

    #resetBtn {
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
    }
    .footer {
      font-size: 0.8em;
      color: #fff;
      margin-top: 30px;
    }

    /* Animations */
    @keyframes tornado {
      0% { transform: rotate(0deg) scale(1) translate(0, 0); }
      20% { transform: rotate(180deg) scale(1.5) translate(-100px, -50px); }
      40% { transform: rotate(360deg) scale(2) translate(100px, -100px); }
      60% { transform: rotate(540deg) scale(1.8) translate(-50px, 50px); }
      80% { transform: rotate(720deg) scale(1.3) translate(50px, 0); }
      100% { transform: rotate(1080deg) scale(1) translate(0, 0); }
    }
    @keyframes double {
      0% { transform: scale(1) rotate(0deg); }
      20% { transform: scale(1.4) rotate(-10deg); }
      40% { transform: scale(1.8) rotate(10deg); }
      60% { transform: scale(1.6) rotate(-5deg); }
      80% { transform: scale(1.2) rotate(5deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    @keyframes sad {
      0% { transform: translateY(0) rotate(0deg); }
      20% { transform: translateY(-30px) rotate(-15deg); }
      40% { transform: translateY(0) rotate(0deg); }
      60% { transform: translateY(-20px) rotate(15deg); }
      80% { transform: translateY(-10px) rotate(-5deg); }
      100% { transform: translateY(0) rotate(0deg); }
    }
    @keyframes kangaroo {
      0% { transform: translateY(0) rotate(0deg); }
      20% { transform: translateY(-60px) rotate(-20deg); }
      40% { transform: translateY(0) rotate(0deg); }
      60% { transform: translateY(-40px) rotate(20deg); }
      80% { transform: translateY(-20px) rotate(-10deg); }
      100% { transform: translateY(0) rotate(0deg); }
    }
    @keyframes pointsReveal {
      0% { transform: perspective(1000px) rotateX(0deg) scale(0.5) translateY(20px); opacity: 0; }
      20% { transform: perspective(1000px) rotateX(20deg) scale(1.4) translateY(-20px); opacity: 1; }
      40% { transform: perspective(1000px) rotateX(-15deg) scale(1.2) translateY(10px); }
      60% { transform: perspective(1000px) rotateX(10deg) scale(1.3) translateY(-5px); }
      80% { transform: perspective(1000px) rotateX(-5deg) scale(1.1) translateY(2px); }
      100% { transform: perspective(1000px) rotateX(0deg) scale(1) translateY(0); }
    }
    @keyframes pointsTextGlow {
      0% { text-shadow: 0 0 20px rgba(255,255,255,0.8); }
      100% { text-shadow: 0 0 20px rgba(255,255,255,0.8); }
    }
    @keyframes specialPopup3D {
      0% { transform: perspective(1000px) rotateX(0deg) scale(0.5); opacity: 0; }
      20% { transform: perspective(1000px) rotateX(30deg) scale(1.4); opacity: 1; }
      40% { transform: perspective(1000px) rotateX(-20deg) scale(1.3); }
      60% { transform: perspective(1000px) rotateX(15deg) scale(1.4); }
      80% { transform: perspective(1000px) rotateX(-5deg) scale(1.2); }
      100% { transform: perspective(1000px) rotateX(0deg) scale(1); }
    }
    .tornado-animation { animation: tornado 2s cubic-bezier(.68,-0.55,.27,1.55); }
    .double-animation { animation: double 1.5s cubic-bezier(.68,-0.55,.27,1.55); }
    .sad-animation { animation: sad 1.5s cubic-bezier(.68,-0.55,.27,1.55); }
    .kangaroo-animation { animation: kangaroo 1.5s cubic-bezier(.68,-0.55,.27,1.55); }
    .points-reveal-animation { animation: pointsReveal 2.2s cubic-bezier(.68,-0.55,.27,1.55); }
    .points-text-glow { animation: pointsTextGlow 2s ease-in-out infinite; }
    .special-popup-3d { animation: specialPopup3D 2.2s cubic-bezier(.68,-0.55,.27,1.55); }

    .special-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(111,92,145,0.95);
      color: #fff;
      font-size: 2.5rem;
      font-weight: 900;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      padding: 2rem 3rem;
      z-index: 1000;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 90vw;
    }
    .special-popup.show {
      opacity: 1;
    }
    .special-popup .emoji {
      font-size: 4rem;
      margin-bottom: 1rem;
      display: block;
    }
    .special-popup .slogan {
      font-size: 1.8rem;
      line-height: 1.2;
      margin: 0;
    }

    /* Game Info */
    .game-info {
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 10px;
      margin: 20px auto;
      max-width: 600px;
      text-align: left;
      position: relative;
    }
    .how-to-play {
      margin-top: 0;
      padding-top: 0;
    }
    .how-title {
      font-weight: 900;
      font-size: 1.3rem;
      margin: 0 0 8px 0;
      text-align: center;
    }
    .how-body {
      margin: 0 0 8px 0;
      font-size: 1.08rem;
      text-align: center;
    }
    .special-items.compact {
      margin: 0;
      gap: 1.5rem;
      justify-content: space-around;
    }
    .special-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
      margin: 0 0 0 0;
    }
    .emoji-big {
      font-size: 2.2rem;
      line-height: 1;
      display: flex;
      align-items: center;
      height: 2.2rem;
    }
    .logo-start-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 2rem;
      margin-top: 2rem;
    }
    .logo-large {
      max-width: 200px;
      height: 200px;
    }
    .start-large, #startGameBtnBottom.compact-start-btn {
      font-size: 2.2rem;
      padding: 0.7rem 0;
      font-weight: 900;
      background: #6F5C91;
      color: #fff;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      display: block;
      width: 100%;
      min-width: 0;
      min-height: 60px;
      max-width: 100%;
      margin: 0 auto 1.2rem auto;
      height: auto;
    }
    .start-large:hover {
      background: #59487a;
      transform: scale(1.05);
    }
    .special-item-selectors {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .special-item-selectors label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.1rem;
      background: #f6f6f6;
      border-radius: 8px;
      padding: 0.4rem 0.8rem;
    }
    .special-item-selectors select {
      font-size: 1.1rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-left: 0.3rem;
    }
    .slogan {
      font-size: 1.15rem;
      font-weight: 700;
      margin-left: 0.5rem;
      color: #333;
      display: inline-block;
    }
    .special-popup {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.97);
      color: #222;
      font-size: 2.5rem;
      font-weight: 900;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      padding: 2rem 3rem;
      z-index: 1000;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .special-popup.show {
      opacity: 1;
      pointer-events: auto;
    }
    .score-animate {
      transition: transform 0.7s cubic-bezier(.68,-0.55,.27,1.55), color 0.7s;
    }
    .kangaroo-jump {
      animation: kangarooJump 0.7s;
    }
    @keyframes kangarooJump {
      0% { transform: translateY(0); }
      30% { transform: translateY(-40px) scale(1.2); }
      60% { transform: translateY(0) scale(1); }
      100% { transform: translateY(0); }
    }
    .lion-roar {
      animation: lionRoar 0.7s;
    }
    @keyframes lionRoar {
      0% { transform: scale(1); }
      20% { transform: scale(1.3) rotate(-5deg); }
      40% { transform: scale(1.1) rotate(5deg); }
      60% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .skunk-cloud {
      animation: skunkCloud 1s;
      color: #6e7f5c !important;
      opacity: 0.5;
    }
    @keyframes skunkCloud {
      0% { filter: blur(0); opacity: 1; }
      50% { filter: blur(2px); opacity: 0.7; }
      100% { filter: blur(6px); opacity: 0; }
    }
    .special-popup.tornado-mode {
      background: transparent;
      box-shadow: none;
      padding: 0;
      font-size: 3.5rem;
      color: #333;
      pointer-events: none;
    }
    .tornado-emoji-big {
      font-size: 7rem;
      animation: tornadoSpinBig 1.2s linear;
      display: block;
      margin: 0 auto;
      filter: drop-shadow(0 8px 32px rgba(0,0,0,0.18));
    }
    @keyframes tornadoSpinBig {
      0% { transform: scale(1) rotate(0deg); }
      40% { transform: scale(1.5) rotate(180deg); }
      70% { transform: scale(2.2) rotate(360deg); }
      100% { transform: scale(1) rotate(720deg); }
    }
    .tornado-text {
      font-size: 3rem;
      font-weight: 900;
      color: #6F5C91;
      letter-spacing: 0.2em;
      margin-top: 0.5rem;
      animation: tornadoTextScroll 1.2s cubic-bezier(.68,-0.55,.27,1.55);
      white-space: nowrap;
      overflow: hidden;
      text-shadow: 2px 2px 8px #fff, 0 0 8px #6F5C91;
    }
    @keyframes tornadoTextScroll {
      0% { transform: translateX(-120%); opacity: 0; }
      30% { opacity: 1; }
      60% { transform: translateX(10%); opacity: 1; }
      100% { transform: translateX(0); opacity: 0; }
    }
    .purple-btn {
      background: #6F5C91;
      color: #fff;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      padding: 12px 32px;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: background 0.2s, transform 0.2s;
    }
    .purple-btn:hover {
      background: #59487a;
      transform: scale(1.05);
    }
    .special-legend {
      margin-top: 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 1.1rem;
      text-align: left;
      align-items: flex-start;
      justify-content: center;
    }
    .compact-info {
      padding: 10px 10px 10px 10px;
      max-width: 480px;
    }
    .special-item-compact-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .special-item-compact {
      margin-bottom: 0.2rem;
    }
    .special-row {
      display: flex;
      align-items: center;
      gap: 0.7em;
      min-width: 320px;
    }
    .special-row select {
      font-size: 1.1rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-left: 0.3rem;
    }
    .special-desc {
      font-size: 0.98rem;
      color: #333;
      margin-left: 2.2rem;
      margin-top: 0.1rem;
      margin-bottom: 0.2rem;
    }
    .questions-block {
      margin: 1.2rem auto 0 auto;
      max-width: 480px;
      background: rgba(255,255,255,0.85);
      border-radius: 10px;
      padding: 1rem 1.2rem 0.5rem 1.2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    #questionsInput {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      height: 120px;
      font-family: inherit;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-bottom: 0.5rem;
    }
    .game-controls {
      display: flex;
      justify-content: center;
      gap: 1.2rem;
      margin-bottom: 0.7rem;
    }
    #questionAnswerRow {
      display: flex;
      justify-content: flex-start;
      align-items: flex-start;
      min-height: 90px;
      margin-bottom: 0.5rem;
      width: 100%;
    }
    .bubble-left, .bubble-right {
      max-width: 28vw;
      min-width: 180px;
      background: #fff;
      color: #222;
      border-radius: 18px;
      padding: 0.7rem 1rem 0.7rem 1rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 0.2rem;
      margin-top: 0.2rem;
      word-break: break-word;
      overflow-wrap: break-word;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-height: 40px;
    }
    .bubble-left {
      margin-left: 2vw;
      align-items: flex-start;
      border-top-left-radius: 0;
    }
    .bubble-right {
      margin-left: auto;
      margin-right: 2vw;
      align-items: flex-end;
      border-top-right-radius: 0;
    }
    #question {
      color: #6F5C91;
      font-size: 1.5em;
      font-weight: 900;
      text-align: left;
      margin-bottom: 0.3em;
      line-height: 1.2;
    }
    #answer {
      color: #31727A;
      font-size: 1.1em;
      font-style: italic;
      text-align: left;
      margin-top: 0.2em;
      line-height: 1.2;
    }
    @media (max-width: 900px) {
      .bubble-left, .bubble-right { max-width: 90vw; min-width: 0; font-size: 1.1rem; padding: 0.7rem 1rem; }
      #question { font-size: 1.1em; }
    }
    .scorebar-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.2rem;
      margin-bottom: 0.7rem;
      width: 100%;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
      padding: 0 20px;
    }
    .team-left, .team-right {
      flex: 0 0 220px;
      min-width: 180px;
      max-width: 260px;
    }
    .center-controls {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 0;
      max-width: 400px;
    }
    #turnDisplay {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.3rem;
    }
    .compact-controls {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      align-items: center;
    }
    .game-footer-btns { display: none; }
    #gameScreen:not(.hidden) .game-footer-btns { display: flex !important; }
    #resetBtn, #homeBtn {
      padding: 8px 16px;
      font-weight: 700;
      cursor: pointer;
      background: #6F5C91;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      transition: background 0.2s, transform 0.2s;
    }
    #resetBtn:hover, #homeBtn:hover {
      background: #59487a;
      transform: scale(1.05);
    }
    .setup-flex-row {
      display: flex;
      flex-direction: row;
      gap: 2.2rem;
      align-items: flex-start;
      justify-content: center;
      margin-bottom: 0.5rem;
      flex-wrap: nowrap;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    .game-info.compact-info {
      min-width: 320px;
      max-width: 420px;
      flex: 1 1 0;
    }
    .compact-setup-form {
      min-width: 180px;
      max-width: 220px;
      flex: 0 0 220px;
    }
    @media (max-width: 900px) {
      .setup-flex-row {
        flex-direction: column;
        gap: 1.2rem;
        align-items: center;
        max-width: 98vw;
      }
      .game-info.compact-info, .compact-setup-form {
        min-width: 0;
        max-width: 98vw;
        width: 100%;
      }
      #grid {
        gap: 6px;
        padding: 0 10px;
        max-height: 60vh;
        margin-bottom: 80px;
      }
      .game-footer-btns {
        margin-top: 2.2rem;
        margin-bottom: 2.2rem;
      }
    }
    .slightly-wider-questions-block {
      max-width: 270px;
      width: 100%;
      margin-top: 1.2rem;
      margin-bottom: 0;
      padding-left: 0;
      padding-right: 0;
    }
    .compact-questions-block {
      padding: 1.2rem 1.5rem 0.8rem 1.5rem;
    }
    .setup-form-and-questions {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 180px;
      max-width: 240px;
      flex: 0 0 240px;
    }
    @keyframes flip {
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(180deg); }
    }
    .flip {
      animation: flip 0.5s forwards;
    }
    /* Responsive design polish */
    @media (max-width: 700px) {
      .setup-flex-row {
        flex-direction: column;
        gap: 1.2rem;
        align-items: center;
        max-width: 98vw;
      }
      .game-info.compact-info, .compact-setup-form, .setup-form-and-questions, .slightly-wider-questions-block {
        min-width: 0;
        max-width: 98vw;
        width: 100%;
      }
      #grid {
        padding: 0 2vw;
        gap: 6px;
      }
      #grid button {
        font-size: 1.1em;
        padding: 14px;
        min-width: 44px;
        min-height: 44px;
      }
      .scorebar-row {
        flex-direction: column;
        gap: 0.7rem;
        max-width: 98vw;
      }
      .team-left, .team-right {
        min-width: 0;
        max-width: 98vw;
        width: 100%;
      }
      .center-controls {
        min-width: 0;
        width: 100%;
      }
      .game-controls.compact-controls {
        flex-direction: column;
        gap: 0.7rem;
      }
    }
    html, body {
      max-width: 100vw;
      overflow-x: hidden;
    }
    /* Make optgroup labels bold and black in quiz dropdown */
    select#quizSelect optgroup {
      color: #111;
      font-weight: bold;
      font-size: 1.05em;
    }
    #startGameBtnBottom.purple-btn {
      font-size: 2.2rem;
      padding: 0.7rem 2.5rem;
      font-weight: 900;
      border-radius: 12px;
      margin-top: 8px !important;
      margin-bottom: 1.2rem;
      min-width: 200px;
      min-height: 60px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .setup-grid-row {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: center;
      gap: 2.5rem;
      max-width: 1200px;
      margin: 0 auto;
      align-items: flex-end;
    }
    .how-to-play-sym {
      flex: 0 0 320px;
      min-width: 260px;
      max-width: 340px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100%;
      background: rgba(255,255,255,0.93);
      border-radius: 12px;
      padding: 18px 18px 18px 18px;
      box-shadow: 0 0 10px rgba(0,0,0,0.07);
      margin-top: 0;
    }
    .setup-main-grid {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      flex: 1 1 0;
      min-width: 400px;
      max-width: 600px;
      gap: 0.2rem;
      justify-content: flex-start;
    }
    .setup-row {
      display: flex;
      flex-direction: row;
      gap: 1.5rem;
      margin-bottom: 0.2rem;
    }
    .team-box, .quiz-box, .grid-box {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.07);
      padding: 10px 16px 10px 16px;
      flex: 1 1 0;
      min-width: 160px;
      max-width: 240px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      min-height: 80px;
      height: 80px;
      margin-bottom: 0.5rem;
    }
    .quiz-box, .grid-box {
      margin-top: 0;
    }
    .questions-block {
      margin-top: 1.2rem;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.07);
      padding: 1.2rem 1.5rem 0.8rem 1.5rem;
      max-width: 500px;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
    }
    #startGameBtnBottom.start-large {
      margin: 1.2rem auto 0.7rem auto;
      display: block;
      width: 80%;
      max-width: 420px;
      min-width: 220px;
      font-size: 2.2rem;
      padding: 1.1rem 0;
    }
    @media (max-width: 900px) {
      .setup-grid-row {
        flex-direction: column;
        align-items: center;
        gap: 1.2rem;
        max-width: 98vw;
      }
      .how-to-play-sym, .setup-main-grid {
        min-width: 0;
        max-width: 98vw;
        width: 100%;
      }
      .setup-row {
        flex-direction: column;
        gap: 0.7rem;
      }
      .team-box, .quiz-box, .grid-box {
        min-width: 0;
        max-width: 98vw;
        width: 100%;
      }
      .questions-block {
        max-width: 98vw;
      }
      #startGameBtnBottom.start-large {
        width: 100%;
        min-width: 0;
        max-width: 98vw;
      }
    }
    /* Make quiz/grid/start button the same width */
    .quiz-box, .grid-box, #startGameBtnBottom.compact-start-btn {
      max-width: 240px;
      width: 100%;
      margin-left: 0;
      margin-right: 0;
    }
    /* Align Q&A and How to Play boxes at the bottom */
    .setup-grid-row {
      align-items: stretch;
    }
    .align-bottom {
      margin-top: 0.5rem;
      margin-bottom: 0;
      align-self: flex-end;
    }
    .team-box label[for^="singlePlayerCheckbox"], .team-box label:has(#singlePlayerCheckbox) {
      margin-bottom: 0.2em;
      margin-top: 0.2em;
      align-items: center;
      display: flex;
    }
    #singlePlayerCheckbox {
      margin-top: 0.1em;
      margin-bottom: 0.1em;
      vertical-align: middle;
    }
    .quiz-box select, .grid-box select {
      margin-top: 8px !important;
      margin-bottom: 0;
      display: block;
      vertical-align: middle;
    }
    .quiz-box label, .grid-box label {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .team-b-name-container {
      display: flex;
      align-items: center;
      gap: 0.5em;
      justify-content: center;
    }
    .team-b-name-container.single-player {
      justify-content: flex-start;
    }
    /* Custom quiz dropdown */
    .custom-quiz-dropdown-container { position: relative; width: 100%; max-width: none; margin: 0; }
    .custom-quiz-dropdown { background: #fff; border-radius: 8px; border: 1px solid #ccc; padding: 0.7em 1em; cursor: pointer; min-height: 2.2em; font-size: 1.1em; text-align: left; position: relative; width: 100%; box-sizing: border-box; display: flex; align-items: center; justify-content: flex-start; }
    .custom-quiz-dropdown-list { position: absolute; top: 100%; left: 0; width: 100%; min-width: 0; max-width: none; background: #fff; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); z-index: 100; max-height: 320px; overflow-y: auto; margin-top: 4px; box-sizing: border-box; }
    .custom-quiz-category, .custom-quiz-folder { font-weight: 700; font-size: 1.08em; cursor: pointer; background: #eee; padding: 0.5em 1em; border-radius: 6px; margin-bottom: 0.3em; display: flex; align-items: center; justify-content: space-between; }
    .custom-quiz-category.open, .custom-quiz-folder.open { background: #d6d6f6; }
    .custom-quiz-category-arrow, .custom-quiz-folder-arrow { margin-left: 0.7em; font-size: 0.9em; transition: transform 0.2s; }
    .custom-quiz-category.open .custom-quiz-category-arrow, .custom-quiz-folder.open .custom-quiz-folder-arrow { transform: rotate(90deg); }
    .custom-quiz-quizlist, .custom-quiz-folderlist { list-style: none; padding-left: 1.2em; margin: 0 0 0.5em 0; }
    .custom-quiz-quizlist li, .custom-quiz-folderlist li { margin-bottom: 0.4em; cursor: pointer; padding: 0.2em 0.5em; border-radius: 4px; white-space: normal; word-break: break-word; background: none; }
    .custom-quiz-quizlist li.selected, .custom-quiz-quizlist li:hover, .custom-quiz-folderlist li.selected, .custom-quiz-folderlist li:hover { background: #e6e6fa; }
    /* Add styles for the unified card and grid */
    .setup-unified-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.10);
      padding: 2.2em 2.5em 1.5em 2.5em;
      margin-bottom: 1.5em;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    .setup-unified-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto auto;
      gap: 1.2em 2.2em;
      align-items: flex-start;
    }
    .setup-unified-cell { min-width: 0; width: 100%; }
    .setup-unified-cell.full-width { grid-column: 1 / span 2; }
    @media (max-width: 700px) {
      .setup-unified-card { padding: 1.2em 0.7em 1em 0.7em; }
      .setup-unified-grid { grid-template-columns: 1fr; grid-template-rows: none; gap: 1.2em 0; }
      .setup-unified-cell.full-width { grid-column: 1 / span 1; }
    }
    .game-footer-btns button {
      position: relative;
      font-size: 1.2rem;
      padding: 0.7em 2em;
      font-weight: 700;
      border-radius: 12px;
      background: #6F5C91;
      color: #fff;
      border: none;
      cursor: pointer;
      margin: 0 0.5em;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .game-footer-btns button span.emoji {
      font-size: 2.1em;
      line-height: 1;
      display: inline-block;
      vertical-align: middle;
    }
    .game-footer-btns div[style*='font-size: 1rem'] {
      margin-top: 0.5rem;
    }
    @media (max-width: 900px) {
      #gameScreen {
        min-height: 100vh;
      }
      #grid {
        margin-bottom: 0;
      }
      .game-footer-btns {
        padding: 1.2rem 0 1.2rem 0;
      }
    }
    .team {
      background: white;
      padding: 10px 20px;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      min-width: 150px;
      max-width: 220px;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #nameA {
      color: var(--teamA);
      font-size: 2.5rem;
      font-weight: 700;
      margin: 5px 0 0;
    }
    #nameB {
      color: var(--teamB);
      font-size: 2.5rem;
      font-weight: 700;
      margin: 5px 0 0;
    }
    .team p {
      font-size: 2em;
      margin: 5px 0 0;
    }
    .team, .team h2, .team p, .announcement, #turnDisplay {
      font-family: 'Lexend Deca', sans-serif !important;
    }
  </style>
</head>
<body>
  <!-- NAVIGATION BAR -->
  <nav id="mainNav" style="background: #6F5C91; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 2rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.07);">
    <div id="logoTitleHome" style="display: flex; align-items: center; gap: 1rem; cursor:pointer;">
      <img src="tornado-logo.png" alt="PlayTornado Logo" style="height: 64px; width: 64px; border-radius: 8px; background: #fff; padding: 2px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);">
      <span style="font-size: 2rem; font-weight: 900; letter-spacing: 1px; color: #fff;">Play Tornado</span>
    </div>
    <div style="display: flex; align-items: center; gap: 2.2rem; font-size: 1.1rem; font-weight: 600;">
      <a href="/" style="color: #fff; text-decoration: none; padding: 0.3em 0.7em; border-radius: 6px; transition: background 0.2s;">Home</a>
      <a href="#" id="myLibraryLink" style="color: #fff; text-decoration: none; padding: 0.3em 0.7em; border-radius: 6px; transition: background 0.2s;">My Library</a>
      <a href="#" id="publicLibraryLink" style="color: #fff; text-decoration: none; padding: 0.3em 0.7em; border-radius: 6px; transition: background 0.2s;">Play Tornado Library</a>
      <button id="loginLogoutBtn" style="background: #fff; color: #6F5C91; border: none; border-radius: 6px; padding: 0.3em 1.1em; font-weight: 700; cursor: pointer; font-size: 1.1rem; transition: background 0.2s, color 0.2s;">Login</button>
    </div>
  </nav>
  <!-- END NAVIGATION BAR -->

  <!-- SETUP SCREEN -->
  <div id="setupScreen" style="position: relative;">
    <!-- Removed the large logo image from here -->
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 80vh; margin-top: 0;">
      <div class="setup-grid-row" style="margin-top: 2.5rem;">
        <div class="setup-main-grid">
          <form id="setupForm" onsubmit="return false;">
            <div class="setup-unified-card">
              <div class="setup-unified-grid">
                <div class="setup-unified-cell">
                  <label style="display: block; margin-bottom: 0.3em;">Team A Name:
                    <input id="teamANameInput" value="Team A" required maxlength="16" style="display: block; width: 100%; margin-bottom: 0.3em;">
                  </label>
                </div>
                <div class="setup-unified-cell">
                  <label style="display: block; margin-bottom: 0.3em;">Team B Name:
                    <input id="teamBNameInput" value="Team B" required maxlength="16" style="display: block; width: 100%;">
                  </label>
                </div>
                <div class="setup-unified-cell">
                  <label style="display: flex; align-items: center; gap: 0.5em; margin-bottom: 0.1em;">
                    <input type="checkbox" id="singlePlayerCheckbox" style="margin-right: 0.5em;"> <span style="white-space: nowrap;">Single Player</span>
                  </label>
                </div>
                <div class="setup-unified-cell">
                  <label>Grid Size:
                    <select id="gridSizeInput">
                      <option>8</option><option>10</option><option>16</option>
                      <option selected>18</option><option>20</option><option>24</option>
                      <option>30</option><option>32</option><option>40</option>
                    </select>
                  </label>
                </div>
                <div class="setup-unified-cell full-width">
                  <label>Choose a Quiz:
                    <div class="custom-quiz-dropdown-container" style="width:100%;">
                      <div id="customQuizDropdown" class="custom-quiz-dropdown">--</div>
                    </div>
                  </label>
                </div>
              </div>
            </div>
            <!-- Start Game button is now outside the card -->
          </form>
          <button id="startGameBtnBottom" class="purple-btn start-large compact-start-btn" style="margin:1.2em auto 0 auto;display:block;">Start Game</button>
          <div class="questions-block compact-questions-block slightly-wider-questions-block align-bottom">
            <label>
              Q&A:
              <small>Enter questions (and answers). One per line, or blank line between Q & A.</small>
              <textarea id="questionsInput"
                placeholder="What city is home to Fenway Park?
Boston

Which band wrote the song 'Hey Jude'?
The Beatles"></textarea>
            </label>
            <div class="inline-radio">
              <span>Order:</span>
              <label><input type="radio" name="order" value="inorder" checked> In order</label>
              <label><input type="radio" name="order" value="random"> Random</label>
            </div>
          </div>
        </div>
        <div class="how-to-play-sym">
          <div class="how-to-play">
            <p class="how-title">How to Play:</p>
            <p class="how-body">
              Play with or without questions!<br>
              - Choose a premade quiz or paste your own Q&A.<br>
              - Ask a question; when a team answers correctly, they pick a number to reveal points or a surprise.<br>
              - First team to the most points wins!
            </p>
          </div>
          <div class="special-item-compact-list" style="display: flex; flex-direction: column; gap: 0.2rem; align-items: flex-start;">
            <div class="special-item-compact" style="width: 100%;">
              <div class="special-row" style="display: flex; align-items: center; gap: 0.7em; min-width: 320px;">
                <span class="emoji-big" style="width: 48px; display: inline-flex; justify-content: center;">üå™Ô∏è</span>
                <b style="min-width: 90px; max-width: 120px; font-size: 1.05em; display: flex; flex-direction: column; justify-content: center; text-align: left;">Tornado</b>
                <select id="tornadoCount" style="width: 2.5em; min-width: 2.5em; max-width: 2.5em; text-align: center;"> <option>0</option><option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option></select>
                <span class="special-desc" style="margin-left: 0.5em; font-size: 0.98em; display: block;">Steal points</span>
              </div>
            </div>
            <div class="special-item-compact" style="width: 100%;">
              <div class="special-row" style="display: flex; align-items: center; gap: 0.7em; min-width: 320px;">
                <span class="emoji-big" style="width: 48px; display: inline-flex; justify-content: center;">ü¶Åü¶Å</span>
                <b style="min-width: 90px; max-width: 120px; font-size: 1.05em; display: flex; flex-direction: column; justify-content: center; text-align: left; line-height: 1.1; margin: 0; padding: 0;">
                  <span style="margin: 0; padding: 0;">Double</span><span style="margin: 0; padding: 0;">Lion</span>
                </b>
                <select id="doubleCount" style="width: 2.5em; min-width: 2.5em; max-width: 2.5em; text-align: center;"> <option>0</option><option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option></select>
                <span class="special-desc" style="margin-left: 0.5em; font-size: 0.98em; display: block;">Double points</span>
              </div>
            </div>
            <div class="special-item-compact" style="width: 100%;">
              <div class="special-row" style="display: flex; align-items: center; gap: 0.7em; min-width: 320px;">
                <span class="emoji-big" style="width: 48px; display: inline-flex; justify-content: center;">ü¶®</span>
                <b style="min-width: 90px; max-width: 120px; font-size: 1.05em; display: flex; flex-direction: column; justify-content: center; text-align: left;">Skunk</b>
                <select id="loseCount" style="width: 2.5em; min-width: 2.5em; max-width: 2.5em; text-align: center;"> <option>0</option><option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option></select>
                <span class="special-desc" style="margin-left: 0.5em; font-size: 0.98em; display: block; line-height: 2.1em; vertical-align: middle;">Lose all points</span>
              </div>
            </div>
            <div class="special-item-compact" style="width: 100%;">
              <div class="special-row" style="display: flex; align-items: center; gap: 0.7em; min-width: 320px;">
                <span class="emoji-big" style="width: 48px; display: inline-flex; justify-content: center;">ü¶ò</span>
                <b style="min-width: 90px; max-width: 120px; font-size: 1.05em; display: flex; flex-direction: column; justify-content: center; text-align: left; line-height: 1.1;">
                  <span>Kangaroo</span><span>Hop</span><span>Swap</span>
                </b>
                <select id="swapCount" style="width: 2.5em; min-width: 2.5em; max-width: 2.5em; text-align: center;"> <option>0</option><option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option></select>
                <span class="special-desc" style="margin-left: 0.5em; font-size: 0.98em; display: block; line-height: 2.1em; vertical-align: middle;">Swap points</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- GAME SCREEN -->
  <div id="gameScreen" class="hidden">
    <!-- Remove the logo image from here -->
    <div id="specialPopup" class="special-popup hidden"></div>
    <div class="scorebar-row">
      <div class="team team-left">
        <div id="annA" class="announcement"></div>
        <h2 id="nameA">Team A</h2><p id="scoreA">0</p>
      </div>
      <div class="center-controls">
        <div id="turnDisplay">Team A's turn</div>
        <div class="game-controls compact-controls">
          <button id="passBtn">Pass</button>
          <button id="skipBtn">Skip</button>
          <button id="revealBtn">Reveal Answer</button>
        </div>
      </div>
      <div class="team team-right">
        <div id="annB" class="announcement"></div>
        <div id="teamBNameContainer" class="team-b-name-container">
          <img id="androidImg" src="Daft-Punk-PNG-Photo.png" alt="Android" style="display:none; width: 48px; height: 48px; object-fit: contain; border-radius: 50%; background: #fff; border: 1px solid #ccc; margin-right: 0.7em; vertical-align: middle;">
          <h2 id="nameB" style="margin: 0;">Team B</h2>
        </div>
        <p id="scoreB">0</p>
      </div>
    </div>

    <div id="questionAnswerRow" style="display:none;">
      <div id="questionBubble" class="bubble-left">
        <div id="question"></div>
        <div id="answer"></div>
      </div>
    </div>

    <div id="grid" style="flex: 1 1 auto;"></div>
    <footer class="game-footer-btns" style="width: 100%; background: #6F5C91; color: #fff; display: flex; flex-direction: row; align-items: center; justify-content: center; padding: 1.2rem 0 1.2rem 0; margin: 0; position: relative;">
      <div style="display: flex; gap: 1.2rem; align-items: center;">
        <button id="resetBtn"><span class="emoji">üîÑ</span> Reset Game</button>
        <button id="homeBtn"><span class="emoji">üè†</span> Home</button>
      </div>
      <div style="flex: 1 1 auto;"></div>
      <div style="font-size: 1rem; opacity: 0.85; margin-left: 2rem; white-space: nowrap; padding-right: 2rem;">Created by Timothy Piontek</div>
    </footer>
  </div>

  <!-- Remove duplicate tabbed interface below navbar and replace with a single #librarySection container -->
  <div id="librarySection" class="hidden" style="max-width:900px;margin:2rem auto 0 auto;display:flex;flex-direction:column;align-items:center;"></div>

  <!-- === AUTH MODAL (just before </body>) === -->
  <div id="authModal" class="hidden" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(49,114,122,0.85);z-index:2000;display:none;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:2.2em 2.5em;border-radius:16px;max-width:420px;width:95vw;box-shadow:0 4px 32px rgba(0,0,0,0.18);position:relative;">
      <button id="closeAuthModal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#6F5C91;">&times;</button>
      <div>
        <div id="authError" style="color:#e57373;margin-bottom:1em;"></div>
        <div style="display:flex;gap:0.5em;margin-bottom:1em;">
          <button id="tabLogin" type="button" style="flex:1;font-weight:700;padding:0.5em 0;background:#eee;border:none;border-radius:6px 0 0 6px;">Login</button>
          <button id="tabSignup" type="button" style="flex:1;font-weight:700;padding:0.5em 0;background:#fff;border:none;border-radius:0 6px 6px 0;">Sign Up</button>
        </div>
        <form id="loginForm" style="display:block;">
          <input id="loginEmail" type="email" placeholder="Email" required style="width:100%;margin-bottom:0.7em;padding:0.7em;border-radius:6px;border:1px solid #ccc;">
          <input id="loginPassword" type="password" placeholder="Password" required style="width:100%;margin-bottom:0.7em;padding:0.7em;border-radius:6px;border:1px solid #ccc;">
          <button type="submit" style="width:100%;background:#6F5C91;color:#fff;font-weight:700;border:none;border-radius:6px;padding:0.7em;font-size:1.1em;cursor:pointer;margin-bottom:0.7em;">Login</button>
          <button type="button" id="googleLoginBtn" style="width:100%;background:#fff;color:#6F5C91;font-weight:700;border:1px solid #6F5C91;border-radius:6px;padding:0.7em;font-size:1.1em;cursor:pointer;">Login with Google</button>
        </form>
        <form id="signupForm" style="display:none;">
          <input id="signupEmail" type="email" placeholder="Email" required style="width:100%;margin-bottom:0.7em;padding:0.7em;border-radius:6px;border:1px solid #ccc;">
          <input id="signupPassword" type="password" placeholder="Password" required style="width:100%;margin-bottom:0.7em;padding:0.7em;border-radius:6px;border:1px solid #ccc;">
          <button type="submit" style="width:100%;background:#6F5C91;color:#fff;font-weight:700;border:none;border-radius:6px;padding:0.7em;font-size:1.1em;cursor:pointer;margin-bottom:0.7em;">Sign Up</button>
        </form>
      </div>
    </div>
  </div>
  <!-- === END AUTH MODAL === -->

  <!-- Move Supabase CDN script and main script block to the end of <body> -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // === SUPABASE INIT ===
      const supabaseClient = supabase.createClient(
        'https://dmbbsrcwqpmdxqtzvtqj.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYmJzcmN3cXBtZHhxdHp2dHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NDg1OTYsImV4cCI6MjA2MjMyNDU5Nn0.E7EYSLCFXMYw5f4Wv7EXXj7-5yAT__BoYXklDB4uE2w'
      );
      
      // Debug: Log session on page load
      supabaseClient.auth.getUser().then(({ data: { user }, error }) => {
        console.log('[DEBUG] On page load, supabaseClient.auth.getUser:', user, error);
      });
      
      // === FOLDER MANAGEMENT ===
      let myLibraryFolders = [];

      function loadMyLibraryFolders() {
        const stored = localStorage.getItem('myLibraryFolders');
        myLibraryFolders = stored ? JSON.parse(stored) : [];
      }

      function saveMyLibraryFolders() {
        localStorage.setItem('myLibraryFolders', JSON.stringify(myLibraryFolders));
      }

      // Load folders immediately
      loadMyLibraryFolders();

      // === DOM REFS ===
      const setupScreen = document.getElementById('setupScreen');
      const gameScreen = document.getElementById('gameScreen');
      const myLibraryLink = document.getElementById('myLibraryLink');
      const publicLibraryLink = document.getElementById('publicLibraryLink');
      const librarySection = document.getElementById('librarySection');
      const startBtnBottom = document.getElementById('startGameBtnBottom');
      const resetBtn = document.getElementById('resetBtn');
      const passBtn = document.getElementById('passBtn');
      const skipBtn = document.getElementById('skipBtn');
      const revealBtn = document.getElementById('revealBtn');
      const gridEl = document.getElementById('grid');
      const annA = document.getElementById('annA');
      const annB = document.getElementById('annB');
      const nameAEl = document.getElementById('nameA');
      const nameBEl = document.getElementById('nameB');
      const scoreAEl = document.getElementById('scoreA');
      const scoreBEl = document.getElementById('scoreB');
      const turnEl = document.getElementById('turnDisplay');
      const questionEl = document.getElementById('question');
      const answerEl = document.getElementById('answer');
      const specialPopup = document.getElementById('specialPopup');
      const teamBNameInput = document.getElementById('teamBNameInput');
      const singlePlayerCheckbox = document.getElementById('singlePlayerCheckbox');
      const androidImg = document.getElementById('androidImg');
      const teamBNameContainer = document.getElementById('teamBNameContainer');
      const quizSelect = document.getElementById('quizSelect');
      const questionsInput = document.getElementById('questionsInput');

      // === LIBRARY SECTION LOGIC ===
      // Helper: get current user
      async function getCurrentUser() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        return user;
      }

      // Refactored renderPublicLibrary
      async function renderPublicLibrary() {
        librarySection.innerHTML = '<h2>Play Tornado Library</h2><div>Loading public quizzes...</div>';
        try {
          const res = await fetch('quiz_library.json');
          if (!res.ok) throw new Error('Failed to fetch quiz_library.json');
          const quizLibrary = await res.json();
          // Group quizzes by category, then by folder
          const categories = {};
          quizLibrary.forEach((quiz, i) => {
            const cat = quiz.category || 'Other';
            const folder = quiz.folder || null;
            if (!categories[cat]) categories[cat] = { folders: {}, root: [] };
            if (folder) {
              if (!categories[cat].folders[folder]) categories[cat].folders[folder] = [];
              categories[cat].folders[folder].push({ ...quiz, index: i });
            } else {
              categories[cat].root.push({ ...quiz, index: i });
            }
          });
          // Build folder UI
          let html = '<div style="width:100%;max-width:700px;text-align:left;margin:0 auto;">';
          Object.keys(categories).sort((a,b)=>a.localeCompare(b)).forEach(cat => {
            html += `<details style="margin-bottom:1.2em;">
              <summary style="font-size:1.2em;font-weight:700;cursor:pointer;background:#eee;padding:0.6em 1em;border-radius:8px;">${cat}</summary>
              <ul style="list-style:none;padding-left:1.2em;">`;
            // Folders first
            const folderNames = Object.keys(categories[cat].folders).sort((a,b)=>a.localeCompare(b));
            folderNames.forEach(folder => {
              html += `<details style="margin-bottom:0.7em;">
                <summary style="font-size:1.08em;font-weight:600;cursor:pointer;background:#f6f6f6;padding:0.4em 1em;border-radius:6px;">${folder}</summary>
                <ul style="list-style:none;padding-left:1.2em;">`;
              categories[cat].folders[folder].forEach(quiz => {
                html += `<li style="margin-bottom:0.5em;display:flex;align-items:center;justify-content:space-between;">
                  <div style='flex:1;min-width:0;'>
                    <a href="#quiz-${quiz.index}" style="font-weight:bold;text-decoration:underline;cursor:pointer;">${quiz.title}</a>
                    <span style="color:#888;font-size:0.95em;">(${quiz.questions && quiz.questions.length ? quiz.questions.length : 0} questions)</span>
                  </div>
                  <div style='display:flex;gap:0.5em;'>
                    <button class="purple-btn" onclick="window.startQuizFromLibrary && window.startQuizFromLibrary('jsonlib:${quiz.index}')">Play</button>
                    <button class="purple-btn" onclick="window.addJsonQuizToMyLibrary && window.addJsonQuizToMyLibrary(${quiz.index})">Add to My Library</button>
                  </div>
                </li>`;
              });
              html += '</ul></details>';
            });
            // Quizzes not in a folder
            categories[cat].root.forEach(quiz => {
              html += `<li style="margin-bottom:0.5em;display:flex;align-items:center;justify-content:space-between;">
                <div style='flex:1;min-width:0;'>
                  <a href="#quiz-${quiz.index}" style="font-weight:bold;text-decoration:underline;cursor:pointer;">${quiz.title}</a>
                  <span style="color:#888;font-size:0.95em;">(${quiz.questions && quiz.questions.length ? quiz.questions.length : 0} questions)</span>
                </div>
                <div style='display:flex;gap:0.5em;'>
                  <button class="purple-btn" onclick="window.startQuizFromLibrary && window.startQuizFromLibrary('jsonlib:${quiz.index}')">Play</button>
                  <button class="purple-btn" onclick="window.addJsonQuizToMyLibrary && window.addJsonQuizToMyLibrary(${quiz.index})">Add to My Library</button>
                </div>
              </li>`;
            });
            html += '</ul></details>';
          });
          html += '</div>';
          librarySection.innerHTML = '<h2>Play Tornado Library</h2>' + html;
        } catch (err) {
          librarySection.innerHTML = '<div style="color:red;">Error loading public quizzes.</div>';
        }
      }

      // New: Render Quiz Detail Page
      async function renderQuizDetailPage(quizIndex) {
        librarySection.innerHTML = '<h2>Loading quiz...</h2>';
        const res = await fetch('quiz_library.json');
        const quizLibrary = await res.json();
        const quiz = quizLibrary[quizIndex];
        if (!quiz) {
          librarySection.innerHTML = '<div style="color:red;">Quiz not found.</div>';
          return;
        }
        let html = `<div style='max-width:700px;margin:0 auto;'>
          <h2>${quiz.title}</h2>
          <div style='margin-bottom:1em;color:#888;'>${quiz.category || ''} &mdash; ${quiz.questions && quiz.questions.length ? quiz.questions.length : 0} questions</div>
          <div style='display:flex;gap:0.5em;margin-bottom:1.5em;'>
            <button class="purple-btn" onclick="window.startQuizFromLibrary && window.startQuizFromLibrary('jsonlib:${quizIndex}')">Play</button>
            <button class="purple-btn" onclick="window.addJsonQuizToMyLibrary && window.addJsonQuizToMyLibrary(${quizIndex})">Add to My Library</button>
            <button class="purple-btn" onclick="navigator.clipboard.writeText(window.location.href)">Share</button>
          </div>
          <ol style='background:#f9f9f9;padding:1.2em 1.5em;border-radius:10px;'>`;
        quiz.questions.forEach((q, i) => {
          html += `<li style='margin-bottom:1em;'><b>Q:</b> ${q.question}<br><b>A:</b> ${q.answer || ''}</li>`;
        });
        html += '</ol></div>';
        librarySection.innerHTML = html;
      }

      // Render My Library (user's quizzes)
      async function renderMyLibrary() {
        console.log('[DEBUG] renderMyLibrary called');
        loadMyLibraryFolders();
        const user = await getCurrentUser();
        if (!user) {
          librarySection.innerHTML = '<h2>My Library</h2><div style="color:#e57373;">Please log in to view your library.</div>';
          return;
        }
        // Add Create Folder button
        librarySection.innerHTML = `
          <h2>My Library</h2>
          <button id="createQuizBtn" class="purple-btn" style="margin:2em auto 1em auto;">+ Create Quiz</button>
          <div id="createQuizModal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(49,114,122,0.85);z-index:3000;display:none;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:2.2em 2.5em;border-radius:16px;max-width:420px;width:95vw;box-shadow:0 4px 32px rgba(0,0,0,0.18);position:relative;">
              <button id="closeCreateQuizModal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#6F5C91;">&times;</button>
              <h3 style="margin-top:0;">Create a New Quiz</h3>
              <p>This is a minimal modal. Add your quiz creation form here.</p>
            </div>
          </div>
          <button id="createFolderBtn" class="purple-btn" style="margin-bottom:1.2em;">+ Create Folder</button>
          <div id="myLibraryList">Loading your quizzes...</div>
        `;
        document.getElementById('createQuizBtn').onclick = function() {
          document.getElementById('createQuizModal').style.display = 'flex';
        };
        document.getElementById('closeCreateQuizModal').onclick = function() {
          document.getElementById('createQuizModal').style.display = 'none';
        };
        document.getElementById('createQuizModal').onclick = function(e) {
          if (e.target === this) document.getElementById('createQuizModal').style.display = 'none';
        };
        // ... rest of createQuizBtn/modal logic ...
        // Fetch quizzes
        let { data, error } = await supabaseClient
          .from('quizzes')
          .select('*')
          .eq('owner', user.id)
          .order('created_at', { ascending: false });
        if (error) {
          document.getElementById('myLibraryList').innerHTML = '<div style="color:red;">Error loading your quizzes.</div>';
          return;
        }
        if (!data || data.length === 0) {
          document.getElementById('myLibraryList').innerHTML = '<div>You have no quizzes yet.</div>';
          return;
        }
        // Group quizzes by folder
        const folderGroups = {};
        myLibraryFolders.forEach(f => folderGroups[f] = []);
        folderGroups['Uncategorized'] = [];
        data.forEach(q => {
          if (q.folder && myLibraryFolders.includes(q.folder)) {
            folderGroups[q.folder].push(q);
          } else {
            folderGroups['Uncategorized'].push(q);
          }
        });
        // Render folders (collapsible), always show all folders
        let html = '';
        Object.keys(folderGroups).forEach(folder => {
          html += `<details open style="margin-bottom:1.2em;" class="folder-dropzone" data-folder="${folder}">
            <summary style="font-size:1.1em;font-weight:700;cursor:pointer;background:#eee;padding:0.5em 1em;border-radius:8px;display:flex;justify-content:space-between;align-items:center;">
              <span>${folder}</span>
              ${folder !== 'Uncategorized' ? `<button class="delete-folder-btn" data-folder="${folder}" style="background:none;border:none;color:#e57373;cursor:pointer;font-size:1.2em;padding:0 0.5em;">üóëÔ∏è</button>` : ''}
            </summary>
            <ul style="list-style:none;padding-left:1.2em;">`;
          if (folderGroups[folder].length === 0) {
            html += `<li style='color:#888;font-size:0.98em;margin-bottom:0.7em;'>No quizzes in this folder.</li>`;
          }
          folderGroups[folder].forEach(quiz => {
            const dropdownId = `moveFolderDropdown-${quiz.id}`;
            html += `<li style="background:#fff;border-radius:10px;padding:1.2em;margin-bottom:1em;box-shadow:0 2px 8px rgba(0,0,0,0.07);text-align:left;" draggable="true" data-quizid="${quiz.id}">
              <a href="#myquiz-${quiz.id}" style="font-weight:bold;text-decoration:underline;cursor:pointer;">${quiz.title}</a> <span style="color:#888;font-size:0.95em;">(${quiz.category||'Uncategorized'})</span><br>
              <span style="font-size:0.95em;color:#888;">${quiz.questions ? (Array.isArray(quiz.questions) ? quiz.questions.length : Object.keys(quiz.questions).length) : 0} questions</span>
              <div style="margin-top:0.7em;display:flex;gap:1em;align-items:center;">
                <button class="purple-btn play-btn" data-quizid="${quiz.id}">Play</button>
                <button class="purple-btn publish-btn" data-quizid="${quiz.id}">Publish to Play Tornado Library</button>
                <button class="purple-btn edit-btn" data-quizid="${quiz.id}">Edit</button>
                <button class="purple-btn delete-btn" data-quizid="${quiz.id}">Delete</button>
                <select class="move-folder-dropdown" id="${dropdownId}" data-quizid="${quiz.id}" style="margin-left:1em;">
                  <option value="">Select folder...</option>
                  ${myLibraryFolders.map(f => `<option value="${f}"${quiz.folder===f?' selected':''}>${f}</option>`).join('')}
                  <option value="Uncategorized"${!quiz.folder?' selected':''}>Uncategorized</option>
                </select>
                <button class="purple-btn move-btn" data-quizid="${quiz.id}" data-dropdownid="${dropdownId}" style="padding:6px 16px;font-size:1em;">Move</button>
              </div>
            </li>`;
          });
          html += '</ul></details>';
        });
        document.getElementById('myLibraryList').innerHTML = html;

        // Attach event listeners for Move, Play, Publish, Edit, Delete after rendering
        const myLibraryList = document.getElementById('myLibraryList');
        if (myLibraryList) {
          // Move button
          myLibraryList.querySelectorAll('.move-btn').forEach(btn => {
            btn.onclick = async function() {
              const quizId = btn.getAttribute('data-quizid');
              const dropdownId = btn.getAttribute('data-dropdownid');
              const sel = document.getElementById(dropdownId);
              if (!sel) { console.log('Dropdown not found for quiz', quizId); return; }
              const folder = sel.value;
              console.log('Move button clicked:', {quizId, folder});
              const { error } = await supabaseClient.from('quizzes').update({ folder: folder === 'Uncategorized' ? null : folder }).eq('id', quizId);
              if (error) {
                console.error('Supabase update error:', error);
                alert('Error moving quiz: ' + error.message);
              } else {
                console.log('Quiz moved successfully');
                await renderMyLibrary();
              }
            };
          });
          // Drag-and-drop support
          myLibraryList.querySelectorAll('li[draggable="true"]').forEach(li => {
            li.ondragstart = function(e) {
              e.dataTransfer.setData('text/plain', li.getAttribute('data-quizid'));
              li.style.opacity = '0.5';
              console.log('Drag start:', li.getAttribute('data-quizid'));
            };
            li.ondragend = function(e) {
              li.style.opacity = '1';
            };
          });
          myLibraryList.querySelectorAll('.folder-dropzone').forEach(folderEl => {
            folderEl.ondragover = function(e) { e.preventDefault(); folderEl.style.background = '#e6e6fa'; };
            folderEl.ondragleave = function(e) { folderEl.style.background = ''; };
            folderEl.ondrop = async function(e) {
              e.preventDefault();
              folderEl.style.background = '';
              const quizId = e.dataTransfer.getData('text/plain');
              const folder = folderEl.getAttribute('data-folder');
              console.log('Drop event:', {quizId, folder});
              const { error } = await supabaseClient.from('quizzes').update({ folder: folder === 'Uncategorized' ? null : folder }).eq('id', quizId);
              if (error) {
                console.error('Supabase update error:', error);
                alert('Error moving quiz: ' + error.message);
              } else {
                console.log('Quiz moved successfully (drag-and-drop)');
                await renderMyLibrary();
              }
            };
          });
          // Play, Publish, Edit, Delete (reuse existing global functions)
          myLibraryList.querySelectorAll('.play-btn').forEach(btn => {
            btn.onclick = () => window.startQuizFromLibrary && window.startQuizFromLibrary(btn.getAttribute('data-quizid'));
          });
          myLibraryList.querySelectorAll('.publish-btn').forEach(btn => {
            btn.onclick = () => window.publishQuizToPublic && window.publishQuizToPublic(btn.getAttribute('data-quizid'));
          });
          myLibraryList.querySelectorAll('.edit-btn').forEach(btn => {
            btn.onclick = () => window.editQuiz && window.editQuiz(btn.getAttribute('data-quizid'));
          });
          myLibraryList.querySelectorAll('.delete-btn').forEach(btn => {
            btn.onclick = () => window.deleteQuiz && window.deleteQuiz(btn.getAttribute('data-quizid'));
          });
        }

        // Add delete folder functionality
        myLibraryList.querySelectorAll('.delete-folder-btn').forEach(btn => {
          btn.onclick = async function(e) {
            e.stopPropagation(); // Prevent folder from toggling
            const folder = btn.getAttribute('data-folder');
            if (!confirm(`Are you sure you want to delete the folder "${folder}"? All quizzes in this folder will be moved to Uncategorized.`)) {
              return;
            }
            // Move all quizzes in this folder to Uncategorized
            const { error } = await supabaseClient
              .from('quizzes')
              .update({ folder: null })
              .eq('folder', folder);
            if (error) {
              alert('Error moving quizzes: ' + error.message);
              return;
            }
            // Remove folder from myLibraryFolders
            myLibraryFolders = myLibraryFolders.filter(f => f !== folder);
            saveMyLibraryFolders();
            await renderMyLibrary();
          };
        });
      }

      // Expose actions globally for inline onclick
      window.startQuizFromLibrary = async function(quizId) {
        if (quizId && quizId.startsWith('jsonlib:')) {
          // Load from quiz_library.json
          const idx = parseInt(quizId.replace('jsonlib:', ''));
          const res = await fetch('quiz_library.json');
          const quizLibrary = await res.json();
          const quiz = quizLibrary[idx];
          if (!quiz) return alert('Quiz not found.');
          // Start game with this quiz
          // Set up game state as if selected from dropdown
          questions = quiz.questions && Array.isArray(quiz.questions) ? quiz.questions.map(q => ({ question: q.question, answer: q.answer || null })) : [];
          usedQuestionIndices = Array.from({length: questions.length}, (_, i) => i);
          // Shuffle if random order is selected
          let order = 'random';
          qIndex = 0;
          names.A = 'Team A';
          names.B = 'Team B';
          singlePlayer = false;
          total = 20;
          setupScreen.classList.add('hidden');
          gameScreen.classList.remove('hidden');
          librarySection.classList.add('hidden');
          androidImg.style.display = 'none';
          nameBEl.textContent = names.B;
          teamBNameContainer.classList.remove('single-player');
          initGame(2,2,2,1); buildGrid(total); showQuestion();
          // Set the game title if you want (optional)
          // document.title = quiz.title + ' - Play Tornado';
          return;
        }
        // ... existing code for DB quizzes ...
      };
      window.addJsonQuizToMyLibrary = async function(idx) {
        // Add a quiz from quiz_library.json to the user's library
        const user = await getCurrentUser();
        if (!user) {
          alert('Please log in to add quizzes to your library.');
          showAuthModal();
          return;
        }
        const res = await fetch('quiz_library.json');
        const quizLibrary = await res.json();
        const quiz = quizLibrary[idx];
        if (!quiz) return alert('Quiz not found.');
        // Insert into Supabase quizzes table
        const { error } = await supabaseClient.from('quizzes').insert([
          {
            title: quiz.title,
            category: quiz.category || null,
            questions: quiz.questions || [],
            is_public: false,
            owner: user.id
          }
        ]);
        if (error) alert('Error adding quiz: ' + error.message);
        else alert('Quiz added to your library!');
      };
      window.saveQuizToMyLibrary = async function(quizId) {
        const user = await getCurrentUser();
        if (!user) alert('Please log in to save quizzes.'); return;
        const { error } = await supabaseClient.from('user_quiz_links').insert([{ user_id: user.id, quiz_id: quizId }]);
        if (error) alert('Error saving quiz: ' + error.message);
        else alert('Quiz saved to your library!');
      };
      window.publishQuizToPublic = async function(quizId) {
        // Get quiz from Supabase
        const { data, error } = await supabaseClient.from('quizzes').select('*').eq('id', quizId).single();
        if (error || !data) {
          alert('Error: Quiz not found.');
          return;
        }
        // Mark as public in DB
        await supabaseClient.from('quizzes').update({ is_public: true }).eq('id', quizId);
        // Append to quiz_library.json
        try {
          const res = await fetch('quiz_library.json');
          if (!res.ok) throw new Error('Failed to fetch quiz_library.json');
          const quizLibrary = await res.json();
          // Avoid duplicates by title + questions
          const exists = quizLibrary.some(q => q.title === data.title && JSON.stringify(q.questions) === JSON.stringify(data.questions));
          if (!exists) {
            quizLibrary.push({
              title: data.title,
              category: data.category,
              questions: data.questions
            });
            await fetch('quiz_library.json', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(quizLibrary)
            });
          }
          alert('Quiz published!');
          renderMyLibrary();
          renderPublicLibrary();
        } catch (e) {
          alert('Error publishing quiz: ' + e.message);
        }
      };
      window.editQuiz = function(quizId) {
        alert('TODO: Edit quiz with ID: ' + quizId);
        // You can implement quiz editing logic here
      };
      window.deleteQuiz = async function(quizId) {
        if (!confirm('Are you sure you want to delete this quiz?')) return;
        const { error } = await supabaseClient.from('quizzes').delete().eq('id', quizId);
        if (error) alert('Error deleting quiz: ' + error.message);
        else { alert('Quiz deleted.'); renderMyLibrary(); renderPublicLibrary(); }
      };

      // Show/hide library section and main screens
      function showLibrary(which) {
        setupScreen.classList.add('hidden');
        gameScreen.classList.add('hidden');
        librarySection.classList.remove('hidden');
        if (which === 'my') {
          renderMyLibrary();
          window.location.hash = '#my-library';
        } else {
          renderPublicLibrary();
          window.location.hash = '#public-library';
        }
      }
      function hideLibrary() {
        librarySection.classList.add('hidden');
        setupScreen.classList.remove('hidden');
        gameScreen.classList.add('hidden'); // Ensure game screen is hidden
      }

      // Navbar link handlers
      myLibraryLink.onclick = function(e) {
        e.preventDefault();
        showLibrary('my');
      };
      publicLibraryLink.onclick = function(e) {
        e.preventDefault();
        showLibrary('public');
      };
      // Home link returns to main setup
      document.getElementById('logoTitleHome').onclick = function(e) {
        e.preventDefault();
        hideLibrary();
        window.location.hash = '';
      };

      // Hash-based navigation
      function handleHash() {
        if (window.location.hash.startsWith('#quiz-')) {
          const quizIndex = parseInt(window.location.hash.replace('#quiz-', ''));
          renderQuizDetailPage(quizIndex);
        } else if (window.location.hash.startsWith('#myquiz-')) {
          const quizId = window.location.hash.replace('#myquiz-', '');
          renderMyQuizDetailPage(quizId);
        } else if (window.location.hash === '#my-library') {
          showLibrary('my');
        } else if (window.location.hash === '#public-library') {
          showLibrary('public');
        } else if (window.location.hash === '#how-to-play') {
          setupScreen.classList.add('hidden');
          gameScreen.classList.add('hidden');
          librarySection.classList.remove('hidden');
          renderHowToPlayPage();
        } else {
          hideLibrary();
        }
      }
      window.addEventListener('hashchange', handleHash);
      handleHash();

      // Re-render My Library on auth state change
      supabaseClient.auth.onAuthStateChange(async () => {
        if (!librarySection.classList.contains('hidden') && window.location.hash === '#my-library') {
          await renderMyLibrary();
        }
      });

      // === AUTH MODAL LOGIC ===
      function showAuthModal() {
        const modal = document.getElementById('authModal');
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        const authError = document.getElementById('authError');
        if (authError) authError.textContent = '';
      }
      function hideAuthModal() {
        const modal = document.getElementById('authModal');
        modal.style.display = 'none';
        modal.classList.add('hidden');
      }
      var loginBtn = document.getElementById('loginLogoutBtn') || document.getElementById('loginBtn');
      if (loginBtn) {
        loginBtn.onclick = function() {
          if (loginBtn.textContent === 'Login') {
            showAuthModal();
          } else {
            supabaseClient.auth.signOut();
          }
        };
      }
      if (document.getElementById('closeAuthModal')) {
        document.getElementById('closeAuthModal').onclick = hideAuthModal;
      }
      if (document.getElementById('authModal')) {
        document.getElementById('authModal').onclick = function(e) {
          if (e.target === this) hideAuthModal();
        };
      }

      // === TAB LOGIC ===
      const tabLogin = document.getElementById('tabLogin');
      const tabSignup = document.getElementById('tabSignup');
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      if (tabLogin) {
        tabLogin.onclick = function() {
          tabLogin.style.background = '#eee';
          tabSignup.style.background = '#fff';
          loginForm.style.display = 'block';
          signupForm.style.display = 'none';
          document.getElementById('authError').textContent = '';
        };
      }
      if (tabSignup) {
        tabSignup.onclick = function() {
          tabLogin.style.background = '#fff';
          tabSignup.style.background = '#eee';
          loginForm.style.display = 'none';
          signupForm.style.display = 'block';
          document.getElementById('authError').textContent = '';
        };
      }
      // Default to login tab
      if (tabLogin) tabLogin.click();

      // === LOGIN FORM ===
      if (loginForm) loginForm.onsubmit = async function(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        let { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) {
          document.getElementById('authError').textContent = error.message;
          return;
        }
        // Debug: Log session after login
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        console.log('[DEBUG] After login, supabaseClient.auth.getUser:', user, userError);
        if (user) {
          hideAuthModal();
          updateLoginBtn();
          // Fallback: reload if UI does not update
          setTimeout(() => { if (!document.getElementById('loginLogoutBtn').textContent.includes('Logout')) window.location.reload(); }, 1000);
        }
      };
      // === SIGNUP FORM ===
      if (signupForm) signupForm.onsubmit = async function(e) {
        e.preventDefault();
        const email = document.getElementById('signupEmail').value.trim();
        const password = document.getElementById('signupPassword').value;
        let { error } = await supabaseClient.auth.signUp({ email, password });
        if (error) {
          document.getElementById('authError').textContent = error.message;
          return;
        }
        document.getElementById('authError').textContent = 'Check your email to confirm your account!';
      };
      // === GOOGLE LOGIN ===
      if (document.getElementById('googleLoginBtn')) {
        document.getElementById('googleLoginBtn').onclick = async function() {
          const { error } = await supabaseClient.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: window.location.origin }
          });
          if (error) document.getElementById('authError').textContent = error.message;
        };
      }

      // === LOGIN BUTTON STATE ===
      async function updateLoginBtn() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const btn = document.getElementById('loginLogoutBtn');
        if (!btn) return;
        if (user) {
          btn.textContent = 'Logout';
          btn.style.background = '#fff';
          btn.style.color = '#e57373';
          btn.title = user.email || '';
        } else {
          btn.textContent = 'Login';
          btn.style.background = '#fff';
          btn.style.color = '#6F5C91';
          btn.title = '';
        }
      }
      updateLoginBtn();
      supabaseClient.auth.onAuthStateChange(async (event, session) => {
        updateLoginBtn();
        if (event === 'SIGNED_IN') {
          hideAuthModal();
          // Immediately check user and update UI
          const { data: { user } } = await supabaseClient.auth.getUser();
          const btn = document.getElementById('loginLogoutBtn');
          if (user && btn) {
            btn.textContent = 'Logout';
            btn.style.background = '#fff';
            btn.style.color = '#e57373';
            btn.title = user.email || '';
          }
        }
      });

      // === BEGIN YOUR GAME/QUIZ LOGIC (leave untouched) ===
      // State
      let rewards=[], scores={A:0,B:0}, picks={A:0,B:0},
          turn='A', names={A:'Team A',B:'Team B'}, total=20,
          questions=[], qIndex=0, usedQuestionIndices=[];
      let singlePlayer = false;

      // Single Player Checkbox logic
      singlePlayerCheckbox.addEventListener('change', function() {
        singlePlayer = this.checked;
        if (singlePlayer) {
          teamBNameInput.value = 'Android';
          teamBNameInput.disabled = true;
        } else {
          teamBNameInput.value = 'Team B';
          teamBNameInput.disabled = false;
        }
      });

      // QUIZ LIBRARY LOGIC
      let quizLibrary = [];
      let selectedQuizIndex = null;

      // Debug: Log fetch start
      console.log('Attempting to fetch quiz_library.json...');
      fetch('quiz_library.json')
        .then(res => {
          console.log('Fetch response:', res);
          if (!res.ok) throw new Error('Failed to fetch quiz_library.json: ' + res.status);
          return res.json();
        })
        .then(data => {
          console.log('Quiz library loaded:', data);
          quizLibrary = data;
          // No more quizSelect logic here!
          // Custom dropdown is built dynamically when opened.
        })
        .catch(err => {
          console.error('Error loading quiz library:', err);
          // Optionally show an error in the custom dropdown
        });

      // Remove quizSelect.onchange and all quizSelect references
      // ... existing code ...
      // Modify Start Game logic to use selected quiz if chosen
      if (startBtnBottom) {
        startBtnBottom.onclick = () => {
          singlePlayer = singlePlayerCheckbox.checked;
          names.A = document.getElementById('teamANameInput').value.trim()||'Team A';
          if (singlePlayer) {
            names.B = 'Android';
          } else {
            names.B = document.getElementById('teamBNameInput').value.trim()||'Team B';
          }
          total = +document.getElementById('gridSizeInput').value;

          // Get special item counts from selectors
          let tornadoCount = parseInt(document.getElementById('tornadoCount').value);
          let doubleCount = parseInt(document.getElementById('doubleCount').value);
          let loseCount = parseInt(document.getElementById('loseCount').value);
          let swapCount = parseInt(document.getElementById('swapCount').value);

          // Adjust defaults for small grids
          if (total <= 10) {
            tornadoCount = 2;
            doubleCount = 1;
            loseCount = 1;
            swapCount = 1;
            document.getElementById('tornadoCount').value = 2;
            document.getElementById('doubleCount').value = 1;
            document.getElementById('loseCount').value = 1;
            document.getElementById('swapCount').value = 1;
          }

          // Use quiz if selected, otherwise use textarea
          if (selectedQuizIndex !== null && quizLibrary[selectedQuizIndex]) {
            const quiz = quizLibrary[selectedQuizIndex];
            // Only support the new format: questions as array of objects
            if (quiz.questions && Array.isArray(quiz.questions) && typeof quiz.questions[0] === 'object') {
              questions = quiz.questions.map(q => ({ question: q.question, answer: q.answer || null }));
            } else {
              questions = [];
            }
            console.log('DEBUG: Selected quiz:', quiz.title, 'Questions loaded:', questions.length, questions);
          } else {
            const raw = questionsInput.value;
            // split blocks on blank line
            const blocks = raw.split(/\n\s*\n/).map(b=>b.trim()).filter(b=>b);
            // detect Q&A blocks
            if(blocks.some(b => b.split('\n').length>1)){
              questions = blocks.map(b=>{
                const [q,a] = b.split('\n');
                return { question:q.trim(), answer:a?.trim()||null };
              });
            } else {
              questions = raw
                .split('\n').map(l=>l.trim()).filter(l=>l)
                .map(q=>({ question:q.replace(/^\d+\.\s*/,''), answer:null }));
            }
          }
          // Prepare usedQuestionIndices for unique rotation
          usedQuestionIndices = [];
          let order = document.querySelector('input[name="order"]:checked').value;
          console.log('DEBUG: Questions array at game start:', questions);
          if (order === 'random') {
            // Shuffle indices
            usedQuestionIndices = Array.from({length: questions.length}, (_, i) => i);
            for (let i = usedQuestionIndices.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [usedQuestionIndices[i], usedQuestionIndices[j]] = [usedQuestionIndices[j], usedQuestionIndices[i]];
            }
          } else {
            usedQuestionIndices = Array.from({length: questions.length}, (_, i) => i);
          }
          qIndex = 0;
          setupScreen.classList.add('hidden');
          gameScreen.classList.remove('hidden');
          // Show Android image if single player
          if (singlePlayer) {
            androidImg.style.display = 'inline-block';
            nameBEl.textContent = 'Android';
            teamBNameContainer.classList.add('single-player');
          } else {
            androidImg.style.display = 'none';
            nameBEl.textContent = names.B;
            teamBNameContainer.classList.remove('single-player');
          }
          initGame(tornadoCount, doubleCount, loseCount, swapCount); buildGrid(total); showQuestion();
        };
      }

      if (passBtn) passBtn.onclick = () => {
        turn = turn==='A'?'B':'A';
        updateTurn();
        showQuestion();
        // In single player mode, if it's now the computer's turn, trigger computer move
        if (singlePlayer && turn === 'B') {
          setTimeout(computerTurn, 1500);
        }
      };
      if (skipBtn) skipBtn.onclick = () => { 
        qIndex = (qIndex + 1) % usedQuestionIndices.length; showQuestion(); 
      };
      if (revealBtn) revealBtn.onclick = () => {
        const qObj = questions[usedQuestionIndices[qIndex]] || {question:'',answer:null};
        answerEl.textContent = qObj.answer || '';
        answerEl.style.color = turn==='A'?'var(--teamA)':'var(--teamB)';
        answerEl.style.textAlign = turn==='A'?'left':'right';
        console.log('DEBUG: Revealed answer for question:', qObj.question, '| Answer:', qObj.answer);
      };

      if (resetBtn) resetBtn.onclick = () => {
        // Get current special item counts
        let tornadoCount = parseInt(document.getElementById('tornadoCount').value);
        let doubleCount = parseInt(document.getElementById('doubleCount').value);
        let loseCount = parseInt(document.getElementById('loseCount').value);
        let swapCount = parseInt(document.getElementById('swapCount').value);
        // Fully reset game state and grid
        initGame(tornadoCount, doubleCount, loseCount, swapCount);
        buildGrid(total);
        showQuestion();
        document.getElementById('questionAnswerRow').style.display = 'none';
      };
      if (document.getElementById('homeBtn')) {
        document.getElementById('homeBtn').onclick = () => {
          gameScreen.classList.add('hidden');
          setupScreen.classList.remove('hidden');
          // Reset everything to initial state
          scores={A:0,B:0}; picks={A:0,B:0};
          annA.textContent=''; annB.textContent='';
          nameAEl.textContent=names.A; nameBEl.textContent=names.B;
          updateScores(); turn='A'; updateTurn();
          gridEl.innerHTML='';
          document.getElementById('questionAnswerRow').style.display = 'none';
          // No need to reassign selector values; UI is already reset
          showQuestion();
        };
      }

      function initGame(tornadoCount=2, doubleCount=2, loseCount=2, swapCount=1){
        scores={A:0,B:0}; picks={A:0,B:0};
        annA.textContent=''; annB.textContent='';
        nameAEl.textContent=names.A; nameBEl.textContent=names.B;
        updateScores(); turn='A'; updateTurn();
        buildRewards(total, tornadoCount, doubleCount, loseCount, swapCount); buildGrid(total); showQuestion();
      }

      function buildRewards(n, tornadoCount=2, doubleCount=2, loseCount=2, swapCount=1){
        // Always include the exact number of each special item
        let specialTotal = tornadoCount + doubleCount + loseCount + swapCount;
        let ptsCount = n - specialTotal;
        if (ptsCount < 0) ptsCount = 0;
        rewards=[];
        for(let i=0;i<ptsCount;i++) rewards.push({type:'points',value:(Math.floor(Math.random()*10)+1)*100});
        for(let i=0;i<loseCount;i++) rewards.push({type:'lose'});
        for(let i=0;i<tornadoCount;i++) rewards.push({type:'steal'});
        for(let i=0;i<doubleCount;i++) rewards.push({type:'double'});
        for(let i=0;i<swapCount;i++) rewards.push({type:'swap'});
        // Shuffle rewards to randomize placement
        for(let i=rewards.length-1;i>0;i--){
          const j=Math.floor(Math.random()*(i+1));
          [rewards[i],rewards[j]]=[rewards[j],rewards[i]];
        }
      }

      function buildGrid(n){
        gridEl.innerHTML='';
        let cols;
        if (n === 18) {
          cols = 6;
        } else if (n === 20) {
          cols = 5;
        } else {
          // Find the widest possible layout (favor wide)
          let bestCols = 1;
          for (let c = Math.floor(Math.sqrt(n)); c <= n; c++) {
            if (n % c === 0 && c >= bestCols) {
              bestCols = c;
            }
          }
          cols = bestCols > 1 ? bestCols : Math.floor(Math.sqrt(n));
          if (n / cols > cols) {
            for (let c = cols + 1; c <= n; c++) {
              if (n % c === 0 && c > cols) {
                cols = c;
              }
            }
          }
        }
        gridEl.style.gridTemplateColumns=`repeat(${cols},1fr)`;
        for(let i=0;i<n;i++){
          const btn=document.createElement('button');
          btn.textContent=i+1; btn.onclick=()=>handlePick(btn,i);
          gridEl.appendChild(btn);
        }
      }

      function handlePick(btn,i){
        let r=rewards[i], me=turn;
        if(picks[me]===0 && r.type!=='points'){
          r={type:'points',value:(Math.floor(Math.random()*10)+1)*100};
        }
        picks[me]++;
        let out='';
        if(r.type==='points'){
          scores[me]+=r.value; out=r.value;
          btn.style.color = me==='A'?'var(--teamA)':'var(--teamB)';
          showPointsPopup(out, me);
        } else if(r.type==='lose'){
          scores[me]=0; out='ü¶®'; 
          styleSpecial(btn,me); 
          showSpecialPopup('ü¶®','Skunked! Lose all your points!');
          animateSkunk(me);
          playSad();
        } else if(r.type==='steal'){
          const o=me==='A'?'B':'A';
          scores[me]+=scores[o]; scores[o]=0;
          out='üå™'; 
          styleSpecial(btn,me); 
          btn.classList.add('tornado-animation');
          showSpecialPopup('üå™Ô∏è','Tornado! Steal the other team\'s points!', true);
          animateKangarooSwap();
        } else if(r.type==='swap'){
          // Swap scores between teams
          let temp = scores['A'];
          scores['A'] = scores['B'];
          scores['B'] = temp;
          out='ü¶ò';
          styleSpecial(btn,me);
          showSpecialPopup('ü¶ò','Kangaroo Hop Swap! Teams swap points!');
          animateKangarooSwap();
        } else {
          scores[me]*=2; out='ü¶Åü¶Å'; 
          styleSpecial(btn,me); 
          showSpecialPopup('ü¶Åü¶Å','Double Lion Roar! Double your points!');
          animateScore(me, 'lion-roar');
        }
        if(me==='A'){
          annA.textContent=`${names.A} got ${out}`; annB.textContent='';
        } else {
          annB.textContent=`${names.B} got ${out}`; annA.textContent='';
        }
        btn.innerHTML = `<span>${out}</span>`; btn.disabled=true;
        if(r.type==='points' && r.value>=800){ confettiBurst(btn); }
        updateScores();
        const done=document.querySelectorAll('#grid button:disabled').length;
        if(done===total){
          if(scores.A>scores.B){
            annA.textContent=`${names.A} wins! üèÜ`; annB.textContent=''; playWin();
          } else if(scores.B>scores.A){
            annB.textContent=`${names.B} wins! üèÜ`; annA.textContent=''; playWin();
          } else {
            annA.textContent="It's a tie!"; annB.textContent=''; playWin();
          }
        } else {
          turn = me==='A'?'B':'A';
          // Advance to next unique question
          qIndex++;
          if (qIndex >= usedQuestionIndices.length) qIndex = 0;
          updateTurn(); showQuestion();
          // If single player and it's now Android's turn, trigger computer move
          if (singlePlayer && turn === 'B') {
            setTimeout(computerTurn, 1500);
          }
        }
      }

      function showQuestion(){
        const qObj = questions[usedQuestionIndices[qIndex]] || {question:'',answer:null};
        questionEl.textContent=qObj.question;
        answerEl.textContent = '';
        // Hide question bubble if no questions
        const questionRow = document.getElementById('questionAnswerRow');
        if (!qObj.question) {
          questionRow.style.display = 'none';
          return;
        } else {
          questionRow.style.display = 'flex';
        }
        // Alternate bubble side based on team turn
        const bubble = document.getElementById('questionBubble');
        if (turn === 'A') {
          bubble.classList.add('bubble-left');
          bubble.classList.remove('bubble-right');
        } else {
          bubble.classList.add('bubble-right');
          bubble.classList.remove('bubble-left');
        }
        revealBtn.classList.toggle('hidden', !qObj.answer);
        console.log('DEBUG: Showing question:', qObj.question, '| Expected answer:', qObj.answer);
      }

      function updateScores(){
        scoreAEl.textContent=scores.A;
        scoreBEl.textContent=scores.B;
      }
      function updateTurn(){
        turnEl.textContent=`${names[turn]}'s turn`;
        turnEl.style.color = turn==='A'?'var(--teamA)':'var(--teamB)';
      }

      function styleSpecial(btn, team) {
        const clr = team==='A'?'var(--teamA)':'var(--teamB)';
        btn.style.background = clr;
        btn.style.color = '#fff';
        btn.style.fontSize = '1.2em';
      }

      function playWind(){
        const C=new(window.AudioContext||window.webkitAudioContext)(),
              buf=C.createBuffer(1,C.sampleRate*0.5,C.sampleRate),
              d=buf.getChannelData(0);
        for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
        const src=C.createBufferSource(),f=C.createBiquadFilter();
        src.buffer=buf; f.type='lowpass'; f.frequency.value=800;
        src.connect(f).connect(C.destination); src.start();
        setTimeout(()=>src.stop(),500);
      }
      function playSad(){
        const C=new(window.AudioContext||window.webkitAudioContext)(),
              o=C.createOscillator(),g=C.createGain();
        o.type='triangle'; o.frequency.value=220;
        o.connect(g).connect(C.destination);
        o.start(); g.gain.setValueAtTime(1,C.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001,C.currentTime+0.8);
        setTimeout(()=>o.stop(),800);
      }

      function showSpecialPopup(emoji, slogan, tornadoMode=false) {
        if (tornadoMode) {
          specialPopup.innerHTML = `
            <div class="special-popup-3d">
              <span class="emoji">üå™Ô∏è</span>
              <div class="slogan">TORNADO!</div>
            </div>`;
          specialPopup.classList.add('show', 'tornado-mode');
          specialPopup.classList.remove('hidden');
          setTimeout(() => {
            specialPopup.classList.remove('show');
            setTimeout(() => specialPopup.classList.add('hidden'), 400);
            specialPopup.classList.remove('tornado-mode');
          }, 5000);
          return;
        }
        specialPopup.innerHTML = `
          <div class="special-popup-3d">
            <span class="emoji">${emoji}</span>
            <div class="slogan">${slogan}</div>
          </div>`;
        specialPopup.classList.add('show');
        specialPopup.classList.remove('hidden');
        setTimeout(() => {
          specialPopup.classList.remove('show');
          setTimeout(() => specialPopup.classList.add('hidden'), 400);
        }, 4000);
      }

      function animateScore(team, animationClass) {
        const el = team === 'A' ? scoreAEl : scoreBEl;
        el.classList.add('score-animate', animationClass);
        setTimeout(() => {
          el.classList.remove(animationClass);
        }, 800);
      }
      function animateKangarooSwap() {
        scoreAEl.classList.add('score-animate', 'kangaroo-jump');
        scoreBEl.classList.add('score-animate', 'kangaroo-jump');
        setTimeout(() => {
          scoreAEl.classList.remove('kangaroo-jump');
          scoreBEl.classList.remove('kangaroo-jump');
        }, 800);
      }
      function animateSkunk(team) {
        const el = team === 'A' ? scoreAEl : scoreBEl;
        el.classList.add('skunk-cloud');
        setTimeout(() => {
          el.classList.remove('skunk-cloud');
        }, 1100);
      }

      // Confetti burst function
      function confettiBurst(targetBtn) {
        const effect = document.createElement('div');
        effect.style.position = 'absolute';
        effect.style.left = targetBtn.offsetLeft + targetBtn.offsetWidth/2 + 'px';
        effect.style.top = targetBtn.offsetTop + targetBtn.offsetHeight/2 + 'px';
        effect.style.pointerEvents = 'none';
        effect.style.zIndex = 10000;
        
        // Create a circular burst of particles
        const particles = [];
        const numParticles = 12;
        const colors = ['#FFD700', '#FFA500', '#FF69B4', '#87CEEB', '#98FB98'];
        
        for (let i = 0; i < numParticles; i++) {
          const particle = document.createElement('div');
          const angle = (i / numParticles) * Math.PI * 2;
          const color = colors[Math.floor(Math.random() * colors.length)];
          
          particle.style.position = 'absolute';
          particle.style.width = '8px';
          particle.style.height = '8px';
          particle.style.background = color;
          particle.style.borderRadius = '50%';
          particle.style.transform = 'translate(-50%, -50%)';
          
          const animation = particle.animate([
            { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 },
            { transform: `translate(${Math.cos(angle) * 100}px, ${Math.sin(angle) * 100}px) scale(0)`, opacity: 0 }
          ], {
            duration: 1500,
            easing: 'cubic-bezier(0.4, 0, 0.2, 1)'
          });
          
          particles.push({ element: particle, animation });
          effect.appendChild(particle);
        }
        
        document.body.appendChild(effect);
        
        // Remove the effect after animation completes
        setTimeout(() => {
          effect.remove();
        }, 1500);
      }

      // Sound effect stubs
      function playWin() {
        const C=new(window.AudioContext||window.webkitAudioContext)(),o=C.createOscillator(),g=C.createGain();
        o.type='triangle'; o.frequency.value=880;
        o.connect(g).connect(C.destination);
        o.start(); g.gain.setValueAtTime(1,C.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001,C.currentTime+0.7);
        setTimeout(()=>o.stop(),700);
      }

      function computerTurn() {
        // Find all enabled grid buttons
        const available = Array.from(document.querySelectorAll('#grid button:not(:disabled)'));
        if (available.length === 0) return;
        // Pick a random button
        const btn = available[Math.floor(Math.random() * available.length)];
        // Always answer correctly: reveal answer before picking
        revealBtn.click();
        // Check if special popup is visible after a short delay (to allow popup to show)
        setTimeout(() => {
          const popup = document.getElementById('specialPopup');
          if (popup && popup.classList.contains('show')) {
            // Wait for popup to disappear (2.65s), then wait 2.0s, then pick
            setTimeout(() => {
              setTimeout(() => {
                btn.click();
              }, 2000);
            }, 2650);
          } else {
            // No popup, normal delay
            setTimeout(() => {
              btn.click();
            }, 2000);
          }
        }, 100); // Give popup a moment to appear
      }

      // --- Custom Expandable Quiz Dropdown Logic ---
      const customQuizDropdown = document.getElementById('customQuizDropdown');
      let customQuizDropdownList = null;
      let customQuizDropdownOpen = false;
      function closeCustomQuizDropdown() {
        if (customQuizDropdownList) {
          customQuizDropdownList.remove();
          customQuizDropdownList = null;
        }
        customQuizDropdownOpen = false;
      }
      function openCustomQuizDropdown() {
        if (customQuizDropdownOpen) return;
        if (!quizLibrary || !quizLibrary.length) return;
        // Group quizzes by category/folder
        const categories = {};
        quizLibrary.forEach((quiz, i) => {
          const cat = quiz.category || 'Other';
          const folder = quiz.folder || null;
          if (!categories[cat]) categories[cat] = { folders: {}, root: [] };
          if (folder) {
            if (!categories[cat].folders[folder]) categories[cat].folders[folder] = [];
            categories[cat].folders[folder].push({ ...quiz, index: i });
          } else {
            categories[cat].root.push({ ...quiz, index: i });
          }
        });
        // Build dropdown list (no <details> or <summary>)
        customQuizDropdownList = document.createElement('div');
        customQuizDropdownList.className = 'custom-quiz-dropdown-list';
        Object.keys(categories).sort((a,b)=>a.localeCompare(b)).forEach(cat => {
          // Category header
          const catDiv = document.createElement('div');
          catDiv.className = 'custom-quiz-category';
          catDiv.tabIndex = 0;
          catDiv.innerHTML = `<span>${cat}</span><span class="custom-quiz-category-arrow">‚ñ∂</span>`;
          let open = false;
          const quizList = document.createElement('ul');
          quizList.className = 'custom-quiz-quizlist';
          quizList.style.display = 'none';
          // Folders
          const folderNames = Object.keys(categories[cat].folders).sort((a,b)=>a.localeCompare(b));
          folderNames.forEach(folder => {
            const folderDiv = document.createElement('div');
            folderDiv.className = 'custom-quiz-folder';
            folderDiv.tabIndex = 0;
            folderDiv.innerHTML = `<span>${folder}</span><span class="custom-quiz-folder-arrow">‚ñ∂</span>`;
            let folderOpen = false;
            const folderList = document.createElement('ul');
            folderList.className = 'custom-quiz-folderlist';
            folderList.style.display = 'none';
            categories[cat].folders[folder].forEach(quiz => {
              const li = document.createElement('li');
              li.textContent = quiz.title;
              li.onclick = function(e) {
                e.stopPropagation();
                customQuizDropdown.textContent = quiz.title;
                selectedQuizIndex = quiz.index;
                closeCustomQuizDropdown();
              };
              if (selectedQuizIndex === quiz.index) li.classList.add('selected');
              folderList.appendChild(li);
            });
            folderDiv.onclick = function(e) {
              e.stopPropagation();
              folderOpen = !folderOpen;
              folderDiv.classList.toggle('open', folderOpen);
              folderList.style.display = folderOpen ? '' : 'none';
            };
            folderDiv.appendChild(folderList);
            quizList.appendChild(folderDiv);
          });
          // Root quizzes
          categories[cat].root.forEach(quiz => {
            const li = document.createElement('li');
            li.textContent = quiz.title;
            li.onclick = function(e) {
              e.stopPropagation();
              customQuizDropdown.textContent = quiz.title;
              selectedQuizIndex = quiz.index;
              closeCustomQuizDropdown();
            };
            if (selectedQuizIndex === quiz.index) li.classList.add('selected');
            quizList.appendChild(li);
          });
          catDiv.onclick = function(e) {
            e.stopPropagation();
            open = !open;
            catDiv.classList.toggle('open', open);
            quizList.style.display = open ? '' : 'none';
          };
          customQuizDropdownList.appendChild(catDiv);
          customQuizDropdownList.appendChild(quizList);
        });
        customQuizDropdown.parentNode.appendChild(customQuizDropdownList);
        customQuizDropdownOpen = true;
      }
      if (customQuizDropdown) {
        customQuizDropdown.onclick = function(e) {
          e.stopPropagation();
          if (customQuizDropdownOpen) {
            closeCustomQuizDropdown();
          } else {
            openCustomQuizDropdown();
          }
        };
        document.addEventListener('click', function(e) {
          if (customQuizDropdownOpen) closeCustomQuizDropdown();
        });
      }
      // Remove old quizSelect logic (dropdown and onchange)
      // ... existing code ...

      function showPointsPopup(points, team) {
        const specialPopup = document.getElementById('specialPopup');
        specialPopup.innerHTML = `<div class="points-reveal-animation points-text-glow">${points}</div>`;
        specialPopup.classList.add('show', 'points-mode');
        specialPopup.classList.remove('hidden');
        specialPopup.style.color = team === 'A' ? 'var(--teamA)' : 'var(--teamB)';
        setTimeout(() => {
          specialPopup.classList.remove('show');
          setTimeout(() => {
            specialPopup.classList.add('hidden');
            specialPopup.classList.remove('points-mode');
          }, 400);
        }, 3500);
      }

      // 1. Make quiz titles in 'My Library' clickable and add detail page
      async function renderMyQuizDetailPage(quizId) {
        librarySection.innerHTML = '<h2>Loading quiz...</h2>';
        // Try to fetch from Supabase
        const { data, error } = await supabaseClient.from('quizzes').select('*').eq('id', quizId).single();
        if (error || !data) {
          librarySection.innerHTML = '<div style="color:red;">Quiz not found.</div>';
          return;
        }
        const quiz = data;
        let html = `<div style='max-width:700px;margin:0 auto;'>
          <h2>${quiz.title}</h2>
          <div style='margin-bottom:1em;color:#888;'>${quiz.category || ''} &mdash; ${quiz.questions && quiz.questions.length ? quiz.questions.length : 0} questions</div>
          <div style='display:flex;gap:0.5em;margin-bottom:1.5em;'>
            <button class="purple-btn" onclick="window.startQuizFromLibrary && window.startQuizFromLibrary('${quiz.id}')">Play</button>
            <button class="purple-btn" onclick="window.publishQuizToPublic && window.publishQuizToPublic('${quiz.id}')">Publish to Play Tornado Library</button>
            <button class="purple-btn" onclick="navigator.clipboard.writeText(window.location.href)">Share</button>
          </div>
          <ol style='background:#f9f9f9;padding:1.2em 1.5em;border-radius:10px;'>`;
        (quiz.questions||[]).forEach((q, i) => {
          html += `<li style='margin-bottom:1em;'><b>Q:</b> ${q.question}<br><b>A:</b> ${q.answer || ''}</li>`;
        });
        html += '</ol></div>';
        librarySection.innerHTML = html;
      }

      // 2. Merge all categories from quiz_library.json and user quizzes for Create Quiz dropdown
      async function loadCategories() {
        quizCategorySelect.innerHTML = '<option value="">Select category</option>';
        // Get user categories
        let { data, error } = await supabaseClient.from('quizzes').select('category').neq('category', null);
        let cats = (data||[]).map(q => q.category).filter(Boolean);
        // Get public library categories
        try {
          const res = await fetch('quiz_library.json');
          if (res.ok) {
            const quizLibrary = await res.json();
            const publicCats = quizLibrary.map(q => q.category).filter(Boolean);
            cats = cats.concat(publicCats);
          }
        } catch (e) {}
        cats = Array.from(new Set(cats)).sort((a,b)=>a.localeCompare(b));
        cats.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          quizCategorySelect.appendChild(opt);
        });
        // Add 'Create new category...' option
        const newOpt = document.createElement('option');
        newOpt.value = '__new__';
        newOpt.textContent = 'Create new category...';
        quizCategorySelect.appendChild(newOpt);
      }

      // Add Create Folder button and modal
      function showCreateFolderModal() {
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(49,114,122,0.85)';
        modal.style.zIndex = '4000';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.innerHTML = `<div style="background:#fff;padding:2.2em 2.5em;border-radius:16px;max-width:420px;width:95vw;box-shadow:0 4px 32px rgba(0,0,0,0.18);position:relative;">
          <button id="closeCreateFolderModal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#6F5C91;">&times;</button>
          <h3 style="margin-top:0;">Create a New Folder</h3>
          <input id="newFolderNameInput" placeholder="Folder name" maxlength="32" style="width:100%;margin-bottom:1em;">
          <button id="createFolderConfirmBtn" class="purple-btn" style="width:100%;">Create Folder</button>
          <div id="createFolderError" style="color:#e57373;margin-top:0.7em;"></div>
        </div>`;
        document.body.appendChild(modal);
        document.getElementById('closeCreateFolderModal').onclick = () => modal.remove();
        modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
        document.getElementById('createFolderConfirmBtn').onclick = async function() {
          const name = document.getElementById('newFolderNameInput').value.trim();
          if (!name) {
            document.getElementById('createFolderError').textContent = 'Please enter a folder name.';
            return;
          }
          if (myLibraryFolders.includes(name)) {
            document.getElementById('createFolderError').textContent = 'Folder already exists.';
            return;
          }
          myLibraryFolders.push(name);
          saveMyLibraryFolders();
          modal.remove();
          await renderMyLibrary();
        };
      }

      // ... inside renderMyLibrary, after rendering the buttons ...
      const createQuizBtn = document.getElementById('createQuizBtn');
      const createQuizModal = document.getElementById('createQuizModal');
      if (createQuizBtn && createQuizModal) {
        createQuizBtn.onclick = () => {
          createQuizModal.innerHTML = `<div style="background:#fff;padding:2.2em 2.5em;border-radius:16px;max-width:420px;width:95vw;box-shadow:0 4px 32px rgba(0,0,0,0.18);position:relative;">
            <button id="closeCreateQuizModal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5em;cursor:pointer;color:#6F5C91;">&times;</button>
            <h3 style="margin-top:0;">Create a New Quiz</h3>
            <form id="createQuizForm">
              <label>Title:<br><input id="quizTitleInput" required maxlength="60" style="width:100%;margin-bottom:0.7em;"></label>
              <label>Category:<br>
                <select id="quizCategorySelect" style="width:100%;margin-bottom:0.7em;"></select>
              </label>
              <div id="newCategoryContainer" class="hidden" style="margin-bottom:0.7em;">
                <input id="newCategoryInput" placeholder="New category name" maxlength="32" style="width:100%;">
              </div>
              <label>Folder:<br>
                <select id="quizFolderSelect" style="width:100%;margin-bottom:0.7em;">
                  <option value="">Uncategorized</option>
                  ${myLibraryFolders.map(f => `<option value="${f}">${f}</option>`).join('')}
                </select>
              </label>
              <label style="display:flex;align-items:center;gap:0.5em;margin-bottom:0.7em;">
                <input type="checkbox" id="quizIsPublicInput">
                <span>Publish to Play Tornado Library</span>
              </label>
              <label>Q&A:<br>
                <textarea id="quizQuestionsInput" required placeholder="Enter questions and answers in one of these formats:\n\nFormat 1 (with answers):\nWhat is the capital of France?\nParis\n\nWhat is 2+2?\n4\n\nFormat 2 (questions only):\nWhat is the capital of France?\nWhat is 2+2?\nWhat is the largest planet in our solar system?" style="width:100%;height:120px;margin-bottom:0.7em;"></textarea>
              </label>
              <div style="display:flex;gap:0.7em;margin-bottom:1em;">
                <button type="submit" class="purple-btn" style="flex:1;">Create Quiz</button>
              </div>
              <div id="createQuizError" style="color:#e57373;margin-top:0.7em;"></div>
              <div id="quizPreview" class="hidden" style="margin-top:1em;padding:1em;background:#f9f9f9;border-radius:8px;"></div>
            </form>
          </div>`;
          createQuizModal.style.display = 'flex';
          createQuizModal.classList.remove('hidden');
          attachCreateQuizModalLogic();
          // Modal close logic
          createQuizModal.onclick = function(e) {
            if (e.target === createQuizModal) createQuizModal.style.display = 'none';
          };
          const closeBtn = document.getElementById('closeCreateQuizModal');
          if (closeBtn) closeBtn.onclick = function() {
            createQuizModal.style.display = 'none';
          };
        };
      }
      // On auth state change, always call renderMyLibrary if on My Library page
      supabaseClient.auth.onAuthStateChange(async () => {
        if (!librarySection.classList.contains('hidden') && window.location.hash === '#my-library') {
          await renderMyLibrary();
        }
      });
      function attachCreateQuizModalLogic() {
        const createQuizModal = document.getElementById('createQuizModal');
        const closeCreateQuizModal = document.getElementById('closeCreateQuizModal');
        const quizCategorySelect = document.getElementById('quizCategorySelect');
        const newCategoryContainer = document.getElementById('newCategoryContainer');
        const newCategoryInput = document.getElementById('newCategoryInput');
        const createQuizForm = document.getElementById('createQuizForm');
        const createQuizError = document.getElementById('createQuizError');
        const quizPreview = document.getElementById('quizPreview');
        if (!createQuizModal || !closeCreateQuizModal || !quizCategorySelect || !newCategoryContainer || !newCategoryInput || !createQuizForm || !createQuizError || !quizPreview) {
          console.error('[DEBUG] One or more modal elements not found:', { createQuizModal, closeCreateQuizModal, quizCategorySelect, newCategoryContainer, newCategoryInput, createQuizForm, createQuizError, quizPreview });
          return;
        }
        console.log('[DEBUG] attachCreateQuizModalLogic: All modal elements found');
        // ... rest of function unchanged ...
      }

      // Move quiz to folder (button-based)
      window.moveQuizToFolderBtn = async function(quizId, dropdownId) {
        const sel = document.getElementById(dropdownId);
        if (!sel) return;
        const folder = sel.value;
        await supabaseClient.from('quizzes').update({ folder: folder === 'Uncategorized' ? null : folder }).eq('id', quizId);
        await renderMyLibrary();
      };

      // 1. Change Home to How to Play in the header
      // In the nav bar HTML:
      // <a href="#" id="myLibraryLink" ...>My Library</a>
      // <a href="#" id="publicLibraryLink" ...>Play Tornado Library</a>
      // <button id="loginLogoutBtn" ...>Login</button>
      // Change the Home link:
      document.querySelector('nav a[href="/"]').textContent = 'How to Play';
      document.querySelector('nav a[href="/"]').id = 'howToPlayLink';

      // 2. Add How to Play page/section
      function renderHowToPlayPage() {
        librarySection.innerHTML = `
          <div style="display:flex;flex-wrap:wrap;align-items:flex-start;justify-content:center;gap:2.5rem;max-width:1100px;margin:2.5rem auto 0 auto;">
            <div style="flex:0 0 220px;max-width:220px;display:flex;align-items:center;justify-content:center;">
              <img src="tornado-logo.png" alt="Play Tornado Logo" style="width:200px;height:200px;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.10);background:#fff;">
            </div>
            <div style="flex:1 1 400px;min-width:320px;max-width:700px;text-align:left;">
              <h1 style="font-size:2.2rem;margin-top:0;display:flex;align-items:center;gap:0.5em;">üå™Ô∏è How to Play Tornado</h1>
              <p style="font-size:1.13rem;line-height:1.7;">Tornado is a fun, flexible classroom game that works great for review, practice, or just getting students excited to participate. You can use it with any content you already have: quizzes, worksheets, discussion questions, or even just verbal prompts. The game can be played as a whole class activity led by a teacher or host, or in single-player mode against the computer.</p>
              <h2 style="margin-top:2.2em;display:flex;align-items:center;gap:0.5em;">üéØ Objective</h2>
              <p>Earn the most points by answering questions correctly and avoiding surprise penalties hidden on the board.</p>
              <h2 style="margin-top:2.2em;display:flex;align-items:center;gap:0.5em;">üë• Game Setup</h2>
              <ul style="margin-bottom:1.2em;">
                <li><b>Enter Team Names:</b> Choose two teams (or just one if playing solo).</li>
                <li><b>Choose Grid Size:</b> Pick how many boxes you want in the game (e.g., 5x5).</li>
                <li><b>Select Question Source:</b> Type in your questions, or leave it blank and use your own worksheet, quiz, or verbal questions.</li>
                <li><b>Set Power-Ups and Penalties:</b> Choose how many of each special box to include. These are explained below.</li>
              </ul>
              <h2 style="margin-top:2.2em;display:flex;align-items:center;gap:0.5em;">üß† How It Works</h2>
              <ul style="margin-bottom:1.2em;">
                <li>One team takes a turn choosing a numbered box.</li>
                <li>The teacher or host reads a question.</li>
                <li>If the team answers correctly, the host clicks the number.</li>
                <li>The box reveals either a point value or a surprise effect.</li>
                <li>If incorrect, the host decides whether to let the other team try or move on.</li>
              </ul>
              <p style="margin-bottom:1.2em;">You can use the <b>Skip</b> and <b>Pass</b> buttons to control the flow. The teacher or host has full control over pacing, turns, and score updates. In single-player mode, turns alternate automatically between the player and the computer.<br>Answers can be revealed at the teacher's or host's discretion.</p>
              <h2 style="margin-top:2.2em;display:flex;align-items:center;gap:0.5em;">üí• Power-Ups and Penalties</h2>
              <table style="width:100%;max-width:500px;background:#f9f9f9;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.04);margin-bottom:1.2em;">
                <thead><tr style="font-weight:700;background:#eee;"><td style="padding:0.5em;">Emoji</td><td style="padding:0.5em;">Name</td><td style="padding:0.5em;">What It Does</td></tr></thead>
                <tbody>
                  <tr><td style="padding:0.5em;">üå™Ô∏è</td><td style="padding:0.5em;">Tornado</td><td style="padding:0.5em;">Steal all of the other team's current points.</td></tr>
                  <tr><td style="padding:0.5em;">ü¶Åü¶Å</td><td style="padding:0.5em;">Double Lion</td><td style="padding:0.5em;">Double the number of points your team just earned.</td></tr>
                  <tr><td style="padding:0.5em;">ü¶®</td><td style="padding:0.5em;">Skunk</td><td style="padding:0.5em;">Lose all of your team's points.</td></tr>
                  <tr><td style="padding:0.5em;">ü¶ò</td><td style="padding:0.5em;">Kangaroo Hop Swap</td><td style="padding:0.5em;">Swap your team's total score with the other team.</td></tr>
                </tbody>
              </table>
              <p style="margin-bottom:1.2em;">You can choose how many of each to include before the game begins.</p>
              <h2 style="margin-top:2.2em;display:flex;align-items:center;gap:0.5em;">‚úÖ Tips for a Smooth Game</h2>
              <ul style="margin-bottom:1.2em;">
                <li>Keep the pace lively by preparing questions in advance.</li>
                <li>Encourage team collaboration before answering.</li>
                <li>Adjust difficulty and surprise settings based on your group.</li>
                <li>Use it to reinforce key ideas, prep for a test, or wrap up a unit in a fun way.</li>
              </ul>
              <button class="purple-btn" id="backToMainBtn" style="margin-top:2.5em;">‚Üê Back</button>
            </div>
          </div>
        `;
        document.getElementById('backToMainBtn').onclick = function() {
          hideLibrary();
          window.location.hash = '';
        };
      }

      // 3. Hook up How to Play link in header
      const howToPlayLink = document.getElementById('howToPlayLink');
      if (howToPlayLink) {
        howToPlayLink.onclick = function(e) {
          e.preventDefault();
          window.location.hash = '#how-to-play';
        };
      }

      // 4. On main page, remove instructional text from How to Play box, leaving only the special item selectors
      // Find the element that contains the How to Play instructions and remove its text content, keeping only the selectors
      const howToPlayBox = document.querySelector('.how-to-play');
      if (howToPlayBox) {
        howToPlayBox.innerHTML = '';
        // Move the special item selectors (if any) back in
        const selectors = document.querySelector('.special-item-compact-list');
        if (selectors) howToPlayBox.appendChild(selectors);
      }

      // ... existing code ...
      if (window.location.hash === '#my-library') {
        renderMyLibrary();
      }
    });

    window.onerror = function(message, source, lineno, colno, error) {
      alert('JavaScript Error: ' + message + '\n' + source + ':' + lineno + ':' + colno);
      console.error('Global JS Error:', message, source, lineno, colno, error);
    };
  </script>
</body>
</html>
