<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tornado Business ‚Äì Manager Dashboard</title>
  <style>
    :root { --bg:#0f172a; --panel:#0b1220; --border:#1f2a44; --text:#e5e7eb; --muted:#9aa3b2; --accent:#22d3ee; }
    * { box-sizing: border-box }
    html, body { height:100% }
    body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position:sticky; top:0; z-index:3; background:#0d1628cc; backdrop-filter: blur(6px); border-bottom:1px solid var(--border); }
    .bar { display:flex; gap:8px; align-items:center; padding:10px 14px; flex-wrap:wrap }
    .bar h1 { font-size:18px; margin:0 8px 0 0; }
    .pill { padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:var(--panel); color:var(--text); cursor:pointer; }
    .pill[disabled] { opacity:.6; cursor:not-allowed }
    .muted { color:var(--muted) }
    .wrap { display:grid; grid-template-columns: 400px 1fr 300px; gap:12px; padding:12px; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px; }
    .title { font-size:14px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); margin:0 0 8px; }
    #gamesList { width: 100%; }
    #roster { display:flex; flex-direction:column; gap:3px; max-height: calc(100vh - 220px); overflow:auto; }
    .row { display:grid; grid-template-columns: 1fr auto; gap:3px; align-items:center; padding:2px 4px; border:1px solid var(--border); border-radius:6px; cursor:pointer; font-size:11px; }
    .row-actions { display:flex; flex-wrap:wrap; gap:2px; justify-content:flex-end; }
    .row.sel { outline:2px solid var(--accent) }
    .bal { font-variant-numeric: tabular-nums; }
    .chip { padding:1px 4px; border:1px solid var(--border); border-radius:4px; font-size:10px; color:var(--muted) }
    .plus { padding:1px 3px; border:1px solid var(--border); border-radius:4px; background:#12223a; cursor:pointer; font-size:9px }
    #board { width:100%; aspect-ratio: 0.8 / 1; background:#0a1220; border:1px solid var(--border); border-radius:12px; overflow:hidden; max-height: 60vh; }
    #grid { width:100%; height:100%; display:grid; }
    .cell { border:1px solid #0d1930; display:flex; align-items:center; justify-content:center; font-size:12px; user-select:none; position:relative; }
    @media (max-height: 800px) { #board { height: 75vh; } }
    .headquarters { font-weight:bold; filter: drop-shadow(0 1px 0 #0008) }
    .section { margin: 10px 0 0 }
    input, textarea, select { width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#081125; color:var(--text) }
    textarea { min-height: 160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:6px 4px; border-bottom: 1px solid var(--border); text-align:left; font-size:14px }
    .minor { font-size:12px; color:var(--muted) }
    .ok { color:#86efac } .warn { color:#facc15 } .err { color:#f87171 }
    
    /* Business Mode specific styles */
    .business-header {
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      font-size: 1.1rem;
      font-weight: bold;
      margin: 0.5rem;
    }
    
    .business-tab {
      flex: 1;
      padding: 6px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s ease;
    }
    
    .business-tab.active {
      background: #64748b;
      color: white;
    }
    
    .business-tab:hover {
      background: #4b5563;
    }
    
    .business-tab-panel {
      display: none;
    }
    
    .business-tab-panel.active {
      display: block;
    }
    
    .metric-card {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 8px;
    }
    
    .metric-name {
      font-weight: 600;
      color: #60a5fa;
      font-size: 12px;
    }
    
    .metric-weight {
      color: var(--muted);
      font-size: 10px;
    }
    
    .credits-display {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 6px;
      padding: 8px;
      text-align: center;
      font-weight: bold;
      color: #fbbf24;
      font-size: 12px;
    }
  </style>
</head>
<body>

<header>
  <div class="bar">
    <h1 style="cursor: pointer;" onclick="window.location.href = '/'">TORNADO BUSINESS</h1>
    <button class="pill" id="btnHelp">How to Play</button>
    <button class="pill" id="btnNewGame" style="background: #dc2626; color: white;">üîÑ New Game</button>
    <div style="flex:1"></div>
    <span id="who" class="muted">Manager Mode</span>
    <button class="pill" onclick="window.location.href='/'">‚Üê Back to Home</button>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: Employee Management -->
  <div class="panel">
    <div class="section">
      <div class="title">Employees</div>
      <div id="employeeList" style="display: flex; flex-direction: column; gap: 6px; max-height: calc(100vh - 300px); overflow: auto;">
        <div style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: rgba(59, 130, 246, 0.1);">
          <div style="font-weight: 600; color: #60a5fa;">Alice Johnson</div>
          <div style="font-size: 11px; color: var(--muted);">Alpha Team ‚Ä¢ 150 pts ‚Ä¢ 25 credits</div>
        </div>
        <div style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: rgba(16, 185, 129, 0.1);">
          <div style="font-weight: 600; color: #34d399;">Bob Smith</div>
          <div style="font-size: 11px; color: var(--muted);">Beta Team ‚Ä¢ 140 pts ‚Ä¢ 22 credits</div>
        </div>
        <div style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: rgba(139, 92, 246, 0.1);">
          <div style="font-weight: 600; color: #a78bfa;">Carol Davis</div>
          <div style="font-size: 11px; color: var(--muted);">Alpha Team ‚Ä¢ 135 pts ‚Ä¢ 20 credits</div>
        </div>
        <div style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: rgba(245, 158, 11, 0.1);">
          <div style="font-weight: 600; color: #fbbf24;">David Wilson</div>
          <div style="font-size: 11px; color: var(--muted);">Gamma Team ‚Ä¢ 130 pts ‚Ä¢ 18 credits</div>
        </div>
      </div>
      <div style="margin-top: 8px;">
        <button class="pill" onclick="addEmployee()" style="background: #10b981; color: white; font-size: 11px; width: 100%;">+ Add Employee</button>
      </div>
    </div>
    
    <div class="section">
      <div class="title">Quick Actions</div>
      <div style="display: flex; flex-direction: column; gap: 6px;">
        <button class="pill" onclick="awardPoints(1)" style="background: #10b981; color: white; font-size: 11px;">+1 Point</button>
        <button class="pill" onclick="awardPoints(5)" style="background: #10b981; color: white; font-size: 11px;">+5 Points</button>
        <button class="pill" onclick="awardPoints(10)" style="background: #10b981; color: white; font-size: 11px;">+10 Points</button>
        <button class="pill" onclick="awardPoints(-1)" style="background: #dc2626; color: white; font-size: 11px;">-1 Point</button>
        <button class="pill" onclick="awardPoints(-10)" style="background: #dc2626; color: white; font-size: 11px;">-10 Points</button>
      </div>
    </div>
    
    <div class="section">
      <div class="title">Game Settings</div>
      <div style="margin-bottom: 8px;">
        <label style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px;">Game Name:</label>
        <input type="text" id="gameName" placeholder="Q4 Performance Challenge" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text); font-size: 11px;">
      </div>
      <div style="margin-bottom: 8px;">
        <label style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px;">Manager Code:</label>
        <input type="text" id="managerCode" placeholder="DEMO" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text); font-size: 11px;">
      </div>
      <button class="pill" onclick="saveGameSettings()" style="background: #3b82f6; color: white; font-size: 11px; width: 100%;">Save Settings</button>
    </div>
  </div>

  <!-- CENTER: Game Board -->
  <div class="panel">
    <div class="business-header" id="gameTitle">
      üè¢ Business Competition
    </div>
    <div id="teamScoreboards" style="margin-bottom: 1rem;"></div>
    <div id="board">
      <div id="grid"></div>
    </div>
    <div class="minor" id="tip">Tip: click an employee name, then click a tile.</div>
  </div>
  
  <!-- RIGHT: Business Tools -->
  <div class="panel">
    <div class="title">Business Tools</div>
    
    <!-- Tab Navigation -->
    <div style="display: flex; gap: 4px; margin-bottom: 12px;">
      <button class="business-tab active" data-tab="leaderboard" onclick="switchTab('leaderboard')">Leaderboard</button>
      <button class="business-tab" data-tab="metrics" onclick="switchTab('metrics')">Metrics</button>
      <button class="business-tab" data-tab="announcements" onclick="switchTab('announcements')">Announcements</button>
      <button class="business-tab" data-tab="rewards" onclick="switchTab('rewards')">Rewards</button>
    </div>
    
    <!-- Tab Content -->
    <div id="businessTabContent">
      <!-- Leaderboard Tab (default) -->
      <div id="tab-leaderboard" class="business-tab-panel active">
        <div class="title">Team Rankings</div>
        <div id="businessLeaderboard">
          <div style="font-size: 11px; color: var(--muted);">Team rankings will appear here...</div>
        </div>
      </div>
      
      <!-- Metrics Tab -->
      <div id="tab-metrics" class="business-tab-panel">
        <div class="title">Performance Metrics</div>
        <div style="margin-bottom: 8px;">
          <button id="addMetricBtn" onclick="showAddMetricModal()" style="width: 100%; padding: 6px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">+ Add Metric</button>
        </div>
        <div id="metricsList">
          <div style="font-size: 11px; color: var(--muted);">Select metrics to track performance...</div>
        </div>
        <div style="margin-top: 8px;">
          <button id="csvImportBtn" onclick="showCsvImportModal()" style="width: 100%; padding: 6px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">üìä CSV Import</button>
        </div>
      </div>
      
      <!-- Announcements Tab -->
      <div id="tab-announcements" class="business-tab-panel">
        <div class="title">Company Updates</div>
        <div style="margin-bottom: 8px;">
          <button id="newAnnouncementBtn" onclick="showNewAnnouncementModal()" style="width: 100%; padding: 6px; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">+ New Announcement</button>
        </div>
        <div id="announcementsList">
          <div style="font-size: 11px; color: var(--muted);">No announcements yet...</div>
        </div>
      </div>
      
      <!-- Rewards Tab -->
      <div id="tab-rewards" class="business-tab-panel">
        <div class="title">Rewards & Incentives</div>
        <div style="margin-bottom: 8px;">
          <label style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px;">Winning Team Gets:</label>
          <input type="text" id="rewardTeam" placeholder="e.g., Team dinner" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text); font-size: 11px;">
        </div>
        <div style="margin-bottom: 8px;">
          <label style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px;">Top Player Gets:</label>
          <input type="text" id="rewardPlayer" placeholder="e.g., 1 PTO day" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text); font-size: 11px;">
        </div>
        <div style="margin-top: 8px;">
          <button id="saveRewardsBtn" onclick="saveRewards()" style="width: 100%; padding: 6px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Save Rewards</button>
        </div>
        
        <!-- Privacy Controls -->
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
          <div class="title">Privacy Settings</div>
          <div style="margin-bottom: 8px;">
            <label style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px;">Leaderboard Visibility:</label>
            <select id="privacyLevel" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text); font-size: 11px;">
              <option value="TEAM_PUBLIC">Team Public - Show team names and scores</option>
              <option value="INDIVIDUAL_PRIVATE">Individual Private - Hide individual names</option>
              <option value="MIXED">Mixed - Teams public, individuals private</option>
            </select>
          </div>
          <div style="margin-top: 8px;">
            <button id="savePrivacyBtn" onclick="savePrivacySettings()" style="width: 100%; padding: 6px; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Save Privacy Settings</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Business Mode State
  let businessState = {
    currentGame: null,
    employees: [],
    metrics: [],
    announcements: [],
    rewards: {
      team: '',
      player: ''
    },
    privacyLevel: 'TEAM_PUBLIC',
    scoreEvents: [],
    board: { w: 0, h: 0, tiles: [] },
    selectedEmployee: null
  };

  // Top 25 Business Metrics
  const TOP_25_METRICS = [
    'Features shipped',
    'Bugs resolved', 
    'Code quality score',
    'Test coverage %',
    'CSAT/NPS delta',
    'Revenue influenced',
    'Deals closed',
    'Hours saved via automation',
    'Knowledge shares hosted',
    'Mentoring sessions',
    'Delivery time delta',
    'On-time task rate %',
    'Escalations handled',
    'Training hours',
    'Certifications earned',
    'New clients onboarded',
    'Retention rate improvement',
    'Innovation proposals',
    'Security issues resolved',
    'Downtime reduced',
    'Documentation completed',
    'Cross-team collaborations',
    'Product demos delivered',
    'Feedback surveys completed',
    'Peer kudos / votes'
  ];

  // Initialize Business Mode
  function initializeBusinessMode() {
    // Load existing game data
    loadGameData();
    
    // Initialize game board
    initializeGameBoard();
    
    // Load initial data
    loadMetricsTab();
    loadAnnouncementsTab();
    loadRewardsTab();
    loadBusinessLeaderboard();
    
    // Set up event listeners
    setupEventListeners();
  }

  function loadGameData() {
    // Load from localStorage or create new game
    const savedGame = localStorage.getItem('businessGame');
    if (savedGame) {
      businessState = { ...businessState, ...JSON.parse(savedGame) };
    }
    
    // Initialize with sample employees if none exist
    if (businessState.employees.length === 0) {
      businessState.employees = [
        {
          id: 'emp_1',
          name: 'Alice Johnson',
          team: 'Alpha',
          points: 100,
          credits: 0,
          balance: 100,
          headquarters: null
        },
        {
          id: 'emp_2',
          name: 'Bob Smith',
          team: 'Beta',
          points: 100,
          credits: 0,
          balance: 100,
          headquarters: null
        },
        {
          id: 'emp_3',
          name: 'Carol Davis',
          team: 'Alpha',
          points: 100,
          credits: 0,
          balance: 100,
          headquarters: null
        },
        {
          id: 'emp_4',
          name: 'David Wilson',
          team: 'Gamma',
          points: 100,
          credits: 0,
          balance: 100,
          headquarters: null
        }
      ];
    }
    
    // Update UI with loaded data
    if (businessState.currentGame) {
      document.getElementById('gameName').value = businessState.currentGame.name || '';
      document.getElementById('managerCode').value = businessState.currentGame.managerCode || 'DEMO';
      document.getElementById('gameTitle').textContent = `üè¢ ${businessState.currentGame.name || 'Business Competition'}`;
    }
    
    if (businessState.rewards.team) {
      document.getElementById('rewardTeam').value = businessState.rewards.team;
    }
    if (businessState.rewards.player) {
      document.getElementById('rewardPlayer').value = businessState.rewards.player;
    }
    
    if (businessState.privacyLevel) {
      document.getElementById('privacyLevel').value = businessState.privacyLevel;
    }
    
    // Update employee display
    updateEmployeeDisplay();
  }

  function saveGameData() {
    localStorage.setItem('businessGame', JSON.stringify(businessState));
  }

  function setupEventListeners() {
    // Auto-save on input changes
    document.getElementById('gameName').addEventListener('input', saveGameData);
    document.getElementById('managerCode').addEventListener('input', saveGameData);
    document.getElementById('rewardTeam').addEventListener('input', saveGameData);
    document.getElementById('rewardPlayer').addEventListener('input', saveGameData);
    document.getElementById('privacyLevel').addEventListener('change', saveGameData);
  }

  function initializeGameBoard() {
    // Calculate board size based on employee count (minimum 8x8)
    const employeeCount = businessState.employees.length || 8; // Default to 8 if no employees
    const w = Math.max(8, Math.ceil(Math.sqrt(employeeCount * 2)));
    const h = Math.max(8, Math.ceil(Math.sqrt(employeeCount * 2)));
    
    console.log('Calculated board size:', { employeeCount, w, h });
    
    // Create board tiles
    const tiles = [];
    for (let y = 0; y < h; y++) {
      for (let x = 0; x < w; x++) {
        tiles.push({
          id: `tile_${x}_${y}`,
          x: x,
          y: y,
          owner: null,
          cost: calculateTilePrice(x, y, w, h),
          isHeadquarters: false
        });
      }
    }
    
    businessState.board = { w, h, tiles };
    
    // Assign starting headquarters to employees
    assignStartingHeadquarters();
    
    // Update grid display
    updateGridDisplay();
  }

  function assignStartingHeadquarters() {
    const { w, h } = businessState.board;
    
    // Place headquarters on outer edges, evenly distributed
    const edgePositions = [];
    
    // Top and bottom edges
    for (let x = 1; x < w - 1; x++) {
      edgePositions.push({ x, y: 0 }); // Top
      edgePositions.push({ x, y: h - 1 }); // Bottom
    }
    
    // Left and right edges
    for (let y = 1; y < h - 1; y++) {
      edgePositions.push({ x: 0, y }); // Left
      edgePositions.push({ x: w - 1, y }); // Right
    }
    
    // Assign headquarters to employees
    businessState.employees.forEach((employee, index) => {
      if (index < edgePositions.length) {
        const pos = edgePositions[index];
        const tile = businessState.board.tiles.find(t => t.x === pos.x && t.y === pos.y);
        if (tile) {
          tile.owner = employee.id;
          tile.isHeadquarters = true;
          employee.headquarters = tile.id;
        }
      }
    });
    
    console.log('Assigned headquarters to employees');
  }

  function calculateTilePrice(x, y, boardW, boardH) {
    const centerX = (boardW - 1) / 2;
    const centerY = (boardH - 1) / 2;
    const distanceFromCenter = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
    const maxDistance = Math.sqrt(Math.pow(boardW / 2, 2) + Math.pow(boardH / 2, 2));
    
    const ringLevel = Math.floor((1 - distanceFromCenter / maxDistance) * 6);
    let price = 20 + (ringLevel * 10);
    
    return Math.max(10, price);
  }

  function updateGridDisplay() {
    const gridEl = document.getElementById('grid');
    if (!gridEl || !businessState.board || !businessState.board.tiles) {
      return;
    }
    
    console.log('updateGridDisplay: updating grid with', businessState.board.tiles.length, 'tiles');
    
    gridEl.style.gridTemplateColumns = `repeat(${businessState.board.w}, 1fr)`;
    gridEl.style.gridTemplateRows = `repeat(${businessState.board.h}, 1fr)`;
    
    gridEl.innerHTML = businessState.board.tiles.map(tile => {
      const owner = tile.owner;
      const employee = businessState.employees.find(emp => emp.id === owner);
      const cost = !owner ? tile.cost : 0;
      const costText = !owner ? `üí∞${cost}` : '';
      
      // Different styling for headquarters vs regular owned tiles
      const isHeadquarters = tile.isHeadquarters;
      const backgroundColor = owner ? (isHeadquarters ? '#1e40af' : '#1e3a8a') : '#1e293b';
      const icon = isHeadquarters ? 'üè¢' : (owner ? 'üè¢' : '');
      
      return `
        <div class="cell ${isHeadquarters ? 'headquarters' : ''}" onclick="selectTile('${tile.id}')" style="
          background: ${backgroundColor};
          cursor: pointer;
          position: relative;
          ${isHeadquarters ? 'border: 2px solid #fbbf24;' : ''}
        ">
          <div style="font-size: 10px; text-align: center;">
            ${icon}
            <div style="font-size: 8px; color: var(--muted);">${costText}</div>
            ${employee ? `<div style="font-size: 7px; color: var(--accent); margin-top: 2px;">${employee.name.split(' ')[0]}</div>` : ''}
          </div>
        </div>
      `;
    }).join('');
    
    console.log('Grid updated with', businessState.board.tiles.length, 'tiles');
  }

  function selectTile(tileId) {
    if (!businessState.selectedEmployee) {
      alert('Please select an employee first!');
      return;
    }
    
    const tile = businessState.board.tiles.find(t => t.id === tileId);
    if (!tile) return;
    
    if (tile.owner) {
      alert('This tile is already owned!');
      return;
    }
    
    // Check if employee has enough balance (mock balance for demo)
    const employeeBalance = 100; // Mock balance
    if (employeeBalance >= tile.cost) {
      tile.owner = businessState.selectedEmployee.id;
      updateGridDisplay();
      alert(`${businessState.selectedEmployee.name} claimed this tile for ${tile.cost} points!`);
    } else {
      alert('Insufficient balance to claim this tile!');
    }
  }

  function switchTab(tabName) {
    // Update active tab
    document.querySelectorAll('.business-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // Show corresponding panel
    document.querySelectorAll('.business-tab-panel').forEach(panel => {
      panel.classList.remove('active');
    });
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    // Load tab content
    if (tabName === 'metrics') {
      loadMetricsTab();
    } else if (tabName === 'announcements') {
      loadAnnouncementsTab();
    } else if (tabName === 'rewards') {
      loadRewardsTab();
    } else if (tabName === 'leaderboard') {
      loadBusinessLeaderboard();
    }
  }

  function loadMetricsTab() {
    const metricsList = document.getElementById('metricsList');
    if (!metricsList) return;
    
    if (businessState.metrics.length === 0) {
      metricsList.innerHTML = '<div style="font-size: 11px; color: var(--muted);">Select metrics to track performance...</div>';
      return;
    }
    
    metricsList.innerHTML = businessState.metrics.map(metric => `
      <div class="metric-card">
        <div class="metric-name">${metric.name}</div>
        <div class="metric-weight">Weight: ${metric.weight}</div>
      </div>
    `).join('');
  }

  function loadAnnouncementsTab() {
    const announcementsList = document.getElementById('announcementsList');
    if (!announcementsList) return;
    
    if (businessState.announcements.length === 0) {
      announcementsList.innerHTML = '<div style="font-size: 11px; color: var(--muted);">No announcements yet...</div>';
      return;
    }
    
    announcementsList.innerHTML = businessState.announcements.map(announcement => `
      <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 6px; padding: 8px; margin-bottom: 8px;">
        <div style="font-weight: 600; color: #a78bfa; font-size: 12px;">${announcement.title}</div>
        <div style="color: var(--text); font-size: 11px; margin-top: 4px;">${announcement.body}</div>
        <div style="color: var(--muted); font-size: 10px; margin-top: 4px;">${new Date(announcement.createdAt).toLocaleString()}</div>
      </div>
    `).join('');
  }

  function loadRewardsTab() {
    // Rewards are loaded in loadGameData()
  }

  function loadBusinessLeaderboard() {
    const businessLeaderboard = document.getElementById('businessLeaderboard');
    if (!businessLeaderboard) return;
    
    // Mock leaderboard data
    const mockData = [
      { name: 'Alice Johnson', team: 'Alpha', points: 150, credits: 25 },
      { name: 'Bob Smith', team: 'Beta', points: 140, credits: 22 },
      { name: 'Carol Davis', team: 'Alpha', points: 135, credits: 20 },
      { name: 'David Wilson', team: 'Gamma', points: 130, credits: 18 }
    ];
    
    let displayData = mockData;
    
    if (businessState.privacyLevel === 'INDIVIDUAL_PRIVATE') {
      displayData = mockData.map((item, index) => ({
        ...item,
        name: `Employee ${index + 1}`,
        team: item.team
      }));
    } else if (businessState.privacyLevel === 'MIXED') {
      displayData = mockData.map((item, index) => ({
        ...item,
        name: `${item.team} Member ${index + 1}`,
        team: item.team
      }));
    }
    
    businessLeaderboard.innerHTML = `
      <div style="font-size: 11px;">
        ${displayData.map((item, index) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid var(--border);">
            <div>
              <span style="font-weight: 600;">${index + 1}. ${item.name}</span>
              <span style="color: var(--muted); font-size: 10px;">(${item.team})</span>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 600;">${item.points} pts</div>
              <div style="color: var(--muted); font-size: 10px;">${item.credits} credits</div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  function showAddMetricModal() {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    `;
    
    modal.innerHTML = `
      <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; max-width: 500px; width: 90%;">
        <h3 style="margin: 0 0 1rem 0; color: var(--text);">Add Performance Metric</h3>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--muted);">Metric Name:</label>
          <select id="metricSelect" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text);">
            <option value="">Select from Top 25...</option>
            ${TOP_25_METRICS.map(metric => `<option value="${metric}">${metric}</option>`).join('')}
            <option value="custom">Custom Metric</option>
          </select>
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--muted);">Custom Name:</label>
          <input type="text" id="customMetricName" placeholder="Enter custom metric name" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text);" disabled>
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--muted);">Weight:</label>
          <input type="number" id="metricWeight" value="1" min="0.1" max="10" step="0.1" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text);">
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button onclick="this.closest('div').parentElement.remove()" style="padding: 0.5rem 1rem; background: var(--border); color: var(--text); border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
          <button onclick="addMetric()" style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">Add Metric</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Handle metric selection
    const metricSelect = document.getElementById('metricSelect');
    const customMetricName = document.getElementById('customMetricName');
    
    metricSelect.onchange = () => {
      if (metricSelect.value === 'custom') {
        customMetricName.disabled = false;
        customMetricName.focus();
      } else {
        customMetricName.disabled = true;
        customMetricName.value = '';
      }
    };
  }

  function addMetric() {
    const metricSelect = document.getElementById('metricSelect');
    const customMetricName = document.getElementById('customMetricName');
    const metricWeight = document.getElementById('metricWeight');
    
    let metricName = metricSelect.value;
    if (metricName === 'custom') {
      metricName = customMetricName.value.trim();
      if (!metricName) {
        alert('Please enter a custom metric name.');
        return;
      }
    }
    
    if (!metricName) {
      alert('Please select or enter a metric name.');
      return;
    }
    
    // Add metric to state
    businessState.metrics.push({
      id: 'metric_' + Date.now(),
      name: metricName,
      weight: parseFloat(metricWeight.value) || 1,
      source: 'MANUAL',
      createdAt: new Date().toISOString()
    });
    
    // Close modal and refresh metrics list
    document.querySelector('[onclick*="addMetric()"]').closest('div').parentElement.remove();
    loadMetricsTab();
    saveGameData();
    
    alert(`Metric "${metricName}" added successfully!`);
  }

  function showCsvImportModal() {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    `;
    
    modal.innerHTML = `
      <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
        <h3 style="margin: 0 0 1rem 0; color: var(--text);">üìä CSV Import</h3>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--muted);">Select CSV File:</label>
          <input type="file" id="csvFile" accept=".csv" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text);">
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--muted);">Expected Format:</label>
          <div style="background: #1e293b; padding: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 11px; color: var(--text);">
            email,team,metric,amount,date,note<br>
            john@company.com,Alpha,Features shipped,5,2024-01-15,Completed user login<br>
            jane@company.com,Beta,Bugs resolved,3,2024-01-15,Fixed payment bug
          </div>
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button onclick="this.closest('div').parentElement.remove()" style="padding: 0.5rem 1rem; background: var(--border); color: var(--text); border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
          <button onclick="importCsvData()" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Import Data</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  }

  function importCsvData() {
    const csvFile = document.getElementById('csvFile');
    
    if (!csvFile.files[0]) {
      alert('Please select a CSV file first.');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const csvContent = e.target.result;
      const lines = csvContent.split('\n').filter(line => line.trim());
      
      let importedCount = 0;
      let errorCount = 0;
      
      // Skip header row
      for (let i = 1; i < lines.length; i++) {
        const columns = lines[i].split(',');
        
        try {
          const email = columns[0]?.trim();
          const team = columns[1]?.trim();
          const metric = columns[2]?.trim();
          const amount = parseFloat(columns[3]?.trim());
          
          if (email && team && metric && !isNaN(amount)) {
            // Create score event
            const scoreEvent = {
              id: 'csv_' + Date.now() + '_' + i,
              email: email,
              team: team,
              metric: metric,
              points: amount,
              source: 'CSV',
              note: `Imported: ${metric}`,
              createdAt: new Date().toISOString()
            };
            
            businessState.scoreEvents.push(scoreEvent);
            importedCount++;
          } else {
            errorCount++;
          }
        } catch (error) {
          errorCount++;
        }
      }
      
      // Close modal and show results
      document.querySelector('[onclick*="importCsvData()"]').closest('div').parentElement.remove();
      
      alert(`CSV Import Complete!\n\nImported: ${importedCount} records\nErrors: ${errorCount} records\n\nData has been added to the game.`);
      
      saveGameData();
    };
    
    reader.readAsText(csvFile.files[0]);
  }

  function showNewAnnouncementModal() {
    alert('New Announcement functionality coming soon! This will allow managers to post company updates.');
  }

  function saveGameSettings() {
    const gameName = document.getElementById('gameName').value;
    const managerCode = document.getElementById('managerCode').value;
    
    businessState.currentGame = {
      name: gameName,
      managerCode: managerCode,
      createdAt: new Date().toISOString()
    };
    
    document.getElementById('gameTitle').textContent = `üè¢ ${gameName || 'Business Competition'}`;
    
    saveGameData();
    alert('Game settings saved successfully!');
  }

  function saveRewards() {
    const teamReward = document.getElementById('rewardTeam').value;
    const playerReward = document.getElementById('rewardPlayer').value;
    
    businessState.rewards = {
      team: teamReward,
      player: playerReward
    };
    
    saveGameData();
    alert('Rewards saved successfully!');
  }

  function savePrivacySettings() {
    const privacyLevel = document.getElementById('privacyLevel').value;
    
    businessState.privacyLevel = privacyLevel;
    
    // Update leaderboard display
    loadBusinessLeaderboard();
    
    saveGameData();
    alert('Privacy settings saved successfully!');
  }

  function awardPoints(points) {
    if (!businessState.selectedEmployee) {
      alert('Please select an employee first!');
      return;
    }
    
    // Award points to selected employee
    businessState.selectedEmployee.points = (businessState.selectedEmployee.points || 0) + points;
    businessState.selectedEmployee.balance = (businessState.selectedEmployee.balance || 0) + points;
    
    updateEmployeeDisplay();
    saveGameData();
    
    alert(`Awarded ${points} points to ${businessState.selectedEmployee.name}!`);
  }

  function addEmployee() {
    const name = prompt('Enter employee name:');
    if (!name) return;
    
    const team = prompt('Enter team name (Alpha, Beta, Gamma):') || 'Alpha';
    
    const newEmployee = {
      id: 'emp_' + Date.now(),
      name: name,
      team: team,
      points: 100, // Equal starting points
      credits: 0,
      balance: 100, // Starting balance
      headquarters: null
    };
    
    businessState.employees.push(newEmployee);
    
    // Reinitialize board to assign new headquarters
    initializeGameBoard();
    updateEmployeeDisplay();
    saveGameData();
    
    alert(`Employee ${name} added to ${team} team with equal starting points!`);
  }

  function updateEmployeeDisplay() {
    const employeeList = document.getElementById('employeeList');
    if (!employeeList) return;
    
    if (businessState.employees.length === 0) {
      employeeList.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 2rem;">No employees yet</div>';
      return;
    }
    
    employeeList.innerHTML = businessState.employees.map(employee => {
      const isSelected = businessState.selectedEmployee && businessState.selectedEmployee.id === employee.id;
      const teamColors = {
        'Alpha': 'rgba(59, 130, 246, 0.1)',
        'Beta': 'rgba(16, 185, 129, 0.1)',
        'Gamma': 'rgba(139, 92, 246, 0.1)'
      };
      
      return `
        <div onclick="selectEmployee('${employee.id}')" style="
          padding: 8px; 
          border: 1px solid var(--border); 
          border-radius: 6px; 
          background: ${teamColors[employee.team] || 'rgba(245, 158, 11, 0.1)'};
          cursor: pointer;
          ${isSelected ? 'outline: 2px solid var(--accent);' : ''}
        ">
          <div style="font-weight: 600; color: ${isSelected ? 'var(--accent)' : 'var(--text)'};">${employee.name}</div>
          <div style="font-size: 11px; color: var(--muted);">${employee.team} Team ‚Ä¢ ${employee.points || 0} pts ‚Ä¢ ${employee.credits || 0} credits</div>
        </div>
      `;
    }).join('');
  }

  function selectEmployee(employeeId) {
    businessState.selectedEmployee = businessState.employees.find(emp => emp.id === employeeId);
    updateEmployeeDisplay();
    
    if (businessState.selectedEmployee) {
      console.log('Selected employee:', businessState.selectedEmployee.name);
    }
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', initializeBusinessMode);
</script>
</body>
</html>
