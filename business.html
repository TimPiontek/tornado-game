<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tornado Business ‚Äì Manager Dashboard</title>
  <style>
    :root { --bg:#0f172a; --panel:#0b1220; --border:#1f2a44; --text:#e5e7eb; --muted:#9aa3b2; --accent:#22d3ee; }
    * { box-sizing: border-box }
    html, body { height:100%; margin:0; padding:0; font-family:system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); }
    
    /* Header */
    .header { background:var(--panel); border-bottom:1px solid var(--border); padding:12px 16px; display:flex; align-items:center; justify-content:space-between; }
    .header-left { display:flex; align-items:center; gap:16px; }
    .logo { font-size:20px; font-weight:bold; color:var(--accent); }
    .header-right { display:flex; align-items:center; gap:12px; }
    .header-btn { padding:6px 12px; background:var(--bg); border:1px solid var(--border); border-radius:6px; color:var(--text); text-decoration:none; font-size:12px; cursor:pointer; }
    .header-btn:hover { background:var(--accent); color:var(--bg); }
    .header-btn.danger { background:#dc2626; color:white; }
    .header-btn.danger:hover { background:#b91c1c; }
    
    .container { display:grid; grid-template-columns: 300px 1fr 300px; height:calc(100vh - 60px); gap:1px; background:var(--border); }
    .panel { background:var(--panel); padding:16px; overflow-y:auto; }
    .title { font-size:14px; font-weight:600; margin-bottom:12px; color:var(--accent); }
    .pill { padding:6px 12px; border:none; border-radius:20px; cursor:pointer; font-size:12px; font-weight:500; }
    .employee-card { background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:8px; margin-bottom:8px; cursor:pointer; transition:all 0.2s; }
    .employee-card:hover { border-color:var(--accent); }
    .employee-card.selected { border-color:var(--accent); background:rgba(34,211,238,0.1); }
    .grid { display:grid; gap:3px; background:var(--border); padding:4px; border-radius:8px; max-height:60vh; overflow:auto; }
    .tile { aspect-ratio:1; background:var(--panel); border:1px solid var(--border); border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s; font-size:11px; position:relative; min-height:58px; padding:4px; text-align:center; }
    .tile:hover { border-color:var(--accent); }
    .tile.owned { background:var(--accent); color:var(--bg); }
    .tile.headquarters { background:#f59e0b; color:var(--bg); }
    .tile.headquarters::after { content:"üè¢"; position:absolute; font-size:16px; }
    .business-tab { padding:8px 12px; border:none; background:transparent; color:var(--muted); cursor:pointer; border-bottom:2px solid transparent; }
    .business-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
    .business-tab-panel { display:none; }
    .business-tab-panel.active { display:block; }
    .modal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:20px; max-width:500px; width:90%; }
    .closeX { position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer; color:var(--muted); }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">üå™Ô∏è TORNADO BUSINESS</div>
    </div>
    <div class="header-right">
      <a href="how-it-works.html" class="header-btn">How to Play</a>
      <button class="header-btn danger" onclick="showNewGameModal()">üîÑ New Game</button>
      <span style="color:var(--muted); font-size:12px;">Manager Mode</span>
      <a href="business-home.html" class="header-btn">‚Üê Back to Home</a>
    </div>
  </div>

  <div class="container">
    <!-- Left Panel -->
    <div class="panel">
      <div class="title">EMPLOYEES</div>
      <div style="margin-bottom:12px;">
        <label for="rosterSelect" style="display:block; margin-bottom:4px; font-size:12px; color:var(--muted);">Select Roster:</label>
        <select id="rosterSelect" name="rosterSelect" onchange="loadSelectedRoster()" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:6px; background:var(--panel); color:var(--text); margin-bottom:8px;">
          <option value="">Choose a roster...</option>
        </select>
        <label for="rosterPaste" style="display:block; margin-bottom:4px; font-size:12px; color:var(--muted);">Or paste new names:</label>
        <textarea id="rosterPaste" name="rosterPaste" placeholder="Paste employee names (one per line)" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:6px; background:var(--panel); color:var(--text); min-height:60px"></textarea>
        <button class="pill" onclick="createRosterFromPaste()" style="background:#22c55e;color:#fff">Create/Update Roster</button>
      </div>
      
      <div style="margin-bottom:12px;">
        <label for="managerCode" style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px;">Manager Code:</label>
        <input type="text" id="managerCode" name="managerCode" placeholder="DEMO" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text); font-size: 11px;">
      </div>
      
      <div id="employeeList"></div>
      
      <div class="title" style="margin-top:20px;">QUICK ACTIONS</div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <button class="pill" onclick="quickAward(1)" style="background:#22c55e;color:#fff">+1 Point</button>
        <button class="pill" onclick="quickAward(5)" style="background:#22c55e;color:#fff">+5 Points</button>
        <button class="pill" onclick="quickAward(10)" style="background:#22c55e;color:#fff">+10 Points</button>
      </div>
    </div>

    <!-- Center Panel -->
    <div class="panel">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px; padding:12px; background:var(--bg); border-radius:8px;">
        <span style="font-size:20px;">üè¢</span>
        <span style="font-weight:600;">Business Competition</span>
      </div>
      
      <div id="gameBoard" class="grid" style="grid-template-columns: repeat(8, 1fr);"></div>
      
      <div style="text-align:center; margin-top:16px; color:var(--muted); font-size:12px;">
        Tip: click an employee name, then click a tile.
      </div>
    </div>

    <!-- Right Panel -->
    <div class="panel">
      <div class="title">BUSINESS TOOLS</div>
      <div style="display:flex; gap:4px; margin-bottom:16px;">
        <button class="business-tab active" onclick="showTab('leaderboard')">Leaderboard</button>
        <button class="business-tab" onclick="showTab('metrics')">Metrics</button>
        <button class="business-tab" onclick="showTab('announcements')">Announcements</button>
        <button class="business-tab" onclick="showTab('rewards')">Rewards</button>
      </div>

      <!-- Leaderboard Tab -->
      <div id="tab-leaderboard" class="business-tab-panel active">
        <div class="title">TEAM RANKINGS</div>
        <div id="teamRankings" style="font-size:12px;color:var(--muted)">Team rankings will appear here...</div>
        
        <div class="title" style="margin-top:20px;">RECENT ACTIVITY</div>
        <div id="recentActivity" style="font-size:12px;color:var(--muted)">No activity yet</div>
      </div>

      <!-- Metrics Tab -->
      <div id="tab-metrics" class="business-tab-panel">
        <div class="title">TEAM METRICS</div>
        <div id="metricsDisplay" style="font-size:12px;color:var(--muted)">Metrics will appear here...</div>
        <button class="pill" onclick="showEditMetricsModal()" style="background:#f59e0b;color:#fff; margin-top:12px;">Edit Metrics</button>
      </div>

      <!-- Announcements Tab -->
      <div id="tab-announcements" class="business-tab-panel">
        <div class="title">ANNOUNCEMENTS</div>
        <div id="announcementsList" style="font-size:12px;color:var(--muted)">No announcements yet</div>
        <button class="pill" onclick="showAnnouncementModal()" style="background:#8b5cf6;color:#fff; margin-top:12px;">New Announcement</button>
      </div>

      <!-- Rewards Tab -->
      <div id="tab-rewards" class="business-tab-panel">
        <div class="title">Rewards & Incentives</div>
        <div style="margin-bottom: 8px;">
          <label for="rewardTeam" style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px;">Winning Team Gets:</label>
          <input type="text" id="rewardTeam" name="rewardTeam" placeholder="e.g., Team dinner" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text); font-size: 11px;">
        </div>
        <div style="margin-bottom: 8px;">
          <label for="rewardPlayer" style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px;">Top Player Gets:</label>
          <input type="text" id="rewardPlayer" name="rewardPlayer" placeholder="e.g., 1 PTO day" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text); font-size: 11px;">
        </div>
        <div style="margin-top: 8px;">
          <button id="saveRewardsBtn" onclick="saveRewards()" style="width: 100%; padding: 6px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Save Rewards</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
  // Supabase client for cloud persistence
  const SUPABASE_URL  = "https://dmbbsrcwqpmdxqtzvtqj.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYmJzcmN3cXBtZHhxdHp2dHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NDg1OTYsImV4cCI6MjA2MjMyNDU5Nn0.E7EYSLCFXMYw5f4Wv7EXXj7-5yAT__BoYXklDB4uE2w";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // Business game state (adapted from working student war game)
  let businessState = {
    employees: [],
    selectedEmployee: null,
    board: { w: 6, h: 6, tiles: [] }, // Smaller grid like student game
    currentGame: null,
    teamMetrics: {
      sales: { current: 45000, target: 100000 },
      products: { current: 12, target: 25 },
      satisfaction: { current: 4.2, target: 5.0 },
      features: { current: 8, target: 15 },
      bugs: { current: 3, target: 0 }
    },
    costs: {
      tile: 10,
      headquartersL1: 25,
      headquartersL2: 50,
      headquartersL3: 100
    }
  };

  // Cloud persistence functions
  async function saveCloudActivity(action, detail) {
    try {
      if (!businessState.currentGame) return;
      const payload = Array.isArray(detail) ? detail : { ...(detail||{}) };
      await supabase.from('activity_feed').insert({
        game_id: businessState.currentGame.id || businessState.currentGame.managerCode,
        actor_id: businessState.selectedEmployee?.id || 'manager',
        action,
        detail: payload,
        created_at: new Date().toISOString()
      });
    } catch (e) { console.warn('[cloud] activity save failed', e); }
  }
  
  async function saveCloudGame() {
    try {
      if (!businessState.currentGame) return;
      
      // Save game
      const { data: game } = await supabase.from('games').upsert({
        id: businessState.currentGame.id,
        code: businessState.currentGame.managerCode,
        name: businessState.currentGame.name,
        mode: 'business',
        status: 'active',
        created_at: new Date().toISOString()
      }).select().single();
      
      if (game && !businessState.currentGame.id) {
        businessState.currentGame.id = game.id;
      }
      
      // Save employees
      if (businessState.employees?.length) {
        const rows = businessState.employees.map(e => ({
          id: e.id,
          game_id: businessState.currentGame.id,
          name: e.name,
          team: e.team,
          points: e.points || 0,
          credits: e.credits || 0,
          balance: e.balance || 0
        }));
        await supabase.from('employees').upsert(rows);
      }
      
      // Save tiles
      if (businessState.board?.tiles?.length) {
        const rows = businessState.board.tiles.map(t => ({
          game_id: businessState.currentGame.id,
          tile_id: t.id,
          x: t.x,
          y: t.y,
          owner_employee_id: t.owner_game_student_id,
          is_headquarters: !!t.isHeadquarters,
          cost: t.cost
        }));
        await supabase.from('tiles').upsert(rows, { onConflict: 'game_id,tile_id' });
      }
    } catch (e) { console.warn('[cloud] game save failed', e); }
  }

  // Initialize the game
  async function init() {
    await loadGameData();
    loadRosterSelector();
    initializeGameBoard();
    updateDisplay();
  }

  // Load game data from Supabase
  async function loadGameData() {
    try {
      // Try to load from Supabase first
      const { data: games } = await supabase.from('games').select('*').eq('mode', 'business').limit(1);
      
      if (games && games.length > 0) {
        const game = games[0];
        businessState.currentGame = game;
        
        // Load employees
        const { data: employees } = await supabase.from('employees').select('*').eq('game_id', game.id);
        businessState.employees = employees || [];
        
        // Load tiles
        const { data: tiles } = await supabase.from('tiles').select('*').eq('game_id', game.id);
        if (tiles && tiles.length > 0) {
          businessState.board.tiles = tiles.map(t => ({
            id: t.tile_id,
            x: t.x,
            y: t.y,
            owner_game_student_id: t.owner_employee_id,
            cost: t.cost,
            isHeadquarters: !!t.is_headquarters
          }));
        }
        
        document.getElementById('managerCode').value = game.code || 'DEMO';
        return;
      }
    } catch (e) {
      console.warn('[cloud] Failed to load from Supabase, falling back to localStorage:', e);
    }
    
    // Fallback to localStorage for compatibility
    const savedRosters = localStorage.getItem('businessRosters');
    console.log('[DEBUG] Saved rosters from localStorage:', savedRosters);
    
    if (savedRosters) {
      const rosters = JSON.parse(savedRosters);
      console.log('[DEBUG] Parsed rosters:', rosters);
      
      if (rosters.length > 0) {
        // Handle both 'roster' and 'employees' property names for compatibility
        businessState.employees = rosters[0].roster || rosters[0].employees || [];
        businessState.currentGame = { name: rosters[0].name, managerCode: 'DEMO' };
        console.log('[DEBUG] Loaded employees:', businessState.employees);
      }
    }
    
    // Create demo roster if none exists
    if (businessState.employees.length === 0) {
      businessState.employees = [
        { id: '1', name: 'Alice Johnson', team: 'Alpha Team', points: 100, credits: 25, balance: 100, tilesOwned: 0 },
        { id: '2', name: 'Bob Smith', team: 'Beta Team', points: 100, credits: 22, balance: 100, tilesOwned: 0 },
        { id: '3', name: 'Carol Davis', team: 'Alpha Team', points: 100, credits: 20, balance: 100, tilesOwned: 0 },
        { id: '4', name: 'David Wilson', team: 'Gamma Team', points: 100, credits: 18, balance: 100, tilesOwned: 0 }
      ];
      
      businessState.currentGame = { name: 'Demo Business Roster', managerCode: 'DEMO' };
      
      // Save to both localStorage and Supabase
      const demoRoster = {
        id: 'demo',
        name: 'Demo Business Roster',
        roster: businessState.employees
      };
      localStorage.setItem('businessRosters', JSON.stringify([demoRoster]));
      
      // Also save to Supabase
      await saveCloudGame();
    }
    
    document.getElementById('managerCode').value = businessState.currentGame?.managerCode || 'DEMO';
  }

  // Load roster selector dropdown
  function loadRosterSelector() {
    const selector = document.getElementById('rosterSelect');
    const savedRosters = localStorage.getItem('businessRosters');
    
    console.log('[DEBUG] Loading roster selector, saved rosters:', savedRosters);
    
    selector.innerHTML = '<option value="">Choose a roster...</option>';
    
    if (savedRosters) {
      const rosters = JSON.parse(savedRosters);
      console.log('[DEBUG] Adding rosters to selector:', rosters);
      
      rosters.forEach(roster => {
        const option = document.createElement('option');
        option.value = roster.id;
        option.textContent = roster.name;
        selector.appendChild(option);
      });
    }
  }

  // Load selected roster
  function loadSelectedRoster() {
    const selector = document.getElementById('rosterSelect');
    const selectedId = selector.value;
    
    if (!selectedId) return;
    
    const savedRosters = localStorage.getItem('businessRosters');
    if (savedRosters) {
      const rosters = JSON.parse(savedRosters);
      const selectedRoster = rosters.find(r => r.id === selectedId);
      
      if (selectedRoster) {
        // Handle both 'roster' and 'employees' property names for compatibility
        businessState.employees = selectedRoster.roster || selectedRoster.employees || [];
        businessState.currentGame = { name: selectedRoster.name, managerCode: 'DEMO' };
        
        // Reinitialize board with new employees
        initializeGameBoard();
        updateDisplay();
      }
    }
  }

  // Initialize the game board (adapted from working student war game)
  function initializeGameBoard() {
    const board = businessState.board;
    board.tiles = [];
    
    for (let y = 0; y < board.h; y++) {
      for (let x = 0; x < board.w; x++) {
        board.tiles.push({
          id: `${x}-${y}`,
          x, y,
          owner_game_student_id: null, // Use same property name as student game
          headquarters_level: 0,
          cost: calculateTilePrice(x, y, board.w, board.h)
        });
      }
    }
    
    // Assign starting headquarters (castles)
    assignStartingHeadquarters();
    updateGridDisplay();
  }

  // Calculate tile price (from working student game)
  function calculateTilePrice(x, y, boardWidth, boardHeight) {
    const centerX = Math.floor(boardWidth / 2);
    const centerY = Math.floor(boardHeight / 2);
    const distanceFromCenter = Math.abs(x - centerX) + Math.abs(y - centerY);
    
    // Base cost increases with distance from center
    let baseCost = 10 + (distanceFromCenter * 2);
    
    // Add some randomness
    const randomFactor = Math.random() * 0.4 + 0.8; // 0.8 to 1.2
    return Math.floor(baseCost * randomFactor);
  }

  // Assign starting headquarters to employees (adapted from working student game)
  function assignStartingHeadquarters() {
    const employees = businessState.employees;
    const board = businessState.board;
    
    // Clear existing headquarters
    board.tiles.forEach(tile => tile.headquarters_level = 0);
    
    if (employees.length === 0) return;
    
    // Place headquarters in corners for better gameplay
    const corners = [
      { x: 0, y: 0 },
      { x: board.w - 1, y: 0 },
      { x: 0, y: board.h - 1 },
      { x: board.w - 1, y: board.h - 1 }
    ];
    
    employees.forEach((emp, i) => {
      if (corners[i]) {
        const tile = board.tiles.find(t => t.x === corners[i].x && t.y === corners[i].y);
        if (tile) {
          tile.owner_game_student_id = emp.id;
          tile.headquarters_level = 1; // Level 1 headquarters
          tile.cost = 0; // Free starting tile
        }
      }
    });
  }

  // Update the grid display (adapted from working student war game)
  function updateGridDisplay() {
    const board = businessState.board;
    const grid = document.getElementById('gameBoard');
    
    // Set grid size
    grid.style.gridTemplateColumns = `repeat(${board.w}, 1fr)`;
    
    grid.innerHTML = '';
    board.tiles.forEach(tile => {
      const div = document.createElement('div');
      div.className = 'tile';
      div.onclick = () => handleTileClick(tile.id);
      
      const owner = tile.owner_game_student_id ? 
        businessState.employees.find(e => e.id === tile.owner_game_student_id) : null;
      
      if (owner) {
        div.classList.add('owned');
        div.textContent = owner.name.split(' ')[0];
        
        if (tile.headquarters_level > 0) {
          div.classList.add('headquarters');
          div.innerHTML = `
            <div style="font-weight:bold; font-size:10px;">${owner.name.split(' ')[0]}</div>
            <div style="font-size:8px;">üè¢</div>
          `;
        }
      } else {
        div.textContent = `$${tile.cost}`;
      }
      
      grid.appendChild(div);
    });
  }

  // Handle tile click (adapted from working student war game)
  window.handleTileClick = function(tileId) {
    console.log('handleTileClick called with tileId:', tileId, 'selectedEmployee:', businessState.selectedEmployee);
    
    if (!businessState.selectedEmployee) {
      alert("Please select an employee first by clicking on their name in the roster.");
      return;
    }

    const tile = businessState.board.tiles.find(t => t.id === tileId);
    if (!tile) {
      console.log('Tile not found:', tileId);
      return;
    }

    const selectedEmployee = businessState.selectedEmployee;
    console.log('Handling tile click:', { tile, selectedEmployee });

    if (!tile.owner_game_student_id) {
      // Empty tile - buy it (check adjacency)
      if (!canEmployeeAttackTile(selectedEmployee.id, tile)) {
        alert(`Cannot claim this territory! You can only claim territories that are adjacent to your own territories.`);
        return;
      }
      
      const cost = tile.cost;
      if (selectedEmployee.balance >= cost) {
        tile.owner_game_student_id = selectedEmployee.id;
        selectedEmployee.balance -= cost;
        updateGridDisplay();
        updateDisplay();
        
        // Save to cloud
        saveCloudGame();
        saveCloudActivity('claim_tile', { tileId: tile.id, cost: cost });
        
        alert(`${selectedEmployee.name} bought the tile for ${cost} points!`);
      } else {
        alert(`Insufficient funds! Need ${cost} points.`);
      }
    } else if (tile.owner_game_student_id === selectedEmployee.id) {
      // Own tile - show headquarters options
      if (tile.headquarters_level > 0) {
        // Has headquarters - show upgrade/sell options
        const upgradeCost = tile.headquarters_level === 1 ? businessState.costs.headquartersL2 : 
                           tile.headquarters_level === 2 ? businessState.costs.headquartersL3 : 0;
        const sellValue = tile.headquarters_level === 1 ? businessState.costs.headquartersL1 : 
                         tile.headquarters_level === 2 ? businessState.costs.headquartersL2 : 
                         tile.headquarters_level === 3 ? businessState.costs.headquartersL3 : 0;
        
        const options = [];
        if (upgradeCost > 0) {
          options.push(`Upgrade to Level ${tile.headquarters_level + 1} (${upgradeCost} points)`);
        }
        options.push(`Sell headquarters (${sellValue} points)`);
        
        const choice = prompt(`Headquarters Level ${tile.headquarters_level} Options:\n${options.join('\n')}\n\nEnter your choice (1-${options.length}):`);
        const choiceIndex = parseInt(choice) - 1;
        
        if (choiceIndex >= 0 && choiceIndex < options.length) {
          if (choiceIndex === 0 && upgradeCost > 0) {
            // Upgrade
            if (selectedEmployee.balance >= upgradeCost) {
              tile.headquarters_level++;
              selectedEmployee.balance -= upgradeCost;
              updateGridDisplay();
              updateDisplay();
              saveCloudGame();
              alert(`Headquarters upgraded to Level ${tile.headquarters_level}!`);
            } else {
              alert(`Insufficient funds! Need ${upgradeCost} points.`);
            }
          } else {
            // Sell
            tile.headquarters_level = 0;
            selectedEmployee.balance += sellValue;
            updateGridDisplay();
            updateDisplay();
            saveCloudGame();
            alert(`Headquarters sold for ${sellValue} points!`);
          }
        }
      } else {
        // No headquarters - offer to build
        const buildCost = businessState.costs.headquartersL1;
        if (confirm(`Build headquarters for ${buildCost} points?`)) {
          if (selectedEmployee.balance >= buildCost) {
            tile.headquarters_level = 1;
            selectedEmployee.balance -= buildCost;
            updateGridDisplay();
            updateDisplay();
            saveCloudGame();
            alert(`Headquarters built!`);
          } else {
            alert(`Insufficient funds! Need ${buildCost} points.`);
          }
        }
      }
    } else {
      // Enemy tile - check if defender would be eliminated
      const defender = businessState.employees.find(e => e.id === tile.owner_game_student_id);
      if (!defender) return;
      
      // Check if this would be defender's last territory
      const defenderTiles = businessState.board.tiles.filter(t => t.owner_game_student_id === defender.id);
      if (defenderTiles.length <= 1) {
        alert(`Cannot attack ${defender.name}'s last territory! They must keep at least one territory.`);
        return;
      }
      
      if (!canEmployeeAttackTile(selectedEmployee.id, tile)) {
        alert(`Cannot attack this territory! You can only attack territories that are adjacent to your own territories.`);
        return;
      }
      
      // Show battle preparation modal
      showBattlePreparation(selectedEmployee, defender, tile);
    }
  };

  // Check if employee can attack/claim a tile based on adjacency (from working student game)
  function canEmployeeAttackTile(employeeId, targetTile) {
    // If employee has no territories, they can claim any unowned tile (initial placement)
    const employeeTiles = businessState.board.tiles.filter(t => t.owner_game_student_id === employeeId);
    if (employeeTiles.length === 0) {
      return true; // Initial placement - can claim any unowned tile
    }
    
    // Check if target tile is adjacent to any of the employee's tiles
    for (const employeeTile of employeeTiles) {
      if (isAdjacent(employeeTile, targetTile)) {
        return true;
      }
    }
    
    return false;
  }

  // Check if two tiles are adjacent (from working student game)
  function isAdjacent(tile1, tile2) {
    const dx = Math.abs(tile1.x - tile2.x);
    const dy = Math.abs(tile1.y - tile2.y);
    return (dx <= 1 && dy <= 1) && !(dx === 0 && dy === 0);
  }

  // Show battle preparation modal (business version)
  function showBattlePreparation(attacker, defender, targetTile) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="card" style="width: 800px; max-height: 90vh; overflow-y: auto;">
        <div class="closeX" onclick="this.closest('.modal').remove()">√ó</div>
        <h2>‚öîÔ∏è Business Acquisition Preparation</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
          <!-- Attacker Section -->
          <div style="border: 2px solid #10b981; border-radius: 8px; padding: 15px;">
            <h3 style="color: #10b981; margin-top: 0;">${attacker.name} (Acquirer)</h3>
            
            <div style="margin-bottom: 15px;">
              <strong>üí∞ Budget:</strong> ${attacker.balance} points
            </div>
            
            <div style="margin-bottom: 15px;">
              <strong>üë• Consultants:</strong>
              <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                <button onclick="adjustConsultants('attacker', -1)" style="padding: 5px 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text);">-</button>
                <span id="attackerConsultants">0</span>
                <button onclick="adjustConsultants('attacker', 1)" style="padding: 5px 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text);">+</button>
                <span style="font-size: 12px; color: var(--muted);">(10 points each)</span>
              </div>
            </div>
            
            <div style="margin-bottom: 15px;">
              <strong>üõ†Ô∏è Acquisition Tools:</strong>
              <div style="margin-top: 10px;">
                <button onclick="selectTool('attacker', 'presentation', 30)" style="padding: 8px 12px; margin: 2px; border: 1px solid var(--border); border-radius: 6px; background: #8b5cf6; color: white;">Presentation (30 pts)</button>
                <button onclick="selectTool('attacker', 'proposal', 60)" style="padding: 8px 12px; margin: 2px; border: 1px solid var(--border); border-radius: 6px; background: #3b82f6; color: white;">Proposal (60 pts)</button>
                <button onclick="selectTool('attacker', 'negotiation', 100)" style="padding: 8px 12px; margin: 2px; border: 1px solid var(--border); border-radius: 6px; background: #dc2626; color: white;">Negotiation (100 pts)</button>
              </div>
              <div id="attackerSelected" style="margin-top: 8px; font-size: 12px; color: var(--muted);">Selected: None</div>
              <button onclick="removeTool('attacker')" style="padding: 4px 8px; margin-top: 5px; border: 1px solid var(--border); border-radius: 4px; background: #dc2626; color: white; font-size: 12px;">Remove</button>
            </div>
          </div>
          
          <!-- Defender Section -->
          <div style="border: 2px solid #dc2626; border-radius: 8px; padding: 15px;">
            <h3 style="color: #dc2626; margin-top: 0;">${defender.name} (Defender)</h3>
            
            <div style="margin-bottom: 15px;">
              <strong>üí∞ Budget:</strong> ${defender.balance} points
            </div>
            
            <div style="margin-bottom: 15px;">
              <strong>üë• Legal Team:</strong>
              <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                <button onclick="adjustConsultants('defender', -1)" style="padding: 5px 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text);">-</button>
                <span id="defenderConsultants">0</span>
                <button onclick="adjustConsultants('defender', 1)" style="padding: 5px 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel); color: var(--text);">+</button>
                <span style="font-size: 12px; color: var(--muted);">(10 points each, +10 power)</span>
              </div>
            </div>
            
            <div style="margin-bottom: 15px;">
              <strong>üõ†Ô∏è Defense Tools:</strong>
              <div style="margin-top: 10px;">
                <button onclick="selectTool('defender', 'presentation', 30)" style="padding: 8px 12px; margin: 2px; border: 1px solid var(--border); border-radius: 6px; background: #8b5cf6; color: white;">Presentation (30 pts)</button>
                <button onclick="selectTool('defender', 'proposal', 60)" style="padding: 8px 12px; margin: 2px; border: 1px solid var(--border); border-radius: 6px; background: #3b82f6; color: white;">Proposal (60 pts)</button>
                <button onclick="selectTool('defender', 'negotiation', 100)" style="padding: 8px 12px; margin: 2px; border: 1px solid var(--border); border-radius: 6px; background: #dc2626; color: white;">Negotiation (100 pts)</button>
              </div>
              <div id="defenderSelected" style="margin-top: 8px; font-size: 12px; color: var(--muted);">Selected: None</div>
              <button onclick="removeTool('defender')" style="padding: 4px 8px; margin-top: 5px; border: 1px solid var(--border); border-radius: 4px; background: #dc2626; color: white; font-size: 12px;">Remove</button>
            </div>
            
            <div style="margin-bottom: 15px;">
              <strong>üè¢ Corporate Defense:</strong>
              <div style="margin-top: 10px;">
                <button onclick="selectDefense('basic', 50)" style="padding: 8px 12px; margin: 2px; border: 1px solid var(--border); border-radius: 6px; background: #10b981; color: white;">Basic Security (50 pts)</button>
                <button onclick="selectDefense('advanced', 100)" style="padding: 8px 12px; margin: 2px; border: 1px solid var(--border); border-radius: 6px; background: #3b82f6; color: white;">Advanced Security (100 pts)</button>
                <button onclick="selectDefense('premium', 200)" style="padding: 8px 12px; margin: 2px; border: 1px solid var(--border); border-radius: 6px; background: #8b5cf6; color: white;">Premium Security (200 pts)</button>
              </div>
              <div id="defenseSelected" style="margin-top: 8px; font-size: 12px; color: var(--muted);">Selected: None</div>
              <button onclick="removeDefense()" style="padding: 4px 8px; margin-top: 5px; border: 1px solid var(--border); border-radius: 4px; background: #dc2626; color: white; font-size: 12px;">Remove</button>
            </div>
          </div>
        </div>
        
        <!-- Battle Summary -->
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin: 20px 0;">
          <h3 style="margin-top: 0;">üìä Acquisition Summary</h3>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
            <div>
              <strong>Acquirer Power:</strong><br>
              <span id="attackerPower" style="font-size: 18px; color: #10b981;">0.0</span>
            </div>
            <div>
              <strong>Acquirer Cost:</strong><br>
              <span id="attackerCost" style="font-size: 18px; color: #10b981;">0 points</span>
            </div>
            <div>
              <strong>Defender Power:</strong><br>
              <span id="defenderPower" style="font-size: 18px; color: #dc2626;">0.0</span>
            </div>
            <div>
              <strong>Defender Cost:</strong><br>
              <span id="defenderCost" style="font-size: 18px; color: #dc2626;">0 points</span>
            </div>
          </div>
          <div style="text-align: center; margin-top: 15px;">
            <strong>Victory Odds:</strong><br>
            <span id="victoryOdds" style="font-size: 24px; color: #f59e0b;">50.0%</span>
          </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
          <button onclick="executeBusinessAcquisition()" style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">üöÄ Execute Acquisition</button>
        </div>
        
        <div style="margin-top: 15px; font-size: 12px; color: var(--muted); text-align: center;">
          How tools affect power: Consultants (+1 each), Presentations (+2), Proposals (+4), Negotiations (+8), Security (+3/+6/+12)
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Initialize battle state
    window.battleState = {
      attacker: attacker,
      defender: defender,
      targetTile: targetTile,
      attackerConsultants: 0,
      defenderConsultants: 0,
      attackerTool: null,
      defenderTool: null,
      defense: null
    };
    
    updateBattleSummary();
  }

  // Battle preparation helper functions
  window.adjustConsultants = function(side, change) {
    const current = window.battleState[side + 'Consultants'];
    const newValue = Math.max(0, current + change);
    window.battleState[side + 'Consultants'] = newValue;
    document.getElementById(side + 'Consultants').textContent = newValue;
    updateBattleSummary();
  };

  window.selectTool = function(side, tool, cost) {
    window.battleState[side + 'Tool'] = { name: tool, cost: cost };
    document.getElementById(side + 'Selected').textContent = `Selected: ${tool.charAt(0).toUpperCase() + tool.slice(1)} (${cost} pts)`;
    updateBattleSummary();
  };

  window.removeTool = function(side) {
    window.battleState[side + 'Tool'] = null;
    document.getElementById(side + 'Selected').textContent = 'Selected: None';
    updateBattleSummary();
  };

  window.selectDefense = function(defense, cost) {
    window.battleState.defense = { name: defense, cost: cost };
    document.getElementById('defenseSelected').textContent = `Selected: ${defense.charAt(0).toUpperCase() + defense.slice(1)} Security (${cost} pts)`;
    updateBattleSummary();
  };

  window.removeDefense = function() {
    window.battleState.defense = null;
    document.getElementById('defenseSelected').textContent = 'Selected: None';
    updateBattleSummary();
  };

  function updateBattleSummary() {
    if (!window.battleState) return;
    
    const state = window.battleState;
    
    // Calculate attacker power
    let attackerPower = state.attackerConsultants;
    if (state.attackerTool) {
      const toolPower = state.attackerTool.name === 'presentation' ? 2 : 
                       state.attackerTool.name === 'proposal' ? 4 : 8;
      attackerPower += toolPower;
    }
    
    // Calculate defender power
    let defenderPower = state.defenderConsultants + (state.defenderConsultants * 0.1); // +10% bonus
    if (state.defenderTool) {
      const toolPower = state.defenderTool.name === 'presentation' ? 2 : 
                       state.defenderTool.name === 'proposal' ? 4 : 8;
      defenderPower += toolPower;
    }
    if (state.defense) {
      const defensePower = state.defense.name === 'basic' ? 3 : 
                          state.defense.name === 'advanced' ? 6 : 12;
      defenderPower += defensePower;
    }
    
    // Calculate costs
    let attackerCost = state.attackerConsultants * 10;
    if (state.attackerTool) attackerCost += state.attackerTool.cost;
    
    let defenderCost = state.defenderConsultants * 10;
    if (state.defenderTool) defenderCost += state.defenderTool.cost;
    if (state.defense) defenderCost += state.defense.cost;
    
    // Calculate victory odds
    const totalPower = attackerPower + defenderPower;
    const victoryOdds = totalPower > 0 ? (attackerPower / totalPower) * 100 : 50;
    
    // Update display
    document.getElementById('attackerPower').textContent = attackerPower.toFixed(1);
    document.getElementById('attackerCost').textContent = attackerCost + ' points';
    document.getElementById('defenderPower').textContent = defenderPower.toFixed(1);
    document.getElementById('defenderCost').textContent = defenderCost + ' points';
    document.getElementById('victoryOdds').textContent = victoryOdds.toFixed(1) + '%';
  }

  window.executeBusinessAcquisition = async function() {
    const state = window.battleState;
    if (!state) return;
    
    // Calculate final costs and power
    let attackerCost = state.attackerConsultants * 10;
    if (state.attackerTool) attackerCost += state.attackerTool.cost;
    
    let defenderCost = state.defenderConsultants * 10;
    if (state.defenderTool) defenderCost += state.defenderTool.cost;
    if (state.defense) defenderCost += state.defense.cost;
    
    // Check if attacker has enough points
    if (state.attacker.balance < attackerCost) {
      alert(`Insufficient funds! Need ${attackerCost} points for this acquisition.`);
      return;
    }
    
    // Calculate victory odds
    let attackerPower = state.attackerConsultants;
    if (state.attackerTool) {
      const toolPower = state.attackerTool.name === 'presentation' ? 2 : 
                       state.attackerTool.name === 'proposal' ? 4 : 8;
      attackerPower += toolPower;
    }
    
    let defenderPower = state.defenderConsultants + (state.defenderConsultants * 0.1);
    if (state.defenderTool) {
      const toolPower = state.defenderTool.name === 'presentation' ? 2 : 
                       state.defenderTool.name === 'proposal' ? 4 : 8;
      defenderPower += toolPower;
    }
    if (state.defense) {
      const defensePower = state.defense.name === 'basic' ? 3 : 
                          state.defense.name === 'advanced' ? 6 : 12;
      defenderPower += defensePower;
    }
    
    const totalPower = attackerPower + defenderPower;
    const victoryChance = totalPower > 0 ? attackerPower / totalPower : 0.5;
    
    // Execute acquisition
    const success = Math.random() < victoryChance;
    
    if (success) {
      // Acquisition successful
      state.targetTile.owner_game_student_id = state.attacker.id;
      state.targetTile.headquarters_level = 0; // Reset headquarters on capture
      state.attacker.balance -= attackerCost;
      
      updateGridDisplay();
      updateDisplay();
      await saveCloudGame();
      await saveCloudActivity('acquisition_success', { 
        tileId: state.targetTile.id, 
        defender: state.defender.id, 
        cost: attackerCost 
      });
      
      alert(`üéâ Acquisition successful! ${state.attacker.name} acquired the territory!`);
    } else {
      // Acquisition failed
      state.attacker.balance -= attackerCost;
      
      updateDisplay();
      await saveCloudGame();
      await saveCloudActivity('acquisition_failed', { 
        tileId: state.targetTile.id, 
        defender: state.defender.id, 
        cost: attackerCost 
      });
      
      alert(`üí• Acquisition failed! ${state.defender.name} defended successfully.`);
    }
    
    // Close modal
    document.querySelector('.modal').remove();
    window.battleState = null;
  };

  // Update all displays
  function updateDisplay() {
    updateEmployeeList();
    updateTeamRankings();
    updateMetricsDisplay();
  }

  // Update employee list
  function updateEmployeeList() {
    const list = document.getElementById('employeeList');
    list.innerHTML = '';
    
    businessState.employees.forEach(emp => {
      const div = document.createElement('div');
      div.className = 'employee-card';
      div.onclick = () => selectEmployee(emp);
      
      if (businessState.selectedEmployee?.id === emp.id) {
        div.classList.add('selected');
      }
      
      div.innerHTML = `
        <div style="font-weight:600; margin-bottom:4px;">${emp.name}</div>
        <div style="font-size:11px; color:var(--muted);">${emp.team} ‚Ä¢ ${emp.balance} pts ‚Ä¢ ${emp.credits} credits</div>
      `;
      
      list.appendChild(div);
    });
  }

  // Select an employee
  function selectEmployee(employee) {
    businessState.selectedEmployee = employee;
    updateEmployeeList();
  }

  // Quick award points
  function quickAward(points) {
    if (!businessState.selectedEmployee) {
      alert('Please select an employee first');
      return;
    }
    
    businessState.selectedEmployee.balance += points;
    businessState.selectedEmployee.points += points;
    updateDisplay();
  }

  // Create roster from pasted text
  function createRosterFromPaste() {
    const text = document.getElementById('rosterPaste').value;
    if (!text.trim()) {
      alert('Please paste employee names');
      return;
    }
    
    const names = text.split('\n').filter(name => name.trim());
    businessState.employees = names.map((name, i) => ({
      id: `emp_${i + 1}`,
      name: name.trim(),
      team: `Team ${String.fromCharCode(65 + (i % 3))}`,
      points: 100,
      credits: 0,
      balance: 100,
      tilesOwned: 0
    }));
    
    // Save to localStorage
    const roster = {
      id: 'current',
      name: 'Current Business Roster',
      roster: businessState.employees
    };
    localStorage.setItem('businessRosters', JSON.stringify([roster]));
    
    // Refresh roster selector
    loadRosterSelector();
    
    // Reinitialize board with new employees
    initializeGameBoard();
    updateDisplay();
    
    alert(`Created roster with ${businessState.employees.length} employees`);
  }

  // Show tab
  function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.business-tab-panel').forEach(panel => {
      panel.classList.remove('active');
    });
    document.querySelectorAll('.business-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`tab-${tabName}`).classList.add('active');
    event.target.classList.add('active');
  }

  // Update team rankings
  function updateTeamRankings() {
    const teams = {};
    businessState.employees.forEach(emp => {
      if (!teams[emp.team]) {
        teams[emp.team] = { name: emp.team, totalPoints: 0, members: 0 };
      }
      teams[emp.team].totalPoints += emp.balance;
      teams[emp.team].members++;
    });
    
    const rankings = Object.values(teams).sort((a, b) => b.totalPoints - a.totalPoints);
    const display = document.getElementById('teamRankings');
    
    if (rankings.length === 0) {
      display.textContent = 'No teams yet';
      return;
    }
    
    display.innerHTML = rankings.map((team, i) => `
      <div style="margin-bottom:8px; padding:8px; background:var(--bg); border-radius:6px;">
        <div style="font-weight:600;">#${i + 1} ${team.name}</div>
        <div style="font-size:11px; color:var(--muted);">${team.totalPoints} points ‚Ä¢ ${team.members} members</div>
      </div>
    `).join('');
  }

  // Update metrics display
  function updateMetricsDisplay() {
    const metrics = businessState.teamMetrics;
    const display = document.getElementById('metricsDisplay');
    
    const salesPercent = (metrics.sales.current / metrics.sales.target * 100).toFixed(1);
    
    display.innerHTML = `
      <div style="margin-bottom:12px;">
        <div style="font-weight:600; margin-bottom:4px;">üéØ Sales Goal</div>
        <div style="background:var(--bg); height:8px; border-radius:4px; overflow:hidden;">
          <div style="background:#22c55e; height:100%; width:${salesPercent}%; transition:width 0.3s;"></div>
        </div>
        <div style="font-size:11px; color:var(--muted); margin-top:4px;">$${metrics.sales.current.toLocaleString()} / $${metrics.sales.target.toLocaleString()} (${salesPercent}%)</div>
      </div>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:11px;">
        <div style="background:var(--bg); padding:8px; border-radius:6px;">
          <div style="font-weight:600;">üì¶ Products</div>
          <div style="color:var(--muted);">${metrics.products.current}/${metrics.products.target}</div>
        </div>
        <div style="background:var(--bg); padding:8px; border-radius:6px;">
          <div style="font-weight:600;">üòä Satisfaction</div>
          <div style="color:var(--muted);">${metrics.satisfaction.current}/${metrics.satisfaction.target}</div>
        </div>
        <div style="background:var(--bg); padding:8px; border-radius:6px;">
          <div style="font-weight:600;">üöÄ Features</div>
          <div style="color:var(--muted);">${metrics.features.current}/${metrics.features.target}</div>
        </div>
        <div style="background:var(--bg); padding:8px; border-radius:6px;">
          <div style="font-weight:600;">üêõ Bugs</div>
          <div style="color:var(--muted);">${metrics.bugs.current}/${metrics.bugs.target}</div>
        </div>
      </div>
    `;
  }

  // Show edit metrics modal
  function showEditMetricsModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="card" style="width: 500px;">
        <div class="closeX" onclick="this.closest('.modal').remove()">√ó</div>
        <h2>‚öôÔ∏è Edit Team Metrics</h2>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600;">üéØ Main Goal (Sales)</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <input type="number" id="salesCurrent" name="salesCurrent" placeholder="Current ($)" value="${businessState.teamMetrics.sales.current}">
            <input type="number" id="salesTarget" name="salesTarget" placeholder="Target ($)" value="${businessState.teamMetrics.sales.target}">
          </div>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600;">üì¶ Products Sold</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <input type="number" id="productsCurrent" name="productsCurrent" placeholder="Current" value="${businessState.teamMetrics.products.current}">
            <input type="number" id="productsTarget" name="productsTarget" placeholder="Target" value="${businessState.teamMetrics.products.target}">
          </div>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600;">üòä Customer Satisfaction</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <input type="number" step="0.1" id="satisfactionCurrent" name="satisfactionCurrent" placeholder="Current" value="${businessState.teamMetrics.satisfaction.current}">
            <input type="number" step="0.1" id="satisfactionTarget" name="satisfactionTarget" placeholder="Target" value="${businessState.teamMetrics.satisfaction.target}">
          </div>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600;">üöÄ Features Shipped</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <input type="number" id="featuresCurrent" name="featuresCurrent" placeholder="Current" value="${businessState.teamMetrics.features.current}">
            <input type="number" id="featuresTarget" name="featuresTarget" placeholder="Target" value="${businessState.teamMetrics.features.target}">
          </div>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600;">üêõ Bugs Resolved</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <input type="number" id="bugsCurrent" name="bugsCurrent" placeholder="Current" value="${businessState.teamMetrics.bugs.current}">
            <input type="number" id="bugsTarget" name="bugsTarget" placeholder="Target" value="${businessState.teamMetrics.bugs.target}">
          </div>
        </div>
        
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button onclick="saveMetricChanges()" style="flex: 1; padding: 10px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">üíæ Save Changes</button>
          <button onclick="this.closest('.modal').remove()" style="flex: 1; padding: 10px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">‚ùå Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  // Save metric changes
  function saveMetricChanges() {
    businessState.teamMetrics.sales.current = parseInt(document.getElementById('salesCurrent').value) || 0;
    businessState.teamMetrics.sales.target = parseInt(document.getElementById('salesTarget').value) || 0;
    businessState.teamMetrics.products.current = parseInt(document.getElementById('productsCurrent').value) || 0;
    businessState.teamMetrics.products.target = parseInt(document.getElementById('productsTarget').value) || 0;
    businessState.teamMetrics.satisfaction.current = parseFloat(document.getElementById('satisfactionCurrent').value) || 0;
    businessState.teamMetrics.satisfaction.target = parseFloat(document.getElementById('satisfactionTarget').value) || 0;
    businessState.teamMetrics.features.current = parseInt(document.getElementById('featuresCurrent').value) || 0;
    businessState.teamMetrics.features.target = parseInt(document.getElementById('featuresTarget').value) || 0;
    businessState.teamMetrics.bugs.current = parseInt(document.getElementById('bugsCurrent').value) || 0;
    businessState.teamMetrics.bugs.target = parseInt(document.getElementById('bugsTarget').value) || 0;
    
    updateMetricsDisplay();
    document.querySelector('.modal').remove();
    alert('‚úÖ Metrics updated!');
  }

  // Show announcement modal
  function showAnnouncementModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="card" style="width: 560px;">
        <div class="closeX" onclick="this.closest('.modal').remove()">√ó</div>
        <h2>üì£ New Announcement</h2>
        <div style="display:grid; gap:8px;">
          <label for="annTitle" style="display:block; margin-bottom:4px; font-size:12px; color:var(--muted);">Title:</label>
          <input id="annTitle" name="annTitle" placeholder="Title" />
          <label for="annBody" style="display:block; margin-bottom:4px; font-size:12px; color:var(--muted);">Message:</label>
          <textarea id="annBody" name="annBody" placeholder="Write your announcement..." style="min-height:120px"></textarea>
          <div style="display:flex; gap:8px;">
            <button onclick="saveAnnouncement()" style="flex:1; padding:10px; background:#8b5cf6; color:#fff; border:none; border-radius:8px; cursor:pointer;">Post</button>
            <button onclick="this.closest('.modal').remove()" style="flex:1; padding:10px; background:#6b7280; color:#fff; border:none; border-radius:8px; cursor:pointer;">Cancel</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  // Save announcement
  function saveAnnouncement() {
    const title = document.getElementById('annTitle').value;
    const body = document.getElementById('annBody').value;
    
    if (!title || !body) {
      alert('Please fill in both title and message');
      return;
    }
    
    // Add to announcements list
    const announcements = JSON.parse(localStorage.getItem('businessAnnouncements') || '[]');
    announcements.push({
      id: Date.now(),
      title,
      body,
      date: new Date().toISOString()
    });
    localStorage.setItem('businessAnnouncements', JSON.stringify(announcements));
    
    updateAnnouncementsList();
    document.querySelector('.modal').remove();
    alert('‚úÖ Announcement posted!');
  }

  // Update announcements list
  function updateAnnouncementsList() {
    const announcements = JSON.parse(localStorage.getItem('businessAnnouncements') || '[]');
    const display = document.getElementById('announcementsList');
    
    if (announcements.length === 0) {
      display.textContent = 'No announcements yet';
      return;
    }
    
    display.innerHTML = announcements.slice(-5).reverse().map(ann => `
      <div style="margin-bottom:12px; padding:8px; background:var(--bg); border-radius:6px;">
        <div style="font-weight:600; margin-bottom:4px;">${ann.title}</div>
        <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">${new Date(ann.date).toLocaleString()}</div>
        <div style="font-size:12px;">${ann.body}</div>
      </div>
    `).join('');
  }

  // Save rewards
  function saveRewards() {
    const teamReward = document.getElementById('rewardTeam').value;
    const playerReward = document.getElementById('rewardPlayer').value;
    
    localStorage.setItem('businessRewards', JSON.stringify({
      team: teamReward,
      player: playerReward,
      updated: new Date().toISOString()
    }));
    
    alert('‚úÖ Rewards saved!');
  }

  // Show new game modal
  function showNewGameModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="card" style="width: 500px;">
        <div class="closeX" onclick="this.closest('.modal').remove()">√ó</div>
        <h2>üîÑ Create New Work Scenario</h2>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600;">Game Name</label>
          <input type="text" id="newGameName" name="newGameName" placeholder="e.g., Q4 Sales Challenge" value="Business Competition">
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600;">Work Scenario</label>
          <select id="workScenario" name="workScenario" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--panel); color: var(--text);">
            <option value="individual">üë§ Individual Competition - Everyone works alone</option>
            <option value="pairs">üë• Pair Competition - Teams of 2 employees</option>
            <option value="teams3">üè¢ Team Competition - Teams of 3 employees</option>
            <option value="teams4">üè¢ Team Competition - Teams of 4 employees</option>
            <option value="mixed">üéØ Mixed Mode - Individual + Team challenges</option>
          </select>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600;">Starting Points per Employee</label>
          <input type="number" id="startingPoints" name="startingPoints" placeholder="100" value="100" min="50" max="500">
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 4px; font-weight: 600;">Board Size</label>
          <select id="boardSize" name="boardSize" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--panel); color: var(--text);">
            <option value="small">Small (8x8) - 64 tiles</option>
            <option value="medium" selected>Medium (10x10) - 100 tiles</option>
            <option value="large">Large (12x12) - 144 tiles</option>
          </select>
        </div>
        
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button onclick="createNewGame()" style="flex: 1; padding: 10px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">üöÄ Create Game</button>
          <button onclick="this.closest('.modal').remove()" style="flex: 1; padding: 10px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">‚ùå Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  // Create new game
  async function createNewGame() {
    const name = document.getElementById('newGameName').value;
    const scenario = document.getElementById('workScenario').value;
    const startingPoints = parseInt(document.getElementById('startingPoints').value) || 100;
    const boardSize = document.getElementById('boardSize').value;
    
    if (!name.trim()) {
      alert('Please enter a game name');
      return;
    }
    
    // Update game state
    businessState.currentGame = {
      name: name,
      managerCode: 'DEMO_' + Date.now(),
      scenario: scenario,
      startingPoints: startingPoints
    };
    
    // Update board size
    const sizes = { small: 8, medium: 10, large: 12 };
    businessState.board.w = businessState.board.h = sizes[boardSize] || 10;
    
    // Reset employees with new starting points
    businessState.employees.forEach(emp => {
      emp.points = startingPoints;
      emp.balance = startingPoints;
    });
    
    // Reinitialize board
    initializeGameBoard();
    updateDisplay();
    
    // Save to cloud
    await saveCloudGame();
    
    document.querySelector('.modal').remove();
    alert('‚úÖ New game created!');
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
